<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Chat :: Final Version</title>

    <!-- =================================================================== -->
    <!-- 【V1.95 优化】新增元数据标签，用于生成漂亮的链接预览图 -->
    <!-- =================================================================== -->
    <meta name="description" content="一个高度可定制化的AI聊天应用界面。">
    <!-- Open Graph Meta Tags (用于微信、QQ、Facebook等) -->
    <meta property="og:title" content="AI Chat :: Final Version">
    <meta property="og:description" content="一个高度可定制化的AI聊天应用界面。">
    <meta property="og:type" content="website">
    <!-- 【【【核心】】】请将下面的链接替换为您想用作预览图的图片URL -->
    <meta property="og:image"
        content="https://tc-new.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250912/I4Xl/1206X1501/IMG_6556.jpeg/webp">
    <meta property="og:url" content="YOUR_WEBSITE_URL_HERE">
    <!-- =================================================================== -->
    <!-- 1. CSS 样式区 -->
    <!-- =================================================================== -->
    <style>
        /* --- 全局和基础样式 --- */
        * {
            -webkit-tap-highlight-color: transparent;
            /* 【新增】全局移除移动端点击高亮效果 */
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* 【核心修复】重新加回 overflow: hidden */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #fafafa;
        }

        #phone-screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: #fafafa;
        }

        /* 【新增】状态栏样式 */
        #status-bar {
            position: absolute;
            top: -15px;
            left: 0;
            width: 100%;
            height: 76px;
            /* 状态栏高度 */
            box-sizing: border-box;
            padding: 0 15px 0 25px;
            /* 【修改】增加了左侧内边距，让时间右移 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            z-index: 100;
            pointer-events: none;
            /* 让状态栏不影响下层元素的点击 */
        }

        #status-bar-icons {
            display: flex;
            align-items: center;
            gap: 14.7px;
            /* 恢复到你最初感觉舒适的间距 */
        }

        /* 【全新】独立移动信号图标 */
        #status-bar-signal-icon {
            position: relative;
            /* 开启相对定位 */
            right: 0;
            /* 把它向右推8px，视觉上就是向左移动了 */
        }

        #status-bar-icons {
            display: flex;
            align-items: center;
            gap: 14.7px;
            /* 恢复到你最初感觉舒适的间距 */
        }

        /* 【全新】独立移动天气图标 */
        #status-bar-weather-icon {
            position: relative;
            /* 开启相对定位 */
            right: 0px;
            /* 把它向右推8px，视觉上就是向左移动了 */
        }

        #status-bar-battery-icon {
            position: relative;
            /* 开启相对定位 */
            top: 0;
            right: 4px;
            /* 把它向右推8px，视觉上就是向左移动了 */
        }

        #chat-interface-screen {
            display: flex;
            /* 核心1：让它成为flex布局的容器 */
            flex-direction: column;
            /* 核心2：让它的子元素（顶栏、消息区、底栏）垂直排列 */
            height: 100%;
            /* 确保它撑满整个屏幕 */
            position: relative;
            /* 保留position，为了背景伪元素 */
            z-index: 1;
        }

        #chat-interface-screen::before {
            /* 【全新】这才是我们真正的、唯一的背景层 */
            content: '';
            position: fixed;
            /* 使用fixed来模拟background-attachment，规避移动端bug */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            z-index: -1;
            /* 把它放在父容器所有内容的后面 */
        }

        /* 【核心动画】新增一个淡入和放大的动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;

            }

            to {
                opacity: 1;

            }
        }

        .screen {
            display: none;
            /* 默认不占据空间 */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            flex-direction: column;
            box-sizing: border-box;
            background-color: #fafafa;
            opacity: 0;
            /* 默认透明 */
            visibility: hidden;
            /* 【关键】默认不可见，不阻挡交互 */

            /* --- 【V1.95 性能优化】--- */
            /* 提示浏览器，这个元素的 opacity 和 transform 属性将会变化，请进行硬件加速优化 */
            will-change: opacity, transform;
        }

        .screen.active {
            display: flex;
            /* 变为可见时，使用flex布局 */
            opacity: 1;
            /* 完全不透明 */
            visibility: visible;
            /* 【关键】变为可见，可以交互 */
            animation: fadeIn 0.4s ease-out;
            /* 【关键】只在变为 active 时播放动画 */
        }

        /* --- 桌面 (#home-screen) --- */
        #home-screen {
            position: relative;
            /* 保持相对定位基准 */
            width: 100%;
            height: 100%;
            /* 【核心修复】确保桌面与屏幕等高 */
            box-sizing: border-box;
            /* 确保padding不会撑大盒子 */
            overflow-y: auto;
            /* 核心：当内容超出时，允许垂直滚动 */
            background-color: #a8d8f0;
            /* 天蓝色背景 */
            padding: 90px 0 110px 0;
            /* 顶部为状态栏和灵动岛留空，底部为Dock栏留空 */
        }

        /* --- 通用头部样式 --- */
        .header {
            padding: 10px 5px;
            /* 【修改】调整内边距 */
            padding-top: 50px;
            /* 【修改】为状态栏留出更多空间，实现加高效果 */
            height: 56px;
            /* 【新增】设定一个固定的总高度 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            box-sizing: content-box;
            /* 【新增】确保 padding 不计入 height */
        }

        .header h1 {
            flex-grow: 1;
            /* 【新增】让标题占据中间所有可用空间 */
            text-align: center;
            /* 【新增】文字居中 */
            margin: 0;
            font-size: 18px;
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header .header-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .header .header-icon svg {
            fill: #333;
        }

        .add-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 设置页面 (#api-settings-screen) --- */
        .form-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-form {
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .settings-form label {
            font-size: 16px;
            font-weight: 500;
            color: #555;
        }

        .settings-form input,
        .settings-form select {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .form-button {
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .form-button:disabled {
            background-color: #a0a0a0;
        }

        /* --- 聊天列表 (#chat-list-screen) --- */
        #chat-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #fff;
        }

        #contact-list {
            height: 100%;
            overflow-y: auto;
            /* 核心：让联系人列表本身可以滚动 */
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: #f5f5f5;
        }

        .contact-item .avatar {
            width: 50px;
            height: 50px;
            background-color: #ddd;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .contact-item .name {
            font-size: 18px;
        }

        /* --- 聊天界面 (#chat-interface-screen) --- */
        #chat-interface-screen .header {
            position: relative;
            flex-shrink: 0;
            z-index: 10;

            /* 核心修改1：默认背景透明，但边框是存在的、透明的 */
            background: transparent !important;
            border-bottom: 1px solid transparent !important;
            /* 默认透明 */

            /* 保留原有布局 */
            height: 56px;
            padding: 10px 5px;
            padding-top: 50px;
            box-sizing: content-box;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* 【全新】当没有壁纸时，才显示顶栏的分割线 */
        #chat-interface-screen.no-wallpaper .header {
            border-bottom-color: #e0e0e0 !important;
            /* 你的联系人界面的分割线颜色 */
        }

        #message-container {
            flex-grow: 1;
            /* 核心1：让它自动填满顶栏和底栏之间的所有剩余空间 */
            overflow-y: auto;
            /* 核心2：只允许这个区域滚动 */

            /* 
    ===========================================================
     【核心】消息列表与边框距离调整区
    ===========================================================
    说明：
    - 距离顶栏(第一个值) 距离底部输入框(第三个值)
    - 右边消息距离边(第二个值) 左边消息距离边(第四个值)
    */
            padding: 20px 19px 10px 19px;

            background-color: transparent;
        }

        #input-area {
            position: relative;
            flex-shrink: 0;
            z-index: 10;
            background: transparent !important;
            border-top: 1.1px solid transparent !important;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            /* 【核心修改1】改为纵向排列，让功能面板可以显示在输入框行的下方 */
            flex-direction: column;
            gap: 10px;
            /* 【核心修改2】允许内容溢出，否则面板会被截断 */
            overflow: visible;
        }

        /* 【新增】为原有的输入行创建一个包裹容器，保持其横向布局 */
        #input-controls-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            width: 100%;

            /*
            ===========================================================
             【核心 V1.60】输入区整体位置微调 (全屏模式)
            ===========================================================
            说明：
            - 这里控制的是 “全屏模式” 下，整个输入区域（输入框+所有按钮）的水平位置。
            - 正数 (例如 left: 10px;) 会将整个区域向右移动。
            - 负数 (例如 left: -10px;) 会将整个区域向左移动。
            - 建议先从 0px 开始，然后微调。
            */
            position: relative;
            left: 3.5px;
            top: -5.8px;
        }

        /* 【全新】当没有壁纸时，才显示底栏的分割线 */
        #chat-interface-screen.no-wallpaper #input-area {
            border-top-color: #e0e0e0 !important;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px 16px;
            /* 【修改】减小内边距，让输入框变矮 */
            border-radius: 20px;
            /* 【修改】圆角也微调 */
            background-color: rgba(238, 238, 238, 0.927);
            /* 【修改】黑色半透明背景 */
            color: white;
            /* 【新增】字体颜色改为白色以适应深色背景 */
            font-size: 16px;
            max-height: 100px;
            /* 【修改】限制最大高度 */
            max-height: 120px;
            max-width: 800px;
            min-width: 200px;
            resize: none;
            box-shadow: inset 0px 1px 3px rgba(76, 76, 76, 0.5),
                inset 0px 0px 0px rgba(0, 0, 0, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.08);
            border: none;
            /* 【核心修改】移除了边框 */
            /* --- 毛玻璃效果核心代码 --- */
            backdrop-filter: blur(4px) saturate(180%);
            -webkit-backdrop-filter: blur(4px) saturate(180%);
            /* 
            ===========================================================
             【新增】输入框独立左右移动调整区
            ===========================================================
            说明：
            - 通过修改下方的 left 属性值，可以单独移动输入框。
            - 正数 (例如 left: 20px;) 会将输入框向右移动。
            - 负数 (例如 left: -20px;) 会将输入框向左移动。
            */
            position: relative;
            left: -40px;
            /* 修改这个值来移动输入框 */

            /*
            ===========================================================
             【新增】输入框宽度与大小调整区
            ===========================================================
            说明：
            - 因为输入框设置了 flex-grow: 1; 它会自动填充父容器的剩余空间，
              所以 max-width 和 min-width 主要在浏览器窗口大小变化时起到限制作用。
            */
            /*
            max-width: 800px;  /* 输入框的最大宽度 */
            /*
            min-width: 200px;  /* 输入框的最小宽度 */
            /*
            font-size: 18px;   /* 输入框内的字体大小 */

        }

        /* 【新增】修改输入框内提示文字的样式 */
        #message-input::placeholder {
            /*
             * font-size: 14px; /* 修改提示文字的大小 */
            /* color: #cccccc;  /* 修改提示文字的颜色 */

        }

        #input-area .action-button {
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            background-color: transparent;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 6px;
            position: relative;
            /* 【【【核心修复】】】 */
        }

        .user-wrapper {
            justify-content: flex-end;
        }

        .ai-wrapper {
            justify-content: flex-start;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            /* 默认值, 会被JS覆盖 */
            background-color: #eee;
            flex-shrink: 0;
            object-fit: cover;
            /* 新增过渡效果，让头像显隐更平滑 */
            transition: width 0.2s ease, margin 0.2s ease, padding 0.2s ease;
        }

        /* 【全新】默认隐藏连续消息的头像  */
        .user-wrapper+.user-wrapper .chat-avatar,
        .assistant-wrapper+.assistant-wrapper .chat-avatar {
            visibility: hidden;
        }

        /* 【全新】当总开关关闭时，彻底隐藏所有头像并移除空间 */
        .no-avatars .chat-avatar {
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            visibility: hidden;
            /* 确保彻底隐藏 */
        }

        .message-bubble {
            max-width: 70%;
            padding: 8px 14px;
            /* 您期望的较小内间距 */
            border-radius: 18px;
            /* 更圆的圆角 */
            width: fit-content;
            word-wrap: break-word;
            line-height: 1.5;
            margin-bottom: 0;
            /* 【全新默认效果】根据您最新的代码适配 */
            background-color: rgba(32, 32, 32, 0.3);
            color: white;
            /* 默认字体白色 */
            backdrop-filter: blur(4px) saturate(180%);
            -webkit-backdrop-filter: blur(4px) saturate(180%);
            box-shadow: inset 0px 1px 0.5px rgba(76, 76, 76, 0.5), 0 0.4px 0.7px rgba(0, 0, 0, 0.235);
        }

        .contact-item .details {
            flex-grow: 1;
            overflow: hidden;
            /* 防止文字溢出 */
        }

        .contact-item .name {
            font-size: 18px;
        }

        .contact-item .last-message {
            font-size: 14px;
            color: #8e8e93;
            white-space: nowrap;
            /* 不换行 */
            overflow: hidden;
            /* 隐藏溢出部分 */
            text-overflow: ellipsis;
            /* 溢出部分显示省略号 */
            margin-top: 4px;
        }

        /* --- 自定义模态框样式 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            padding: 25px 14px;
            border-radius: 11px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform: scale(0.85);
            transition: transform 0.2s ease-in-out;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin: 0;
            text-align: center;
            font-size: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
        }

        .modal-actions button {
            flex: 0 1 80px;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 13px !important;
            cursor: pointer;
        }

        .modal-card-footer button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 14px !important;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-confirm-btn {
            background-color: #333;
            color: white;
            font-weight: 550 !important;
            /* 为确认按钮文字加粗 */
        }

        .modal-cancel-btn {
            background-color: #e5e5e5;
            color: #333;
            font-weight: 550 !important;
            /* 为取消按钮文字加粗 */
        }

        /* --- 【全新】主设置页面样式 --- */
        #main-settings-container .settings-item-title {
            color: #353333;
        }

        .main-settings-item {
            padding-left: 20px;
            /* 统一左内边距 */
            gap: 18px;
            /* 图标和文字的间距 */
        }

        .main-settings-item-icon {
            width: 26px;
            /* 固定图标容器宽度，让所有图标左侧对齐 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 根据草图调整板块间距 */
        #main-settings-container .settings-plate:nth-of-type(2) {
            margin-top: 25px;
        }

        #main-settings-container .settings-plate:nth-of-type(3) {
            margin-top: 40px;
        }


        /* 【核心修改】用逗号隔开，让主设置页、聊天设置页、外观设置页共用一套样式 */
        #main-settings-container .settings-plate,
        #chat-settings-container .settings-plate,
        #appearance-settings-container .settings-plate {
            background-color: transparent;
            /* 移除白色背景 */
            box-shadow: none;
            /* 移除阴影 */
            margin-bottom: 0;
            /* 移除板块自己的下边距，间距由之后的规则控制 */
            overflow: visible;
            /* 修复可能存在的显示问题 */
        }

        #main-settings-container .settings-plate .settings-item,
        #chat-settings-container .settings-plate .settings-item {
            margin-bottom: 12px;
            /* 为每个项目添加独立的下方间距 */
        }

        /* 移除项目之间的分割线 */
        #main-settings-container .settings-plate .settings-item:not(:last-child),
        #chat-settings-container .settings-plate .settings-item:not(:last-child) {
            border-bottom: none;
        }

        #main-settings-container .settings-item-title {
            font-size: 14.5px;
            /* 您可以在这里修改数值来调整大小 */
            font-weight: 550;
        }

        .api-text {
            font-weight: 500;
            /* 这个数值控制粗细，可以改为 700 更粗 */
        }

        #chat-settings-container .settings-item-title {
            font-size: 14.5px;
            /* 修改这个数值来调整大小 */
            font-weight: 500;
            /* 修改这个数值来调整粗细 (普通是400, 粗体是700) */
        }

        /* 【新增】为“我的名字”显示区添加占位符样式 */
        #user-settings-name-display:empty::before {
            content: "设置我的名字";
            color: #b0b0b0;
            /* 这是一个比较柔和的浅灰色 */
        }

        #chat-settings-container .settings-name-input::placeholder {
            font-size: 15.5px;
            /* 设置与标题统一的字号 */
            font-weight: 500;
            /* 设置与标题统一的粗细 */
        }

        #chat-settings-container #clear-history-btn span {
            font-size: 14px;
            font-weight: 550;
            color: #f1251ad6;
            /* 这是iOS系统风格的红色，您也可以换成 "red" 或其他您喜欢的色号 */
        }


        /* 调整回板块间的大间距 */
        #main-settings-container .settings-plate:nth-of-type(2) .settings-item:first-child {
            margin-top: 25px;
        }

        #main-settings-container .settings-plate:nth-of-type(3) .settings-item:first-child {
            margin-top: 40px;
        }

        /* --- 聊天设置页面样式 --- */
        #chat-settings-container {
            padding: 20px;
        }

        .settings-plate {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .settings-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 15px;
            color: #252525;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .settings-item:hover {
            background-color: #f5f5f5;
        }

        .settings-plate .settings-item:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-avatar {
            width: 45px;
            /* 这里可以修改头像大小 */
            height: 45px;
            /* 这里可以修改头像大小 */
            border-radius: 50%;
            margin-right: 15px;
            background-color: #eee;
            object-fit: cover;
        }


        /* --- 【新增】统一所有头像的描边与阴影 --- */
        .contact-item .avatar,
        .settings-avatar,
        .chat-avatar {
            border: 1.5px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .settings-name-input {
            flex-grow: 1;
            border: none;
            background: none;
            font-size: 16px;
            color: #252525;
            padding: 5px 0;
            max-width: calc(100% - 50px);
        }

        .settings-name-input:focus {
            outline: none;
            background-color: #f0f2f5;
            border-radius: 4px;
        }

        .settings-arrow {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            /* 【核心新增】下面是新增的代码 */
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-item-title {
            flex-grow: 1;
        }

        .settings-value-input {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 6px 10px;
            width: 80px;
            text-align: right;
            font-size: 14px;
        }

        .settings-item-center {
            justify-content: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 26px;
        }

        /* 缩小了整体宽高 */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            /* 缩小了圆圈的高度 */
            width: 22px;
            /* 缩小了圆圈的宽度 */
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            /* 【核心新增】给圆圈加描边 */
            border: 1.4px solid rgba(171, 171, 171, 0.562);
            box-sizing: border-box;
            /* 确保描边不会撑大圆圈 */
        }

        input:checked+.slider {
            background-color: #353333c3;
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }

        /* 调整了圆圈移动距离 */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* --- 卡片式弹窗样式 (气泡、背景) --- */
        .modal-card {
            background: #f7f7f7;
            width: 95%;
            max-width: 450px;
            height: 60vh;
            max-height: 450px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }

        .modal-overlay.visible .modal-card {
            transform: scale(1);
        }

        .modal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .modal-card-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .modal-card-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .modal-card-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modal-card-footer {
            display: flex;
            gap: 12px;
            /* 按钮间距 */
            padding: 15px 20px;
            border-top: 1.5px solid #e0e0e0;
            flex-shrink: 0;
            justify-content: center;
            /* 让按钮居中 */
        }

        /* 【全新】统一弹窗底部按钮样式 */
        .modal-card-footer .modal-cancel-btn,
        .modal-card-footer .modal-confirm-btn {
            flex: 0 1 87px;
            /* 不拉伸，基础宽度100px */
            padding: 8px 28.7px;
            /* 减小内边距 */
            border-radius: 8px;
            font-size: 13.4px !important;
            /* 减小字体 */
            font-weight: 550 !important;
            border: none;
        }

        /* 保存按钮 */
        .modal-card-footer .modal-confirm-btn {
            background-color: #333;
            color: white;
        }

        /* 取消按钮 */
        .modal-card-footer .modal-cancel-btn {
            background-color: #e5e5e5;
            color: #333;
        }

        .modal-plate {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 15px;
        }

        .modal-plate-title {
            font-size: 16px;
            font-weight: 500;
            margin: 0 0 15px 0;
            color: #252525;
        }

        .color-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .color-picker-wrapper {
            width: 70px;
            /* 外框宽度 */
            height: 32px;
            /* 外框高度 */
            border-radius: 8px;
            /* 外框圆角 */
            border: 1px solid #ddd;
            background-color: #fff;
            padding: 4px;
            /* 外框和内块的间距 */
            box-sizing: border-box;
            position: relative;
            /* 用于绝对定位内部的input */
            cursor: pointer;
        }

        /* 【全新】使用伪元素绘制内部的颜色块 */
        .color-picker-wrapper::before {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 5px;
            /* 内块圆角 */
            /* 颜色由JS动态设置 */
            background-color: var(--color-preview, #fff);
        }

        /* 【全新】将真正的input设为透明并覆盖在最上层 */
        .color-picker-wrapper input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            /* 完全透明，但可点击 */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            /* 核心修复：移除移动端点击高亮效果 */
        }

        .modal-textarea {
            width: 100%;
            box-sizing: border-box;
            min-height: 120px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
        }

        #bubble-preview-area {
            padding: 15px;
            background-color: #f0f2f5;
            /* 设置浅灰色背景 */
            border-radius: 8px;
        }

        #bubble-preview-area .ai-bubble {
            margin-right: auto;
            margin-left: 0;
        }

        #bubble-preview-area .user-bubble {
            margin-left: auto;
            margin-right: 0;
        }

        #background-preview {
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 宽高比 */
            height: 0;
            border-radius: 10px;
            background-color: #fff;
            border: 2px dashed #ccc;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        #remove-background-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        /* --- 独立的图标微调样式区 --- */
        /* 所有返回按钮的SVG图标 */
        #back-arrow-icon {
            margin-left: 5px;
            /* 示例: margin-top: 2px; */
        }

        /* 聊天列表页的“+”按钮SVG图标 */
        #add-contact-icon {
            /* 示例: margin-right: -5px; */
        }

        /* 聊天界面的“设置”按钮SVG图标 */
        #chat-settings-icon {
            margin-left: -20px;
        }

        /* 输入框的“发送”按钮SVG图标 */
        #send-btn-icon {
            /* 示例: margin-left: 2px; */
        }

        /* 输入框的“生成”按钮SVG图标 */
        #generate-btn-icon {
            /* 示例: margin-right: 2px; */
        }

        /* 聊天界面设置图标的独立大小和颜色控制 */
        #chat-settings-btn svg {
            /* width: 28px; height: 28px; fill: #000000; */
        }

        /* 设置页面中的所有右箭头 > */
        #settings-arrow-icon-1,
        #settings-arrow-icon-2,
        #settings-arrow-icon-3,
        #settings-arrow-icon-4,
        #settings-arrow-icon-5 {
            /* margin-top: 2px; margin-right: -5px; fill: #cccccc; */
        }

        /* 【新增】弹窗内标题与重置按钮的样式 */
        .modal-plate-title-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 15px 0;
        }

        .modal-plate-title-wrapper .modal-plate-title {
            margin: 0;
            /* 移除原有的 margin-bottom */
        }



        .modal-reset-btn {
            background: #e5e5e5;
            border: none;
            color: #333;
            padding: 3px 10px;
            /* 减小内边距 */
            font-size: 11.5px !important;
            /* 减小字体大小 */
            border-radius: 6px;
            cursor: pointer;
            font-weight: 550 !important;
        }

        .modal-reset-btn:hover {
            background: #dcdcdc;
        }

        /* 【核心修改】重新定位输入区的所有按钮 */

        /* --- 独立的图标微调样式区 --- */
        /* ... 其他样式 ... */
        /* 【新增】输入框“更多”按钮SVG图标 */
        #more-btn {

            position: relative;
            top: 0px;
            left: -15px;

        }

        /* 【新增】输入框“语音”按钮SVG图标 */
        #voice-btn {
            position: relative;
            top: 0px;
            left: -35px;
        }


        #send-btn {
            position: relative;
            top: 0px;
            left: -48px;
        }

        #generate-btn {
            position: relative;
            top: 0px;
            left: -65px;
        }

        /* ... 其他样式 ... */
        /* 弹窗中的关闭按钮 X */
        #modal-close-icon-1,
        #modal-close-icon-2 {
            /* margin-top: 1px; fill: #000000; */
        }


        /* 
        【新增】聊天界面设置图标的独立大小和颜色控制
        说明：
        - 解除下方注释并修改数值，可以单独控制设置图标的大小和颜色。
        */
        #chat-settings-btn svg {
            /*
            width: 28px;
            height: 28px;
            fill: #000000;
            */
        }


        /* 【全新】表情面板、网格和单个表情的样式 */
        #sticker-panel {
            /* 基础样式和功能面板一致 */
            margin: 0 -15px -15px -15px;
            width: calc(100% + 30px);
            background-color: #f9f9f9;
            border-top: 1.2px solid #e0e0e0;

            /* 动画效果和功能面板一致 */
            max-height: 0;
            overflow: hidden;
            /* 默认隐藏滚动条 */
            transition: max-height 0.3s ease-in-out;
            position: relative;
        }

        #sticker-panel.visible {
            max-height: 185px;
            /* 【修改】精确计算出的两行表情+边距的高度 */
            overflow-y: auto;
            /* 展开后如果内容溢出则显示滚动条 */
        }

        #sticker-grid {
            display: grid;
            /* 核心：根据您的截图调整，列数更多，间距更小 */
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 15px;
            /* 表情之间的间距 */
            padding: 20px;
            box-sizing: border-box;
        }

        .sticker-item,
        .add-sticker-btn-wrapper {
            position: relative;
            aspect-ratio: 1 / 1;
            /* 保持1:1的正方形比例 */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fefefe;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;

            /* 核心：禁止长按时系统的默认行为 */
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Non-prefixed version */
        }

        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* 保证图片完整显示且不形变 */
            border-radius: 12px;
            /* 让图片也带圆角，避免遮盖容器圆角 */
        }

        .sticker-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            color: #888;
            opacity: 0;
            /* 默认隐藏 */
            pointer-events: none;
            /* 默认不可点击 */
            transition: opacity 0.2s ease;
            z-index: 5;

            /* 【可调整】白色圆形背景 */
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* 
         * 【微调注释】
         * 如果不想要白色圆形背景，可以注释掉上面 .sticker-delete-btn 的 
         * background-color, border-radius, box-shadow 这三行。
         *
         * 如果想微调叉号(×)的位置，可以解除下面 transform 的注释并修改数值
         */
        .sticker-delete-btn svg {
            /* transform: translate(1px, -1px); */
        }

        .sticker-item.show-delete .sticker-delete-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* 【全新】聊天记录中表情消息的样式 */
        .message-wrapper .sticker-in-chat {
            max-width: 100px;
            /* 将最大宽度从 120px 减小到 100px */
            max-height: 100px;
            /* 将最大高度从 120px 减小到 100px */
            background: none;
            padding: 0;
            border-radius: 8px;
        }

        /* 【全新】添加表情弹窗内部组件的样式 */
        .modal-input-field {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            background-color: #fff;
        }

        .modal-upload-btn {
            width: 100%;
            padding: 12px;
            background-color: #333;
            /* 和保存按钮一样的颜色 */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            /* 图标和文字的间距 */
        }

        /* 
        ===================================================================
         【新增】桌面文字原地编辑输入框样式
        ===================================================================
        */
        .temp-edit-input {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 2px 5px;
            font-size: inherit;
            /* 继承父元素的字体大小 */
            font-weight: inherit;
            /* 继承父元素的字体粗细 */
            color: #333;
            text-align: center;
            width: 80%;
            /* 占据父容器80%宽度 */
            box-sizing: border-box;
            outline: none;
            /* 移除默认的蓝色边框 */
        }

        /* 
        ===================================================================
         【全新】V1.63 字体设置页面专属样式
        ===================================================================
        */
        #font-settings-screen .form-container {
            /* 允许内容超出时垂直滚动 */
            overflow-y: auto;
        }

        .font-settings-plate {
            padding: 15px 20px;
            /* 【修改】将上下的内边距从20px减小到15px */
            display: flex;
            flex-direction: column;
            gap: 25px;
            /* 各个设置板块之间的间距 */
        }

        .font-setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 标题和输入框的间距 */
        }

        .font-setting-group .group-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .font-setting-group .group-subtitle {
            font-size: 13px;
            color: #888;
            margin: -4px 0 4px 0;
        }

        #font-settings-preview-box {
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 12px;
            border: 1.5px solid #e0e0e0;
            background-color: #f5f5f5;
            color: #555;
            font-size: 15px;
            transition: all 0.2s ease-in-out;
            /* 让所有变化都有平滑过渡 */
        }

        .font-input-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .font-input-row .font-setting-group {
            flex: 1;
            /* 让字号和粗细调节平分宽度 */
        }

        .font-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-input-wrapper input {
            /* flex-grow: 1;  【删除】移除flex-grow，不再让它自动伸展 */
            width: 100px;
            /* 【修改】设定一个固定的宽度，您可以根据喜好调整这个数值 */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
            text-align: center;
        }

        .font-input-wrapper .unit-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .font-link-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .font-link-input-wrapper input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }

        .font-link-input-wrapper button {
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* 【新增】开启相对定位，为移动做准备 */
            left: -8px;
            /* 【新增】修改这个值来左右移动，正数向右，负数向左 */
        }

        #font-entry-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            /* 每个字体链接条之间的间距 */
            margin-top: 15px;
            min-height: 0px;
            /* 【修改】默认最小高度为0，不占空间 */
            transition: min-height 0.3s ease;
            /* 【新增】为高度变化添加动画 */
        }

        .font-entry-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border: 1.5px solid #dcdcdc;
            border-radius: 12px;
            background-color: #fff;
        }

        .font-entry-name {
            font-weight: 500;
            color: #333;
            padding: 5px 8px;
            border-radius: 6px;
            cursor: pointer;
            min-width: 40px;
            /* 保证即使没字也能点 */
            text-align: center;
        }

        .font-entry-name:empty::before {
            content: "命名";
            color: #aaa;
            font-style: italic;
        }

        .font-entry-url {
            flex-grow: 1;
            padding: 5px 8px;
            border-radius: 6px;
            background-color: #f5f5f5;
            font-size: 12px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .font-entry-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-entry-actions button {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .font-entry-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .font-entry-checkbox.checked {
            background-color: #353333;
            border-color: #353333;
        }

        .font-entry-checkbox.checked svg path {
            fill: #fff;
        }

        .font-settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: -12px;
            /* 【修改】减小与上方元素的间距，实现上移效果 */
        }

        .font-settings-buttons .form-button {
            margin-top: 0;
        }

        #restore-font-defaults-btn {
            background-color: #e5e5e5;
            color: #333;
        }

        #save-font-settings-btn {
            background-color: #32323c;
            /* 【新增】您可以将这里的 #333 修改为您想要的任何颜色代码 */
            color: white;
            /* 【新增】确保文字颜色与背景形成对比 */
        }


        /* 
        ===================================================================
         【全新 V1.73】情侣空间新布局专属样式
        ===================================================================
        */

        /* --- 整体内容区改造 --- */
        #couple-space-screen .couple-space-content {
            justify-content: flex-start;
            /* 改为从顶部开始排列 */
            padding-top: 20px;
            /* 增加一些顶部内边距 */
            position: relative;
            /* 为底部导航栏定位提供基准 */
            overflow: hidden;
            /* 隐藏主容器的滚动条 */
        }

        /* --- 拍立得相框容器 --- */
        #polaroid-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 15px;
            /* 【修改】增加了拍立得之间的间距 */
            margin-bottom: 20px;
            /* 与下方头像的间距 */
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .polaroid-item {
            position: relative;
            width: 75px;
            /* 拍立得宽度 */
            height: 90px;
            /* 拍立得高度 */
            background-color: #ffffff;
            border-radius: 4px;
            padding: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            display: flex;
            /* 【新增】使用flex布局来控制内部照片区 */
            flex-direction: column;
            /* 【新增】让照片区在上方 */
            cursor: pointer;
            /* 【新增】添加小手指针，提示可以点击 */
        }

        /* 【修改】重构为照片区域，不再占满全部空间 */
        .polaroid-photo {
            width: 100%;
            height: 63px;
            /* 【核心修改】精确控制照片区域高度 */
            flex-shrink: 0;
            /* 【新增】防止被压缩 */
            background-color: #f1f1f1;
            border-radius: 2px;
            /* 【新增】让背景图能正常显示 */
            background-size: cover;
            background-position: center;
        }

        .polaroid-tape {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 16px;
            background-color: #f9e2a3;
            /* 黄色胶带 */
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.5);
            border-right: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* 为每个拍立得和胶带设置不同的旋转角度 */
        #polaroid-item-1 {
            transform: rotate(-8deg);
        }

        #polaroid-item-2 {
            transform: rotate(5deg);
            top: -10px;
        }

        #polaroid-item-3 {
            transform: rotate(-4deg);
            top: -5px;
        }

        #polaroid-item-4 {
            transform: rotate(10deg);
        }

        #polaroid-item-1 .polaroid-tape {
            transform: translateX(-50%) rotate(3deg);
        }

        #polaroid-item-2 .polaroid-tape {
            transform: translateX(-50%) rotate(-5deg);
        }

        #polaroid-item-3 .polaroid-tape {
            transform: translateX(-50%) rotate(2deg);
        }

        #polaroid-item-4 .polaroid-tape {
            transform: translateX(-50%) rotate(-8deg);
        }

        /* --- 头像和提示语下移调整 --- */
        #couple-space-screen .couple-avatars-container {
            margin-top: 25px;
            /* 【修改】增加与拍立得的间距 */
        }

        #couple-space-screen .couple-space-prompt {
            /* 【核心修改】减小与头像的间距，实现上移 */
            margin-top: 13px !important;
        }

        #confirm-modal-text {
            font-size: 13.8px;
            font-weight: 550;
            color: #232323;
        }

        /* --- 全新底部导航栏 --- */
        .couple-bottom-nav {
            position: absolute;
            /* 定位在父容器底部 */
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 300px;
            height: 59px;
            /* 【修改】将高度从 65px 进一步缩小到 55px (您可以按需调整) */
            background-color: #ffe5a5;
            border-radius: 28px;
            /* 【修改】圆角也相应缩小，让形状更协调 */
            box-shadow: 0 2px 8px rgba(138, 103, 0, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .nav-icon-wrapper {
            position: relative;
            /* 为滑块定位提供基准 */
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .nav-slider {
            position: absolute;
            top: 50%;
            left: 12.5%;
            /* 初始位置在第一个图标的中心 */
            transform: translate(-50%, -50%);
            width: 55px;
            /* 【修改】将滑块宽度从 52px 缩小到 46px */
            height: 46px;
            /* 【修改】将滑块高度从 52px 缩小到 46px */
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            /* 【修改】圆角也相应缩小 */
            z-index: 1;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* 核心动画 */
        }


        /* --- 子页面切换容器 --- */
        .couple-main-content {
            width: 100%;
            flex-grow: 1;
            position: relative;
            /* 让子页面可以绝对定位 */
            /* 【【【关键修改】】】移除滚动能力，交还给子页面 */
            overflow: hidden;
        }

        /* 【【【关键新增】】】只为第一个页面开启滚动 */
        #couple-page-1 {
            height: 100%;
            /* 让其高度填满父容器 */
            overflow-y: auto;
            /* 允许自身垂直滚动 */
            position: absolute;
            /* 保持绝对定位以进行切换 */
            /* 确保其他属性继承或保持默认 */
            display: flex;
            /* 恢复 flex 布局 */
        }

        .couple-content-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 【修改】从居中对齐改为从顶部开始排列 */
            justify-content: flex-start;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
            /* 【新增】为整个内容区添加顶部内边距，实现上移 */
            padding-top: 30px;
        }

        .couple-content-page.active {
            opacity: 1;
            visibility: visible;
        }

        /* 功能未开放提示语样式 */
        .couple-feature-locked-prompt {
            color: #ffd063;
            font-size: 16px;
            font-weight: 550;
            margin-bottom: 100px;
            /* 【新增】增加下边距，使其上移实现垂直居中 */
        }

        /* --- 顶栏“更多”按钮 --- */
        .couple-header .header-icon-right {
            /* 样式已经继承自 .header-icon, 无需额外代码 */
        }

        /* 
        ===================================================================
         【全新 V1.73】更换主题页面专属样式
        ===================================================================
        */
        #couple-theme-screen {
            background-color: #fff9eb;
            /* 同样使用专属背景色 */
        }

        #couple-theme-screen .form-container {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* 项目之间的间距 */
        }

        .theme-plate {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 每行2个 */
            gap: 15px;
        }

        .theme-choice-item {
            /* 【修改】移除背景、边框和内边距 */
            display: flex;
            flex-direction: column;
            /* 【修改】改为垂直排列 */
            align-items: center;
            /* 【修改】居中对齐 */
            gap: 10px;
            /* 【修改】调整方块和文字的间距 */
            cursor: pointer;
            transition: transform 0.2s;
            /* 【修改】交互效果改为缩放 */
        }

        .theme-choice-item:hover {
            transform: scale(1.05);
            /* 【修改】鼠标悬浮时轻微放大 */
        }

        .theme-color-preview {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            /* 用于居中相机图标 */
            justify-content: center;
            align-items: center;
        }

        .theme-choice-item .theme-title {
            font-size: 16px;
            font-weight: 500;
            color: #1d1d1c;
        }

        .theme-action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
            align-items: center;
            /* 【新增】垂直对齐 */
        }

        .theme-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 16px;
            font-weight: 500;
        }

        .theme-action-btn:hover {
            transform: scale(1.05);
        }

        #theme-reset-btn {
            background-color: #e9e9e9;
            color: #5b5b5b;
            border: none;
            /* 【核心修改】调整为更小尺寸 */
            width: 50%;
            /* 不占满格子 */
            justify-self: center;
            /* 在格子内水平居中 */
            padding: 10px 0;
            /* 使用内边距控制高度 */
            height: auto;
            /* 高度自适应 */
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            /* 确保字体大小一致 */
            font-weight: 500;
        }

        /* 【全新 V1.81】主题页右上角编辑按钮 */
        .header-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            /* 【【【修复】】】 将字体大小从 11px 恢复到 15px */
            font-weight: 500;
            /* 【【【修复】】】 将字重从 550（稍粗）调整为 500（正常） */
            color: #2c2c2c;
            padding: 0 10px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* --- 【新增】相对定位，让按钮可以移动 --- */
            position: relative;
            /* --- 【新增】向左移动10px，您可以修改这个数值 --- */
            right: 10px;
        }

        /* 【全新 V1.81】删除图标通用样式 */
        .polaroid-delete-btn,
        .avatar-delete-btn {
            position: absolute;
            width: 19px;
            height: 19px;
            border-radius: 50%;
            background-color: rgba(53, 53, 53, 0.148);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            /* 默认隐藏 */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        /* 【全新 V1.81】编辑模式下，为已自定义的元素显示删除按钮 */
        .edit-mode-active .is-customized .polaroid-delete-btn,
        .edit-mode-active .is-customized .avatar-delete-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* 【全新 V1.81】为每个拍立得的删除按钮设置独立的位置和旋转 */
        #polaroid-item-1 .polaroid-delete-btn {
            top: -8px;
            right: -6px;
            transform: rotate(-10deg);
        }

        #polaroid-item-2 .polaroid-delete-btn {
            top: -12px;
            right: -6px;
            transform: rotate(8deg);
        }

        #polaroid-item-3 .polaroid-delete-btn {
            top: -10px;
            right: -6px;
            transform: rotate(-5deg);
        }

        #polaroid-item-4 .polaroid-delete-btn {
            top: -8px;
            right: -6px;
            transform: rotate(12deg);
        }

        /* 【全新 V1.81】为头像的删除按钮设置位置 */
        .my-avatar-wrapper .avatar-delete-btn {
            top: 6px;
            right: 8px;
            transform: rotate(10deg);
        }

        /* 
        ===========================================================
         【新增】情侣空间底部导航图标独立微调区
        ===========================================================
        说明：
        - 修改下方 left 的 px 值，可以单独移动每个图标。
        - 正数向右移动，负数向左移动。
        */
        #couple-nav-icon-1 {
            position: relative;
            left: -7px;
        }

        #couple-nav-icon-2 {
            position: relative;
            left: -2px;
        }

        #couple-nav-icon-3 {
            position: relative;
            left: 3px;
        }

        #couple-nav-icon-4 {
            position: relative;
            left: 8.4px;
        }

        /* 
===================================================================
 【全新 V2.30】聊天交互与时间戳专属样式
===================================================================
*/

        /* --- 消息时间戳 --- */
        .message-timestamp {

            color: #646464da;
            /* 修改：颜色加深 */
            margin: 0 1px;
            /* 修改：减小左右间距 */
            padding-bottom: 2px;
            /* 新增：微调垂直位置 */
            align-self: flex-end;
            white-space: nowrap;
            /* --- 新增：在这里通过 top 和 left 属性进行微调 --- */
            position: relative;
            top: -7px;
            /* 正数向下移动，负数向上移动 */
            left: 0px;
            /* 正数向右移动，负数向左移动 */
        }

        /* --- 日期分隔符 --- */
        .date-separator {
            text-align: center;
            margin: 31.5px 0;
            /* --- 【修改】在这里调整字体大小 --- */
            font-size: 12.3px;
            font-weight: 500;
            color: #474747;
        }


        /* --- 查看历史消息按钮 --- */
        .history-loader {
            text-align: center;
            padding: 10px;
            cursor: pointer;
            /* --- 【修改】在这里调整字体大小 --- */
            font-size: 12.7px;
            color: #494949;
            font-weight: 500;
        }

        .history-loader.boxed {
            background-color: #ececec;
            border-radius: 28px;
            width: fit-content;
            margin: 0 auto 10px auto;
            padding: 6px 12px;
        }

        #message-context-menu {
            position: fixed;
            z-index: 1001;
            background-color: rgba(249, 249, 249, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 14px;
            /* 【【【再缩小】】】 */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
            padding: 5px;
            /* 【【【再缩小】】】 */
            display: none;
            flex-direction: column;
            gap: 3px;
            /* 【【【再缩小】】】 */
            width: 210px;
            /* 【【【再缩小】】】 */
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
        }

        #message-context-menu.visible {
            display: flex;
            opacity: 1;
            transform: scale(1);
        }

        .context-menu-row {
            display: flex;
            justify-content: space-around;
        }

        .context-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5px;
            /* 【【【再缩小】】】 */
            cursor: pointer;
            padding: 2px;
            border-radius: 8px;
            transition: background-color 0.2s;
            width: 46px;
            /* 【【【再缩小】】】 */
            height: 42px;
            /* 【【【再缩小】】】 */
        }

        .context-menu-item:active {
            background-color: rgba(0, 0, 0, 0.08);
        }



        .context-menu-item span {
            font-size: 10px;
            /* 【【【修改】】】 */
            color: #424242;
            font-weight: 550 !important;
        }

        .context-menu-item.placeholder {
            pointer-events: none;
            opacity: 0;
            /* 修改：直接让它完全透明 */
        }

        /* --- 引用回复栏 --- */
        #reply-bar {
            display: none;
            /* 默认隐藏 */
            align-items: center;
            padding: 10px 15px 0px 15px;
            /* 修改：调整内边距，使其更紧凑 */
            margin-bottom: 9px;
            /* 新增：与输入框的间距 */
            /* 移除所有背景和边框相关的样式 */
        }

        #reply-bar-content {
            flex-grow: 1;
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #cancel-reply-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0 0 10px;
            /* 增加左边距，方便点击 */
        }

        /* --- 引用消息样式 --- */
        /* 方案一：自定义颜色气泡的引用样式 */
        .message-bubble .reply-quote-box {
            background-color: rgba(128, 128, 128, 0.15);
            padding: 6px 10px;
            border-radius: 8px;
            margin-top: 6px;
            font-size: 13px;
            /* 引用文字小一点 */
        }

        /* 方案二：默认/CSS气泡的引用样式 */
        .message-bubble.default-style-reply {
            display: flex;
            flex-direction: column;
        }

        .message-bubble.default-style-reply .reply-content-wrapper {
            padding: 6px 10px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
            font-size: 13px;
        }

        .reply-content-wrapper .reply-author {
            font-weight: 600;
        }


        /* 实时预览气泡微调 */
        #bubble-preview-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #bubble-preview-area .message-bubble {
            font-size: 12.5px;
            /* 预览字体小一点 */
            padding: 8px 14px;
            /* 【新增】减小内边距让气泡变小 */
        }

        #bubble-preview-area .chat-avatar {
            width: 35px;
            height: 35px;
        }

        #bubble-preview-area .user-wrapper,
        #bubble-preview-area .ai-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        #bubble-preview-area .user-wrapper {
            justify-content: flex-end;
        }

        #bubble-preview-area .chat-avatar {
            width: 35px;
            height: 35px;
        }

        #bubble-preview-area .user-wrapper,
        #bubble-preview-area .ai-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        #bubble-preview-area .user-wrapper {
            justify-content: flex-end;
        }

        /* --- 【V2.31 新增】原地编辑输入框样式 --- */
        .inplace-edit-textarea {
            width: 100%;
            height: auto;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
            overflow-y: hidden;
            /* 防止出现滚动条 */
        }



        /* --- 【V2.31 新增】弹窗在手机框内的定位 --- */
        body.phone-frame-visible .modal-overlay {
            position: absolute;
            /* 关键：从fixed改为absolute */
            z-index: 2000;
            /* 确保在最顶层 */
        }

        /* 
        ===================================================================
         【【【全新】】】插入新消息弹窗专属样式
        ===================================================================
        */
        #insert-message-card {
            height: 60vh;
            /* 【【【修改】】】 */
            max-height: 410px;
            /* 【【【修改】】】 */
        }

        #insert-modal-body {
            /* 核心：使用flex布局，让预览区自动填满剩余空间 */
            display: flex;
            flex-direction: column;
            padding: 11px 4px;
            /* 微调内边距 */
            gap: 10px;
            /* 减小间距 */
            transform: scale(0.97);
            /* 整体缩小5% */
            transform-origin: top center;
            /* 从顶部中心开始缩放 */
        }

        #insert-actions-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-shrink: 0;
            /* border-bottom: 1px solid #e0e0e0; 【【【删除】】】 */
            padding-bottom: 15px;
        }

        .insert-action-btn {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 7.5px 12.5px;
            /* 在这里修改按钮的整体大小 */
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #4b4b4b;
        }

        .insert-action-btn span {
            font-size: 12px !important;
            /* 在这里单独修改文字大小 */
            font-weight: 550;
            /* 在这里单独修改文字粗细 */
        }

        #insert-preview-container {
            flex-grow: 1;
            /* 核心：占据所有剩余垂直空间 */
            overflow-y: auto;
            /* 当内容超出时，出现滚动条 */
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 预览消息之间的间距 */
        }

        /* 弹窗内消息行的特殊样式 */
        .insert-preview-item {
            display: flex;
            align-items: flex-start;
            /* 头像和气泡顶部对齐 */
            gap: 10px;
            position: relative;
            /* 为删除按钮提供定位基准 */
        }

        .insert-preview-item.user-wrapper {
            justify-content: flex-end;
            /* 【【【核心修复】】】确保用户消息行整体靠右 */
        }

        .insert-preview-item .chat-avatar {
            /* 在弹窗内，所有头像都显示，不受连续消息规则影响 */
            visibility: visible !important;
        }

        .insert-preview-item .message-content-wrapper {
            display: flex;
            align-items: flex-end;
            /* 让气泡和时间戳底部对齐 */
            gap: 8px;
            max-width: calc(100% - 50px);
            /* 限制最大宽度 */
        }

        .insert-preview-item.user-wrapper .message-content-wrapper {
            flex-direction: row-reverse;
            /* 用户消息，时间戳在左 */
        }

        .insert-preview-item .message-bubble {
            /* 继承主界面的气泡样式，但确保它可交互 */
            cursor: text;
        }

        .insert-preview-item .message-timestamp {
            /* 继承主界面的时间戳样式，但确保它可交互 */
            cursor: text;
            padding-bottom: -12px !important;
            /* 微调垂直对齐 */

        }

        /* 弹窗内删除按钮 (叉号) 的样式 */
        .insert-delete-btn {
            position: absolute;
            bottom: -2px;
            width: 18.5px;
            height: 18.5px;
            background-color: #3f3f3f;
            /* 【【【新增】】】 */
            border-radius: 50%;
            /* 【【【新增】】】 */
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
        }

        /* 当进入可编辑状态时，显示删除按钮 */
        #insert-preview-container.editable .insert-delete-btn {
            display: flex;
        }

        /* AI方(左侧)的删除按钮定位 */
        .insert-preview-item.assistant-wrapper .insert-delete-btn {
            left: 28px;
            /* 靠近头像左下角 */
        }

        /* 用户方(右侧)的删除按钮定位 */
        .insert-preview-item.user-wrapper .insert-delete-btn {
            right: 28px;
            /* 靠近头像右下角 */
        }

        /* 
        ===================================================================
         【【【全新】】】多选模式专属样式
        ===================================================================
        */
        /* --- 顶栏变化 --- */
        #chat-interface-screen .header .multi-select-actions {
            display: none;
            /* 默认隐藏多选顶栏 */
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        #chat-interface-screen.multi-select-mode .header .header-icon,
        #chat-interface-screen.multi-select-mode .header h1,
        #chat-interface-screen.multi-select-mode .header #chat-settings-btn {
            display: none;
            /* 在多选模式下，隐藏原始顶栏元素 */
        }

        #chat-interface-screen.multi-select-mode .header .multi-select-actions {
            display: flex;
            /* 在多选模式下，显示多选顶栏 */
        }

        .multi-select-btn {
            background-color: transparent;
            /* 【【【修改】】】 */
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 550 !important;
            padding: 10px 15px;
        }

        #multi-select-cancel-btn {
            color: #252525;
        }

        #multi-select-delete-btn {
            color: #df3546;
        }

        #multi-select-counter {
            font-size: 16px;
            /* 【【【修改】】】 */
            font-weight: 540 !important;
            /* 【【【修改】】】 */
            color: #2d2d2d;
        }

        /* --- 勾选图标 --- */
        .selection-checkmark {
            position: absolute;
            bottom: -2px;
            width: 19px;
            height: 19px;
            background-color: #3f3f3f;
            border-radius: 50%;
            display: none;
            /* 【【【核心修复】】】默认必须是 none */
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* 【【【核心修复】】】只有在多选模式下，且消息被选中时，才显示整个勾选框 */
        #chat-interface-screen.multi-select-mode .message-wrapper.selected .selection-checkmark {
            display: flex;
        }

        /* 【核心修复】当消息被选中时，显示内部的SVG图标 */
        .message-wrapper.selected .selection-checkmark svg {
            display: block;
        }

        /* AI方(左侧)的勾选框定位 */
        .assistant-wrapper .selection-checkmark {
            left: 28px;
        }

        /* 用户方(右侧)的勾选框定位 */
        .user-wrapper .selection-checkmark {
            right: 28px;
        }

        /* 【【【全新】】】全局移除输入框和可编辑元素的聚焦边框 */
        input:focus,
        textarea:focus,
        [contenteditable]:focus {
            outline: none;
        }

        /* --- 【2.60版新增】修复菜单栏图标与文字对齐 --- */
        .context-menu-item svg {
            height: 18px;
            /* 为所有图标设置一个固定的高度 */
            margin-bottom: 2px;
            /* 在图标和文字之间增加一点固定间距 */
        }



        /* 
        ===================================================================
         【【【全新 V2.62】】】情侣空间绑定后 & 状态详情页专属样式
        ===================================================================
        */

        /* --- 1. 情侣空间绑定后UI样式 --- */
        .breakup-popup {
            position: absolute;
            top: 7px;
            right: -19px;
            width: 34px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            gap: 0;
            /* 动画的起点（隐藏状态） */
            transform: translate(-5%, -5%) scale(0);
            /* 【【【核心修改1】】】收起动画的基点：在中心 */
            transform-origin: center;
            background-color: #ffe694;
            z-index: 20;
            opacity: 0;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease-out;
        }

        /* 当头像被点击时，显示小气泡 */
        .couple-avatar-wrapper.popup-active .breakup-popup {
            /* 动画的终点（可见状态） */
            transform: translate(0, 0) scale(1);
            opacity: 1;
            /* 【【【核心修改2】】】弹出动画的基点：在左下角 */
            transform-origin: bottom left;
        }

        /* 弹出的小气泡上的关闭按钮 */
        .breakup-close-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            line-height: 1;
            /* 确保SVG垂直居中 */
            /* [新增] 为关闭按钮也增加一个容器，确保点击区域足够大 */
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 弹出小气泡的尾巴 */
        .breakup-popup::after {
            content: '';
            position: absolute;
            /* [修改] 定位到圆形的右下角内侧 */
            bottom: 6px;
            top: 19.7px;
            left: 3.4px;
            /* [修改] 旋转角度，使其指向头像中心 */
            transform: rotate(180deg);
            /* [保留] 尺寸和颜色 */
            width: 11px;
            height: 11px;
            background-color: #ffe694;
            border-radius: 2px;
            /* [新增] 把它放在圆形下方，避免穿透 */
            z-index: -1;
        }

        /* 当头像被点击时，显示小气泡 */
        .couple-avatar-wrapper.popup-active .breakup-popup {
            /* [修改] 动画的最终状态，回到正常位置和大小 */
            transform: translate(0, 0) scale(1);
            opacity: 1;
        }

        .couple-space-prompt {
            /* 【修复问题2】实现天数居中显示 */
            text-align: center;
        }

        .couple-message-list {
            /* 这是全屏模式下的默认样式 */
            width: 100%;
            /* 宽度先撑满可用空间 */
            max-width: 380px;
            /* 【关键】给一个固定的最大宽度，比手机框宽 */
            margin: 0 auto;
            /* 【关键】让列表在宽屏下水平居中 */
            padding: 0;
            /* 居中后，不再需要左右内边距 */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 【【【全新 V3.3 修复】】】 手机框模式下的专属样式 */
        body.phone-frame-visible .couple-message-list {
            /* 还原为您在手机框模式下满意的样式 */
            width: 92%;
            max-width: none;
            /* 【关键】移除最大宽度限制 */
            margin: 0;
            /* 【关键】移除居中 */
            padding: 0 20px;
            /* 【关键】恢复您原来的左右边距 */
        }

        .couple-message-item {
            background-color: #ffffffef;
            border-radius: 14px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .couple-message-item:active {
            transform: scale(0.97);
        }

        .message-item-icon-wrapper {
            width: 38px;
            height: 38px;
            background-color: #ffe49a;
            /* 黄色背景 */
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            z-index: 1;
        }

        .message-item-content {
            flex-grow: 1;
            overflow: hidden;
            z-index: 1;
        }

        .message-item-title {
            /* --- 【修改】在这里调整字体大小 --- */
            font-size: 14.2px;
            font-weight: 550;
            color: #3b3b3b;
            margin: 0 0 4px 0;
        }

        .message-item-subtitle {
            font-size: 13px;
            color: #999;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-item-timestamp {
            font-size: 12px;
            color: #aaa;
            flex-shrink: 0;
            display: none;
            /* 默认不显示 */
            z-index: 1;
        }

        /* 【【【全新 V3.4 微调区】】】 解除关系小气泡上的 “x” 图标位置微调 */
        .breakup-close-btn svg {
            position: relative;
            /* 修改下面的 left 值来左右移动图标，正数向右，负数向左 */
            left: -0.6px;
        }

        /* --- 3. 状态详情页专属样式 (V2.62重构版) --- */
        #couple-status-detail-screen {
            background-color: #fafafaec;
            /* 纯白背景 */
            /* 【新增】确保顶栏和输入框固定，只有中间消息区滚动 */
            display: flex;
            flex-direction: column;
        }

        #couple-status-detail-screen .couple-status-header {
            background-color: #ffffff !important;
            box-shadow: 0 1.18px 3.65px rgb(39, 39, 39, 0.1);
            flex-shrink: 0;
            /* 防止被压缩 */
        }

        #couple-status-message-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px 15px 125px 15px;
            /* 【核心修改】保留/增加底部内边距，为浮动输入框留出空间 */
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        /* 【【【核心动画修改区】】】 */

        /* 输入区域总容器：现在是定位的“舞台” */
        #couple-status-input-area {
            position: absolute;
            /* 【【【核心修改】】】改为 absolute，使其脱离文档流，实现幽灵浮动 */
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 0 30px 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            background-color: transparent !important;
            /* position: relative;  【【【核心修改】】】移除多余的 relative，因为 absolute 已经可以作为子绝元素的定位基准 */
        }

        /* 【【【全新】】】为提示语文字本身添加入场动画 */
        #status-input-placeholder span {
            animation: fadeIn 0.32s ease-out;
        }

        /* 小输入提示框：样式不变 */
        #status-input-placeholder {
            width: 70%;
            height: 44px;
            background-color: #f0f2f5;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            color: #aaa;
            cursor: text;
            position: relative;
        }

        #status-input-placeholder::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 10px;
            height: 10px;
            background-color: #f0f2f5;
            border-radius: 3px;
        }

        /* 大输入框容器：动画主体，样式不变 */
        #status-input-active-wrapper {
            position: relative;
            width: 70%;
            height: 44px;
            max-height: 200px;
            background-color: #f0f2f5;
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #status-input-active-wrapper.input-active {
            height: 19vh;
        }

        #status-message-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            font-size: 16px;
            resize: none;
            outline: none;
            text-align: center;
            padding-top: 20px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        #status-input-active-wrapper.input-active #status-message-input {
            opacity: 1;
        }

        #status-input-active-wrapper::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 10px;
            height: 10px;
            background-color: #f0f2f5;
            border-radius: 3px;
        }

        /* 【【【发送按钮全新定位与动画】】】 */
        #status-send-btn {
            /* 【核心1】绝对定位，相对于父容器 #couple-status-input-area */
            position: absolute;
            /* 【核心2】精确定位到大输入框的右侧外部 */
            bottom: 20px;
            /* 从底部微调，使其与输入框底部对齐 */
            right: 5%;
            /* 定位在屏幕右侧的空白区域，你可以微调这个百分比 */
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            /* 【动画】默认状态：透明、缩小、不可点击 */
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* 【【【动画联动】】】 */
        /* 当大输入框被激活时，使用 ~ 选择器找到它后面的发送按钮兄弟，并让其显示 */
        #status-input-active-wrapper.input-active~#status-send-btn {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        /* 【【【全新 V3.2.1 修复】】】确保编辑时消息气泡能自动换行 */
        .message-bubble[contenteditable="true"] {
            /* 核心：覆盖掉 width: fit-content，让 max-width 正常生效 */
            width: auto;
            /* 确保文字可以正常断行和换行 */
            white-space: normal;
            word-wrap: break-word;
            /* 优化体验：在编辑时显示文本光标 */
            cursor: text;
        }

        /* --- 4. 状态详情页内的消息气泡 --- */
        .status-message-wrapper {
            display: flex;
            max-width: 80%;
        }

        .status-message-wrapper.user {
            margin-left: auto;
            flex-direction: row-reverse;
            /* 时间戳在左边 */
        }

        .status-message-wrapper.ai {
            margin-right: auto;
        }

        .status-message-bubble {
            padding: 10px 15px;
            position: relative;
            word-wrap: break-word;
            word-break: break-all;
            /* 【新增】强制英文或数字长串换行 */
        }

        /* 用户气泡 */
        .status-message-bubble.user {
            background-color: #007Aff;
            color: #ffffff;
            border-radius: 18px 18px 8px 18px;
            /* 右上角更尖锐 */
        }

        /* AI气泡 */
        .status-message-bubble.ai {
            background-color: #EBEBEB;
            color: #262626;
            border-radius: 8px 18px 18px 18px;
            /* 左上角更尖锐 */
        }

        .status-message-timestamp {
            align-self: flex-end;
            /* 垂直底部对齐 */
            font-size: 11px;
            color: #b0b0b0;
            margin: 0 8px;
            padding-bottom: 2px;
            white-space: nowrap;
        }

        /* --- 5. 状态详情页右上角菜单 --- */
        #couple-status-context-menu {
            position: absolute;
            top: 110px;
            /* 初始位置在顶栏下方 */
            right: 15px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
            /* 弹性动画准备 */
            transform: scale(0.8);
            opacity: 0;
            transform-origin: top right;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
            visibility: hidden;
        }

        #couple-status-context-menu.visible {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        /* 菜单的三角形气泡指针 */
        #couple-status-context-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 15px;
            /* 对准右上角按钮 */
            width: 14px;
            height: 14px;
            background-color: #ffffff;
            transform: rotate(45deg);
            border-radius: 2px;
        }

        .status-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            color: #3f3f3f;
            cursor: pointer;
        }

        .status-menu-item svg {
            flex-shrink: 0;
        }

        /* --- 【【【全新 V3.4 修复】】】确保状态页编辑时消息气泡能自动换行 --- */
        .status-message-bubble[contenteditable="true"] {
            /* 核心：让 max-width 正常生效 */
            width: auto;
            /* 确保文字可以正常断行和换行 */
            white-space: normal;
            word-wrap: break-word;
            /* 优化体验：在编辑时显示文本光标 */
            cursor: text;
        }

        /* 
        ===================================================================
         【【【全新】】】状态详情页消息交互 (菜单、多选)
        ===================================================================
        */

        /* --- 7.1 消息交互小卡片 (编辑/删除) --- */
        #status-message-context-card {
            position: absolute;
            /* 由JS控制位置 */
            z-index: 101;
            background-color: #ffffff;
            border-radius: 10px;
            /* 【修改】圆角变小 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 4px;
            /* 【修改】内边距变小 */
            display: flex;
            flex-direction: column;
            gap: 4px;
            /* 【修改】项目间距变小 */
            opacity: 0;
            transform: scale(0.85);
            /* [修改] 初始状态缩得更小一点 */
            /* 【核心修改】移除了固定的 transform-origin，将由JS动态设置 */
            /* [修改] 优化动画曲线，加入回弹效果，并让淡入淡出更平滑 */
            transition: opacity 0.2s ease-out, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
            pointer-events: none;
        }

        #status-message-context-card.visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
            pointer-events: auto;
        }

        .status-card-menu-item {
            padding: 6px 12px;
            /* 【修改】内边距变小 */
            font-size: 14px;
            /* 【修改】字体变小 */
            font-weight: 550;
            color: #3f3f3f;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .status-card-menu-item:hover {
            background-color: #f0f0f0;
        }

        /* --- 7.2 多选模式下的顶栏变化 --- */
        #couple-status-detail-screen.multi-select-mode .couple-status-header .header-icon,
        #couple-status-detail-screen.multi-select-mode .couple-status-header h1,
        #couple-status-detail-screen.multi-select-mode .couple-status-header #couple-status-options-btn {
            display: none;
        }

        #couple-status-detail-screen .multi-select-actions {
            display: none;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        #couple-status-detail-screen.multi-select-mode .multi-select-actions {
            display: flex;
        }

        /* 【新增】为状态页的多选按钮设置独立颜色 */
        #status-multi-select-cancel-btn {
            color: #252525;
        }

        #status-multi-select-delete-btn {
            color: #df3546;
        }

        /* 
        ===================================================================
         【【【全新】】】情侣空间绑定后新UI专属样式
        ===================================================================
        */

        /* 【【【核心修复】】】 只有在绑定后，才让内容从顶部开始排列 */
        .couple-space-bound .couple-content-page {
            justify-content: flex-start;
        }

        /* 1. 绑定后，主内容页需要变成相对定位，作为头像的定位基准 */
        .couple-space-bound #couple-page-1 {
            position: relative;
        }

        /* 2. 新增的自定义背景区域样式 */
        #couple-custom-background-area {
            display: none;
            position: absolute;
            top: -64px;
            width: 100%;
            height: 270px;
            background-color: #fffdf5 !important;
            z-index: 1;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        /* 3. 绑定后，才显示自定义背景区域 */
        .couple-space-bound #couple-custom-background-area {
            display: block;
        }

        /* 4. 绑定后，拍立得容器需要设置更高的层级，并微调位置 */
        .couple-space-bound #polaroid-container {
            position: relative;
            z-index: 2;
            /* 【核心修复 V3.8.3】将上边距增加20px，以抵消顶栏负边距带来的上移效果 */
            margin-top: 20px;
        }

        /* 5. 绑定后，头像容器的全新位置 */
        .couple-space-bound .couple-avatars-container {
            position: absolute;
            top: 105px;
            left: 42px;
            margin-top: 0;
            z-index: 3;
            width: 150px;
            height: 80px;
        }

        /* 6. 绑定后，两个头像的新布局 */
        .couple-space-bound .my-avatar-wrapper {
            width: 84px;
            height: 84px;
            left: -6px;
        }

        .couple-space-bound .partner-avatar-wrapper {
            width: 84px;
            height: 84px;
            right: 2px;
        }

        /* 7. 绑定后，隐藏旧的提示文字 */
        .couple-space-bound .couple-space-prompt {
            display: none !important;
        }

        /* 8. 【【【全新】】】绑定后的新天数计数器容器 */
        .couple-days-counter-bound {
            display: none;
            /* 【核心修正】默认必须是none */
            position: absolute;
            top: 250px;
            left: 49px;
            z-index: 3;
            font-size: 15px;
            font-weight: 550;
            align-items: baseline;
        }

        /* 9. 【【【全新】】】绑定后才显示新的计数器 */
        .couple-space-bound .couple-days-counter-bound {
            display: flex;
        }

        /* 10. 【【【全新】】】为计数器的每个部分设置样式 */
        .couple-days-counter-bound .days-prefix {
            color: #ffe49c;
            margin-right: 12px;
        }

        .couple-days-counter-bound .days-number {
            color: #ffd063;
            font-size: 15.8px;
            margin-right: 12px;
        }

        .couple-days-counter-bound .days-suffix {
            color: #ffd865;
        }

        /* 11. 【【【全新】】】分割线样式 */
        .couple-section-divider {
            display: none;
            /* 【核心修正】默认必须是none */
            position: absolute;
            top: 285px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            height: 1.9px;
            background-color: #fff4d8;
            z-index: 3;
        }

        /* 12. 【【【全新】】】绑定后才显示分割线 */
        .couple-space-bound .couple-section-divider {
            display: block;
        }

        /* 13. 【【【全新】】】“发动态”按钮 */
        #post-status-btn {
            display: none;
            /* 【核心修正】默认必须是none */
            position: absolute;
            top: 220px;
            right: 40px;
            z-index: 3;
            background-color: #ffe5a5;
            border: none;
            border-radius: 10px;
            padding: 9px 14px;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        #post-status-btn span {
            color: white;
            font-size: 13.6px;
            font-weight: 550;
        }

        /* 14. 【【【全新】】】绑定后才显示“发动态”按钮 */
        .couple-space-bound #post-status-btn {
            display: flex;
        }

        /* 15. 【【【全新】】】动态/相册 选项卡容器 */
        .couple-tabs-container {
            display: none;
            /* 【核心修正】默认必须是none */
            position: absolute;
            top: 290px;
            left: 49px;
            z-index: 3;
        }

        /* 16. 【【【全新】】】绑定后才显示选项卡 */
        .couple-space-bound .couple-tabs-container {
            display: block;
        }

        /* 17. 【【【全新】】】选项卡内的文字项包裹器 */
        .couple-tab-items-wrapper {
            display: flex;
        }

        .couple-tab-item {
            font-size: 13.5px;
            font-weight: 500;
            color: #ffe8ab;
            padding: 5px;
            margin-right: 15px;
            cursor: pointer;
        }

        /* 18. 【【【全新】】】下方的滑块指示条 */
        .couple-tab-slider {
            width: 28px;
            height: 3px;
            background-color: #ffe8ab;
            border-radius: 1.5px;
            margin-top: 2px;
            margin-left: 5px;
        }

        /* --- 7.3 消息气泡上的勾选图标 --- */
        /* 【新增】为消息外层容器添加相对定位，作为勾选图标的“锚点” */
        .status-message-wrapper {
            position: relative;
        }

        .status-selection-checkmark {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            /* 【修改】颜色统一改为深灰色 */
            background-color: #3f3f3f;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* 【删除】不再需要为AI气泡单独设置颜色 */

        /* 核心显示逻辑：当屏幕处于多选模式，且消息被选中时，才显示 */
        #couple-status-detail-screen.multi-select-mode .status-message-wrapper.selected .status-selection-checkmark {
            display: flex;
        }

        /* --- 6. 解除关系弹窗样式 --- */
        #breakup-confirm-modal {
            /* 复用通用弹窗样式 */
        }

        .breakup-popup-card {
            background: white;
            padding: 25px 20px 20px 20px;
            border-radius: 14px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 280px;
            text-align: center;
        }

        #breakup-confirm-text {
            font-size: 16px;
            margin: 0 0 20px 0;
            color: #333;
        }

        .breakup-popup-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .breakup-popup-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 550;
            cursor: pointer;
        }

        #breakup-cancel-btn {
            background-color: #e5e5e5;
            color: #333;
        }

        #breakup-confirm-btn {
            background-color: #f1251ad6;
            color: white;
        }

        /* 
        ===================================================================
         【【【全新 V3.8.4】】】动态评论功能专属样式
        ===================================================================
        */
        .status-post-comments-list {
            margin-top: 15px;
            /* 评论区与上方爱心/删除图标的间距 */
            margin-bottom: 15px;
            /* 【核心新增】增加评论区与下方分割线的间距 */
            display: flex;
            flex-direction: column;
            gap: 4px;
            /* 每条评论之间的间距 */

            /* --- 【新增】在这里调整评论区的左右位置 --- */
            /* 修改下面的值，正数向内缩进，负数向外扩张 */
            margin-left: 0px;
            margin-right: 0px;
        }

        .comment-item {
            display: flex;
            /* 使用flex布局，让评论内容和删除按钮能对齐 */
            justify-content: space-between;
            /* 两端对齐 */
            align-items: flex-start;
            /* 顶部对齐 */
            gap: 10px;
            /* 内容和删除按钮的间距 */
            font-size: 13px;
            /* 评论字体大小 */
            color: #555;
            line-height: 1.5;
            margin-left: 12px;
        }

        .comment-content {
            flex-grow: 1;
            /* 让评论内容占据尽可能多的空间 */
            word-wrap: break-word;
            /* 允许长单词换行 */
        }

        .comment-content .commenter-name {
            font-weight: 550;
            /* 评论人ID加粗 */
            color: #333;
        }

        .comment-delete-btn {
            flex-shrink: 0;
            /* 防止删除按钮被压缩 */
            cursor: pointer;
            /* 为了让它和爱心旁边的删除按钮在视觉上右对齐，给它一个固定的容器尺寸 */
            width: 15px;
            height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 
        ===================================================================
         【【【全新 V3.8】】】动态点赞功能专属样式
        ===================================================================
        */

        /* 1. 定义一个名为 "like-bounce" 的动画 */
        @keyframes like-bounce {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }

            /* 先放大到1.4倍 */
            100% {
                transform: scale(1);
            }

            /* 再恢复原状 */
        }

        /* 2. 爱心图标的容器样式 */
        .like-btn-wrapper {
            cursor: pointer;
            /* 鼠标悬浮时显示小手图标 */
            transition: transform 0.2s;
            /* 为点击时增加轻微的缩放过渡效果 */
            display: flex;
            /* 让内部SVG居中 */
            align-items: center;
            justify-content: center;
        }

        .like-btn-wrapper:active {
            transform: scale(0.9);
            /* 点击时轻微缩小 */
        }

        /* 3. 默认状态下，显示描边爱心，隐藏实心爱心 */
        .like-btn-wrapper .heart-outline {
            display: block;
        }

        .like-btn-wrapper .heart-filled {
            display: none;
        }

        /* 4. 当容器有 .liked 类时，反转显示状态，并为实心爱心应用动画 */
        .like-btn-wrapper.liked .heart-outline {
            display: none;
        }

        .like-btn-wrapper.liked .heart-filled {
            display: block;
            animation: like-bounce 0.4s ease-out;
            /* 应用我们定义的动画 */
        }

        /* 
        ===================================================================
         【【【全新】】】发布动态弹窗专属样式
        ===================================================================
        */
        #post-status-modal .status-modal-card {
            background-color: #fefefe;
            border-radius: 16px;
            width: 85%;
            max-width: 340px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* 沿用您现有弹窗的入场动画 */
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }

        #post-status-modal.visible .status-modal-card {
            transform: scale(1);
        }

        #post-status-modal .status-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 15px 20px;
        }

        #post-status-modal .status-modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 550;
            color: #484848;
        }

        #post-status-modal .status-modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        #post-status-modal .status-modal-body {
            padding: 0px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 输入框和照片按钮的间距 */
        }

        #post-status-modal .status-modal-textarea {
            width: 100%;
            height: 120px;
            /* 您可以调整这个高度 */
            border: none;
            border-radius: 12px;
            background-color: #f7f7f7;
            padding: 15px;
            box-sizing: border-box;
            resize: none;
            font-size: 14px !important;
            color: #333;
        }

        #post-status-modal .status-modal-textarea::placeholder {
            color: #cbcbcb;
        }

        #post-status-modal .status-modal-photo-btn {
            width: fit-content;
            /* 宽度自适应内容 */
            background-color: #ffe495;
            border: none;
            border-radius: 8px;
            /* 8px的小圆角 */
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        #post-status-modal .status-modal-photo-btn span {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        #post-status-modal .status-modal-footer {
            display: flex;
            justify-content: flex-end;
            /* 按钮靠右对齐 */
            gap: 12px;
            /* 按钮之间的间距 */
            padding: 0px 20px 20px 20px;
        }

        #post-status-modal .status-modal-action-btn {
            border: none;
            border-radius: 8px;
            padding: 6px 15px;
            font-size: 12.5px;
            font-weight: 550;
            color: #ffffff;
            cursor: pointer;
        }

        #post-status-modal .status-modal-action-btn.cancel {
            background-color: #ffebb5;
        }

        #post-status-modal .status-modal-action-btn.publish {
            background-color: #ffe495;
        }

        /* 
        ===================================================================
         【【【全新】】】情侣空间动态卡片与滚动布局专属样式 (最终修复版)
        ===================================================================
        */

        /* 【核心修复 1】移除父容器的 overflow: hidden 限制 */
        .couple-space-bound .couple-space-content {
            flex-grow: 1;
            /* 【【【关键修改】】】将 overflow: hidden 改为 overflow: visible */
            overflow: visible;
            display: flex;
            flex-direction: column;
        }

        /* 【核心修复 2】让 page-1 成为真正的、唯一的滚动容器 */
        .couple-space-bound #couple-page-1 {
            flex-grow: 1;
            /* 让它填满父容器的剩余空间 */
            overflow-y: auto;
            /* 【【【关键】】】允许它自己垂直滚动 */
            display: block;
            /* 覆盖掉 flex 布局，让其内部元素按正常文档流排列 */
        }

        /* 【【【关键新增】】】定义我们新创建的“舞台”容器的样式 */
        .couple-space-header-content {
            position: relative;
            /* 成为内部所有绝对定位元素的定位基准 */
            height: 320px;
            /* 给予一个固定的高度，足以容纳所有元素。您可以微调这个值。 */
            flex-shrink: 0;
            /* 防止在布局中被意外压缩 */
        }

        /* 【核心修复 3】动态流容器，现在只是一个普通的、带边距的块 */
        #couple-status-feed {
            /* 移除所有 flex 和 overflow 属性 */
            padding-top: 20px;
            /* 与上方的“舞台”隔开一点距离 */
            padding-bottom: 160px;
            /* 底部留出空间，防止被底栏遮挡 */
        }

        /* 【【【最终修复】】】专门用于居中“未绑定”状态下的头像容器 */
        #couple-space-screen:not(.couple-space-bound) .couple-avatars-container {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        .status-post-card {
            display: none;
            width: 74%;
            margin: 0 auto 20px auto;
            background-color: #fefefe;
            border-radius: 14px;
            /* --- 【修改】减小上下的内边距来让卡片变矮 --- */
            padding: 13px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .couple-space-bound .status-post-card {
            display: block;
        }

        .status-post-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .status-post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1.5px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
            margin-left: 7px;
        }

        .status-post-user-info {
            flex-grow: 1;
        }

        .status-post-username {
            /* 动态卡片用户名称 */
            font-size: 14px;
            font-weight: 550;
            color: #333;
            margin: 0 0 4px 0;
            margin-top: 12px;
            margin-left: 2px;
        }

        .status-post-timestamp {
            font-size: 11px;
            color: #aaa;
            margin-left: 2.4px;
        }

        .status-post-content {
            margin: 15px 0 5px 0;
            font-size: 13.3px;
            color: #2b2b2b;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-left: 14px;
            margin-top: 20px;
        }

        .status-post-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            /* --- 【修改】减小下边距，让图标靠近分割线 --- */
            margin-bottom: 12px;

            /* --- 【新增】增加右内边距，让图标整体向左移动 --- */
            padding-right: 5px;
        }

        .status-post-actions svg {
            margin-top: 10px;
            cursor: pointer;
        }

        .status-post-divider {
            height: 1.7px;
            background-color: #f7f7f7;
            margin: 0 0 10px 0;
        }

        .status-post-comment-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-post-comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .status-post-comment-input {
            flex-grow: 1;
            background-color: #f8f8f7;
            border-radius: 10px;
            padding: 8px 12px !important;
            font-size: 13.4px !important;
            color: #333;
            border: none;
            outline: none;
            height: 36px;
            box-sizing: border-box;
            min-width: 0;
        }

        .status-post-comment-input::placeholder {
            color: #9f9f9f;
        }

        .status-post-comment-send {
            font-size: 13px;
            font-weight: 500;
            color: #505050;
            cursor: pointer;
            flex-shrink: 0;

        }

        /* 
        ===================================================================
         【【【全新 V3.9】】】添加状态弹窗及新状态消息专属样式
        ===================================================================
        */

        /* --- 1. 添加状态弹窗主体 --- */
        #add-status-card {
            width: 85%;
            max-width: 340px;
            /* 尺寸参考“发布动态”弹窗 */
            max-height: 480px;
            /* 【【【微调】】】限制最大高度，让弹窗稍微变矮 */
            height: auto;
            /* 【【【微调】】】高度自适应内容 */
        }

        #add-status-header h2 {
            color: #484848;
        }

        #add-status-body {
            padding: 15px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            /* 各个表单组之间的垂直间距 */
        }

        .add-status-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 标题和输入框的间距 */
        }

        .add-status-form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            padding-left: 5px;
            /* 标题左侧稍微缩进 */
        }

        /* --- 2. 自定义下拉框 --- */
        .status-dropdown-container {
            position: relative;
        }

        .status-dropdown-header {
            display: flex;
            align-items: center;
            background-color: #f7f7f7;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            height: 48px;
            box-sizing: border-box;
        }

        .status-dropdown-selected-icon {
            width: 22px;
            /* 为图标预留空间 */
            height: 22px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-dropdown-selected-text {
            flex-grow: 1;
            color: #333;
            font-size: 15px;
        }

        .status-dropdown-selected-text:empty::before {
            content: " ";
            /* 占位，防止空的时候塌陷 */
        }

        /*
         * 【【【这里是您要找的小三角动画】】】
         *  - transform: rotate(0deg) 是初始状态（正三角）
         *  - transition: transform 0.3s ease-in-out; 控制动画效果，您可以修改 0.3s 来调整速度。
         */
        .status-dropdown-arrow {
            flex-shrink: 0;
            transform: rotate(0deg);
            /* 【【【微调】】】初始是正三角 */
            transition: transform 0.3s ease-in-out;
        }

        .status-dropdown-container.expanded .status-dropdown-arrow {
            transform: rotate(0deg);
            /* 【【【微调】】】展开时是倒三角 */
        }

        .status-dropdown-list {
            position: absolute;
            top: 105%;
            /* 紧贴在header下方 */
            left: 0;
            width: 100%;
            background-color: #ffffff;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 150px;
            /* 约等于3个item的高度 */
            overflow-y: auto;
            z-index: 1001;
            /* 确保在弹窗内容之上 */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .status-dropdown-container.expanded .status-dropdown-list {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .status-dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
        }

        .status-dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .status-dropdown-item-icon {
            width: 22px;
            height: 22px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-dropdown-item-text {
            font-size: 15px;
        }

        /* --- 3. 其他输入控件 --- */
        .add-status-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .add-status-row .add-status-form-group {
            flex: 1;
            /* 平分宽度 */
        }

        .add-status-subject-btn,
        .add-status-input {
            width: 100%;
            height: 48px;
            box-sizing: border-box;
            background-color: #f7f7f7;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 15px;
            text-align: center;
        }

        .add-status-subject-btn {
            cursor: pointer;
        }

        #add-status-time-input::placeholder,
        #add-status-content-input::placeholder {
            color: #cbcbcb;
        }

        /* --- 4. 全新的居中状态消息样式 --- */
        .system-status-wrapper {
            text-align: center;
            margin: 9px 0;
            /* 【【【微调】】】将上下边距从 18px 减小到 12px，让消息间距更近 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            /* 时间戳和灰色矩形的间距 */
        }

        .system-status-timestamp {
            font-size: 13px;
            font-weight: 500;
            color: #8e8e93;
        }

        .system-status-bubble {
            display: inline-flex;
            /* 核心：让其宽度自适应内容 */
            align-items: center;
            gap: 8px;
            /* 图标和文字的间距 */
            background-color: #f0f2f5;
            border-radius: 18px;
            padding: 6px 12px;
            max-width: 85%;
            /* 防止内容过长时撑满屏幕 */
        }

        .system-status-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .system-status-content {
            font-size: 13px;
            color: #323232;
            line-height: 1.5;
            text-align: left;
            /* 确保矩形内的文字是左对齐的 */
        }

        /* --- 5. 【V3.9.1 新增】状态页历史消息加载按钮 --- */
        .status-history-loader {
            margin: 0 auto 20px auto;
            cursor: pointer;
            background-color: #f0f2f5;
            border-radius: 18px;

            /* 【核心修改】不再自适应内容，而是给一个固定的尺寸 */
            width: 40px;
            height: 24px;

            /* 【核心修改】开启相对定位，作为内部SVG的定位锚点 */
            position: relative;
        }

        /* 【【【全新】】】专门控制SVG图标的样式和位置 */
        .status-history-loader svg {
            /* 1. 使用绝对定位实现完美居中 */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            /* 
             * --- 【这里是您可以精确微调上下左右位置的地方】 ---
             * 在已经居中的基础上，您可以通过修改下面的 top 和 left 值进行微调。
             *
             * === 上下位置微调 ===
             * - 负数 (例如 top: -2px;) 会将图标向上移动。
             * - 正数 (例如 top: 2px;) 会将图标向下移动。
             *
             * === 左右位置微调 ===
             * - 负数 (例如 left: -2px;) 会将图标向左移动。
             * - 正数 (例如 left: 2px;) 会将图标向右移动。
             *
             * 我将 top 和 left 的初始值都设为50%，您可以直接在后面增减像素值
             * 例如: top: calc(50% - 1px);
             * 为了简单，我们直接修改 transform 里的值。
             */
            transform: translate(calc(-50% + 0px), calc(-50% + 0px));
        }


        /* 
        ===================================================================
         【【【全新 V3.9.5 最终解决方案】】】状态详情页快捷删除模式专属样式
        ===================================================================
        */

        /* --- 1. 右上角按钮容器 (保持不变) --- */
        .header-actions-wrapper {
            display: flex;
            align-items: center;
            height: 100%;
        }

        /* --- 2. 新增的“删除模式”按钮 --- */
        #status-direct-delete-btn {
            /* --- 【您可以修改这里的 top 和 right 值来微调按钮位置】 --- */
            position: relative;
            top: 0px;
            /* 正数向下, 负数向上 */
            right: 0px;
            /* 正数向左, 负数向右 */
        }

        /* --- 3. 当进入普通多选模式时，隐藏我们的新按钮 (保持不变) --- */
        #couple-status-detail-screen.multi-select-mode .header-actions-wrapper {
            display: none;
        }

        /* --- 4. 【【【核心修正】】】让状态条自身成为定位锚点 --- */
        .system-status-bubble {
            position: relative;
            /* <-- 关键：让状态条自己成为锚点 */
        }

        /* --- 5. 【【【核心修正】】】状态条旁边的删除叉号图标，使用绝对定位 --- */
        .status-direct-delete-icon {
            position: absolute;
            /* <-- 关键：使用绝对定位，脱离文档流 */

            /* --- 【您可以修改这里的 top 和 left 值来微调叉号位置】 --- */
            top: 50%;
            /* 垂直居中 */
            left: 100%;
            /* 定位到状态条的右侧外边缘 */
            transform: translateY(-50%);
            /* 垂直居中修正 */
            margin-left: 4px;
            /* 与状态条的间距 */

            /* 基础样式 */
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;

            /* 默认“隐身”，不占据空间也不可见 */
            display: none;
        }

        /* --- 6. 【【【核心修正】】】当页面进入快捷删除模式时，让图标“现身” --- */
        #couple-status-detail-screen.direct-delete-mode .status-direct-delete-icon {
            display: flex;
        }

        /* 
        ===================================================================
         【【【全新 V3.9.7 最终修复】】】状态详情页顶栏标题绝对居中
        ===================================================================
        */
        #couple-status-detail-screen .couple-header h1 {
            /* 1. 将标题从文档流中“拎”出来 */
            position: absolute;

            /* 2. 将标题的左边缘对齐到父容器的正中心 */
            left: 50%;
            top: 64px;

            /* 3. 再将标题向左移动自身宽度的一半，实现完美居中 */
            transform: translateX(-50%);

            /* 4. 【安全措施】防止标题过长时与按钮重叠 */
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- 【V4.0 新增】聊天列表页专属样式 (最终修正版) --- */
        #chat-list-screen {
            background-color: #fafafa;
            /* 核心：确保整个页面是flex布局，为内容滚动做准备 */
            display: flex;
            flex-direction: column;
        }

        /* 移除聊天列表页顶栏的边框，并设置为flex-shrink: 0防止被压缩 */
        #chat-list-screen .header {
            border-bottom: none !important;
            flex-shrink: 0;
            position: relative;
            /* 【【【核心新增】】】 */
        }

        /* 【V4.1 最终修复】标题使用绝对定位居中，与菜单栏标题方案统一 */
        #chat-list-screen .header h1 {
            position: absolute;
            left: 50%;
            top: 50%;
            /* 先定位到父容器中心 */
            transform: translate(-50%, -50%);
            /* 再根据自身大小进行微调，实现完美居中 */
            padding-top: 40px;
            /* 根据您的顶栏高度微调，确保垂直居中 */
            box-sizing: border-box;
            width: 60%;
            /* 限制最大宽度，防止与左右按钮重叠 */
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 【V4.1 核心修正】主内容区域，用于容纳可切换的页面 */
        #chat-list-main-content {
            flex-grow: 1;
            /* 占据头部和导航栏之间的所有空间 */
            position: relative;
            overflow: hidden;
            /* 防止子页面溢出导致整个屏幕滚动 */
        }

        /* 【V4.1 核心修正】可切换的子页面 */
        .chat-list-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* 继承父容器的高度 */
            display: none;
            /* 【【【核心修复】】】 默认不显示，彻底杜绝重叠BUG */
            flex-direction: column;
        }

        /* 【【【全新最终修复】】】 当任何子页面被激活时，让它正确显示出来 */
        .chat-list-page.active {
            display: flex;
        }

        /* 【V4.1 核心修正】真正滚动的列表容器 */
        #chat-list-container {
            height: 100%;
            /* 撑满父页面容器 */
            overflow-y: auto;
            /* 允许自身垂直滚动 */
            padding: 22.5px 27px 135px 27px;
            /* 增加底部padding，为浮动导航栏留出空间 */
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 置顶和普通板块的通用样式 */
        .chat-section-plate {
            background-color: #ffffff;
            border-radius: 18px;
            overflow: hidden;
            flex-shrink: 0;
            /* 防止板块在flex布局中被压缩 */
        }

        /* 移除聊天列表页所有联系人项的分割线 */
        #chat-list-screen .contact-item {
            border-bottom: none !important;
        }

        /* 联系人项内部布局调整 */
        #chat-list-screen .contact-item {
            padding: 12px 15px;
            position: relative;
        }

        /* 联系人名字 */
        #chat-list-screen .contact-item .name {
            font-size: 17px;
            font-weight: 500;
        }

        /* 最后一条消息 */
        #chat-list-screen .contact-item .last-message {
            margin-top: 5px;
            font-size: 13.5px !important;
        }

        /* 联系人列表时间戳样式 */
        .contact-timestamp {
            position: absolute;
            top: 14px;
            right: 25px;
            font-size: 12.5px;
            color: #8e8e93;
            white-space: nowrap;
        }

        /* 【V4.1 核心修正】底部浮动导航栏样式 */
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 86%;
            max-width: 380px;
            height: 68px;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 34px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            border-top: none;
            z-index: 10;
            /* 确保在内容之上 */
        }

        /* --- 【【【请在这里新增下面的代码】】】 --- */
        #chat-list-bottom-nav .nav-item svg {
            height: 28px;
            /* 强制所有图标的高度统一为28px */
            display: flex;
            /* 让图标在自己的小空间里垂直居中 */
            align-items: center;
        }

        /* --- 【【【新增结束】】】 --- */

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            flex: 1;
        }

        .nav-item .nav-title {
            font-size: 11px;
            font-weight: 500;
            color: #333333;
            transition: color 0.2s;
        }

        .nav-item svg path {
            fill: #333333;
            transition: fill 0.2s;
        }

        /* 选中状态的样式 */
        .nav-item.active .nav-title {
            color: #007cff;
        }

        .nav-item.active svg path {
            fill: #007cff;
        }

        /* 
        ===================================================================
         【【【全新 V4.2】】】未读消息红点专属样式
        ===================================================================
        */

        /* --- 1. 包裹联系人头像的容器，作为红点定位的“锚点” --- */
        .contact-avatar-wrapper {
            position: relative;
            /* 关键：开启相对定位 */
            flex-shrink: 0;
            /* 防止在flex布局中被压缩 */
        }

        /* --- 2. 未读消息红点的通用样式 --- */
        .unread-badge {
            position: absolute;
            /* 关键：脱离文档流，浮动在父元素之上 */
            top: -2px;
            /* 距离顶部的距离，可微调 */
            right: 9px;
            /* 距离右侧的距离，可微调 */
            min-width: 20px;
            /* 最小宽度，确保单个数字也能撑起圆形 */
            height: 20px;
            background-color: #f94242;
            /* 您指定的红色 */
            color: #ffffff;
            /* 您指定的白色 */
            border-radius: 10px;
            /* 高度一半的圆角，形成完美圆形 */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            padding: 0 5px;
            /* 左右留白，让多位数也好看 */
            box-sizing: border-box;
            border: 1.5px solid #ffffff;
            /* 白色描边，增加质感 */
            z-index: 5;
            /* 确保在头像之上 */
        }

        /* --- 3. 底部导航栏图标的包裹容器，同样用作“锚点” --- */
        .nav-icon-badge-wrapper {
            position: relative;
            /* 关键：开启相对定位 */
            display: flex;
            /* 确保内部SVG能正常显示 */
            justify-content: center;
            align-items: center;
        }

        /* --- 4. 针对底部导航栏红点的微调 --- */
        .nav-icon-badge-wrapper .unread-badge {
            top: -5px;
            /* 位置微调 */
            right: -8px;
        }

        /* 
        ===================================================================
         【【【全新 V4.3】】】“Me”页面异形顶栏专属样式
        ===================================================================
        */

        /* --- 1. “Me”页面的内容区基础样式 --- */
        #me-page .me-page-content {
            flex-grow: 1;
            /* 让内容区填满剩余空间 */
            padding: 20px;
            text-align: center;
            color: #888;
        }

        /* --- 2. 异形顶栏的容器 (白色矩形部分) --- */
        #me-page .me-page-header {
            width: 100%;
            height: 120px;
            /* 您可以根据需要调整顶栏的高度 */
            background-color: #ffffff;
            /* 顶栏的背景色是白色 */
            position: relative;
            /* 【【【核心】】】开启相对定位，这是让“挖洞”成功的关键 */
            flex-shrink: 0;
            /* 防止被压缩 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            /* 添加一个非常淡的底部阴影增加质感 */
        }

        /* --- 3. 实现“挖洞”效果的伪元素 (最关键的部分) --- */
        #me-page .me-page-header::after {
            content: '';
            /* 伪元素必须有 content 属性 */
            position: absolute;
            /* 绝对定位，相对于 me-page-header */

            /* --- 【您可以微调这里的数值来改变“凹陷”的大小】 --- */
            width: 44px;
            /* “凹陷”的宽度 */
            height: 44px;
            /* “凹陷”的高度 */

            bottom: 0;
            /* 定位到父容器的底部 */
            left: 0;
            /* 定位到父容器的左边 */

            /* 【【【魔法所在】】】背景色必须和页面背景色(#fafafa)完全一样！ */
            background-color: #fafafa;

            /* 【【【画龙点睛】】】只给右上角设置圆角，形成弧线效果 */
            border-top-right-radius: 22px;
            /* 圆角大小，通常是宽高的一半 */
        }

        /* 
        ===================================================================
         【【【全新 V4.3】】】“Me”页面专属样式
        ===================================================================
        */

        /* --- 1. “Me”页面激活时，隐藏聊天列表的顶栏元素 --- */
        #chat-list-screen.me-page-active .header .header-icon,
        #chat-list-screen.me-page-active .header h1,
        #chat-list-screen.me-page-active .header .add-btn {
            display: none !important;
            /* 强制隐藏 */
        }

        /* --- 2. “Me”页面主内容容器 --- */
        #me-page {
            /* 覆盖掉 .chat-list-page 的 flex 布局，让我们自己控制 */
            /* 【【【核心修复】】】 移除了 display: block; 这一行，以解决首次加载时的覆盖问题 */
            padding: 0;
            overflow-y: auto;
            /* 如果内容超出一屏，允许滚动 */
        }

        #me-page-content {
            padding: 40px 20px;
            /* 上下左右的内边距 */
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 各个大板块之间的垂直间距 */
        }

        /* --- 3. 顶部个人信息区域 --- */
        .me-profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 所有内容居中对齐 */
            gap: 12px;
            /* 头像、名字、签名之间的间距 */
        }

        .me-avatar {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: -40px;
            cursor: pointer;
        }

        #me-page-name {
            font-size: 16px;
            font-weight: 550;
            color: #2a2a2a;
            margin: 4px 0 0 0;
            /* 名字和头像的间距微调 */
        }

        #me-page-signature {
            font-size: 14px;
            color: #aaa;
            /* 浅灰色 */
            margin: 0;
        }

        /* --- 4. 中间白色胶囊容器 --- */
        .me-settings-plate {
            /* 【【【核心修复】】】 恢复所有胶囊默认的白色背景 */
            background-color: #ffffff;
            border-radius: 28px;
            overflow: hidden;
            /* 确保内部分割线不会超出圆角 */
        }

        /* 【【【全新最终修复】】】 使用相邻兄弟选择器(+)，精确地将第二个胶囊容器的背景去掉 */
        #me-page-content .me-settings-plate+.me-settings-plate {
            background-color: transparent;
            overflow: visible;
        }


        /* 【【【核心新增】】】 为第二个设置板块（个人/个性装扮）添加一个较大的上边距 */
        #me-page-content .me-settings-plate:nth-of-type(2) {
            margin-top: 10px;
            /* 这个值可以微调，它决定了与上方Pay胶囊的距离 */
        }


        .me-settings-item {
            display: flex;
            align-items: center;
            /* 【【【核心修改】】】 我们将统一的 padding 拆分开来，只增加左内边距 */
            padding: 16px 16px 16px 26px;
            /* 上 右 下 左 */
            cursor: pointer;
            position: relative;
            /* 为箭头定位提供基准 */

            /*
             * --- 【【【全新】】】 图标与标题统一右移微调区 ---
             * 说明：
             * - 修改上方 padding 属性的最后一个值 (当前是 26px)，即可将图标和标题整体向右移动。
             * - 将 26px 改为更大的值（如 36px），会向右移动更多。
             * - 将 26px 改为比原始值 16px 更小的值，会向左移动。
            */
        }


        .me-settings-item-icon {
            width: 20px;
            /* 固定图标容器宽度，让图标左对齐 */
            margin-right: 15px;
            /* 图标和文字的间距 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .me-settings-item-title {
            font-size: 14px;
            font-weight: 550;
            color: #333333e7;
            /* 你指定的颜色 */
            flex-grow: 1;
            /* 占据所有剩余空间 */
        }

        /* --- 【【【全新】】】 “Pay and Services”箭头位置微调区 --- */
        #me-page-content .me-settings-plate:first-of-type .me-settings-item-arrow {
            /* 
             * 说明：
             * - 修改下面的 top 值可以微调箭头的上下位置。
             * - 正数会将箭头向下移动，负数会将箭头向上移动。
             * - 例如：top: 2px;
            */
            position: relative;
            top: 10px;
        }

        .me-settings-item-arrow {
            position: absolute;
            right: 20px;
            /* 距离右边框的距离 */
            top: 55%;
            transform: translateY(-50%);
        }

        /* --- 【【【全新最终修复】】】 “Pay and Services”箭头位置微调区 --- */
        #me-page-content .me-settings-plate:first-of-type .me-settings-item-arrow {
            /* 
             * 说明：
             * - 修改下面的 0px 可以微调箭头的上下位置。
             * - 正数 (例如 2px) 会将箭头向下移动。
             * - 负数 (例如 -2px) 会将箭头向上移动。
            */
            top: calc(50% + 0px);
        }

        /* --- 5. 原地编辑输入框的样式 (复用你已有的) --- */
        .temp-edit-input {
            background-color: rgba(240, 240, 240, 0.8);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 2px 5px;
            font-size: inherit;
            /* 继承父元素的字体大小 */
            font-weight: inherit;
            /* 继承父元素的字体粗细 */
            color: #333;
            text-align: center;
            width: 80%;
            /* 占据父容器80%宽度 */
            box-sizing: border-box;
            outline: none;
            /* 移除默认的蓝色边框 */
        }

        /* css结束 */



        /* 
        ===================================================================
         【新增】字体大小和粗细调整区 
        ===================================================================
        */

        /* --- 桌面App标题 --- */
        .app-icon span {
            /* font-size: 14px; */
            /* font-weight: 500; */
        }

        /* --- 所有页面的顶部大标题 (如“聊天”、“API设置”等) --- */
        .header h1 {
            font-size: 16px;
            font-weight: 550;
            /* 600是 légèrement 加粗 */
        }

        /* --- 弹窗/卡片的标题 (如“创建新联系人”) --- */
        .modal-content h2,
        .modal-card-header h2,
        #confirm-modal-title {
            font-size: 15px;
            font-weight: 540;

        }

        /* 【全新】更多功能按钮的交互样式 */
        #more-btn {
            position: relative;
            top: 0px;
            left: -15px;
            /* 【新增】为旋转动画添加平滑过渡 */
            transition: transform 0.3s ease-in-out;
        }

        #more-btn.rotated {
            /* 【新增】旋转45度，变成 "×" 号 */
            transform: rotate(45deg);
        }

        /* 【全新】功能面板、分页和图标的样式 (V2.0 美化版) */

        /* 1. 功能面板的总容器 */
        #more-functions-panel {
            /* 【核心修改1】修复缝隙问题 */
            margin: 0 -15px -15px -15px;
            /* 上右下左，用负边距抵消父容器的padding */
            width: calc(100% + 30px);
            /* 补偿左右负边距，撑满宽度 */

            /* 【核心修改2】样式美化 */
            background-color: #f9f9f9;
            /* 背景改为白色 */
            border-top: 1.2px solid #e0e0e0;
            /* 在顶部添加分割线 */

            /* 原有动画和布局保持不变 */
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            position: relative;
        }

        /* 2. 当面板可见时，展开它 (不变) */
        #more-functions-panel.visible {
            max-height: 300px;
        }

        /* 3. "视口" (不变) */
        #functions-viewport {
            overflow: hidden;
            position: relative;
        }

        /* 4. "胶卷条" (不变) */
        #functions-slider {
            display: flex;
            width: 200%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 5. 每一页的样式 (不变) */
        .functions-page {
            width: 50%;
            flex-shrink: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px 15px;
            padding: 20px;
            box-sizing: border-box;
        }

        /* 6. 单个功能图标的容器 (不变) */
        .function-icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* 【新增】7. 图标按钮本身的白色圆角矩形包裹样式 */
        /* 【核心修正】在选择器前加上 #more-functions-panel 来提高优先级 */
        #more-functions-panel .function-icon-item .action-button {
            width: 48px;
            height: 48px;
            /* 现在你可以自由修改这里的颜色了！*/
            background-color: #f7f7f7;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            /* 【重要】覆盖掉旧的透明背景设置 */
            background-color: #fefefe !important;
        }

        /* 8. 图标下方的文字标签 */
        .function-icon-label {
            /* 【核心修改3】字体加深加粗 */
            font-size: 12px;
            color: #555555;
            /* 颜色加深 */
            font-weight: 500;
            /* 字体稍微加粗 */
            text-shadow: none;
            /* 移除之前的阴影 */
        }

        /* 9. 导航箭头的样式 (不变) */
        .functions-nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0);
            /* 箭头背景稍微调浅以适应白色背景 */
            border: none;
            color: #666;
            /* 箭头颜色 */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.2s, background-color 0.2s;
        }

        #functions-nav-prev {
            left: 8px;
        }

        #functions-nav-next {
            right: 8px;
        }

        /* 10. 用于隐藏箭头的辅助类 (不变) */
        .functions-nav-arrow.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* 【全新】微调“添加表情”按钮的大小 */
        .add-sticker-btn-wrapper {
            transform: scale(0.85);
            /* 将按钮缩放至原大小的85% */
        }

        /* 
        ===================================================================
         【全新】V1.40 新桌面布局样式
        ===================================================================
        */

        /* --- 灵动岛 --- */
        #dynamic-island {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 36px;
            background-color: #000;
            border-radius: 18px;
            display: flex;
            align-items: center;
            padding: 4px;
            box-sizing: border-box;
            z-index: 20;
            /* 确保在最顶层 */
        }

        #dynamic-island .island-content {
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 7px;
            margin-left: 8px;
            /* 【修正】向右移动5px, 您可以在此调整 */
        }



        #user-card {
            position: relative;
            /* 改为相对定位，在滚动流中 */
            margin: -21px auto 0 auto;
            /* 顶部外边距20px, 左右自动居中 */
            width: 90%;
            max-width: 390px;
            /* 减小最大宽度 */
            height: 250px;
            /* 减小总高度 */
            border-radius: 25px;
            /* 稍微减小圆角 */
            overflow: hidden;
            background-color: #ffffff;
            /* 白色背景 */
            flex-shrink: 0;
            /* 防止被flex布局压缩 */
        }

        /* 【全新】卡片背景层样式 (让其可见并可点击) */
        #user-card-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            /* 【核心修正】让背景层铺满整个卡片 */
            height: 100%;
            z-index: 1;
            /* 确保它在最底层 */
            cursor: pointer;
            /* 鼠标悬浮时显示小手图标 */
            /* 【核心新增】让JS设置的背景图能正确显示 */
            background-size: cover;
            background-position: center;
        }

        /* 【全新】卡片前景层裁剪容器 */
        #user-card-foreground-clipper {
            position: absolute;
            /* 【核心恢复】恢复你最初的定位方式，这是形成弧形的关键 */
            bottom: -110px;
            left: 0;
            width: 100%;
            height: 250px;
            /* 【核心新增】确保它在背景层之上 */
            z-index: 2;
        }

        /* 【全新】卡片前景层内容实体 */
        #user-card-foreground-content {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            /* 白色背景 */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.441);
            border-radius: 25px;
            /* 【核心】自身的圆角，被裁剪后形成弧形 */
            box-sizing: border-box;
        }

        /* 用户文字信息容器 */
        #user-info-text {
            position: absolute;
            /* 定位在前景层之上 */
            bottom: 120px;
            /* 【修改】相对于 clipper 定位，值需要重新计算 */
            left: 0;
            width: 100%;
            text-align: center;
            /* 文字居中 */
            z-index: 3;
            /* 确保文字在最上层 */
            padding: 0 20px;
            /* 左右留些边距 */
            box-sizing: border-box;
        }

        /* 卡片头像 */
        #user-card-avatar {
            position: absolute;
            /* 绝对定位，脱离文档流，才能悬浮 */
            top: 58px;
            /* 头像的垂直中心线位置 */
            left: 50%;
            /* 水平居中 */
            transform: translateX(-50%);
            /* 水平居中修正 */
            width: 80px;
            /* 头像宽度 */
            height: 80px;
            /* 头像高度 */
            border-radius: 50%;
            /* 完美圆形 */
            border: 3px solid white;
            /* 白色描边 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            /* 阴影 */
            cursor: pointer;
            z-index: 5;
            /* 【层级提升】确保头像在所有前景元素之上 */
            background-color: white;
            /* 【新增】白色背景 */
            display: flex;
            /* 【新增】Flex布局 */
            justify-content: center;
            /* 【新增】水平居中SVG */
            align-items: center;
            /* 【新增】垂直居中SVG */
        }

        /* 文字基本样式重置 */
        #user-info-text p {
            margin: 6px 0;
            /* 减小段落间距 */
        }

        /* ID样式 */
        #user-id {
            font-size: 14px;
            font-weight: 600;
            /* 稍粗体 */
            color: #333;
        }

        /* @handle样式 */
        #user-handle {
            font-size: 12px;
            color: #aaa;
            /* 浅灰色 */
        }

        /* 个人简介样式 (带长度限制) */
        #user-bio {
            font-size: 12px;
            color: #555;
            /* 浅黑色 */
            white-space: nowrap;
            /* 强制不换行 */
            overflow: hidden;
            /* 隐藏溢出部分 */
            text-overflow: ellipsis;
            /* 溢出部分显示省略号 */
            max-width: 100%;
            /* 确保在父容器内 */
            margin-top: 6px;
        }

        /* 地址样式 */
        #user-location {
            display: inline-flex;
            /* 使用flex布局让图标和文字对齐 */
            align-items: center;
            gap: 4px;
            /* 图标和文字的间距 */
            font-size: 10.5px;
            color: #4e4e4e;
            font-weight: 560;
            /* 稍粗体 */
            margin-top: 2px;
        }

        /* --- 【位置调整后】中间App图标容器 --- */
        #main-apps-container {
            position: absolute;
            top: 340px;
            right: 26.8px;
            width: 160px;
            /* 【修复】稍微增加容器宽度以容纳更大的间距 */

            /* --- 【核心修复】从 Flexbox 改为 Grid 布局 --- */
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 定义为两列，每列占据可用空间的一半 */

            /* 【核心修复】独立控制行间距和列间距 */
            row-gap: 15px;
            /* 保持原来的垂直间距 */
            column-gap: 12px;
            /* 【修复】显著增大列之间的水平间距 */
        }


        /* --- 【位置调整后】音乐组件 --- */
        #music-widget {
            position: absolute;
            top: 510px;
            /* 定位到自定义矩形条下方 */
            right: 30px;
            /* 距离右边框的距离 */
            width: 158px;
            /* 稍微放大一点以匹配草图 */
            height: 158px;
        }

        #record-outer {
            width: 100%;
            /* 使用百分比以适应父容器 */
            height: 100%;
            background-color: #222;
            /* 黑色外圈 */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #record-inner {
            width: 108px;
            /* 白色内圈大小 */
            height: 108px;
            background-color: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        /* --- 底部Dock栏 --- */
        #bottom-dock {
            position: absolute;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 340px;
            height: 75px;

            /* --- 【V1.92 最终美化版】多层次样式叠加 --- */
            /* 1. 通透层(光泽) + 底层(基色) - 微调透明度以增强对比 */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.15)),
                rgba(255, 255, 255, 0.25);

            /* 2. 模糊层 (保持不变) */
            backdrop-filter: blur(17px);
            -webkit-backdrop-filter: blur(15px);

            /* 3. 【核心修复】移除呆板的 border 属性 */
            /* border: 1.5px solid rgba(255, 255, 255, 0.25); */

            box-shadow:
                /* 顶部和左侧的亮边高光 (更亮更细) */
                inset 0.8px 0.8px 1px rgba(255, 255, 255, 0.7),
                /* 底部和右侧的暗边轮廓 (更暗更细) */
                inset -0.8px -0.8px 1px rgba(255, 255, 255, 0.15),
                /* 外部的悬浮投影 */
                0 2px 8px rgba(0, 0, 0, 0.1);

            border-radius: 32px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
        }

        /* 【【【核心新增】】】为Dock栏内的App图标设置专属样式，解决“双重玻璃”问题 */
        #bottom-dock .new-app-icon {
            background-color: rgba(255, 255, 255, 0.09);
            /* 3. 【强化质感】用更强的内外阴影和边框来模拟玻璃实体感 */
            box-shadow: inset 0 0.125em 0.125em rgba(0, 0, 0, 0.05),
                inset 0 0.125em 0.125em rgba(255, 255, 255, 0.2),
                0 0.25em 0.125em -0.125em rgba(0, 0, 0, 0.2);
        }

        /* --- 全局新App图标样式 --- */
        .new-app-icon {
            width: 58px;
            height: 58px;

            /* --- 【V1.92 最终美化版】多层次样式叠加 --- */
            /* 1. 通透层(光泽) + 底层(基色) - 微调透明度以增强对比 */
            background: linear-gradient(135deg, rgba(198, 198, 198, 0.1), rgba(224, 224, 224, 0.299)),
                rgba(246, 246, 246, 0.183);

            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(17px);
            box-shadow: inset 0 0.125em 0.125em rgba(0, 0, 0, 0.05),
                inset 0 -0.125em 0.125em rgba(255, 255, 255, 0.2),
                0 0.25em 0.125em -0.125em rgba(0, 0, 0, 0.2);
            transition: all 400ms cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .new-app-icon:active {
            transform: scale(0.92);
            /* 点击时缩小 */
        }

        /* 【新增】中间App图标的独立大小 */
        #main-apps-container .new-app-icon {
            width: 69.5px;
            height: 67.5px;
        }

        /* 【新增】底部Dock栏图标的独立大小 */
        #bottom-dock .new-app-icon {
            width: 52px;
            height: 52px;
        }


        /* 
        ===================================================================
         【全新】V1.48 新增桌面组件样式
        ===================================================================
        */

        /* --- 纪念日组件 --- */
        #days-matter-widget {
            position: absolute;
            top: 430px;
            /* 【位置微调】与右侧图标顶部对齐 */
            left: 25px;
            width: 158px;
            height: 158px;
            /* --- 【核心修复】多层次样式叠加 --- */
            /* 1. 通透层(光泽) + 底层(基色) */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.22)),
                rgba(255, 255, 255, 0.12);

            /* 2. 模糊层 (增加模糊度) */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border-radius: 22px;
            /* 【核心】使用box-shadow模拟不规则描边 */
            box-shadow:
                -0.8px -0.8px 0.5px rgba(245, 245, 245, 0.313) inset,
                /* 左上角亮的内阴影 (模拟粗边) */
                1.4px 1.4px 1px rgba(255, 255, 255, 0.557) inset;
            /* 右下角暗的内阴影 (模拟细边) */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* 必须保留，用于裁剪圆角 */
        }

        /* 【全新】上半部分样式 */
        .widget-top-pane {
            height: 39px;
            /* 顶部区域高度 */
            flex-shrink: 0;
            /* 【核心】设置一个更深、更不透明的背景 */
            background-color: rgba(206, 206, 206, 0.105);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .days-matter-title {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            /* 文字改为白色以适应深色背景 */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 【全新】下半部分样式 */
        .widget-bottom-pane {
            flex-grow: 1;
            /* 【核心】设置一个更浅、更透明的背景 */
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 5px;
        }

        .days-matter-content {
            font-size: 48px;
            font-weight: 500;
            line-height: 1.1;
        }

        /* 当有数字时，文字为白色 */
        .days-matter-content:not(:empty) {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* “暂无纪念日”的特殊样式 */
        span.days-matter-content {
            font-size: 14px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.7);
            /* 改为白色系 */
        }

        .days-matter-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* --- 自定义矩形条容器 --- */
        #capsule-widgets-container {
            position: absolute;
            top: 350px;
            /* 定位在纪念日组件下方 */
            left: 30px;
            width: 150px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 两个矩形条之间的间距 */
        }

        /* 单个矩形条样式 */
        .capsule-widget {
            width: 100%;
            height: 50px;
            /* 高度 */
            background-color: rgba(255, 255, 255, 0.162);
            /* 浅黑色半透明 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 28px;
            /* 圆角 */
            border: 0.6px solid rgba(255, 255, 255, 0.548);
            /* 浅灰色描边 */
            display: flex;
            align-items: center;
            padding: 0 10px;
            /* 内部左右边距 */
            box-sizing: border-box;
            gap: 8px;
            /* 图标和文字的间距 */
        }

        .capsule-icon {
            width: 34px;
            /* 圆形图标大小 */
            height: 34px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            /* 默认背景 */
            flex-shrink: 0;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        .capsule-text {
            flex-grow: 1;
            /* 占据所有剩余空间 */
            margin: 0;
            font-size: 9px;
            font-style: italic;
            /* 斜体 */
            color: white;
            /* 白色文字 */
            /* 【核心】使用text-shadow实现发光效果 */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7), 0 0 10px rgba(255, 255, 255, 0.5);
            /* 【核心】文字长度限制 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            /* 【核心修复】确保即使没内容也能被点击 */
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 让文字在编辑时也居中 */
        }

        /* 
        ===================================================================
         【全新 V1.57】手机框样式
        ===================================================================
        */
        body {
            /* 为背景色变化添加过渡动画 */
            transition: background-color 0.4s ease;
            background-color: #fafafa;
            /* 默认背景色 */
        }

        /* 当手机框可见时，html和body的样式 */
        html.phone-frame-visible,
        body.phone-frame-visible {
            overflow: hidden;
            /* 核心：强制隐藏外部滚动条 */
        }

        body.phone-frame-visible {
            background-color: #ffffff;
            /* 背景变为纯白 */
            /* 使用flex布局，让手机框在页面中居中显示 */
            display: flex;
            justify-content: center;
            align-items: center;
            /* 确保在所有屏幕尺寸下都能看到完整的手机 */
            padding: 1px 0;
            /* 注意：这里的 overflow: auto; 已经被上面的 overflow: hidden; 覆盖掉了 */
        }

        /* 手机框包裹层 */
        #phone-wrapper {
            width: 100%;
            height: 100%;
            /* 【新增】将此容器设置为绝对定位的基准 */
            position: relative;
            /* 核心：为所有会变化的属性添加平滑过渡动画 */
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out,
                padding 0.4s ease-in-out, border-radius 0.4s ease-in-out,
                background-color 0.4s ease-in-out, width 0.4s ease-in-out, height 0.4s ease-in-out;
            /* 【新增】为子元素的3D变换（比如translateZ）做准备，有助于优化渲染 */
            transform-style: preserve-3d;
        }

        /* 当手机框可见时，包裹层的“变身”样式 */
        body.phone-frame-visible #phone-wrapper {
            /* 设定一个固定的手机尺寸，而不是百分比 */
            width: 450px;
            height: 844px;
            min-height: 844px;
            /* 防止在flex布局中被压缩 */

            /* 
            ===========================================================
             【核心修改】手机大小与清晰度调整区
            ===========================================================
            说明：
            - 将 scale 的值从 0.95 改为 1，可以解决模糊问题，并让手机显示为最大尺寸。
            - 如果在您的屏幕上，手机框的阴影被浏览器边缘裁切了，您可以尝试 scale(0.98) 或 scale(0.97) 
              这样微小的缩放，在清晰度和完整可见性之间找到最佳平衡点。
            - translateZ(0) 是一个优化渲染的小技巧，它会提示浏览器启用硬件加速，可能会让动画和字体更平滑。
            */
            transform: scale(0.97) translateZ(0);

            /* 添加阴影 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);

            /* 手机边框的颜色 */
            background-color: #1c1c1c;

            /* 通过内边距“挤”出边框的厚度 */
            padding: 15px;

            /* 手机外壳的圆角 */
            border-radius: 50px;

            box-sizing: border-box;
        }

        /* 确保内部的屏幕能完美地填充手机框 */
        body.phone-frame-visible #phone-screen {
            /* 内部屏幕的圆角，比外壳小一些 */
            border-radius: 35px;
            height: 100%;
            width: 100%;
            /* 【核心新增】隐藏掉“缩放前”超出的内容 */
            overflow: hidden;
        }

        /* 确保内部的屏幕能完美地填充手机框 */
        body.phone-frame-visible #phone-screen {
            /* 内部屏幕的圆角，比外壳小一些 */
            border-radius: 35px;
            height: 100%;
            width: 100%;
        }

        /* 【新增】针对手机等小屏幕设备的响应式调整 */
        @media (max-width: 450px) {
            body.phone-frame-visible {
                /* 在小屏幕上减少上下内边距，给手机更多空间 */
                padding: 1px 0;
            }

            body.phone-frame-visible #phone-wrapper {
                /*
                ===========================================================
                 【核心修改】移动端手机大小调整区
                ===========================================================
                说明：
                - 通过修改下面的 scale 值，可以控制手机在移动端浏览器中的整体大小。
                - 0.8 代表缩小到80%，0.75 代表75%，数值越小，手机看起来就越小。
                - 建议在 0.7 到 0.9 之间寻找最适合您手机的值。
                */
                transform: scale(0.829) translateZ(0);
            }
        }

        /* 【全新 V1.79 修正】当在手机框模式下，应用微缩放并调整布局间距 */
        body.phone-frame-visible #couple-space-screen .couple-space-content {
            transform: scale(1.1);
            /* 轻微放大以保证清晰度，您可以微调此值 */
            padding-top: 40px;
            /* 减小顶部内边距 */
            gap: -15px;
            /* 减小主要元素间的通用间距 */
        }

        body.phone-frame-visible #polaroid-container {
            margin-bottom: 5px;
            /* 大幅减小拍立得和头像间的间距 */
        }

        body.phone-frame-visible #couple-space-screen .couple-avatars-container {
            margin-top: 55px;
            /* 大幅减小头像和上方元素的间距 */
        }

        body.phone-frame-visible #couple-space-screen .couple-space-prompt {
            margin-top: 30px;
            /* 减小提示语和头像的间距 */
        }

        body.phone-frame-visible .couple-bottom-nav {
            bottom: 60px;
            /* 向上移动底部导航栏，使其更紧凑 */
        }


        /* 
        ===================================================================
         【全新 V1.57.3】为手机框模式下的Dock栏设置专属位置
        ===================================================================
        */
        body.phone-frame-visible #bottom-dock {
            /*
            ===========================================================
             【核心】Dock栏底部距离调整区 (仅在手机框模式下生效)
            ===========================================================
            说明：
            - 我们将 `bottom` 的值从原来的 `-100px` 覆盖为一个正数。
            - 正数 `30px` 代表Dock栏的底部距离其容器(#home-screen)的底部有30像素的间距。
            - 您可以把 30px 这个值改大（比如 40px）或改小（比如 20px），
              来精确控制Dock栏在手机框内的垂直位置，直到您满意为止。
            */
            bottom: 30px;
        }

        /* 
        ===================================================================
         【核心 V1.60】为手机框模式下的输入区设置专属位置
        ===================================================================
        */
        body.phone-frame-visible #input-controls-row {
            /*
            ===========================================================
             【核心】输入区整体位置微调 (手机框模式)
            ===========================================================
            说明：
            - 这里专门控制 “手机框模式” 下，整个输入区域的水平位置。
            - 它的值会覆盖掉上面为全屏模式设置的值。
            - 您可以修改下面的 left 值来解决您在截图中看到的对齐问题。
              我根据截图估算了一个值，您可以自行微调。
            */
            left: 11.8px;
            top: -6.5px;

            /*
            ===========================================================
             【新增】输入区整体缩放调整 (手机框模式)
            ===========================================================
            说明：
            - 通过修改下面的 scale 值，可以整体放大或缩小 “手机框模式” 下的输入区域。
            - 1.05 代表放大 5%，1.1 代表放大 10%。
            - 1 代表原始大小，0.95 代表缩小 5%。
            - 您可以微调这个数值，直到获得满意的视觉效果。
            */
            transform: scale(1.014);

        }


        /* 
        ===================================================================
         【全新 V1.65】情侣空间专属样式
        ===================================================================
        */
        #couple-space-screen,
        #couple-space-invite-screen,
        #couple-theme-screen {
            /* 【新增】让主题设置页也应用此样式 */
            background-color: #fff9eb;
            /* 专属背景色 */
            /* 【核心修改】移除背景图相关属性，让这里只负责纯色背景 */
        }

        /* 【【【全新】】】情侣空间半透明背景图层样式 */
        #couple-space-background-overlay {
            display: none;
            /* 默认隐藏 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            /* 层级低于内容，高于纯色背景 */
            background-size: cover;
            background-position: center;
            opacity: 0.75;
            /* 【【【核心】】】设置75%的透明度 */
        }

        /* 【【【全新】】】当设置了背景图时，通过这个类来显示背景图层 */
        #couple-space-screen.has-custom-bg #couple-space-background-overlay {
            display: block;
        }

        /* --- 【新增】动态卡片中 “删除” 图标独立位置微调区 --- */
        .delete-status-btn {
            position: relative;
            /* 关键：开启相对定位，允许我们移动它 */

            /* 
             * === 上下位置微调 ===
             * 修改下面的 top 值来控制图标的垂直位置。
             * - 负数 (例如 top: -5px;) 会将图标向上移动。
             * - 正数 (例如 top: 5px;) 会将图标向下移动。
             * - 0px 表示保持在原始垂直位置。
             */
            top: 3px;
        }

        .couple-header {
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            height: 120px;
            /* 增加高度以容纳弧形 */
            background-color: #ffe5a5;
            /* 专属顶栏颜色 */
            border-bottom-left-radius: 20px;
            /* 核心：实现弧形效果 */
            border-bottom-right-radius: 20px;
            /* 核心：实现弧形效果 */
            display: flex;
            align-items: flex-start;
            /* 顶部对齐 */
            justify-content: space-between;
            padding: 50px 5px 10px 5px;
            /* 调整内边距适应新布局 */
            box-sizing: border-box;
            color: #2c2c2c;
            /* 标题字体颜色 */
            /* 【新增】为顶栏添加柔和的阴影 */

        }

        /* --- 【【【核心修复 V3.8.5】】】 --- */
        /* 将消除缝隙的样式，精准地只应用在情侣空间主屏幕上，不再影响其他页面 */
        #couple-space-screen .couple-header {
            margin-bottom: -22px;
        }

        .couple-header h1 {
            flex-grow: 1;
            text-align: center;
            margin: 0;
            /* --- 【核心修改】使用 em 单位实现等比缩放 --- */
            /* 1.2em 表示基础大小是全局字体的1.2倍 */
            font-size: 1.12em !important;
            font-weight: 500 !important;
            color: #2c2c2c;
            position: relative;
            top: 11px;
            /* 【核心修正】移除固定的transform，让flexbox自动处理居中 */
        }

        .couple-header .header-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        /* 底部装饰条 */
        .couple-footer {
            flex-shrink: 0;
            height: 60px;
            /* 底栏高度 */
            width: 100%;
            background-color: #ffe5a5;
            /* 专属底栏颜色 */
            box-shadow: 0 -2.8px 5px rgba(255, 255, 255, 0.1);
        }

        /* 中间内容区 */
        .couple-space-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        /* 头像容器 */
        .couple-avatars-container {
            position: relative;
            width: 220px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .couple-avatar-wrapper {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            cursor: pointer;
            /* 【新增】为头像添加默认的、更精致的阴影 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            /* 【修改】为阴影和缩放变化同时添加平滑过渡效果 */
            transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* 我方头像在左，在下层 */
        .my-avatar-wrapper {
            left: 0;
            z-index: 1;
        }

        /* 对方头像在右，在上层 */
        .partner-avatar-wrapper {
            right: 0;
            z-index: 2;
            /* border: 4px solid white; */
            /* 【核心修改】移除或注释掉此行 */
            box-sizing: border-box;
        }

        .couple-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3.8px solid white;
            /* 我方头像的白色描边 */
            box-sizing: border-box;
        }

        .partner-avatar-placeholder {
            border: 2.5px solid #ffe5a5;
            /* 内层黄色描边 */
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 1. 定义动画本身：从无光 -> 发光 -> 无光 + 从小 -> 放大 -> 缩小 */
        @keyframes breathing-glow {
            0% {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 0 5px rgba(255, 220, 130, 0.2);
                transform: scale(1);
                /* 初始大小 */
            }

            50% {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18), 0 0 20px rgba(255, 255, 255, 0.546);
                transform: scale(1.05);
                /* 放大5% */
            }

            100% {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 0 5px rgba(255, 220, 130, 0.2);
                transform: scale(1);
                /* 恢复初始大小 */
            }
        }

        /* 2. 触发规则：当鼠标悬停在头像上时，应用这个动画 */
        .couple-avatar-wrapper:hover {
            animation: breathing-glow 3s ease-in-out infinite;
        }

        /* 
        ===================================================================
         【全新 V1.68】特定标题字体加粗
        ===================================================================
        */
        #world-book-screen .header h1,
        #couple-space-screen .couple-header h1,
        #couple-space-invite-screen .couple-header h1 {
            font-weight: 550 !important;
            /* 您可以修改 600 这个值来调整粗细 */
        }

        /* 提示文字 */
        .couple-space-prompt {
            color: #ffd063;
            font-size: 16px;
            font-weight: 550;
        }

        /* 邀请好友列表 */
        #couple-invite-list-container {
            padding-top: 37px;
            /* 列表与顶栏的间距 */
            padding-left: 0;
            /* 【核心修改】移除容器的左边距 */
            padding-right: 0;
            /* 【核心修改】移除容器的右边距 */
            overflow-y: auto;
            flex-grow: 1;
        }

        .couple-invite-item {
            display: flex;
            align-items: center;
            padding: 8px 25px;
            cursor: pointer;
        }

        .couple-invite-item:hover {
            background-color: rgba(140, 140, 140, 0.192);
        }

        .couple-invite-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
            margin-right: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .couple-invite-name {
            font-size: 18px;
            font-weight: 500;
            color: #555;
        }

        /* 发送成功提示框 */
        #success-toast {
            position: absolute;
            top: 120px;
            /* 从顶栏下方出现 */
            left: 50%;
            transform: translate(-50%, -20px);
            /* 初始位置偏上 */
            background-color: #ffffff;
            color: #4d4d4d;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 550;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        #success-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }

        /* 
        ===================================================================
         【全新 V1.69】情侣关系卡片及弹窗样式
        ===================================================================
        */
        .couple-status-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px 22px 12px 15px;
            width: 240px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            position: relative;
            /* 【核心修复】添加此行以创建新的堆叠上下文 */
        }

        .couple-status-card.processed {
            opacity: 0.7;
            pointer-events: none;
            /* 让处理过的卡片不可点击 */
        }

        .couple-status-card.clickable:hover {
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .couple-status-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .couple-status-text-content {
            flex-grow: 1;
        }

        .couple-status-title {
            /* --- 在这里修改主标题的字体大小 --- */
            font-size: 14.9px;
            /* --- 在这里修改主标题的字体粗细 (400=正常, 600=粗) --- */
            font-weight: 550;
            color: #353535;
            margin: 0 0 5px 0;
        }

        .couple-status-subtitle {
            font-size: 13.5px;
            color: #888;
            margin: 0;
        }

        .couple-status-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .status-icon-pink {
            background-color: #fb97c4;
        }

        .status-icon-blue {
            background-color: #6ca0f7;
        }

        .couple-status-divider {
            height: 1px;
            background-color: #f0f0f0;
            margin: 9px 0;
        }

        .couple-status-footer {
            font-size: 13px;
            color: #aaa;
            padding-top: 1px;
            /* 让分割线上方空间稍大 */
        }

        /* 邀请弹窗样式 */
        .invite-modal-card {
            background: white;
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }

        .modal-overlay.visible .invite-modal-card {
            transform: scale(1);
        }

        .invite-modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border: none;
            background: none;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
        }

        @keyframes avatars-approach {
            from {
                transform: translateX(-15px);
            }

            to {
                transform: translateX(0px);
            }
        }

        .invite-avatars-animation-container {
            width: 140px;
            /* 总宽度 */
            height: 80px;
            display: flex;
            justify-content: center;
            /* 水平居中 */
            position: relative;
            /* 为头像定位提供基准 */
            left: 7px;
        }

        .invite-avatars-animation-container.animate .invite-modal-ai-avatar {
            animation: avatars-approach 0.5s ease-in-out forwards;
        }

        .invite-avatars-animation-container.animate .invite-modal-user-avatar {
            animation: avatars-approach 0.5s ease-in-out forwards reverse;
        }

        .invite-modal-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            object-fit: cover;
            background-color: #eee;
            position: absolute;
        }

        .invite-modal-ai-avatar {
            right: 0;
            z-index: 2;
            transform: translateX(15px);
            /* 初始靠右 */
        }

        .invite-modal-user-avatar {
            left: 0;
            z-index: 1;
            transform: translateX(-15px);
            /* 初始靠左 */
        }

        .invite-modal-prompt {
            font-size: 17px;
            font-weight: 500;
            color: #444;
            text-align: center;
            margin: 10px 0;
        }

        .invite-modal-actions {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 12px;
            margin-top: 10px;
        }

        .invite-modal-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .invite-modal-btn:active {
            transform: scale(0.97);
        }

        .accept-btn {
            background-color: #fb97c4;
        }

        .reject-btn {
            background-color: #6ca0f7;
        }

        /* 
        ===================================================================
         【全新 V1.91 修正版】外观设置 & 更换应用图标页面专属样式
        ===================================================================
        */
        /* --- 外观设置页 --- */
        #appearance-settings-container .settings-plate:first-of-type {
            margin-top: 0px;
            /* 顶部板块的上边距 */
        }

        #appearance-settings-container .settings-plate:nth-of-type(2) {
            margin-top: 7px;
            /* 【修改】减小第二个板块与第一个的间距 */
        }

        #appearance-settings-container .settings-item {
            padding: 18px 20px;
            /* 上下左右内边距 */
            border-bottom: none !important;
            /* 【核心修复】强制移除所有项目的分割线 */
        }


        /* --- 更换壁纸弹窗 (复用样式) --- */
        .background-preview-clone {
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 宽高比 */
            height: 0;
            border-radius: 10px;
            background-color: #fff;
            border: 2px dashed #ccc;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .remove-background-btn-clone {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        /* --- 更换应用图标页 --- */
        #app-icon-settings-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            /* 每个设置项之间的垂直间距 */
        }

        .app-icon-setting-item {
            display: flex;
            align-items: center;
            gap: 15px;
            /* 各个元素之间的水平间距 */
        }

        .app-icon-preview {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            /* 样式将由JS动态同步桌面图标 */
        }

        .app-icon-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 标题和输入框的间距 */
        }

        .app-icon-setting-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .app-icon-url-input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 13px;
            background-color: #f9f9f9;
        }

        .app-icon-actions {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .app-icon-btn {
            width: 60px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-icon-upload-btn {
            background-color: #353333;
            color: white;
        }

        .app-icon-reset-btn {
            background-color: #e5e5e5;
            color: #333;
        }

        /* 
        ===================================================================
         【全新 V1.92 最终修复】修复PC端SVG图标“吞”点击事件的问题
        ===================================================================
        */
        .app-icon-upload-btn svg {
            pointer-events: none;
        }

        /* 
        ===================================================================
         【全新 V2.21】世界书功能专属样式
        ===================================================================
        */

        /* --- 【新增】素材页面专属样式 --- */
        #preset-page-assets {
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* “文风”和“朋友圈素材”两大块之间的间距 */
        }

        /* 【新增】包裹灰色块和加号的父容器 */
        .asset-section-top-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            /* 这是灰色块和外部+号的间距 */
        }

        .asset-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f0f0f0;
            padding: 12px 15px;
            border-radius: 12px;
            flex-grow: 1;
            /* 让灰色块占据所有剩余空间 */
        }

        .asset-section-title-wrapper {
            flex-grow: 1;
        }

        .asset-section-title-wrapper h3 {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin: 0 0 4px 0;
        }

        .asset-section-title-wrapper p {
            font-size: 13px;
            color: #888;
            margin: 0;
        }

        .asset-section-arrow {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            flex-shrink: 0;
            transform-origin: center;
        }

        .asset-section-arrow.expanded {
            /* 【核心修正】在旋转的同时，向上移动2像素来修正视觉位置 */
            transform: rotate(180deg) translateY(5px);
        }

        .asset-section-add-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .asset-list-container {
            padding-left: 15px;
            /* 列表左侧内边距 */
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .asset-list-container.expanded {
            max-height: 1000px;
            /* 一个足够大的值来容纳内容 */
        }

        .asset-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .asset-list-item:last-child {
            border-bottom: none;
        }

        .asset-list-item .drag-handle {
            color: #ccc;
            cursor: grab;
        }

        .asset-list-item .asset-list-name {
            flex-grow: 1;
            font-size: 16px;
            color: #333;
        }

        .asset-list-item .asset-list-actions {
            display: flex;
            align-items: center;
            /* 【核心修正】设置固定宽度和间距，以实现与顶部的垂直对齐 */
            width: 74px;
            /* 32(按钮)+10(间距)+32(按钮) = 74 */
            justify-content: space-between;
            /* 让两个图标分别靠在容器两边 */
        }

        .asset-list-item .asset-list-actions button {
            background: none;
            border: none;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 【新增】素材编辑器页面专属样式 --- */
        .asset-editor-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .asset-editor-row {
            display: flex;
            align-items: flex-start;
            /* 顶部对齐，以防提示语影响 */
            gap: 20px;
        }

        .asset-editor-row .preset-form-group {
            flex: 1;
        }

        .influence-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .influence-input-wrapper input {
            width: 100px;
            /* 固定宽度 */
            text-align: center;
            /* 文字居中 */
        }

        .influence-input-wrapper .unit-label {
            font-size: 16px;
            color: #333;
        }

        .image-link-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .image-link-inputs input[type="text"] {
            flex-grow: 1;
        }

        .image-link-inputs input#new-social-asset-keyword-input {
            flex-grow: 0;
            width: 50%;
            /* 关键词框为链接框的一半 */
        }

        .image-link-inputs button {
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #social-asset-image-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .asset-image-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            /* 通过内边距控制高度 */
            border: 1.5px solid #dcdcdc;
            border-radius: 12px;
            background-color: #fff;
        }

        .asset-image-item .item-name {
            /* 命名区 */
            font-weight: 500;
            color: #333;
            padding: 5px 8px;
            border-radius: 6px;
            cursor: pointer;
            min-width: 40px;
            text-align: center;
            outline: none;
        }

        .asset-image-item .item-name:empty::before {
            content: "命名";
            color: #aaa;
            font-style: italic;
        }

        .asset-image-item .item-url {
            /* 链接灰框 */
            flex-grow: 1;
            /* 占据所有剩余空间 */
            padding: 5px 10px;
            /* 增加内边距让框看起来更大 */
            border-radius: 6px;
            background-color: #f5f5f5;
            font-size: 12px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-image-item .item-actions {
            /* 叉号和勾选框的容器 */
            display: flex;
            align-items: center;
            gap: 8px;
            /* 叉号和勾选框的间距 */
        }

        .asset-image-item .item-actions button {
            /* 通用按钮样式 */
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .asset-image-item .font-entry-checkbox {
            /* 勾选框样式 (复用字体设置的) */
            width: 22px;
            /* 减小勾选框大小 */
            height: 22px;
            /* 减小勾选框大小 */
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .asset-image-item .font-entry-checkbox.checked {
            background-color: #353333;
            border-color: #353333;
        }

        .asset-image-item .font-entry-checkbox.checked svg path {
            fill: #fff;
        }


        /* --- 主页面布局 --- */
        #world-book-screen {
            flex-direction: column;
            /* 确保顶栏、内容、底栏垂直排列 */
        }

        .preset-main-container {
            flex-grow: 1;
            /* 占据中间所有可用空间 */
            overflow-y: auto;
            /* 内容超出时可滚动 */
            position: relative;
            /* 为页面切换提供定位基准 */
        }

        .preset-page {
            position: absolute;
            /* 所有页面都叠在一起 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            overflow-y: auto;
            /* 【核心新增】为每个独立的页面开启自己的垂直滚动条 */
        }

        .preset-page.active {
            opacity: 1;
            visibility: visible;
        }

        /* --- 底部导航栏 --- */
        .preset-bottom-nav {
            flex-shrink: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 80px;
            /* 您可以微调这个高度 */
            background-color: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .preset-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            opacity: 0.65;
            /* 未选中时降低不透明度 */
            transition: opacity 0.2s;
            /* --- 【核心新增】让每个按钮平分底部导航栏的宽度 --- */
            flex: 1;
            /* --- 【核心新增】增加上下的可点击区域，让按钮更高 --- */
            padding: 10px 0;
        }

        .preset-nav-item.active {
            opacity: 1;
            /* 选中时完全不透明 */
        }

        .preset-nav-item span {
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }

        /* --- 角色列表项 --- */
        #preset-page-role {
            display: flex;
            flex-direction: column;
            gap: 5px;
            /* 【修复】减小列表项之间的间距 */
        }

        .preset-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            /* background-color: #f0f0f0; */
            /* <-- 移除或注释掉这一行 */
            border-radius: 12px;
            gap: 15px;
        }

        /* 【新增】只为禁词项添加灰色背景 */
        .preset-list-item.forbidden-words-item {
            background-color: #f0f0f0;
        }

        .preset-list-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ddd;
            object-fit: cover;
            cursor: pointer;
            flex-shrink: 0;
        }

        .preset-list-name {
            flex-grow: 1;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .preset-list-actions {
            display: flex;
            align-items: center;
            /* 【核心修改】减小图标间距，并让整体靠右 */
            gap: 2px !important;
            margin-left: auto;
        }

        /* 【核心修改】将按钮样式移出，并为开关腾出空间 */
        .preset-list-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 编辑/创建角色页面表单 --- */
        /* --- 【【【核心新增】】】预设列表项 --- */
        #preset-page-offline {
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 列表项之间的间距 */
        }

        .preset-list-item-offline {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #ffffff;
            border-radius: 12px;
            gap: 10px;
            border: 1px solid #e0e0e0;
        }

        .preset-list-item-offline .drag-handle {
            cursor: grab;
            flex-shrink: 0;
            color: #ccc;
        }

        .preset-list-item-offline .preset-list-name {
            flex-grow: 1;
        }

        .preset-list-item-offline .preset-list-actions .switch {
            transform: scale(0.85);
            /* 稍微缩小开关以适应布局 */
        }

        .preset-editor-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
            /* 表单组之间的间距 */
        }

        .preset-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .preset-input-box,
        .preset-textarea-box,
        .preset-select-wrapper {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: #fff;
        }

        .preset-textarea-box {
            width: 100%;
            box-sizing: border-box;
            min-height: 185px;
            max-height: 185px;
            overflow-y: auto;
            /* 样式统一化 */
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: #fff;
            resize: vertical;
            /* 允许用户垂直拖动调整大小 */
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .preset-input-box,
        .preset-textarea-box {
            position: relative;
            /* 为内部的span和input提供定位基准 */
        }

        #forbidden-words-content-input {
            width: 100%;
            box-sizing: border-box;
            min-height: 200px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 10px;
            /* --- 【修改】调大实际输入文字的大小 --- */
            font-size: 16.8px !important;
            resize: vertical;
        }

        /* --- 【新增】单独控制提示文字的样式 --- */
        #forbidden-words-content-input::placeholder {
            font-size: 15px;
            /* 将提示文字调得更大 */
            color: #bbb;
            /* 可以顺便调整一下颜色，让它浅一点 */
        }

        .preset-select-wrapper select {
            width: 100%;
            border: none;
            background: none;
            font-size: 15px;
            outline: none;
        }

        .preset-editable-text:empty::before {
            content: '点击输入内容...';
            color: #aaa;
            font-style: italic;
            font-size: 15px;
            /* 【新增】调整占位符文字的大小 */
        }

        /* --- 原地编辑输入框样式 (更新后) --- */
        .preset-inplace-editor {
            width: 100%;
            height: 100%;
            font-size: 15px;
            border: none;
            outline: none;
            background: transparent;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        /* --- 【【【核心新增】】】模拟原地编辑的 Textarea 样式 --- */
        .styled-textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            /* 允许用户垂直拖动调整大小 */
            /* 样式统一化 */
            border: 1px solid #ccc;
            background-color: #fff;
            color: #333;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* 获得焦点时：边框变色提示 */
        .styled-textarea:focus {
            border-color: #aaa;
        }

        /* 为所有这些输入框设置统一的占位符样式 */
        .styled-textarea::placeholder {
            color: #aaa;
            font-style: italic;
            font-size: 15px;
        }


        /* --- 关联其他 下拉框 --- */
        .preset-dropdown-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            width: 70%;
            /* 【修复】将宽度设置为父容器的一半 */
        }

        .preset-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 13px 12px;
            /* 【修复】增加上下内边距，拉高整体高度 */
            cursor: pointer;
            background-color: #fff;
        }

        .preset-dropdown-arrow {
            transform: rotate(0deg);
            /* 默认是正三角 */
            transition: transform 0.2s ease-in-out;
        }

        .preset-dropdown-container.expanded .preset-dropdown-arrow {
            transform: rotate(180deg);
            /* 展开时旋转为倒三角 */
        }

        .preset-dropdown-list {
            max-height: 0;
            overflow-y: auto;
            transition: max-height 0.3s ease-in-out;
            background-color: #fafafa;
        }

        .preset-dropdown-container.expanded .preset-dropdown-list {
            max-height: 98px;
            /* 约等于两个item的高度+padding */
            border-top: 1px solid #ccc;
        }

        .preset-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 12px;
            /* 【修复】增加上下内边距，拉高整体高度 */
            border-bottom: 1px solid #eee;
        }

        .preset-dropdown-item label {
            transform: translateY(4.6px);
            /* 【修复】将文字整体下移1像素，实现视觉上的垂直居中 */
        }

        .preset-dropdown-item:last-child {
            border-bottom: none;
        }

        .preset-dropdown-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #353333;
            /* 美化勾选框颜色 */
        }

        /* 
        ===================================================================
         【全新 V2.03】对方/我的信息页面专属样式
        ===================================================================
        */
        .info-screen-form {
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            gap: 28px;
            /* 各个板块之间的间距 */
        }

        .info-avatar-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            /* 与下方人设框的间距 */
        }

        .info-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background-color: #eee;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .info-name {
            font-size: 16px;
            /* 将字号从20px改为18px */
            font-weight: 550;
            /* 稍微加粗一点以保持清晰 */
            color: #333;
            padding: 5px;
            /* 增加一些内边距，方便点击 */
            border-radius: 6px;
            /* 增加圆角，编辑时更好看 */
        }

        .info-name:focus {
            outline: none;
            background-color: #f0f2f5;
            /* 编辑时给一个背景色提示 */
        }

        .info-textarea {
            width: 100%;
            box-sizing: border-box;
            min-height: 120px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-size: 14px !important;
            /* 根据要求设置默认字体大小 */
            resize: vertical;
            background-color: #f9f9f9;
        }

        .info-textarea:focus {
            outline: none;
            border-color: #aaa;
            background-color: #fff;
        }

        /* 表情包库列表 */
        .sticker-pack-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sticker-pack-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1.5px solid #dcdcdc;
            border-radius: 12px;
            background-color: #fff;
            cursor: pointer;
        }

        .sticker-pack-name {
            flex-grow: 1;
            font-size: 16px;
            color: #444;
        }

        .sticker-pack-name.default-pack {
            color: #888;
            /* 默认包的字体颜色浅一些 */
        }

        .sticker-pack-actions button {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .add-sticker-pack-btn svg {
            fill: #515151;
        }

        /* 
        ===================================================================
         【全新 V2.06 最终修复版】表情包库新布局样式
        ===================================================================
        */
        .sticker-pack-list .sticker-pack-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
            border: none;
            background-color: transparent;
        }

        /* 【核心修复】为名字框和添加按钮容器设置统一的宽度，与关联框一致 */
        .sticker-pack-name-wrapper {
            flex: 1;
            /* 占据所有可用空间 */
            min-width: 0;
            /* 允许flex item收缩 */
        }

        .sticker-pack-name {
            display: block;
            /* 确保它能撑满父容器 */
            width: 100%;
            box-sizing: border-box;
            /* 确保 padding 不会撑大盒子 */
            font-size: 16px;
            color: #444;
            height: 48px;
            padding: 0 15px;
            line-height: 48px;
            border: 1.5px solid #dcdcdc;
            border-radius: 12px;
            background-color: #fff;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sticker-pack-name:empty::before {
            content: " ";
        }

        .sticker-pack-name.default-pack {
            color: #888;
        }

        .sticker-pack-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            /* 【核心新增】让所有动作区宽度统一且内容靠右 */
            width: 90px;
        }

        .sticker-pack-actions .delete-sticker-pack-btn,
        .sticker-pack-actions .add-sticker-pack-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            /* 防止被压缩 */
        }

        /* 【核心修复】使用容器包裹勾选框，并替换为SVG方案 */
        .sticker-pack-checkbox-wrapper {
            width: 18px;
            height: 18px;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .sticker-pack-checkbox-wrapper.checked {
            background-color: #353333;
            border-color: #353333;
        }

        /* 默认隐藏SVG */
        .sticker-pack-checkbox-wrapper svg {
            display: none;
        }

        /* 选中时显示SVG */
        .sticker-pack-checkbox-wrapper.checked svg {
            display: block;
        }

        /* 
        ===================================================================
         【全新 V2.06 修复版】管理表情页面专属样式
        ===================================================================
        */
        .manage-stickers-header-actions {
            display: flex;
            align-items: center;
            /* 【新增】将按钮组整体左移 */
            position: relative;
            right: 8px;
        }

        .delete-mode-btn {
            background-color: #333;
            color: white;
            border: none;
            /* 【修改】进一步缩小按钮 */
            padding: 4px 10px;
            border-radius: 7px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-left: 8px;
            /* 【新增】为按钮添加过渡动画 */
            transition: opacity 0.2s, transform 0.2s;
            transform: scale(0.95);
            /* 初始稍微缩小 */
        }

        .delete-mode-btn#cancel-sticker-delete-btn {
            background-color: #e5e5e5;
            color: #333;
        }

        .sticker-management-container {
            padding: 15px 20px;
        }

        .sticker-pack-editable-title {
            font-size: 16px;
            font-weight: 550;
            color: #333;
            padding: 5px;
            border-radius: 6px;
            outline: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .sticker-management-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            /* 强制4列 */
            gap: 15px;
        }

        .manage-sticker-item-wrapper {
            position: relative;
            aspect-ratio: 1 / 1;
        }

        /* 【核心修复】为管理页的表情项和添加按钮设置独立的、更小的样式 */
        #manage-stickers-screen .sticker-item,
        #manage-stickers-screen .add-sticker-btn-wrapper {
            width: 100%;
            height: 100%;
            /* 继承聊天面板的公共样式 */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fefefe;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            -webkit-touch-callout: none;
            user-select: none;
        }

        #manage-stickers-screen .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        /* 确保添加按钮不会过大 */
        #manage-stickers-screen .add-sticker-btn-wrapper {
            transform: scale(1);
            /* 覆盖掉可能继承的缩放 */
        }

        .sticker-delete-checkbox {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            border: 1.5px solid #ccc;
            border-radius: 50%;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            /* 默认隐藏 */
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 5;
        }

        /* 【核心修复】当管理页面处于删除模式时，才显示勾选框 */
        #manage-stickers-screen.delete-mode .sticker-delete-checkbox {
            opacity: 1;
            pointer-events: auto;
        }

        .sticker-delete-checkbox.checked {
            background-color: #353333;
            border-color: #353333;
        }

        /* --- 【全新】聊天设置页输入框统一样式 --- */
        .settings-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            /* 输入框和单位之间的间距 */
        }

        .settings-value-input {
            /* 移除旧的占满全行的样式 */
            flex-grow: 0;
            /* 设定一个固定的、较短的宽度 */
            width: 70px;
            /* 文字居中显示 */
            text-align: center;
        }

        .settings-unit-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
    </style>
</head>

<body>

    <!-- =================================================================== -->
    <!-- 2. HTML 结构区 -->
    <!-- =================================================================== -->
    <div id="phone-wrapper">
        <div id="phone-screen">
            <!-- 【新增】手机顶部状态栏 -->
            <div id="status-bar">
                <div id="status-bar-time">00:00</div>
                <div id="status-bar-icons">
                    <!-- 【核心修改】为这个天气图标添加一个唯一的ID -->
                    <svg id="status-bar-weather-icon" t="1757565492604" class="icon" viewBox="0 0 1239 1024"
                        version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="106700" width="22" height="22">
                        <path
                            d="M717.865062 899.486106l-39.910605-23.536026 36.84055-25.582694c13.303501-8.18647 18.420326-28.652544 7.163494-45.025485-9.210163-12.279706-28.653773-15.349555-41.957274-6.139802l-24.560333 17.396224 0-31.722492c0-15.349555-14.326886-30.699213-31.723827-30.699213s-31.723827 15.349555-31.723827 30.699213l0 36.839023-27.630387-19.44279c-16.373555-9.209754-33.770496-4.093235-42.980659 9.209754-10.233446 15.349555-6.140109 34.792448 9.210163 44.002202l34.793882 21.489459-41.957274 27.629261c-13.303501 9.209754-18.420326 27.629261-8.186778 41.955533 6.140109 9.209754 16.373555 13.302989 25.583718 13.302989 6.140109 0 11.256832-1.023283 17.396941-5.116518l33.770496-22.512742 0 36.839023c0 16.372941 14.326886 30.699213 31.723827 30.699213s31.723827-14.326272 31.723827-30.699213l0-35.815717 28.653773 19.44279c6.140109 3.069952 12.280218 4.093235 16.373555 4.093235 10.233446 0 19.44361-4.093235 25.583718-14.326272C736.285389 927.115366 733.215334 909.719245 717.865062 899.486106L717.865062 899.486106zM962.445517 867.76361l-24.560333-17.396224 23.53705-13.302989c11.256832-9.209754 13.303501-25.582694 5.116723-36.839014-6.140109-11.25632-23.53705-15.349555-34.793882-7.163187l-13.303501 8.18647 0-16.372899c0-13.302989-12.280218-24.559309-26.607104-24.559309-13.303501 0-24.560333 11.25632-24.560333 24.559309l0 19.442818-16.373555-10.233037c-11.256832-5.116518-27.630387-3.069952-36.84055 8.18647-6.140109 12.279706-3.070054 28.652544 9.210163 36.839014l20.466995 12.279706-24.560333 18.419507c-12.280218 8.18647-16.373555 23.536026-8.186778 35.815731 4.09344 7.163187 13.303501 10.233037 22.513664 10.233037 4.09344 0 9.210163-1.023283 12.280218-3.069952l21.490381-14.326272 0 22.512736c0 12.279706 11.256832 24.559309 24.560333 24.559309 14.326886 0 26.607104-12.279706 26.607104-24.559309l0-21.48943 15.350272 12.279706c5.116723 2.046566 9.210163 3.069952 14.326886 3.069952 8.186778 0 17.396941-3.069952 21.490381-11.25632C976.772403 890.276352 973.702349 875.95008 962.445517 867.76361L962.445517 867.76361zM413.930394 867.76361l-24.560333-17.396224 22.513664-13.302989c12.280218-9.209754 15.350272-25.582694 6.140109-36.839014-7.163494-11.25632-23.53705-15.349555-35.817267-7.163187l-13.303501 8.18647 0-16.372899c0-13.302989-11.256832-24.559309-24.560333-24.559309-15.350272 0-27.630387 11.25632-27.630387 24.559309l0 19.442818-14.326886-10.233037c-12.280218-5.116518-28.653773-3.069952-35.817267 8.18647-8.186778 12.279706-4.09344 28.652544 7.163494 36.839014l21.490381 12.279706-25.583718 18.419507c-11.256832 8.18647-15.350272 23.536026-7.163494 35.815731 5.116723 7.163187 12.280218 10.233037 20.466995 10.233037 5.116723 0 11.256832-1.023283 14.326886-3.069952l19.44361-14.326272 0 22.512736c0 12.279706 12.280218 24.559309 27.630387 24.559309 13.303501 0 24.560333-12.279706 24.560333-24.559309l0-21.48943 16.373555 12.279706c5.116723 2.046566 9.210163 3.069952 14.326886 3.069952 8.186778 0 16.373555-3.069952 21.490381-11.25632C429.280666 890.276352 426.210611 875.95008 413.930394 867.76361L413.930394 867.76361zM984.959181 210.80105c-11.256832 0-22.513664 1.023283-35.817267 3.069952-38.887219-119.726797-169.875968-213.871002-313.144832-213.871002l-2.046698 0c-218.996736 1.023283-319.284941 141.216256-353.055437 254.803251-11.256832-1.023283-22.513664-2.046566-34.793882-2.046566-86.984704 0-165.782528 42.978816-212.856627 117.68023l-1.023386 1.023283c-33.770496 63.444992-68.564378 205.684531 54.237491 298.805453 38.887219 29.67593 94.148096 31.722496 115.638477 31.722496l1.023349 0 814.585923 0 10.233491 0c72.657818-13.302989 209.786573-85.957734 209.786573-249.686733C1237.726413 319.271526 1125.158093 210.80105 984.959181 210.80105L984.959181 210.80105zM1010.543002 588.40105l-807.422479 0c0 0 0 0-1.023386 0-20.466995 0-41.957274-5.116518-48.097382-9.209754-30.700442-22.512742-42.980659-52.18857-39.910605-92.097536 2.046669-30.699213 16.373555-55.258522 17.396941-59.351757 34.793882-57.30519 93.124813-63.444992 114.615091-63.444992 22.513664 0 36.84055 6.139802 41.957274 10.233037 16.373555 12.279706 37.863936 14.326272 58.330931 8.18647 16.373555-8.18647 30.700442-27.629261 32.747213-46.048768 2.046669-24.559309 28.653773-223.080755 254.813901-224.104038l2.046698 0c117.685146 0 209.786573 93.120819 213.880013 170.892186 0 19.44279 8.186778 34.792448 23.53705 45.025485 14.326886 11.25632 32.747213 12.279706 50.144154 8.18647 20.466995-8.18647 41.957274-12.279706 61.400986-12.279706 86.984704 0 140.19881 67.538227 140.19881 127.913267C1125.158093 553.608704 1033.056666 583.284531 1010.543002 588.40105z"
                            p-id="106701" fill="#353333"></path>
                    </svg>
                    <svg id="status-bar-battery-icon" t="1757369903873" class="icon" viewBox="0 0 1024 1024"
                        version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33293" width="22" height="22">
                        <path
                            d="M984.2 434.8c-5-2.9-8.2-8.2-8.2-13.9v-99.3c0-53.6-43.9-97.5-97.5-97.5h-781C43.9 224 0 267.9 0 321.5v380.9C0 756.1 43.9 800 97.5 800h780.9c53.6 0 97.5-43.9 97.5-97.5v-99.3c0-5.8 3.2-11 8.2-13.9 23.8-13.9 39.8-39.7 39.8-69.2v-16c0.1-29.6-15.9-55.5-39.7-69.3zM912 702.5c0 12-6.2 19.9-9.9 23.6-3.7 3.7-11.7 9.9-23.6 9.9h-781c-11.9 0-19.9-6.2-23.6-9.9-3.7-3.7-9.9-11.7-9.9-23.6v-381c0-11.9 6.2-19.9 9.9-23.6 3.7-3.7 11.7-9.9 23.6-9.9h780.9c11.9 0 19.9 6.2 23.6 9.9 3.7 3.7 9.9 11.7 9.9 23.6v381z"
                            p-id="33294" fill="#515151"></path>
                        <path
                            d="M736 344v336c0 8.8-7.2 16-16 16H112c-8.8 0-16-7.2-16-16V344c0-8.8 7.2-16 16-16h608c8.8 0 16 7.2 16 16z"
                            p-id="33295" fill="#353333"></path>
                    </svg>
                </div>
            </div>

            <div id="home-screen" class="screen active">
                <!-- 【新增】顶部灵动岛 -->
                <div id="dynamic-island">
                    <div class="island-content"></div>
                </div>

                <!-- 【新增】用户信息卡片 -->
                <div id="user-card">
                    <!-- 背景层 -->
                    <div id="user-card-background" class="clickable-area"></div>

                    <!-- 【全新】前景层裁剪容器 (实现弧形的关键) -->
                    <div id="user-card-foreground-clipper">
                        <div id="user-card-foreground-content">
                            <!-- 文字信息 -->
                            <div id="user-info-text">
                                <p id="user-id">Name</p>
                                <p id="user-handle">@...</p>
                                <p id="user-bio">自定义文案</p>
                                <div id="user-location">
                                    <svg t="1757547877892" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="89228" width="15" height="15">
                                        <path
                                            d="M839.8 281.4c-17.9-42.3-43.5-80.3-76.1-112.9-32.6-32.6-70.6-58.2-112.9-76.1-43.8-18.6-90.4-28-138.3-28-48 0-94.5 9.4-138.3 27.9-42.3 17.9-80.3 43.5-112.9 76.1-32.6 32.6-58.2 70.6-76.1 112.9-18.5 43.8-27.9 90.3-27.9 138.3 0 81.3 57.4 196.2 170.5 341.5C410.3 867.3 494.1 952 495 952.8c4.6 4.7 11 7.3 17.5 7.3 6.6 0 12.9-2.6 17.5-7.3 0.8-0.8 84.6-85.6 167.2-191.6C810.4 616 867.8 501.1 867.8 419.7c0-47.9-9.4-94.5-28-138.3zM510.7 555.9c-71.9 0-130.4-58.5-130.4-130.4s58.5-130.4 130.4-130.4 130.4 58.5 130.4 130.4-58.5 130.4-130.4 130.4z"
                                            p-id="89229" fill="#515151"></path>
                                    </svg>
                                    <span>...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 【修改】头像 (img -> div) -->
                    <div id="user-card-avatar" class="clickable-area">
                        <svg t="1757570711263" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="118953" width="35" height="35">
                            <path
                                d="M959.791 258.732c-25.828-25.828-56.262-37.478-91.391-37.478H755.786l-25.828-68.002c-7.044-16.436-18.784-30.524-35.13-42.173-16.436-11.74-35.13-18.784-51.566-18.784H385.343c-18.784 0-35.13 7.044-51.565 18.784-16.436 11.74-28.176 25.828-35.13 42.173l-28.176 68.002H155.6c-35.13 0-65.653 11.74-91.391 37.478C38.38 284.56 26.73 314.994 26.73 350.214v452.532c0 35.13 11.74 65.654 37.478 91.482 25.828 25.828 56.262 37.477 91.391 37.477h712.71c35.13 0 65.653-11.74 91.39-37.477 25.829-25.828 37.479-56.262 37.479-91.482V350.214c0.09-35.22-11.56-65.654-37.388-91.482zM511.955 781.614c-117.22 0-213.397-96.088-213.397-213.397 0-117.22 96.087-213.398 213.397-213.398s213.397 96.088 213.397 213.398-96.178 213.397-213.397 213.397z m0 0"
                                p-id="118954" fill="#353333"></path>
                            <path
                                d="M511.955 427.607c-79.742 0-143.048 63.306-143.048 143.048s63.306 143.047 143.048 143.047 143.047-63.305 143.047-143.047-63.305-143.048-143.047-143.048z m0 0"
                                p-id="118955" fill="#353333"></path>
                        </svg>
                    </div>
                </div>

                <!-- 【全新】纪念日组件 -->
                <div id="days-matter-widget">
                    <!-- 上半部分深色区域 -->
                    <div class="widget-top-pane">
                        <span class="days-matter-title" style="display: none;">XXXX 已经</span>
                    </div>
                    <!-- 下半部分浅色区域 -->
                    <div class="widget-bottom-pane">
                        <span class="days-matter-content">暂无纪念日</span>
                        <span class="days-matter-date" style="display: none;">起始日: XXXX-XX-XX</span>
                    </div>
                </div>

                <!-- 【新增】中间区域的App图标 -->
                <div id="main-apps-container">
                    <!-- 序号①: 聊天 (保留功能) -->
                    <div class="new-app-icon app-icon" data-target="chat-list-screen">
                        <svg t="1757553299427" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="94520" width="33.6" height="33.6">
                            <path
                                d="M678.115556 361.81333300000006c11.377778 0 22.755556 0 34.133333 2.275556C682.666667 227.55555600000002 534.755556 125.15555599999999 366.364444 125.15555599999999c-188.871111 0-341.333333 127.43111099999999-341.333333 291.271111 0 93.297778 52.337778 170.666667 136.533333 229.831111l-34.133333 102.4 120.60444500000001-59.164445c43.235556 9.102222 77.368889 18.204444 120.604444 18.204445 11.377778 0 20.48 0 31.857778-2.275556-6.826667-22.755556-11.377778-47.786667-11.377778-72.817778 0-147.911111 127.43111099999999-270.791111 288.99555599999997-270.791111z m-182.044445-91.022222c25.031111 0 43.235556 15.928889 43.235556 43.235556 0 25.031111-15.928889 43.235556-43.235556 43.235555-25.031111 0-52.337778-18.204444-52.337778-43.235555 0-27.306666999999997 25.031111-43.235556 52.337778-43.235556z m-241.208889 84.195556c-25.031111 0-52.337778-18.204444-52.337778-43.235556 0-25.031111 25.031111-43.235556 52.337778-43.235555 25.031111 0 43.235556 15.928889 43.235556 43.235555s-15.928889 43.235556-43.235556 43.235556z m0 0"
                                fill="#ffffff" p-id="94521"></path>
                            <path
                                d="M992.1422220000001 630.328889c0-136.533333-136.533333-248.03555600000004-291.271111-248.03555600000004-163.84 0-291.271111 111.502222-291.271111 248.03555600000004s127.43111099999999 248.03555600000004 291.271111 248.035555c34.133333 0 68.266667-9.102222 102.4-18.204444l93.297778 52.337778-25.031111-86.471111c68.266667-50.062222 120.604444-120.604444 120.604444-195.697778z m-386.844444-43.235556c-15.928889 0-34.133333-15.928889-34.133334-34.133333 0-15.928889 18.204444-34.133333 34.133334-34.133333 25.031111 0 43.235556 18.204444 43.235555 34.133333s-15.928889 34.133333-43.235555 34.133333z m188.871111 0c-15.928889 0-34.133333-15.928889-34.133333-34.133333 0-15.928889 18.204444-34.133333 34.133333-34.133333 25.031111 0 43.235556 18.204444 43.235555 34.133333s-18.204444 34.133333-43.235555 34.133333z m0 0"
                                fill="#ffffff" p-id="94522"></path>
                        </svg>
                    </div>
                    <!-- 论坛 -->
                    <div class="new-app-icon">
                        <svg t="1757553378424" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="100419" width="32" height="32">
                            <path
                                d="M278.1184 735.0272h1.4336A1031.3728 1031.3728 0 0 0 573.44 582.2464a1242.3168 1242.3168 0 0 0 130.2528-106.7008c17.408-16.384 32.768-31.9488 46.2848-46.6944 16.7936-18.2272 30.72-34.816 41.984-49.152 5.7344-7.3728 10.8544-14.1312 15.1552-20.48l8.6016-12.288c2.8672-4.3008 5.5296-8.3968 8.192-12.6976A346.29632 346.29632 0 1 0 262.144 739.328l14.336-3.8912zM860.16 512q-10.4448 11.6736-21.7088 23.3472l-5.12 5.3248-20.48 20.48-7.7824 7.5776-20.48 19.2512-11.0592 10.0352-19.0464 16.7936-14.7456 12.4928-16.9984 14.1312-20.48 15.7696-13.5168 10.6496q-17.2032 13.1072-34.816 25.8048t-35.6352 24.7808l-14.336 9.4208-20.48 13.7216-18.6368 11.4688-16.1792 9.8304-21.504 12.4928-12.9024 7.168-23.7568 12.6976-10.0352 5.12-25.8048 12.9024-6.9632 3.2768-27.8528 12.6976-4.096 1.8432c-10.0352 4.3008-20.48 8.3968-29.9008 12.288a346.112 346.112 0 0 0 503.808-308.4288 337.5104 337.5104 0 0 0-4.096-51.8144c-6.9632 8.3968-14.336 16.7936-21.9136 25.1904z"
                                fill="#ffffff" p-id="100420"></path>
                            <path
                                d="M942.08 189.0304c-16.1792-22.528-48.3328-46.8992-112.64-46.8992a305.9712 305.9712 0 0 0-39.3216 2.6624 34.05824 34.05824 0 0 0 4.096 67.9936h4.7104a242.0736 242.0736 0 0 1 30.9248-2.2528c28.2624 0 48.3328 6.3488 56.9344 18.432 12.9024 18.0224 5.12 55.5008-22.1184 104.0384-3.072 5.5296-6.5536 11.264-10.24 17.2032s-6.7584 10.8544-10.6496 16.5888A1033.216 1033.216 0 0 1 593.92 610.304a1066.1888 1066.1888 0 0 1-304.7424 157.696h-3.072l-18.8416 4.9152-20.48 4.3008a276.8896 276.8896 0 0 1-52.6336 5.7344c-31.744 0-50.3808-7.9872-57.5488-18.2272-13.7216-18.0224-3.6864-58.9824 24.9856-109.3632A34.01728 34.01728 0 1 0 102.4 621.7728c-56.32 97.0752-42.3936 153.3952-20.48 184.32 17.2032 23.9616 49.7664 47.104 112.4352 47.104a409.6 409.6 0 0 0 111.2064-18.2272h2.8672l17.2032-5.5296c6.7584-2.2528 13.5168-4.096 20.48-6.5536a1200.7424 1200.7424 0 0 0 286.72-155.4432 1204.224 1204.224 0 0 0 241.664-225.28l12.9024-16.9984q6.3488-8.8064 12.288-17.408c57.5488-86.2208 80.6912-165.2736 42.3936-218.7264z"
                                fill="#ffffff" p-id="100421"></path>
                            <path
                                d="M276.6848 735.4368h1.4336-1.4336l-14.336 3.8912zM417.9968 829.6448l27.8528-12.6976zM384.2048 843.776c9.8304-3.8912 20.48-7.9872 29.9008-12.288-10.0352 4.096-20.0704 8.192-29.9008 12.288zM752.8448 614.4l19.0464-16.7936zM563.2 753.2544l18.6368-11.4688zM602.9312 728.064l14.336-9.4208zM720.896 641.8432l16.9984-14.1312zM782.7456 588.3904l20.48-19.2512zM525.5168 775.5776l21.504-12.4928zM832.3072 540.2624l-20.48 20.48zM488.8576 795.4432l23.1424-12.6976zM453.0176 813.4656l25.8048-12.9024zM687.7184 668.2624l13.5168-10.6496z"
                                fill="#ffffff" p-id="100422"></path>
                        </svg>
                    </div>
                    <!-- 世界书 (保留功能) -->
                    <div class="new-app-icon app-icon" data-target="world-book-screen">
                        <svg t="1758207819060" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8038" width="39" height="39">
                            <path
                                d="M696.25 836.67H291.44c-55.51 0-100.67-45.16-100.67-100.67s45.16-100.67 100.67-100.67H664c11.05 0 20 8.95 20 20s-8.95 20-20 20H291.44c-33.46 0-60.67 27.22-60.67 60.67s27.22 60.67 60.67 60.67h404.81c24.31 0 44.09-19.78 44.09-44.09v-481c0-11.05 8.95-20 20-20s20 8.95 20 20v481.01c0 46.37-37.72 84.09-84.09 84.09z"
                                fill="#ffffff" p-id="8039"></path>
                            <path
                                d="M684 658H255.78L191 729V262.19c0-44.29 35.9-80.19 80.19-80.19H653.5c16.85 0 30.5 13.66 30.5 30.5V658zM680 756H292c-11.05 0-20-8.95-20-20s8.95-20 20-20h388c11.05 0 20 8.95 20 20s-8.95 20-20 20z"
                                fill="#ffffff" p-id="8040"></path>
                        </svg>
                    </div>
                    <!-- 情侣空间 -->
                    <div class="new-app-icon">
                        <svg t="1758208324049" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="36005" width="33" height="33">
                            <path
                                d="M316.1 543.2H72.7c-5.1 0-8.5-3.4-8.5-8.5v-22.1c0-5.1 3.4-8.5 8.5-8.5H134c6.8 0 10.2-8.5 6.8-13.6-23.8-45.8-37.4-90-37.4-137.5 0-125.6 97-222.4 224.6-222.4 66.4 0 132.8 28.9 177 81.5 5.1 3.4 10.2 3.4 13.6 0 44.2-49.2 110.6-78.1 177-78.1 125.9 0 224.6 96.7 224.6 222.4 0 64.5-25.5 125.6-69.8 186.7-1.7 1.7-3.4 3.4-6.8 3.4H668.3c-3.4 0-5.1 1.7-6.8 3.4l-45.9 56c-5.1 6.8-13.6 3.4-15.3-3.4l-57.9-286.9c-1.7-10.2-13.6-10.2-17-1.7l-68.1 219c-3.4 8.5-13.6 8.5-17 0l-40.8-122.2c-1.7-8.5-11.9-8.5-15.3-1.7l-68.1 134.2z"
                                fill="#ffffff" p-id="36006"></path>
                            <path
                                d="M950.8 583.9c5.1 0 8.5 3.4 8.5 10.2v22.1c0 5.1-3.4 8.5-8.5 8.5H782.3c-3.4 0-5.1 1.7-6.8 3.4-56.1 57.7-125.9 120.5-207.6 191.8l-51.1 50.9c-1.5 1.6-3.7 2.6-6 2.6s-4.4-0.9-6-2.6l-51-50.9c-95.3-83.2-175.3-154.5-234.9-220.7-5.1-6.8 0-15.3 6.8-15.3h108.9c3.4 0 6.8-1.7 8.5-5.1l37.4-78.1c1.7-6.8 11.9-6.8 15.3 0L440 622.9c3.4 6.8 13.6 6.8 17 0l59.6-154.5c3.4-6.8 15.3-6.8 17 1.7L588 668.7c1.7 6.8 10.2 8.5 15.3 3.4l68.1-84.9c1.7-1.7 3.4-3.4 6.8-3.4h272.6z"
                                fill="#ffffff" p-id="36007"></path>
                        </svg>
                    </div>
                </div>

                <!-- 【全新】底部两个自定义矩形条 -->
                <div id="capsule-widgets-container">
                    <div class="capsule-widget">
                        <div class="capsule-icon clickable-area"></div>
                        <p class="capsule-text clickable-area"></p>
                    </div>

                </div>

                <!-- 【位置调整】黑胶唱片/音乐组件 -->
                <div id="music-widget">
                    <div id="record-outer">
                        <div id="record-inner" class="clickable-area"></div>
                    </div>
                </div>

                <!-- 【新增】底部Dock栏 -->
                <div id="bottom-dock">
                    <!--  设置 (保留功能) -->
                    <div class="new-app-icon app-icon" data-target="main-settings-screen">
                        <svg t="1757546076600" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="63192" width="28" height="28">
                            <path
                                d="M424.680727 94.301091a426.216727 426.216727 0 0 1 174.545455-0.093091 170.356364 170.356364 0 0 0 83.409454 122.135273 170.356364 170.356364 0 0 0 147.549091 11.170909 426.077091 426.077091 0 0 1 87.133091 151.226182 170.356364 170.356364 0 0 0-64 133.213091 170.356364 170.356364 0 0 0 64.093091 133.306181 428.637091 428.637091 0 0 1-87.272727 151.133091 170.356364 170.356364 0 0 0-147.502546 11.170909 170.356364 170.356364 0 0 0-83.362909 122.042182 426.356364 426.356364 0 0 1-174.545454 0.139637 170.356364 170.356364 0 0 0-83.409455-122.181819 170.356364 170.356364 0 0 0-147.502545-11.170909 426.216727 426.216727 0 0 1-87.179637-151.179636 170.356364 170.356364 0 0 0 64-133.259636A170.356364 170.356364 0 0 0 106.589091 378.693818a428.497455 428.497455 0 0 1 87.272727-151.179636 170.356364 170.356364 0 0 0 147.456-11.170909 170.356364 170.356364 0 0 0 83.362909-122.042182zM512 640a128 128 0 1 0 0-256 128 128 0 0 0 0 256z"
                                fill="#ffffff" p-id="63193"></path>
                        </svg>
                    </div>
                    <!-- 相机 -->
                    <div class="new-app-icon">
                        <svg t="1757546170923" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="65746" width="26.8" height="26.8">
                            <path
                                d="M 694.08 549.76 c 0 92.8 -75.52 168.32 -168.32 168.32 s -168.32 -75.52 -168.32 -168.32 c 0 -93.44 75.52 -168.64 168.32 -168.64 s 168.32 75.2 168.32 168.64 Z"
                                fill="#ffffff" p-id="65747"></path>
                            <path
                                d="M 917.76 239.36 h -119.36 L 646.4 152 c -16.64 -12.8 -27.84 -19.84 -48.96 -19.84 h -163.84 c -21.44 0 -42.24 7.04 -59.52 20.48 L 219.84 239.36 h -124.8 C 54.08 239.36 20.48 272.96 20.48 313.92 v 524.8 c 0 40.96 33.6 74.56 74.56 74.56 h 822.72 A 74.56 74.56 0 0 0 992 838.72 V 313.92 c 0 -40.96 -32.96 -74.56 -74.24 -74.56 Z M 525.76 781.44 c -130.88 0 -236.8 -106.24 -236.8 -236.8 s 106.24 -236.48 236.8 -236.48 c 130.88 0 236.8 106.24 236.8 236.48 c 0 130.56 -105.92 236.8 -236.8 236.8 Z"
                                fill="#ffffff" p-id="65748"></path>
                            <path
                                d="M 694.08 549.76 c 0 92.8 -75.52 168.32 -168.32 168.32 s -168.32 -75.52 -168.32 -168.32 c 0 -93.44 75.52 -168.64 168.32 -168.64 s 168.32 75.2 168.32 168.64 Z"
                                fill="#ffffff" p-id="65749"></path>
                            <path
                                d="M 694.08 549.76 c 0 92.8 -75.52 168.32 -168.32 168.32 s -168.32 -75.52 -168.32 -168.32 c 0 -93.44 75.52 -168.64 168.32 -168.64 s 168.32 75.2 168.32 168.64 Z"
                                fill="#ffffff" p-id="65750"></path>
                        </svg>
                    </div>
                    <!-- 短信 -->
                    <div class="new-app-icon">
                        <svg t="1757546242938" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="66891" width="32" height="32">
                            <path
                                d="M853.333333 324.266667l-315.733333 243.2v4.266666-4.266666L213.333333 324.266667V554.666667H170.666667V256h725.333333v554.666667H170.666667v-42.666667h682.666666V324.266667z m-34.133333-25.6H247.466667l285.866666 217.6L819.2 298.666667zM85.333333 597.333333h170.666667v42.666667H85.333333v-42.666667z m-42.666666 85.333334h170.666666v42.666666H42.666667v-42.666666z"
                                fill="#ffffff" p-id="66892"></path>
                        </svg>
                    </div>
                    <!--电话 -->
                    <div class="new-app-icon">
                        <svg t="1757546341829" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="68912" width="28" height="28">
                            <path
                                d="M751.616 972.8h-4.608c-110.592-5.632-260.096-109.568-399.872-278.528l-51.712-62.464C155.648 462.848 82.432 297.984 99.84 190.976 111.616 115.2 224.256 51.2 288.768 51.2c31.744 0 43.008 15.872 47.104 25.088 36.352 64.512 81.408 177.152 81.92 217.6v3.072l-1.024 2.56c-8.192 20.992-26.112 31.232-41.984 40.448-20.992 11.776-32.768 19.456-34.304 41.984-0.512 6.656 5.632 37.376 97.792 151.04l39.424 47.616c92.16 109.056 121.344 120.832 128.512 121.856 22.528 3.072 32.768-6.656 48.64-24.064 12.288-13.312 26.112-28.672 48.64-31.744l3.072-0.512 3.072 0.512c40.448 8.704 143.36 74.752 201.728 123.904 8.192 5.632 23.04 22.016 11.264 58.88-18.432 57.856-98.304 143.36-171.008 143.36z"
                                p-id="68913" fill="#ffffff"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="main-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>API 设置</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div class="form-container">
                    <div class="settings-form">
                        <label for="base-url">Base URL:</label>
                        <input type="text" id="base-url" placeholder="例如: https://api.openai.com">
                        <label for="api-key">API Key:</label>
                        <input type="password" id="api-key" placeholder="请输入你的 API Key">
                        <label for="model-select">Model:</label>
                        <select id="model-select"></select>
                        <button class="form-button" id="fetch-models-btn">拉取模型</button>
                        <button class="form-button" id="save-api-settings-btn">保存</button>
                    </div>
                </div>
            </div>

            <div id="chat-list-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="home-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>WeChat</h1>
                    <button id="add-contact-btn" class="add-btn">
                        <svg id="add-contact-icon" t="1757279304410" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="6687" width="18" height="18">
                            <path
                                d="M469.44 469.312v-320a42.88 42.88 0 0 1 42.944-42.624c22.912 0 42.368 19.072 42.368 42.624v320h320a42.88 42.88 0 0 1 42.688 43.008 42.752 42.752 0 0 1-42.624 42.368H554.752v320a41.6 41.6 0 0 1-41.408 42.624h-0.96a42.88 42.88 0 0 1-42.944-42.624v-320H149.376a42.88 42.88 0 0 1-42.624-43.008c0-22.912 19.072-42.368 42.624-42.368h320z"
                                p-id="6688" fill="#515151"></path>
                        </svg>
                    </button>
                </div>

                <!-- 【V4.0 核心修改】主内容区，包含聊天列表和其他未来页面 -->
                <div id="chat-list-main-content" style="flex-grow: 1; position: relative;">
                    <!-- 页面1: Chats -->
                    <div id="chats-page" class="chat-list-page active">
                        <div id="chat-list-container">
                            <div id="pinned-chats-section" class="chat-section-plate" style="display: none;">
                                <!-- 置顶联系人将由JS渲染到这里 -->
                            </div>
                            <div id="unpinned-chats-section" class="chat-section-plate">
                                <!-- 普通联系人将由JS渲染到这里 -->
                            </div>
                        </div>
                    </div>
                    <!-- 页面2: Contacts (空) -->
                    <div id="contacts-page" class="chat-list-page"
                        style="display: none; justify-content: center; align-items: center; color: #888;">此页面待开发</div>
                    <!-- 页面3: Discover (空) -->
                    <div id="discover-page" class="chat-list-page"
                        style="display: none; justify-content: center; align-items: center; color: #888;">此页面待开发</div>
                    <!-- 页面4: Me (全新布局) -->
                    <div id="me-page" class="chat-list-page">
                        <!-- 【【【全新】】】 Me页面的专属内容容器 -->
                        <div id="me-page-content">
                            <!-- 1. 顶部头像、昵称、签名区 -->
                            <div class="me-profile-section">
                                <img id="me-page-avatar"
                                    src="https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp"
                                    class="me-avatar">
                                <p id="me-page-name">Name</p>
                                <p id="me-page-signature">点我输入自定义个性签名...</p>
                            </div>

                            <!-- 2. 【【【核心修改】】】 第一个独立的胶囊容器，只放 Pay and Services -->
                            <div class="me-settings-plate">
                                <div class="me-settings-item">
                                    <div class="me-settings-item-icon">
                                        <svg t="1759055030471" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="1531" width="17" height="17">
                                            <path
                                                d="M372.434824 631.747765a34.063059 34.063059 0 0 1-45.116236-13.793883l-2.228706-4.909176-93.214117-204.528941a17.076706 17.076706 0 0 1 25.660235-20.87153l109.989647 78.305883a50.838588 50.838588 0 0 0 45.477647 5.210353L930.273882 240.941176C837.511529 131.704471 684.815059 60.295529 512 60.295529c-282.774588 0-512 191.006118-512 426.646589 0 128.572235 68.969412 244.284235 176.911059 322.499764 8.673882 6.174118 14.336 16.323765 14.336 27.798589 0 3.794824-0.813176 7.258353-1.807059 10.87247l-23.070118 86.076235c-1.084235 4.035765-2.770824 8.252235-2.770823 12.468706 0 9.426824 7.649882 17.076706 17.076706 17.076706a19.456 19.456 0 0 0 9.84847-3.162353l112.097883-64.692706c8.432941-4.879059 17.347765-7.890824 27.196235-7.890823 5.240471 0 10.300235 0.813176 15.058823 2.258823 52.284235 15.028706 108.694588 23.401412 167.122824 23.401412 282.774588 0 512-191.036235 512-426.676706 0-71.378824-21.142588-138.601412-58.307765-197.692235l-589.522823 340.329412-3.734588 2.138353z"
                                                fill="#0074ff" p-id="1532"></path>
                                        </svg>
                                    </div>
                                    <span class="me-settings-item-title">Pay and Services</span>
                                    <div class="me-settings-item-arrow">
                                        <svg t="1759061190252" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="8595" width="15.5" height="16.5">
                                            <path
                                                d="M761.856 405.504l-255.68-170.432A128 128 0 0 0 307.2 341.568v340.864a128 128 0 0 0 199.008 106.496l255.648-170.432a128 128 0 0 0 0-212.992z"
                                                p-id="8596" fill="#434343"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. 【【【核心修改】】】 第二个独立的胶囊容器，放剩下的两个 -->
                            <div class="me-settings-plate">
                                <!-- 个人 -->
                                <div class="me-settings-item">
                                    <div class="me-settings-item-icon">
                                        <svg t="1759054938631" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="393411" width="21" height="21">
                                            <path
                                                d="M132.656 543.008l356.72 183.68a52.192 52.192 0 0 0 46.272 0l353.536-183.68a33.76 33.76 0 0 0 20.576-31.04c0-13.504-8.128-25.744-20.56-30.96l-26.8-13.616-325.968 169.232c-14.624 7.2-31.68 7.2-46.208 0L160.112 466.992l-27.456 14.016a33.552 33.552 0 0 0-20.608 30.976 33.6 33.6 0 0 0 20.608 31.04z"
                                                fill="#0080ff" p-id="393412"></path>
                                            <path
                                                d="M133.472 362.992L490.24 546.608c14.752 8 32.656 8 47.392 0l353.6-183.616A33.392 33.392 0 0 0 912 332.192c0-13.584-8.288-25.76-20.784-30.848L532.064 117.712a48.832 48.832 0 0 0-45.84 0L133.472 301.344a33.264 33.264 0 0 0 0 61.648z"
                                                fill="#0080ff" p-id="393413"></path>
                                            <path
                                                d="M889.216 661.072l-26.8-14-325.968 169.6c-14.624 7.232-31.68 7.232-46.208 0L160.112 646.624l-27.456 14.464A33.152 33.152 0 0 0 112 691.088v1.584c0.32 13.2 8.368 25.008 20.64 29.984l356.736 183.616a49.632 49.632 0 0 0 46.288 0l353.536-183.616a33.248 33.248 0 0 0 0-61.6z"
                                                fill="#0080ff" p-id="393414"></path>
                                        </svg>
                                    </div>
                                    <span class="me-settings-item-title">个人</span>
                                </div>
                                <!-- 个性装扮 -->
                                <div class="me-settings-item">
                                    <div class="me-settings-item-icon">
                                        <svg t="1759055000181" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="1921" width="18" height="18">
                                            <path
                                                d="M808.533333 364.672v390.144q0 61.653333-4.693333 70.784-6.272 12.074667-18.346667 18.346667-9.173333 4.736-70.826666 4.736H309.845333q-61.653333 0-70.826666-4.736-12.074667-6.272-18.346667-18.346667-4.693333-9.130667-4.693333-70.784V364.672h-85.333334v390.144q0 82.432 14.293334 110.08 18.730667 36.096 54.826666 54.826667 27.605333 14.293333 110.08 14.293333h404.821334q82.474667 0 110.08-14.293333 36.096-18.773333 54.826666-54.869334 14.293333-27.605333 14.293333-110.037333V364.672h-85.333334z m-169.130666 254.933333H385.152a42.666667 42.666667 0 0 0 0 85.333334h254.250667a42.666667 42.666667 0 0 0 0-85.333334z"
                                                fill="#0080FF" p-id="1922"></path>
                                            <path
                                                d="M778.24 89.984H246.314667q-50.133333 0-69.674667 8.064-25.685333 10.624-42.922667 32.384-13.141333 16.554667-26.88 64.768L91.861333 247.466667q-12.586667 43.946667-15.786666 60.672-6.101333 31.573333-0.213334 54.485333 10.88 42.069333 45.866667 65.706667 35.584 24.064 120.661333 15.658666 9.386667-0.938667 18.474667-2.133333 60.586667-8.234667 108.245333-30.208l1.450667-0.64q69.888 43.648 141.653333 43.648 72.917333 0 143.829334-45.013333 66.432 26.624 109.056 32.213333 4.181333 0.554667 8.832 0.981333 86.784 8.405333 124.629333-16.554666 36.309333-23.978667 48.085333-66.432 6.528-23.594667 0.256-56.490667-3.370667-17.621333-16.469333-63.530667l-12.8-44.672q-13.738667-48.213333-26.88-64.768-17.237333-21.76-42.922667-32.384-19.498667-8.064-69.632-8.064zM209.194667 176.938667q3.882667-1.621333 37.12-1.621334H778.24q33.194667 0 37.077333 1.621334 5.12 2.133333 8.618667 6.485333 2.56 3.285333 11.733333 35.2l12.757334 44.714667q18.517333 64.768 16 73.813333-3.2 11.605333-12.8 17.92-12.672 8.362667-69.418667 2.858667-3.242667-0.298667-5.973333-0.64-33.109333-4.352-92.330667-28.416-15.957333-6.485333-35.2-5.546667-17.92 0.896-34.56 11.904-52.010667 34.133333-101.888 34.133333-47.786667 0-97.408-31.317333l-1.962667-1.237333q-19.968-12.928-38.826666-13.482667-16.981333-0.512-37.546667 9.386667l-3.029333 1.493333q-36.096 16.64-84.053334 23.082667-7.509333 1.024-15.402666 1.792-54.4 5.376-64.426667-1.408-8.277333-5.546667-11.093333-16.298667-2.218667-8.746667 15.402666-70.4l14.933334-52.352q9.130667-31.914667 11.733333-35.2 3.498667-4.394667 8.618667-6.485333z"
                                                fill="#0080FF" p-id="1923"></path>
                                        </svg>
                                    </div>
                                    <span class="me-settings-item-title">个性装扮</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 【V4.0 核心修改】底部导航栏 -->
                <div id="chat-list-bottom-nav">
                    <div class="nav-item active" data-page="chats">
                        <!-- 【核心修改】用一个新的div把SVG图标包裹起来，并为红点预留一个span -->
                        <div class="nav-icon-badge-wrapper">
                            <svg t="1759003009966" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="287690" width="28" height="28">
                                <path
                                    d="M420.768 875.84l-160.512 67.264a20.16 20.16 0 0 1-27.904-17.92l-3.744-128.064C128 727.68 64 623.36 64 506.656 64 297.536 269.632 128 523.232 128c253.632 0 459.264 169.536 459.264 378.656 0 209.152-205.632 378.656-459.264 378.656-35.2 0-69.536-3.264-102.464-9.472z"
                                    p-id="287691"></path>
                            </svg>
                            <!-- 这个span就是我们将要用来显示总未读数的红点 -->
                            <span id="chats-total-unread-badge" class="unread-badge" style="display: none;"></span>
                        </div>
                        <span class="nav-title">Chats</span>
                    </div>
                    <div class="nav-item" data-page="contacts">
                        <svg t="1759003224292" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="310446" width="27" height="27">
                            <path
                                d="M530.4 572.2c-82.6 22.5-172.9 93.3-172.9 162.3v88.3H124.3c-14.3 0-25.9-11.6-25.9-25.9v-60.5c0-114.8 228.4-172.7 342.8-172.7 25.4-0.1 56.4 2.8 89.2 8.5z m-172.9-60.4c-85.9 0-155.5-69.6-155.5-155.5s69.6-155.5 155.5-155.5S513 270.4 513 356.3s-69.6 155.5-155.5 155.5z m342.9 51.8c66.9-1.7 123-56.7 126.1-123.5 3.3-73-54.1-134.1-126.8-135.5h-5.2c-71.5 1.4-128.4 60.6-127 132.1 1.4 71.5 60.6 128.7 132.9 126.9z m-6 51.9c-77.8 0-233.2 46.3-233.2 138.2v43.2c0 14.3 11.6 25.9 25.9 25.9h414.6c14.3 0 25.9-11.6 25.9-25.9v-43.2c0-92-155.4-138.2-233.2-138.2z"
                                p-id="310447"></path>
                        </svg>
                        <span class="nav-title">Contacts</span>
                    </div>
                    <div class="nav-item" data-page="discover">
                        <svg t="1759003314767" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="313720" width="21" height="21">
                            <path
                                d="M1023.200312 43.682936L877.057399 920.640375c-1.899258 10.995705-8.096837 19.592347-18.292854 25.689965-5.29793 2.898868-11.295588 4.598204-17.693089 4.598204-4.19836 0-8.796564-0.99961-13.69465-2.898868l-236.707536-96.762202c-12.994924-5.29793-27.889106-1.499414-36.785631 9.296368l-123.251855 150.341273c-6.897306 8.796564-16.293635 13.094885-27.989066 13.094885-4.898087 0-9.096447-0.799688-12.695041-2.299102-7.197189-2.698946-12.994924-6.997267-17.393206-13.394768-4.398282-6.29754-6.697384-13.194846-6.697384-20.891839V811.083171c0-14.794221 5.098009-28.988676 14.394377-40.484186l478.912925-587.070676-602.864506 521.796174c-4.598204 3.898477-10.995705 4.998048-16.493557 2.698945L23.390863 619.358063C9.296369 614.060133 1.599375 603.664194 0.599766 587.870363c-0.799688-15.194065 5.29793-26.489652 18.292854-33.786802L968.921515 5.997657c5.797735-3.498633 11.795392-5.098009 18.292854-5.098008 7.696993 0 14.594299 2.199141 20.691918 6.397501 12.695041 8.996486 17.593128 21.291683 15.294025 36.385786z"
                                p-id="313721"></path>
                        </svg>
                        <span class="nav-title">Discover</span>
                    </div>
                    <div class="nav-item" data-page="me">
                        <svg t="1759002624548" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="267273" width="22" height="22">
                            <path
                                d="M502.496 63.136c125.888 0 227.936 100.384 227.936 224.192 0 123.84-102.048 224.224-227.936 224.224-125.888 0-227.936-100.384-227.936-224.224C274.56 163.488 376.64 63.136 502.496 63.136L502.496 63.136zM502.496 63.136c125.888 0 227.936 100.384 227.936 224.192 0 123.84-102.048 224.224-227.936 224.224-125.888 0-227.936-100.384-227.936-224.224C274.56 163.488 376.64 63.136 502.496 63.136L502.496 63.136zM417.024 586.304l189.984 0c162.624 0 294.432 129.632 294.432 289.6l0 18.656c0 63.04-131.84 65.44-294.432 65.44l-189.984 0c-162.624 0-294.432-0.096-294.432-65.44l0-18.656C122.592 715.936 254.4 586.304 417.024 586.304L417.024 586.304zM417.024 586.304"
                                p-id="267274"></path>
                        </svg>
                        <span class="nav-title">Me</span>
                    </div>
                </div>
            </div>

            <div id="chat-interface-screen" class="screen">
                <div class="header">
                    <!-- 原始顶栏元素 -->
                    <button class="header-icon" data-target="chat-list-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="chat-contact-name">...</h1>
                    <button class="header-icon" id="chat-settings-btn">
                        <svg id="chat-settings-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                            width="24" height="24">
                            <path fill="#515151"
                                d="M128 512a64 64 0 1 0 128 0 64 64 0 1 0-128 0z m320 0a64 64 0 1 0 128 0 64 64 0 1 0-128 0z m320 0a64 64 0 1 0 128 0 64 64 0 1 0-128 0z">
                            </path>
                        </svg>
                    </button>

                    <!-- 【【【全新】】】多选模式下的顶栏 -->
                    <div class="multi-select-actions">
                        <button id="multi-select-cancel-btn" class="multi-select-btn">取消</button>
                        <span id="multi-select-counter">请选择项目</span>
                        <button id="multi-select-delete-btn" class="multi-select-btn">删除</button>
                    </div>
                </div>
                <div id="message-container"></div>
                <div id="input-area">
                    <!-- 【新增】引用回复栏 -->
                    <div id="reply-bar">
                        <span id="reply-bar-content"></span>
                        <button id="cancel-reply-btn">
                            <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                                <path
                                    d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                                    p-id="32290" fill="#888"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- 【核心修改1】将原有的输入行包裹起来 -->
                    <div id="input-controls-row">
                        <!-- 更多功能按钮 -->
                        <button id="more-btn" class="action-button">
                            <svg t="1757444626090" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="34660" width="22" height="22">
                                <path
                                    d="M696 480H544V328c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v152H328c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h152v152c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V544h152c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"
                                    p-id="34661" fill="#353333"></path>
                                <path
                                    d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"
                                    p-id="34662" fill="#353333"></path>
                            </svg>
                        </button>
                        <!-- 语音按钮 -->
                        <button id="voice-btn" class="action-button">
                            <svg t="1757444947062" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="35967" width="23" height="23">
                                <path
                                    d="M544 851.946667V906.666667a32 32 0 0 1-64 0v-54.72C294.688 835.733333 149.333333 680.170667 149.333333 490.666667v-21.333334a32 32 0 0 1 64 0v21.333334c0 164.949333 133.717333 298.666667 298.666667 298.666666s298.666667-133.717333 298.666667-298.666666v-21.333334a32 32 0 0 1 64 0v21.333334c0 189.514667-145.354667 345.066667-330.666667 361.28zM298.666667 298.56C298.666667 180.8 394.165333 85.333333 512 85.333333c117.781333 0 213.333333 95.541333 213.333333 213.226667v192.213333C725.333333 608.533333 629.834667 704 512 704c-117.781333 0-213.333333-95.541333-213.333333-213.226667V298.56z m64 0v192.213333C362.666667 573.12 429.557333 640 512 640c82.496 0 149.333333-66.805333 149.333333-149.226667V298.56C661.333333 216.213333 594.442667 149.333333 512 149.333333c-82.496 0-149.333333 66.805333-149.333333 149.226667z"
                                    fill="#353333" p-id="35968"></path>
                            </svg>
                        </button>
                        <!-- 输入框 -->
                        <textarea id="message-input" placeholder="입력..." rows="1"></textarea>
                        <!-- 发送按钮 -->
                        <button id="send-btn" class="action-button">
                            <svg t="1757445050961" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="37600" width="24" height="24">
                                <path
                                    d="M392.021333 925.013333a34.133333 34.133333 0 0 1-34.133333-34.133333V579.242667c0-10.24 4.608-19.968 12.629333-26.453334l276.48-224.085333a34.0992 34.0992 0 0 1 43.008 52.906667L426.154667 595.456v192.853333l82.944-110.592c10.069333-13.482667 28.672-17.578667 43.52-9.557333l137.557333 73.728L853.333333 156.16c3.242667-11.434667-3.413333-18.602667-6.485333-21.162667-3.072-2.56-11.093333-7.850667-21.845333-2.901333L206.336 422.4l80.213333 46.08c16.384 9.386667 22.016 30.208 12.629334 46.592s-30.208 22.016-46.592 12.629333l-137.045334-78.677333a33.979733 33.979733 0 0 1-17.066666-31.061333c0.512-12.8 8.021333-24.064 19.626666-29.525334L795.989333 70.314667c31.744-14.848 68.096-10.069333 94.890667 12.629333a87.790933 87.790933 0 0 1 28.16 91.477333L744.277333 801.28a34.082133 34.082133 0 0 1-48.981333 20.821333L546.133333 742.058667l-126.805333 169.301333c-6.656 8.704-16.896 13.653333-27.306667 13.653333z"
                                    fill="#353333" p-id="37601"></path>
                            </svg>
                        </button>
                        <!-- 生成按钮 -->
                        <button id="generate-btn" class="action-button">
                            <svg t="1757445162269" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="41878" width="21" height="21">
                                <path
                                    d="M958.681412 457.499032c-6.170072-50.632177-20.854483-99.563886-43.643361-145.434552-45.779694-92.144205-122.249797-166.333021-215.325711-208.898719-20.083724-9.18513-43.810309-0.349891-52.995439 19.734833-9.18413 20.082724-0.349891 43.810309 19.733833 52.996438 159.26323 72.834239 245.755201 249.640987 205.658732 420.410622-30.735395 130.876101-129.201624 233.321087-256.187941 270.333521l-0.262918-70.800875-196.843487 114.650172 197.690222 113.176632-0.275914-74.43274c75.398438-17.911403 144.809747-54.929834 202.084849-108.039237 65.597501-60.827991 111.122274-139.186504 131.651859-226.606186 12.170197-51.828803 15.10328-104.683286 8.715276-157.089909zM408.299406-0.001l0.271915 74.43374c-75.404436 17.911403-144.820744 54.931834-202.099843 108.046235-65.6005 60.83099-111.124274 139.191503-131.651859 226.616183-7.987504 34.034364-11.994252 68.507591-11.994252 103.010809 0 17.994377 1.090659 35.996751 3.271978 53.946142 6.152077 50.59119 20.803499 99.48891 43.545392 145.333583 45.678725 92.080225 122.012871 166.270041 214.936832 208.900718 20.071728 9.209122 43.810309 0.401874 53.018432-19.670852 9.210122-20.076726 0.400875-43.810309-19.671853-53.019432-158.963324-72.92821-245.278351-249.658982-205.24886-420.22368 30.732396-130.883099 129.201624-233.333083 256.195939-270.345517l0.259919 70.801874 196.850484-114.640174L408.299406-0.001z"
                                    fill="#353333" p-id="41879"></path>
                            </svg>
                        </button>


                    </div>

                    <!-- 【核心修改2】在这里新增功能面板的完整HTML结构 -->
                    <div id="more-functions-panel">
                        <!-- 左右导航箭头 -->
                        <button class="functions-nav-arrow hidden" id="functions-nav-prev">
                            <!-- 你可以在这里替换成你的左箭头SVG -->
                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                                fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <button class="functions-nav-arrow" id="functions-nav-next">
                            <!-- 你可以在这里替换成你的右箭头SVG -->
                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                                fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>

                        <!-- 滑动视口 -->
                        <div id="functions-viewport">
                            <!-- 滑动条 -->
                            <div id="functions-slider">
                                <!-- 第一页 -->
                                <div class="functions-page">
                                    <!-- 图标1: 表情 -->
                                    <div class="function-icon-item" id="open-sticker-panel-btn">
                                        <button class="action-button">
                                            <!-- 表情图标SVG代码 -->
                                            <svg t="1757450727866" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                xmlns="http://www.w3.org/2000/svg" p-id="52023" width="24" height="24">
                                                <path
                                                    d="M872.802928 755.99406 872.864326 755.99406 872.864326 755.624646Z"
                                                    fill="#353333" p-id="52024"></path>
                                                <path
                                                    d="M807.273469 216.727043c-162.808016-162.836669-427.736874-162.836669-590.544891 0-162.836669 162.806993-162.836669 427.736874 0 590.543867 162.808016 162.837692 427.737898 162.837692 590.544891 0C970.110137 644.462894 970.110137 379.534036 807.273469 216.727043M764.893242 764.92036c-139.444912 139.443889-366.370225 139.414213-505.798764 0-139.459239-139.473565-139.459239-366.354875 0-505.827417 139.428539-139.429563 366.354875-139.460262 505.798764 0C904.336108 398.521482 904.336108 625.476471 764.893242 764.92036"
                                                    fill="#353333" p-id="52025"></path>
                                                <path
                                                    d="M381.724423 468.02137c24.783453 0 44.953841-20.169365 44.953841-44.967144 0-24.828478-20.170388-45.027519-44.953841-45.027519-24.842805 0-45.013193 20.199041-45.013193 45.027519C336.71123 447.852004 356.881618 468.02137 381.724423 468.02137"
                                                    fill="#353333" p-id="52026"></path>
                                                <path
                                                    d="M640.680243 468.095048c24.812105 0 45.010123-20.213367 45.010123-45.01217 0-24.827455-20.198018-44.99682-45.010123-44.99682-24.785499 0-44.953841 20.169365-44.953841 44.99682C595.726401 447.88168 615.894743 468.095048 640.680243 468.095048"
                                                    fill="#353333" p-id="52027"></path>
                                                <path
                                                    d="M642.245901 619.058294l-2.453888 0.798179c-40.310078 18.248619-83.548858 27.5341-128.411625 27.5341-46.343491 0-90.173742-9.375531-130.305765-27.799136l-2.425236-0.741897c-1.508353-0.413416-3.548826-1.003863-6.092765-1.003863-14.757099 0-26.734898 11.977799-26.734898 26.675546 0 6.978948 3.282766 13.988596 8.695033 19.253506l-0.325411 1.62501 6.831592 3.076058c47.911196 21.679765 100.021018 33.095769 150.681838 33.095769 51.608402 0 102.180194-11.120268 150.978597-33.361829 8.575306-4.703115 13.928221-13.721513 13.928221-23.511483C676.611593 627.458615 661.027663 613.290941 642.245901 619.058294"
                                                    fill="#353333" p-id="52028"></path>
                                            </svg>
                                        </button>
                                        <span class="function-icon-label">表情</span>
                                    </div>
                                    <!-- 图标2: 照片 -->
                                    <div class="function-icon-item">
                                        <button class="action-button">
                                            <!-- 照片图标SVG代码 -->
                                            <svg t="1757447075322" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                xmlns="http://www.w3.org/2000/svg" p-id="46520" width="26" height="26">
                                                <path
                                                    d="M509.505795 749.981522c-105.616664 0-191.451705-85.835041-191.451705-191.451705s85.835041-191.451705 191.451705-191.451705 191.451705 85.835041 191.451705 191.451705S615.122459 749.981522 509.505795 749.981522zM509.505795 430.895347c-70.353771 0-127.63447 57.280699-127.63447 127.63447s57.280699 127.63447 127.63447 127.63447 127.63447-57.280699 127.63447-127.63447S579.859567 430.895347 509.505795 430.895347z"
                                                    fill="#353333" p-id="46521"></path>
                                                <path
                                                    d="M860.586595 909.610616 158.424996 909.610616c-52.808332 0-95.81186-43.003528-95.81186-95.81186L62.613136 303.260877c0-52.808332 43.003528-95.81186 95.81186-95.81186l95.81186 0c17.545439 0 31.994625 14.277171 31.994625 31.994625 0 17.717453-14.277171 31.994625-31.994625 31.994625L158.424996 271.438266c-17.545439 0-31.994625 14.277171-31.994625 31.994625l0 510.53788c0 17.545439 14.277171 31.994625 31.994625 31.994625l701.989585 0c17.545439 0 31.994625-14.277171 31.994625-31.994625L892.409205 303.260877c0-17.545439-14.277171-31.994625-31.994625-31.994625l-350.908785 0c-17.545439 0-31.994625-14.277171-31.994625-31.994625 0-17.717453 14.277171 31.994625 31.994625 31.994625l351.0808 0c52.808332 0 95.81186 43.003528 95.81186 95.81186L956.398455 813.626743C956.22644 866.607089 913.222913 909.610616 860.586595 909.610616z"
                                                    fill="#353333" p-id="46522"></path>
                                                <path
                                                    d="M764.774735 351.252814c0 26.490173 21.501764 47.819923 47.819923 47.819923 26.490173 0 47.819923-21.501764 47.819923-47.819923s-21.501764-47.819923-47.819923-47.819923C786.276499 303.260877 764.774735 324.762641 764.774735 351.252814z"
                                                    fill="#353333" p-id="46523"></path>
                                                <path
                                                    d="M477.683185 143.803796c0 17.545439-14.277171 31.994625-31.994625 31.994625l-127.63447 0c-17.545439 0-31.994625-14.277171-31.994625-31.994625l0 0c0-17.545439 14.277171-31.994625 31.994625-31.994625l127.63447 0C463.234 111.809172 477.683185 126.086343 477.683185 143.803796L477.683185 143.803796z"
                                                    fill="#353333" p-id="46524"></path>
                                            </svg>
                                        </button>
                                        <span class="function-icon-label">照片</span>
                                    </div>
                                    <!-- 图标3: 拍摄 -->
                                    <div class="function-icon-item">
                                        <button class="action-button">
                                            <!-- 拍摄图标SVG代码 -->
                                            <svg t="1757447420487" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                xmlns="http://www.w3.org/2000/svg" p-id="47827" width="26" height="26">
                                                <path
                                                    d="M896 160H128c-17.67 0-32 14.33-32 32v640c0 17.67 14.33 32 32 32h768c17.67 0 32-14.33 32-32V192c0-17.67-14.33-32-32-32z m-32 64v472.01l-227.2-170.4c-16.97-12.72-40.62-12.72-57.59 0l-98.58 73.92L349.2 494.39c-16.47-13.19-39.27-14.19-56.81-2.39L160 581.02V224h704zM160 800V658.16l158.36-106.48 161.02 128.8L608 584l256 192v24H160z"
                                                    fill="#353333" p-id="47828"></path>
                                                <path
                                                    d="M704 480c52.94 0 96-43.06 96-96s-43.06-96-96-96-96 43.06-96 96 43.06 96 96 96z m0-128c17.64 0 32 14.36 32 32s-14.36 32-32 32-32-14.36-32-32 14.36-32 32-32z"
                                                    fill="#353333" p-id="47829"></path>
                                            </svg>
                                        </button>
                                        <span class="function-icon-label">拍摄</span>
                                    </div>
                                    <!-- 后续6个图标的预留空位 -->
                                </div>
                                <!-- 第二页 (空) -->
                                <div class="functions-page">
                                    <!-- 这里是空的，为未来功能预留 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 【全新】表情面板的HTML结构 -->
                    <div id="sticker-panel">
                        <div id="sticker-grid">
                            <!-- “添加”按钮将由JS动态创建 -->
                            <!-- 表情将由JS动态加载到这里 -->
                        </div>
                    </div>

                </div>
            </div>



            <!-- =================================================================== -->
            <!-- 【全新 V1.96】世界书功能主页面 -->
            <!-- =================================================================== -->
            <div id="world-book-screen" class="screen">
                <!-- 顶栏 -->
                <div class="header">
                    <button class="header-icon" data-target="home-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>世界书</h1>
                    <!-- 【核心修改】将按钮们包裹在一个容器里，方便统一控制 -->
                    <div class="header-actions"
                        style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                        <!-- 角色页的加号 -->
                        <button class="add-btn" id="add-new-role-btn" style="display: flex;">
                            <svg id="add-contact-icon" t="1757279304410" class="icon" viewBox="0 0 1024 1024"
                                version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6687" width="18" height="18">
                                <path
                                    d="M469.44 469.312v-320a42.88 42.88 0 0 1 42.944-42.624c22.912 0 42.368 19.072 42.368 42.624v320h320a42.88 42.88 0 0 1 42.688 43.008 42.752 42.752 0 0 1-42.624 42.368H554.752v320a41.6 41.6 0 0 1-41.408 42.624h-0.96a42.88 42.88 0 0 1-42.944-42.624v-320H149.376a42.88 42.88 0 0 1-42.624-43.008c0-22.912 19.072-42.368 42.624-42.368h320z"
                                    p-id="6688" fill="#515151"></path>
                            </svg>
                        </button>
                        <!-- 预设页的加号 -->
                        <button class="add-btn" id="add-new-offline-preset-btn" style="display: none;">
                            <svg id="add-contact-icon" t="1757279304410" class="icon" viewBox="0 0 1024 1024"
                                version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6687" width="18" height="18">
                                <path
                                    d="M469.44 469.312v-320a42.88 42.88 0 0 1 42.944-42.624c22.912 0 42.368 19.072 42.368 42.624v320h320a42.88 42.88 0 0 1 42.688 43.008 42.752 42.752 0 0 1-42.624 42.368H554.752v320a41.6 41.6 0 0 1-41.408 42.624h-0.96a42.88 42.88 0 0 1-42.944-42.624v-320H149.376a42.88 42.88 0 0 1-42.624-43.008c0-22.912 19.072-42.368 42.624-42.368h320z"
                                    p-id="6688" fill="#515151"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 页面内容容器 -->
                <div class="preset-main-container">
                    <!-- 角色页面 -->
                    <div id="preset-page-role" class="preset-page active">
                        <!-- 内容将由JS动态生成 -->
                    </div>
                    <!-- 预设页面 -->
                    <div id="preset-page-offline" class="preset-page">
                        <!-- 【新增】预设列表将由JS动态生成到这里 -->
                    </div>
                    <!-- 其他页面 (依旧叫assets, 方便未来扩展) -->
                    <div id="preset-page-assets" class="preset-page">
                        <!-- 【新增】文风板块 -->
                        <div class="asset-section" id="writing-style-section">
                            <div class="asset-section-top-wrapper">
                                <div class="asset-section-header">
                                    <div class="asset-section-title-wrapper">
                                        <h3>文风</h3>
                                        <p>此类文风只会对线下模式进行影响</p>
                                    </div>
                                    <button class="asset-section-arrow" style="display: none;">
                                        <svg t="1758349365407" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="75574" width="18" height="18">
                                            <path
                                                d="M464.6 736C346 613.3 227.3 490.5 108.8 367.8c-48.9-50.5 30.5-125.9 79.5-75.1C293.9 401.9 399.4 511.2 505 620.3 614.2 510.6 723.6 400.8 832.8 291c49.7-50 129.1 25.4 79.5 75.2C789.6 489.5 666.9 612.7 544.2 736c-20.4 20.4-59.4 20.9-79.6 0z"
                                                fill="#3f3f3f" p-id="75575"></path>
                                        </svg>
                                    </button>
                                </div>
                                <button class="asset-section-add-btn" data-type="writingStyle">
                                    <svg t="1757638742634" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="28011" width="24" height="24">
                                        <path
                                            d="M828.704099 196.575729C744.096116 112.384034 631.648434 66.016073 512 66.016073s-232.1288 46.367961-316.736783 130.559656C110.624271 280.800108 64 392.831501 64 512c0 119.199462 46.624271 231.199892 131.232254 315.424271 84.607983 84.191695 197.088348 130.559656 316.736783 130.559656s232.1288-46.367961 316.704099-130.559656c84.67163-84.255342 131.295901-196.288456 131.263217-315.455235C959.967316 392.800538 913.375729 280.800108 828.704099 196.575729zM736.00086 544.00086 544.00086 544.00086l0 192c0 17.695686-14.336138 32.00086-32.00086 32.00086s-32.00086-14.303454-32.00086-32.00086L479.99914 544.00086 288.00086 544.00086c-17.664722 0-32.00086-14.336138-32.00086-32.00086s14.336138-32.00086 32.00086-32.00086l192 0L480.00086 288.00086c0-17.664722 14.336138-32.00086 32.00086-32.00086s32.00086 14.336138 32.00086 32.00086l0 192 192 0c17.695686 0 32.00086 14.336138 32.00086 32.00086S753.696546 544.00086 736.00086 544.00086z"
                                            fill="#353333" p-id="28012"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="asset-list-container" id="writing-style-list">
                                <!-- JS will render items here -->
                            </div>
                        </div>

                        <!-- 【新增】朋友圈素材板块 -->
                        <div class="asset-section" id="social-asset-section">
                            <div class="asset-section-top-wrapper">
                                <div class="asset-section-header">
                                    <div class="asset-section-title-wrapper">
                                        <h3>朋友圈素材</h3>
                                        <p>可添加专属风格、图片等</p>
                                    </div>
                                    <button class="asset-section-arrow" style="display: none;">
                                        <svg t="1758349365407" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="75574" width="18" height="18">
                                            <path
                                                d="M464.6 736C346 613.3 227.3 490.5 108.8 367.8c-48.9-50.5 30.5-125.9 79.5-75.1C293.9 401.9 399.4 511.2 505 620.3 614.2 510.6 723.6 400.8 832.8 291c49.7-50 129.1 25.4 79.5 75.2C789.6 489.5 666.9 612.7 544.2 736c-20.4 20.4-59.4 20.9-79.6 0z"
                                                fill="#3f3f3f" p-id="75575"></path>
                                        </svg>
                                    </button>
                                </div>
                                <button class="asset-section-add-btn" data-type="socialAsset">
                                    <svg t="1757638742634" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="28011" width="24" height="24">
                                        <path
                                            d="M828.704099 196.575729C744.096116 112.384034 631.648434 66.016073 512 66.016073s-232.1288 46.367961-316.736783 130.559656C110.624271 280.800108 64 392.831501 64 512c0 119.199462 46.624271 231.199892 131.232254 315.424271 84.607983 84.191695 197.088348 130.559656 316.736783 130.559656s232.1288-46.367961 316.704099-130.559656c84.67163-84.255342 131.295901-196.288456 131.263217-315.455235C959.967316 392.800538 913.375729 280.800108 828.704099 196.575729zM736.00086 544.00086 544.00086 544.00086l0 192c0 17.695686-14.336138 32.00086-32.00086 32.00086s-32.00086-14.303454-32.00086-32.00086L479.99914 544.00086 288.00086 544.00086c-17.664722 0-32.00086-14.336138-32.00086-32.00086s14.336138-32.00086 32.00086-32.00086l192 0L480.00086 288.00086c0-17.664722 14.336138-32.00086 32.00086-32.00086s32.00086 14.336138 32.00086 32.00086l0 192 192 0c17.695686 0 32.00086 14.336138 32.00086 32.00086S753.696546 544.00086 736.00086 544.00086z"
                                            fill="#353333" p-id="28012"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="asset-list-container" id="social-asset-list">
                                <!-- JS will render items here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部导航栏 -->
                <div class="preset-bottom-nav">
                    <div class="preset-nav-item active" data-page="role">
                        <svg t="1758256337142" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="49982" width="25" height="25">
                            <path
                                d="M381.7 985.3c-10.2 0-20.4-3.9-28.3-11.7-15.6-15.6-15.6-40.9 0-56.5L496 774.5c39-39 90.9-60.5 146.1-60.5h136.2c91.4 0 165.7-74.3 165.8-165.7V284.4c0-91.4-74.4-165.8-165.8-165.8H245.7c-91.4 0-165.8 74.4-165.8 165.8v263.9c0 91.4 74.4 165.7 165.8 165.7h74.4c22.1 0 40 17.9 40 40s-17.9 40-40 40h-74.4C110.2 793.9 0 683.7 0 548.3V284.4C0 148.9 110.2 38.7 245.7 38.7h532.6c135.5 0 245.7 110.2 245.7 245.7v263.9C1024 683.8 913.8 794 778.3 794H642.2c-33.8 0-65.7 13.2-89.6 37.1L410 973.6c-7.8 7.8-18 11.7-28.3 11.7z"
                                fill="#302f2f" p-id="49983"></path>
                            <path d="M322.965 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"
                                fill="#302f2f" p-id="49984"></path>
                            <path d="M512.065 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"
                                fill="#302f2f" p-id="49985"></path>
                            <path d="M701.165 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"
                                fill="#302f2f" p-id="49986"></path>
                        </svg>
                        <span>角色</span>
                    </div>
                    <div class="preset-nav-item" data-page="offline">
                        <svg t="1758212820644" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="47395" width="25" height="25">
                            <path
                                d="M512 85.333333c235.637333 0 426.666667 191.029333 426.666667 426.666667a432.554667 432.554667 0 0 1-4.490667 62.112 423.36 423.36 0 0 1-8.789333 43.914667l-0.458667 1.749333-0.330667 1.301333-1.418666 5.216a423.210667 423.210667 0 0 1-9.365334 29.546667l-1.066666 2.944a426.698667 426.698667 0 0 1-94.357334 150.154667c22.986667 3.082667 43.818667 10.837333 62.4 23.466666a32 32 0 1 1-35.957333 52.938667c-30.485333-20.714667-77.781333-18.965333-144.053333 9.386667a343.68 343.68 0 0 1-5.706667 2.773333l-1.834667 0.853333c-1.568 0.746667-3.136 1.472-4.704 2.186667l-0.874666 0.394667c-1.834667 0.832-3.68 1.653333-5.525334 2.453333l-0.778666 0.330667c-1.706667 0.746667-3.413333 1.472-5.12 2.197333-0.533333 0.202667-1.034667 0.416-1.546667 0.629333-3.658667 1.514667-7.349333 2.986667-11.061333 4.394667l-2.250667 0.832a278.826667 278.826667 0 0 1-3.914667 1.450667l-2.453333 0.874666c-1.6 0.576-3.232 1.152-4.853333 1.706667a322.752 322.752 0 0 1-6.08 2.026667l-1.941334 0.618666c-1.781333 0.576-3.573333 1.130667-5.365333 1.685334l-0.693333 0.202666c-1.717333 0.533333-3.445333 1.034667-5.173334 1.536l-2.101333 0.597334c-1.248 0.362667-2.485333 0.704-3.733333 1.045333l-3.082667 0.832c-1.173333 0.32-2.346667 0.629333-3.530667 0.928l-2.922666 0.736c-1.706667 0.426667-3.434667 0.853333-5.162667 1.258667l-1.173333 0.266666c-10.346667 2.410667-20.821333 4.448-31.424 6.08l-2.592 0.394667-0.746667 0.106667A426.250667 426.250667 0 0 1 512 938.666667C276.362667 938.666667 85.333333 747.637333 85.333333 512S276.362667 85.333333 512 85.333333z m0 522.666667a64 64 0 1 0 0 128 64 64 0 0 0 0-128z m160-160a64 64 0 1 0 0 128 64 64 0 0 0 0-128z m-320 0a64 64 0 1 0 0 128 64 64 0 0 0 0-128z m160-160a64 64 0 1 0 0 128 64 64 0 0 0 0-128z"
                                fill="#302f2f" p-id="47396"></path>
                        </svg>
                        <span>预设</span>
                    </div>
                    <div class="preset-nav-item" data-page="assets">
                        <svg t="1758256365170" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="52196" width="25" height="25">
                            <path
                                d="M879.709091 367.709091c0-74.472727-60.509091-134.981818-134.981818-134.981818h-228.072728l-79.127272-111.709091c-9.309091-9.309091-18.618182-18.618182-32.581818-18.618182h-214.109091c-74.472727 0-134.981818 60.509091-134.981819 134.981818v549.236364c0 74.472727 60.509091 134.981818 134.981819 134.981818h581.818181c60.509091 0 111.709091-41.890909 125.672728-97.745455l69.818182-293.236363c4.654545-13.963636 4.654545-23.272727 4.654545-37.236364 0-55.854545-37.236364-111.709091-93.090909-125.672727z m-749.381818 232.727273v-363.054546c0-32.581818 27.927273-60.509091 60.509091-60.509091h190.836363l83.781818 111.709091c9.309091 13.963636 23.272727 18.618182 37.236364 18.618182h242.036364c32.581818 0 60.509091 23.272727 60.509091 55.854545h-512c-65.163636 0-116.363636 46.545455-130.327273 107.054546l-32.581818 130.327273z m768-83.781819l-74.472728 283.927273v4.654546c0 4.654545 0 4.654545-4.654545 9.309091s-4.654545 9.309091-9.309091 13.963636c-9.309091 9.309091-27.927273 13.963636-41.890909 13.963636h-539.927273c-32.581818 0-60.509091-27.927273-60.509091-60.509091v-13.963636l69.818182-283.927273c4.654545-27.927273 32.581818-46.545455 60.509091-46.545454h544.581818c32.581818 0 60.509091 27.927273 60.509091 60.509091 0 4.654545 0 9.309091-4.654545 18.618181z"
                                p-id="52197" fill="#302f2f"></path>
                        </svg>
                        <span>素材</span>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.96】创建/编辑角色页面 -->
            <!-- =================================================================== -->
            <div id="preset-edit-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="world-book-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="preset-editor-title">创建角色</h1>
                    <button class="header-edit-btn" id="save-role-preset-btn">保存</button>
                </div>
                <div class="form-container preset-editor-form">
                    <div class="preset-form-group">
                        <label>名称</label>
                        <div class="preset-input-box" id="preset-name-input-container">
                            <span class="preset-editable-text" id="preset-name-text"></span>
                        </div>
                    </div>
                    <div class="preset-form-group">
                        <label>内容</label>
                        <!-- 【核心修改】直接使用 textarea 并赋予新样式类 -->
                        <textarea class="preset-textarea-box styled-textarea" id="preset-content-text"
                            placeholder="点击输入内容..."></textarea>
                    </div>
                    <div class="preset-form-group">
                        <label>关联其他 (可多选)</label>
                        <div class="preset-dropdown-container">
                            <div class="preset-dropdown-header">
                                <span id="preset-dropdown-label">点击选择</span>
                                <div class="preset-dropdown-arrow">
                                    <svg t="1758256512079" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="54311" width="10" height="10">
                                        <path
                                            d="M406.656 836.096L56.96 328.576A128 128 0 0 1 162.304 128h699.392a128 128 0 0 1 105.344 200.576L617.472 836.096a128 128 0 0 1-210.816 0z"
                                            fill="#515151" opacity=".99" p-id="54312"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="preset-dropdown-list">
                                <!-- 关联项将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.96】修改禁词页面 -->
            <!-- =================================================================== -->
            <div id="preset-forbidden-words-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="world-book-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>修改内容</h1>
                    <button class="header-edit-btn" id="save-forbidden-words-btn">保存</button>
                </div>
                <div class="form-container preset-editor-form">
                    <div class="preset-form-group">
                        <label>位置</label>
                        <div class="preset-select-wrapper">
                            <select id="forbidden-words-position-select">
                                <option value="all">全部模式生效</option>
                                <option value="online">仅线上模式生效</option>
                                <option value="offline">仅线下模式生效</option>
                            </select>
                        </div>
                    </div>
                    <div class="preset-form-group">
                        <label>内容</label>
                        <textarea id="forbidden-words-content-input"
                            placeholder="在此处填写聊天或线下模式中将要禁止的词汇（将会永久禁止）"></textarea>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【【【核心新增】】】创建/编辑预设页面 -->
            <!-- =================================================================== -->
            <div id="preset-offline-edit-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="world-book-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="preset-offline-editor-title">创建预设</h1>
                    <button class="header-edit-btn" id="save-offline-preset-btn">保存</button>
                </div>
                <div class="form-container preset-editor-form">
                    <div class="preset-form-group" style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex-grow: 1;">
                            <label>名称</label>
                            <div class="preset-input-box" id="preset-offline-name-container">
                                <span class="preset-editable-text" id="preset-offline-name-text"></span>
                            </div>
                        </div>
                        <div style="width: 130px; flex-shrink: 0;">
                            <label>模式</label>
                            <div class="preset-select-wrapper">
                                <select id="preset-offline-mode-select">
                                    <option value="all">全部模式生效</option>
                                    <option value="online">仅线上模式生效</option>
                                    <option value="offline">仅线下模式生效</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="preset-form-group">
                        <label>提示词</label>
                        <!-- 【核心修改】同样，直接使用 textarea -->
                        <textarea class="preset-textarea-box styled-textarea" id="preset-offline-content-text"
                            placeholder="点击输入内容..."></textarea>
                    </div>
                    <div class="preset-form-group" style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex-grow: 1;">
                            <label>角色</label>
                            <div class="preset-select-wrapper">
                                <select id="preset-offline-role-select">
                                    <option value="system">系统</option>
                                    <option value="user">角色</option>
                                    <option value="assistant">ai</option>
                                </select>
                            </div>
                        </div>
                        <div style="flex-grow: 1;">
                            <label>位置</label>
                            <div class="preset-select-wrapper">
                                <select id="preset-offline-position-select">
                                    <option value="before">角色定义之前</option>
                                    <option value="after">角色定义之后</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.63】字体设置页面 -->
            <!-- =================================================================== -->
            <div id="font-settings-screen" class="screen">
                <div class="header">
                    <!-- 【修改】返回目标改为 main-settings-screen -->
                    <button class="header-icon" data-target="main-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>字体设置</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div class="form-container">
                    <div class="font-settings-plate">
                        <!-- 1. 预览区 -->
                        <div class="font-setting-group">
                            <h3 class="group-title">预览</h3>
                            <div id="font-settings-preview-box">
                                此区域实时预览文字效果，调节下方数值可更改文字大小、粗细、间距。
                            </div>
                        </div>

                        <!-- 2. 字号和粗细调节 -->
                        <div class="font-input-row">
                            <div class="font-setting-group">
                                <h3 class="group-title">字号调节</h3>
                                <p class="group-subtitle">调整全局字体大小</p>
                                <div class="font-input-wrapper">
                                    <input type="number" id="global-font-size-input" placeholder="16">
                                    <span class="unit-label">px</span>
                                </div>
                            </div>
                            <div class="font-setting-group">
                                <h3 class="group-title">字体粗细调节</h3>
                                <p class="group-subtitle">调整文字字粗细</p>
                                <div class="font-input-wrapper">
                                    <input type="number" id="global-font-weight-input" placeholder="400" step="100">
                                </div>
                            </div>
                        </div>

                        <!-- 3. 字间距调节 -->
                        <div class="font-setting-group">
                            <h3 class="group-title">字间距调节</h3>
                            <p class="group-subtitle">调整文字字间距</p>
                            <div class="font-input-wrapper">
                                <input type="number" id="global-letter-spacing-input" placeholder="0" step="0.1">
                                <span class="unit-label">px</span>
                            </div>
                        </div>

                        <!-- 4. 字体链接 -->
                        <div class="font-setting-group">
                            <h3 class="group-title">字体链接 (ttf, woff, otf等)</h3>
                            <div class="font-link-input-wrapper">
                                <input type="text" id="font-url-input" placeholder="在此粘贴url，此字体影响全局">
                                <button id="add-font-btn">
                                    <svg t="1757638742634" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="28011" width="27" height="27">
                                        <path
                                            d="M828.704099 196.575729C744.096116 112.384034 631.648434 66.016073 512 66.016073s-232.1288 46.367961-316.736783 130.559656C110.624271 280.800108 64 392.831501 64 512c0 119.199462 46.624271 231.199892 131.232254 315.424271 84.607983 84.191695 197.088348 130.559656 316.736783 130.559656s232.1288-46.367961 316.704099-130.559656c84.67163-84.255342 131.295901-196.288456 131.263217-315.455235C959.967316 392.800538 913.375729 280.800108 828.704099 196.575729zM736.00086 544.00086 544.00086 544.00086l0 192c0 17.695686-14.336138 32.00086-32.00086 32.00086s-32.00086-14.303454-32.00086-32.00086L479.99914 544.00086 288.00086 544.00086c-17.664722 0-32.00086-14.336138-32.00086-32.00086s14.336138-32.00086 32.00086-32.00086l192 0L480.00086 288.00086c0-17.664722 14.336138-32.00086 32.00086-32.00086s32.00086 14.336138 32.00086 32.00086l0 192 192 0c17.695686 0 32.00086 14.336138 32.00086 32.00086S753.696546 544.00086 736.00086 544.00086z"
                                            fill="#515151" p-id="28012"></path>
                                    </svg>
                            </div>
                            <!-- 动态添加的字体列表将放在这里 -->
                            <div id="font-entry-list"></div>
                        </div>

                        <!-- 5. 按钮 -->
                        <div class="font-settings-buttons">
                            <button class="form-button" id="save-font-settings-btn">保存效果</button>
                            <button class="form-button" id="restore-font-defaults-btn">恢复默认</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- =================================================================== -->
            <!-- 【全新】V1.51 主设置页面 -->
            <!-- =================================================================== -->

            <div id="main-settings-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="home-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>设置</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div id="main-settings-container" class="form-container">
                    <!-- 板块1: API, 后台, 主题, 外观 -->
                    <div class="settings-plate">
                        <div class="settings-item main-settings-item" id="goto-api-settings-btn">
                            <div class="main-settings-item-icon">
                                <svg t="1757620534100" class="icon" viewBox="0 0 1026 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="16440" width="20" height="20">
                                    <path
                                        d="M683.328 744.616c-17.101 0-34.136-7.14-46.499-21.15-31.763-36.082-77.042-56.72-124.239-56.72-47.96 0-92.086 20.061-124.109 56.46-23.31 26.429-62.948 28.486-88.697 4.44-25.74-23.99-27.667-64.754-4.357-91.183 55.333-62.827 134.488-98.835 217.162-98.835 82.553 0 161.708 36.138 217.228 99.086 23.319 26.429 21.336 67.193-4.347 91.183C713.499 739.151 698.381 744.616 683.328 744.616L683.328 744.616 683.328 744.616zM822.676 583.019c-16.002 0-32.079-6.302-44.311-18.776C707.28 491.52 612.886 451.519 512.59 451.519c-100.538 0-194.942 39.936-265.896 112.472-24.585 25.209-64.363 25.004-88.827-0.261-24.455-25.274-24.325-66.169 0.261-91.313 94.655-96.703 220.56-150.016 354.462-150.016 133.725 0 259.565 53.369 354.406 150.342 24.595 25.144 24.66 66.039 0.261 91.378C854.96 576.661 838.818 583.019 822.676 583.019L822.676 583.019 822.676 583.019zM961.716 421.814c-15.63 0-31.251-5.976-43.483-17.939C808.601 295.852 664.57 236.302 512.59 236.302c-152.287 0-296.383 59.42-405.755 167.387-24.986 24.623-64.745 23.85-88.827-1.936-24.017-25.721-23.18-66.616 1.787-91.313 132.887-131.109 307.852-203.385 492.73-203.385 184.506 0 359.471 72.276 492.609 203.45 25.041 24.697 25.87 65.592 1.927 91.313C994.699 415.13 978.175 421.814 961.716 421.814L961.716 421.814 961.716 421.814zM436.702 838.945c0 43.082 33.941 78.001 75.888 78.001 41.882 0 75.888-34.918 75.888-78.001s-34.006-78.001-75.888-78.001C470.708 761.009 436.702 795.862 436.702 838.945L436.702 838.945 436.702 838.945z"
                                        fill="#353333" p-id="16441"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title"><span class="api-text">API</span> 设置</span>
                        </div>
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757620734584" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="24727" width="20" height="20">
                                    <path
                                        d="M853.333333 256h-341.333333l-85.333333-85.333333H170.666667a85.333333 85.333333 0 0 0-85.333334 85.333333v512a85.333333 85.333333 0 0 0 85.333334 85.333333h682.666666a85.333333 85.333333 0 0 0 85.333334-85.333333V341.333333a85.333333 85.333333 0 0 0-85.333334-85.333333z m-341.333333 85.333333a106.666667 106.666667 0 1 1-106.666667 106.666667A106.24 106.24 0 0 1 512 341.333333z m192 426.666667h-384v-42.666667a128 128 0 0 1 128-128h128a128 128 0 0 1 128 128v42.666667z"
                                        fill="#353333" p-id="24728"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">后台功能</span>
                        </div>
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757621216939" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="56772" width="20" height="20">
                                    <path
                                        d="M807.8 38.8 36.8 809.8l179.6 179.6 771-771L807.8 38.8zM158.8 851.6l-70-70 15.4-15.4 70 70L158.8 851.6zM227.4 783l-70-70 15.4-15.4 70 70L227.4 783zM295.8 714.6l-70-70 15.4-15.4 70 70L295.8 714.6zM364.4 646l-70-70 15.4-15.4 70 70L364.4 646zM432.8 577.6l-70-70 15.4-15.4 70 70L432.8 577.6zM501.4 509l-70-70 15.4-15.4 70 70L501.4 509zM570 440.6l-70-70 15.4-15.4 70 70L570 440.6zM638.4 372l-70-70 15.4-15.4 70 70L638.4 372zM707 303.4l-70-70 15.4-15.4 70 70L707 303.4zM775.4 235l-70-70 15.4-15.4 70 70L775.4 235zM774 96.4l15.4-15.4 70 70-15.4 15.4L774 96.4zM845.4 671.8 711 537.4 536 712.4 670.4 846.8 898 899.4ZM213.96432 40.52308l272.9406 272.9406-174.93654 174.93654-272.9406-272.9406 174.93654-174.93654Z"
                                        fill="#353333" p-id="56773"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">主题设置</span>
                        </div>
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757631435980" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="24174" width="18.5" height="18.5">
                                    <path
                                        d="M384 597.333333a85.333333 85.333333 0 0 1 78.933333-85.12L469.333333 512h469.333334V256h-42.666667v85.333333a85.333333 85.333333 0 0 1-85.333333 85.333334H85.333333a85.333333 85.333333 0 0 1-85.333333-85.333334V85.333333a85.333333 85.333333 0 0 1 85.333333-85.333333h725.333334a85.333333 85.333333 0 0 1 85.333333 85.333333v85.333334h42.666667a85.333333 85.333333 0 0 1 85.12 78.933333L1024 256v256a85.333333 85.333333 0 0 1-78.933333 85.12L938.666667 597.333333H469.333333v128a42.666667 42.666667 0 0 1 42.666667 42.666667v213.333333a42.666667 42.666667 0 0 1-42.666667 42.666667H384a42.666667 42.666667 0 0 1-42.666667-42.666667v-213.333333a42.666667 42.666667 0 0 1 42.666667-42.666667v-128z"
                                        fill="#353333" p-id="24175"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">外观设置</span>
                        </div>
                        <!-- 【新增】字体设置板块 -->
                        <div class="settings-item main-settings-item" id="goto-font-settings-btn">
                            <div class="main-settings-item-icon">
                                <svg t="1757621130380" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="54806" width="20" height="20">
                                    <path
                                        d="M822.966016 452.8128c-4.7872-14.4128-19.2-24.0128-35.2-24.0128-14.3872 0-30.3872 9.6-35.2 24.0128l-198.4 441.6c-9.6 19.2 0 44.8 19.2 54.4s44.8 0 54.4-19.2l49.6128-104.0128h228.7872l49.6128 108.8c4.7872 14.4128 19.2 24.0128 35.2 24.0128 4.7872 0 9.6 0 14.3872-4.8128 14.4128-19.2 24.0128-39.9872 14.4128-59.1872l-196.8128-441.6zM787.766016 563.2l80 172.8h-153.6L787.766016 563.2zM421.378816 100.8128C416.566016 86.4 400.566016 76.8 381.366016 76.8c-14.3872 0-30.3872 9.6-39.9872 24.0128L3.766016 889.6c-9.6 19.2 0 44.8 19.2 54.4s44.8 0 54.4-19.2l104.0128-238.3872h401.5872l4.8128-9.6 39.9872-84.8128v-9.6L421.378816 100.8128z m-35.2 119.9872L549.378816 608H222.978816l163.2-387.2z"
                                        fill="#353333" p-id="54807"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">字体设置</span>
                        </div>
                    </div>


                    <!-- 板块2: 显示手机框 -->
                    <div class="settings-plate">
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757621314631" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="62989" width="24" height="24">
                                    <path
                                        d="M855 160.1l-189.2 23.5c-6.6 0.8-9.3 8.8-4.7 13.5l54.7 54.7-153.5 153.5c-3.1 3.1-3.1 8.2 0 11.3l45.1 45.1c3.1 3.1 8.2 3.1 11.3 0l153.6-153.6 54.7 54.7c4.7 4.7 12.7 1.9 13.5-4.7L863.9 169c0.7-5.2-3.7-9.6-8.9-8.9zM416.6 562.3c-3.1-3.1-8.2-3.1-11.3 0L251.8 715.9l-54.7-54.7c-4.7-4.7-12.7-1.9-13.5 4.7L160.1 855c-0.6 5.2 3.7 9.5 8.9 8.9l189.2-23.5c6.6-0.8 9.3-8.8 4.7-13.5l-54.7-54.7 153.6-153.6c3.1-3.1 3.1-8.2 0-11.3l-45.2-45z"
                                        p-id="62990" fill="#353333"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">显示手机框</span>
                            <label class="switch">
                                <input type="checkbox" id="show-phone-frame-toggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 板块3: 导入导出 -->
                    <div class="settings-plate">
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757622004789" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="8129" width="24" height="24">
                                    <path
                                        d="M712.533333 371.2l-128 128-59.733333-59.733333 128-128L597.333333 256l-42.666666-42.666667h256v256l-42.666667-42.666666-55.466667-55.466667zM657.066667 256H768v110.933333V256h-110.933333zM298.666667 298.666667v426.666666h426.666666v-256l85.333334 85.333334v256H213.333333V213.333333h256l85.333334 85.333334H298.666667z"
                                        fill="#353333" p-id="8130"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">导出数据</span>
                        </div>
                        <div class="settings-item main-settings-item">
                            <div class="main-settings-item-icon">
                                <svg t="1757621959264" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="7020" width="24" height="24">
                                    <path
                                        d="M746.666667 469.333333H554.666667V213.333333l42.666666 42.666667 51.2 51.2L746.666667 213.333333l59.733333 59.733334-98.133333 98.133333 21.333333 21.333333 38.4 34.133334 42.666667 42.666666h-64zM512 213.333333v85.333334H298.666667v426.666666h426.666666v-213.333333h85.333334v298.666667H213.333333V213.333333h298.666667z"
                                        fill="#353333" p-id="7021"></path>
                                </svg>
                            </div>
                            <span class="settings-item-title">导入数据</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【新增】聊天设置页面 -->
            <!-- =================================================================== -->
            <div id="chat-settings-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="chat-interface-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>聊天设置</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div id="chat-settings-container" class="form-container">
                    <!-- 板块1: 对方信息 & 我的身份 -->
                    <div class="settings-plate">
                        <div class="settings-item" id="ai-info-item">
                            <img src="" class="settings-avatar" id="ai-settings-avatar">
                            <span class="settings-item-title" id="ai-settings-name-display">对方名字</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="settings-item" id="user-info-item">
                            <img src="" class="settings-avatar" id="user-settings-avatar">
                            <span class="settings-item-title" id="user-settings-name-display">设置我的名字</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 板块2: 查找聊天内容 -->
                    <div class="settings-plate">
                        <div class="settings-item">
                            <span class="settings-item-title">查找聊天内容</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 板块3: 气泡样式设置 -->
                    <div class="settings-plate">
                        <div class="settings-item" id="open-bubble-style-modal-btn">
                            <span class="settings-item-title">气泡样式设置</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 板块4: 设置聊天背景 -->
                    <div class="settings-plate">
                        <div class="settings-item" id="open-background-modal-btn">
                            <span class="settings-item-title">设置聊天背景</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 板块5: 头像设置 -->
                    <div class="settings-plate">
                        <!-- 【V4.0 新增】置顶聊天开关 -->
                        <div class="settings-item">
                            <span class="settings-item-title">置顶聊天</span>
                            <label class="switch">
                                <input type="checkbox" id="pin-chat-toggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <span class="settings-item-title">显示头像</span>
                            <label class="switch">
                                <input type="checkbox" id="show-avatars-toggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <span class="settings-item-title">头像圆角值</span>
                            <!-- 【修改】将输入框和单位包裹起来 -->
                            <div class="settings-input-wrapper">
                                <input type="text" id="avatar-radius-input" class="settings-value-input"
                                    placeholder="0">
                                <span class="settings-unit-label">px</span>
                            </div>
                        </div>

                        <div class="settings-item">
                            <span class="settings-item-title">字体大小</span>
                            <!-- 【修改】将输入框和单位包裹起来 -->
                            <div class="settings-input-wrapper">
                                <input type="text" id="font-size-input" class="settings-value-input" placeholder="16">
                                <span class="settings-unit-label">px</span>
                            </div>
                        </div>

                        <!-- 【【【核心新增】】】 -->
                        <div class="settings-item">
                            <span class="settings-item-title">上下文记忆轮数</span>
                            <div class="settings-input-wrapper">
                                <input type="number" id="max-memory-input" class="settings-value-input"
                                    placeholder="10">
                                <span class="settings-unit-label">条</span>
                            </div>
                        </div>
                    </div>

                    <!-- 板块6: 清空聊天记录 -->
                    <div class="settings-plate">
                        <div class="settings-item settings-item-center" id="clear-history-btn">
                            <span>清空聊天记录</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V2.03】对方信息页面 -->
            <!-- =================================================================== -->
            <div id="ai-info-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="chat-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="ai-info-title">对方信息</h1>
                    <button class="header-edit-btn" id="save-ai-info-btn">保存</button>
                </div>
                <div class="form-container info-screen-form">
                    <!-- 头像和名称 -->
                    <div class="info-avatar-section">
                        <img src="" class="info-avatar" id="ai-info-avatar">
                        <span class="info-name" id="ai-info-name-display">名称</span>
                    </div>
                    <!-- 对方人设 -->
                    <div class="preset-form-group">
                        <label>对方人设 (ai)</label>
                        <textarea class="info-textarea" id="ai-persona-input"></textarea>
                    </div>
                    <!-- 与我的关系 -->
                    <div class="preset-form-group">
                        <label>与我的关系</label>
                        <textarea class="info-textarea" id="ai-relationship-input"></textarea>
                    </div>
                    <!-- 关联角色书 -->
                    <div class="preset-form-group">
                        <label>关联角色书 (可多选)</label>
                        <div class="preset-dropdown-container" id="ai-info-associations-dropdown">
                            <div class="preset-dropdown-header">
                                <span id="ai-info-dropdown-label">点击选择</span>
                                <div class="preset-dropdown-arrow">
                                    <svg t="1758256512079" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="54311" width="10" height="10">
                                        <path
                                            d="M406.656 836.096L56.96 328.576A128 128 0 0 1 162.304 128h699.392a128 128 0 0 1 105.344 200.576L617.472 836.096a128 128 0 0 1-210.816 0z"
                                            fill="#515151" opacity=".99" p-id="54312"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="preset-dropdown-list">
                                <!-- 关联项将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    <!-- 表情包库 -->
                    <div class="preset-form-group">
                        <label>表情包库</label>
                        <div class="sticker-pack-list" id="ai-info-sticker-pack-list">
                            <!-- 表情包列表将由JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V2.03】我的信息页面 -->
            <!-- =================================================================== -->
            <div id="my-info-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="chat-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="my-info-title">我的信息</h1>
                    <button class="header-edit-btn" id="save-my-info-btn">保存</button>
                </div>
                <div class="form-container info-screen-form">
                    <!-- 头像和名称 -->
                    <div class="info-avatar-section">
                        <img src="" class="info-avatar" id="my-info-avatar">
                        <span class="info-name" id="my-info-name-display">名称</span>
                    </div>
                    <!-- 我的人设 -->
                    <div class="preset-form-group">
                        <label>我的人设</label>
                        <textarea class="info-textarea" id="my-persona-input"></textarea>
                    </div>
                    <!-- 补充信息 -->
                    <div class="preset-form-group">
                        <label>补充信息</label>
                        <textarea class="info-textarea" id="my-supplementary-info-input"
                            placeholder="可在此处填写关于二人的回忆或补充信息等..."></textarea>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V2.03】管理表情页面 -->
            <!-- =================================================================== -->
            <div id="manage-stickers-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="ai-info-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>管理表情</h1>
                    <div class="manage-stickers-header-actions">
                        <button class="header-icon" id="sticker-delete-mode-btn">
                            <svg t="1758266990858" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="69048" width="24.5" height="24.5">
                                <path
                                    d="M757.397 323.67c17.602 0 31.354 15.122 29.782 32.585l-0.052 0.53-46.184 429.569C734.961 842 688.36 884.28 632.603 884.99l-1.693 0.009-290.07-0.69c-55.705-0.133-102.489-41.739-109.305-96.876l-0.194-1.675-46.493-428.948c-1.899-17.518 11.662-32.832 29.195-33.137l0.532-0.004h542.822zM402.692 452.969c-16.349 0-29.633 13.127-29.897 29.421l-0.004 0.495v204.81l0.008 0.706c0.375 16.196 13.615 29.21 29.893 29.21 16.349 0 29.633-13.127 29.897-29.421l0.004-0.495v-204.81l-0.008-0.706c-0.375-16.196-13.615-29.21-29.893-29.21z m156.004 0c-16.349 0-29.633 13.127-29.897 29.421l-0.004 0.495v204.81l0.008 0.706c0.375 16.196 13.615 29.21 29.893 29.21 16.349 0 29.633-13.127 29.897-29.421l0.004-0.495v-204.81l-0.008-0.706c-0.375-16.196-13.615-29.21-29.893-29.21z m268.403-210.153c16.514 0 29.901 13.394 29.901 29.916 0 16.286-13.007 29.533-29.195 29.908l-0.706 0.008H133.9c-16.514 0-29.901-13.394-29.901-29.916 0-16.286 13.007-29.533 29.195-29.908l0.706-0.008H827.1zM598.003 140c16.514 0 29.902 13.394 29.902 29.916 0 16.286-13.008 29.533-29.196 29.908l-0.706 0.008H362.758c-16.514 0-29.901-13.394-29.901-29.916 0-16.286 13.007-29.533 29.195-29.908l0.706-0.008h235.245z"
                                    fill="#353333" p-id="69049"></path>
                            </svg>
                        </button>
                        <div class="delete-mode-actions" style="display: none;">
                            <button class="delete-mode-btn" id="confirm-sticker-delete-btn">删除</button>
                            <button class="delete-mode-btn" id="cancel-sticker-delete-btn">取消</button>
                        </div>
                    </div>
                </div>
                <div class="form-container sticker-management-container">
                    <span class="sticker-pack-editable-title" id="sticker-pack-title-editor" contenteditable="true"
                        spellcheck="false">默认</span>
                    <div class="sticker-management-grid" id="sticker-management-grid-view">
                        <!-- 管理页的表情将由JS动态生成 -->
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.65】情侣空间页面 -->
            <!-- =================================================================== -->
            <div id="couple-space-screen" class="screen">
                <!-- 独特的弧形顶栏 -->
                <div class="couple-header">
                    <button class="header-icon" data-target="home-screen">
                        <svg t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#2c2c2c" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>情侣空间</h1>
                    <!-- 【新增】右上角“更多”按钮 -->
                    <button class="header-icon header-icon-right" id="couple-space-options-btn">
                        <svg t="1757796956627" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="19436" width="18" height="18">
                            <path d="M224 512a64 64 0 1 0-128 0 64 64 0 0 0 128 0Z" fill="#2c2c2c" p-id="19437"></path>
                            <path d="M576 512a64 64 0 1 0-128 0 64 64 0 0 0 128 0Z" fill="#2c2c2c" p-id="19438"></path>
                        </svg>
                    </button>
                </div>

                <!-- =================================================================== -->
                <!-- 【【【 在这里新增下面的代码 】】】 -->
                <div id="couple-space-background-overlay"></div>
                <!-- =================================================================== -->

                <!-- 主内容区 -->
                <div class="couple-space-content">

                    <!-- 【新增】用于页面切换的容器 -->
                    <div class="couple-main-content">
                        <!-- 第1页：主界面 -->
                        <div id="couple-page-1" class="couple-content-page active">

                            <!-- 【【【关键新增：顶部固定的舞台容器】】】 -->
                            <div class="couple-space-header-content">
                                <!-- 【全新】 可自定义背景区域 -->
                                <div id="couple-custom-background-area"></div>

                                <!-- 拍立得容器 -->
                                <div id="polaroid-container">
                                    <div class="polaroid-item" id="polaroid-item-1">
                                        <div class="polaroid-tape"></div>
                                        <div class="polaroid-photo"></div>
                                        <div class="polaroid-delete-btn">
                                            <svg viewBox="0 0 24 24" width="12" height="12" stroke="#ffffff"
                                                stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="polaroid-item" id="polaroid-item-2">
                                        <div class="polaroid-tape"></div>
                                        <div class="polaroid-photo"></div>
                                        <div class="polaroid-delete-btn">
                                            <svg viewBox="0 0 24 24" width="12" height="12" stroke="#ffffff"
                                                stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="polaroid-item" id="polaroid-item-3">
                                        <div class="polaroid-tape"></div>
                                        <div class="polaroid-photo"></div>
                                        <div class="polaroid-delete-btn">
                                            <svg viewBox="0 0 24 24" width="12" height="12" stroke="#ffffff"
                                                stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="polaroid-item" id="polaroid-item-4">
                                        <div class="polaroid-tape"></div>
                                        <div class="polaroid-photo"></div>
                                        <div class="polaroid-delete-btn">
                                            <svg viewBox="0 0 24 24" width="12" height="12" stroke="#ffffff"
                                                stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <!-- 头像和提示语 -->
                                <div class="couple-avatars-container">
                                    <div class="couple-avatar-wrapper my-avatar-wrapper">
                                        <img id="couple-my-avatar-img"
                                            src="https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp"
                                            class="couple-avatar">
                                        <div class="avatar-delete-btn">
                                            <svg viewBox="0 0 24 24" width="12" height="12" stroke="#ffffff"
                                                stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="couple-avatar-wrapper partner-avatar-wrapper"
                                        data-target="couple-space-invite-screen">
                                        <img id="couple-partner-avatar-img" src="" class="couple-avatar"
                                            style="display: none;">
                                        <div class="couple-avatar partner-avatar-placeholder">
                                            <svg t="1757772627589" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                                xmlns="http://www.w3.org/2000/svg" p-id="155641" width="28" height="28">
                                                <path
                                                    d="M884.392 476.688h-336.6v-336.6c0-19.422-15.891-35.312-35.313-35.312-19.421 0-35.311 15.89-35.311 35.312v336.6H140.567c-19.421 0-35.312 15.89-35.312 35.311 0 19.422 15.89 35.312 35.312 35.312h336.6v336.6c0 19.421 15.89 35.311 35.311 35.311 19.422 0 35.312-15.89 35.312-35.312V547.312h336.6c19.421 0 35.312-15.89 35.312-35.312 0.001-19.421-15.89-35.312-35.31-35.312z"
                                                    p-id="155642" fill="#ffdc82"></path>
                                            </svg>
                                        </div>
                                        <div class="breakup-popup">
                                            <button class="breakup-close-btn">
                                                <svg t="1758715492835" class="icon" viewBox="0 0 1024 1024"
                                                    version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="106221"
                                                    width="11" height="11">
                                                    <path
                                                        d="M886.528 908.032c-28.096 28.096-73.856 28.096-102.016 0L138.304 261.824c-28.096-28.16-28.16-73.856 0-102.016 28.032-28.16 73.792-28.16 102.08 0l646.144 646.144C914.624 834.24 914.752 879.872 886.528 908.032L886.528 908.032zM885.76 261.504 239.616 907.648c-28.224 28.224-73.92 28.224-102.08 0-28.16-28.096-28.16-73.728 0.064-102.016L783.744 159.552c28.224-28.16 73.984-28.16 102.016-0.064C913.984 187.648 913.856 233.344 885.76 261.504L885.76 261.504z"
                                                        fill="#ffffff" p-id="106222"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 【全新】发动态按钮 -->
                                <button id="post-status-btn">
                                    <svg t="1758793265382" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                        xmlns="http://www.w3.org/2000/svg" p-id="13270" width="15" height="15">
                                        <path
                                            d="M512 901.746939c-13.583673 0-26.122449-4.179592-37.093878-13.061225-8.881633-7.314286-225.697959-175.020408-312.424489-311.379592C133.746939 532.37551 94.040816 471.24898 94.040816 384.522449c0-144.718367 108.146939-262.269388 240.326531-262.269388 67.395918 0 131.657143 30.82449 177.632653 84.636735 45.453061-54.334694 109.191837-84.636735 177.110204-84.636735 132.702041 0 240.326531 117.55102 240.326531 262.269388 0 85.159184-37.093878 143.673469-67.395919 191.216327l-1.044898 1.567346c-86.726531 136.359184-303.542857 304.587755-312.424489 311.379592-10.44898 8.359184-22.987755 13.061224-36.571429 13.061225z"
                                            fill="#ffffff" p-id="13271"></path>
                                    </svg>
                                    <span>发动态</span>
                                </button>

                                <!-- 【全新】绑定后的天数计数器 -->
                                <div class="couple-days-counter-bound">
                                    <span class="days-prefix">在一起</span>
                                    <span class="days-number">001</span>
                                    <span class="days-suffix">天</span>
                                </div>

                                <!-- 【全新】分割线 -->
                                <div class="couple-section-divider"></div>

                                <!-- 【全新】动态/相册 选项卡容器 -->
                                <div class="couple-tabs-container">
                                    <div class="couple-tab-items-wrapper">
                                        <div class="couple-tab-item active">动态</div>
                                        <div class="couple-tab-item">相册</div>
                                    </div>
                                    <div class="couple-tab-slider"></div>
                                </div>
                            </div>

                            <!-- 【【【关键】】】动态流现在位于“舞台”的外面 -->
                            <div id="couple-status-feed">
                                <!-- 动态卡片将由JavaScript动态生成到这里 -->
                            </div>

                            <!-- （这个是旧的，会被CSS修改显示状态） -->
                            <p class="couple-space-prompt">添加另一半解锁更多功能</p>
                        </div>

                        <!-- 第2页：消息 -->
                        <div id="couple-page-2" class="couple-content-page">
                            <!-- 未绑定时的提示 -->
                            <p class="couple-feature-locked-prompt">未绑定关系，此功能未开放</p>
                            <!-- 绑定后的消息列表 -->
                            <div class="couple-message-list" style="display: none;">
                                <div class="couple-message-item" data-target="couple-status-detail-screen">
                                    <div class="message-item-icon-wrapper">
                                        <svg t="1758622644540" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="99605" width="20" height="20">
                                            <path
                                                d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z"
                                                fill="#ffffff" p-id="99606"></path>
                                        </svg>
                                    </div>
                                    <div class="message-item-content">
                                        <p class="message-item-title">状态</p>
                                        <p class="message-item-subtitle">暂无消息</p>
                                    </div>
                                    <span class="message-item-timestamp"></span>
                                </div>
                                <div class="couple-message-item">
                                    <div class="message-item-icon-wrapper">
                                        <svg t="1758622667988" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="100927" width="19.5" height="19.5">
                                            <path
                                                d="M933.487032 440.406428 351.446839 440.406428l91.479481-24.397666 0.324388 0.054235 0.024559-0.148379 195.429994-52.123125 0.620124 0.104377 0.047072-0.281409 188.366112-50.238195 0.215918 0.035816 0.016373-0.098237 106.767676-28.475542c13.652951-3.640923 21.766746-17.659195 18.125823-31.311123L907.709949 84.209914c-1.747807-6.556323-6.02932-12.148691-11.901051-15.548114-5.871731-3.399423-12.855796-4.327562-19.410072-2.578732l-689.635723 183.929056-1.000793-0.167822-0.075725 0.454348-101.766778 27.14115c-6.5553 1.74883-12.147668 6.030343-15.547091 11.901051-3.399423 5.872754-4.327562 12.854772-2.578732 19.410072l43.243897 162.141844 0 462.305181c0 14.130835 11.452843 25.582655 25.582655 25.582655l798.866497 0c14.129812 0 25.582655-11.45182 25.582655-25.582655l0-467.210911C959.069687 451.860295 947.61582 440.406428 933.487032 440.406428zM262.200212 411.255505l22.479991-134.403083 82.083483-21.892613-22.481014 134.403083L262.200212 411.255505zM475.027435 226.085178l87.834464-23.425525-22.482037 134.403083-87.834464 23.426549L475.027435 226.085178zM671.126672 173.785022l80.334653-21.425985-22.479991 134.403083-80.335676 21.425985L671.126672 173.785022zM896.838344 241.99452l-59.592236 15.893992 22.479991-134.403083 5.140067-1.37123L896.838344 241.99452zM176.41543 305.727053l-22.481014 134.403083-0.13917 0.036839-31.972179-119.880321L176.41543 305.727053zM907.904377 907.618363 160.20319 907.618363l0-416.045601 747.701187 0L907.904377 907.618363z"
                                                fill="#ffffff" p-id="100928"></path>
                                            <path
                                                d="M242.604922 646.450155l603.346451 0c14.129812 0 25.582655-11.452843 25.582655-25.582655l0-1.023306c0-14.128789-11.452843-25.582655-25.582655-25.582655L242.604922 594.261539c-14.129812 0-25.582655 11.453866-25.582655 25.582655l0 1.023306C217.022267 634.995265 228.47511 646.450155 242.604922 646.450155z"
                                                fill="#ffffff" p-id="100929"></path>
                                            <path
                                                d="M242.604922 805.574269l603.346451 0c14.129812 0 25.582655-11.452843 25.582655-25.582655l0-1.023306c0-14.129812-11.452843-25.582655-25.582655-25.582655L242.604922 753.385653c-14.129812 0-25.582655 11.452843-25.582655 25.582655l0 1.023306C217.022267 794.119379 228.47511 805.574269 242.604922 805.574269z"
                                                fill="#ffffff" p-id="100930"></path>
                                        </svg>
                                    </div>
                                    <div class="message-item-content">
                                        <p class="message-item-title">你演我猜</p>
                                        <p class="message-item-subtitle">未开始，暂无消息</p>
                                    </div>
                                    <span class="message-item-timestamp"></span>
                                </div>
                                <div class="couple-message-item">
                                    <div class="message-item-icon-wrapper">
                                        <svg t="1758622696482" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="104163" width="30" height="30">
                                            <path
                                                d="M826.85 431.04l-16.16-48.02c-2.52-7.48-12.97-7.81-15.96-0.51l-15.1 36.87c-1.87 4.55-2 9.64-0.36 14.28l1.32 3.76a40.102 40.102 0 0 1-0.64 28.24l-119.7 297.02c-6.99 17.35-25.05 27.55-43.52 24.59l-326.1-52.37a39.909 39.909 0 0 1-29.36-21.55l-10.93-21.86c-3.72-7.42 2.53-15.92 10.72-14.61l322.79 51.84c18.39 2.95 36.38-7.15 43.43-24.37l164.37-401.31c9.78-23.87-5.21-50.62-30.67-54.74l-346.45-56.19c-18.4-2.98-36.43 7.11-43.49 24.36L200.38 633.08a71.317 71.317 0 0 0 3.86 62.02l24.29 43.14a71.295 71.295 0 0 0 50.83 35.42l362.43 58.21c18.46 2.97 36.51-7.22 43.51-24.56l140.75-348.5c3.58-8.86 3.87-18.72 0.82-27.79z m-296.13-50.21c1 1.87 3.68 2.39 5.93 1.17 97.28-52.76 173.74 73.13 18.03 135.18-37.28 15.38-52.12 18.83-79.38 27.59-5.65 1.82-11.53 0.66-14.97-2.96-16.69-17.52-26.55-25.68-46.78-52.5-85.83-109.75 74.11-188.95 117.17-108.49z"
                                                p-id="104164" fill="#ffffff"></path>
                                        </svg>
                                    </div>
                                    <div class="message-item-content">
                                        <p class="message-item-title">心情日记</p>
                                        <p class="message-item-subtitle">暂无消息</p>
                                    </div>
                                    <span class="message-item-timestamp"></span>
                                </div>
                            </div>
                        </div>
                        <div id="couple-page-3" class="couple-content-page">
                            <p class="couple-feature-locked-prompt">未绑定关系，此功能未开放</p>
                        </div>
                        <div id="couple-page-4" class="couple-content-page">
                            <p class="couple-feature-locked-prompt">未绑定关系，此功能未开放</p>
                        </div>
                    </div>

                    <!-- 【全新】底部导航栏 -->
                    <div class="couple-bottom-nav">
                        <div class="nav-slider"></div>
                        <div id="couple-nav-icon-1" class="nav-icon-wrapper" data-page="1">
                            <svg t="1757788421766" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="30657" width="28" height="28">
                                <path
                                    d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z"
                                    fill="#ffffff" p-id="30658"></path>
                            </svg>
                        </div>
                        <div id="couple-nav-icon-2" class="nav-icon-wrapper" data-page="2">
                            <svg t="1757788519577" class="icon" viewBox="0 0 1163 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="36960" width="30" height="30">
                                <path
                                    d="M1087.246369 133.098887A3085.113769 3085.113769 0 0 0 373.730676 91.632165c-24.313255 1.40756-42.954044 19.466557-41.429187 39.721347l32.040761 442.063029c1.524857 20.259482 19.241347 35.597196 39.383532 34.438304a2570.598928 2570.598928 0 0 1 341.980811 2.932417c-0.211134 1.210502-0.375349 2.430387-0.473878 3.673732l-7.070644 93.912413c-1.48263 20.264174 9.1726 25.93195 24.027052 12.794721a2359.976321 2359.976321 0 0 1 117.010474-96.79791 2557.396014 2557.396014 0 0 1 118.469645 18.002694c19.949819 3.500133 39.383533-9.67463 43.235555-29.615065l83.060124-435.372427c3.852023-19.949819-12.635198-40.05447-36.718552-44.286533zM584.94915 400.568156c-33.828362-0.403501-61.627675-25.655129-62.092169-57.278314-0.464495-31.599725 27.930685-57.639588 63.424659-57.212628 35.50805 0.398809 63.312055 27.090841 62.101554 58.67649-1.196426 31.604417-29.586914 56.194493-63.434044 55.814452z m334.103166-33.612536c-4.217989 31.351056-34.898108 53.093168-68.57633 49.466355-33.69699-3.654964-58.986153-31.449585-56.41501-62.969549 2.566451-31.501196 33.359175-54.693095 68.717086-50.864531 35.339143 3.809796 60.501627 33.04482 56.274254 64.367725z"
                                    fill="#ffffff" p-id="36961"></path>
                                <path
                                    d="M703.479789 699.430708c-1.182351 19.410254-2.364701 38.820509-3.556435 58.230763-1.318415 21.488751-6.35748 47.162648-11.115033 57.062488-4.813856 9.820078-43.061956 16.201017-62.57074 15.698987a2342.400586 2342.400586 0 0 0-245.042145 5.132903c-19.522859 1.431019-35.386062 3.425063-35.278148 4.086616 0.103221 0.670937 1.857979 20.015505 3.758185 41.466722l1.398176 15.797516c1.890822 21.451216 1.651537 44.858942-0.502029 52.004656-2.120724 7.122254-29.497769-11.527918-44.530511-25.143716a2194.733452 2194.733452 0 0 0-53.39814-47.275254c-15.516005-13.376513-44.413214-21.873485-63.82816-18.776852-2.266172 0.35189-4.527652 0.708472-6.793824 1.074438-19.368027 3.068481-43.282474 3.509517-53.262075 0.713164-9.904532-2.829196-25.232861-42.325333-29.314786-63.476271L31.069544 437.596371c-4.081924-21.146245-2.876115-63.818777 7.450685-70.354547 10.242346-6.549847 38.018199-15.276719 61.679285-19.030213a2859.08307 2859.08307 0 0 1 192.896733-24.219419l3.556436 38.9988 24.069278 264.072357c2.017503 21.446525 20.747436 37.403565 41.649705 35.827098a2517.139794 2517.139794 0 0 1 343.482208-2.542992l-2.374085 39.083253z"
                                    fill="#ffffff" p-id="36962"></path>
                            </svg>
                        </div>
                        <div id="couple-nav-icon-3" class="nav-icon-wrapper" data-page="3">
                            <svg t="1757788564775" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="38246" width="38" height="38">
                                <path
                                    d="M826.85 431.04l-16.16-48.02c-2.52-7.48-12.97-7.81-15.96-0.51l-15.1 36.87c-1.87 4.55-2 9.64-0.36 14.28l1.32 3.76a40.102 40.102 0 0 1-0.64 28.24l-119.7 297.02c-6.99 17.35-25.05 27.55-43.52 24.59l-326.1-52.37a39.909 39.909 0 0 1-29.36-21.55l-10.93-21.86c-3.72-7.42 2.53-15.92 10.72-14.61l322.79 51.84c18.39 2.95 36.38-7.15 43.43-24.37l164.37-401.31c9.78-23.87-5.21-50.62-30.67-54.74l-346.45-56.19c-18.4-2.98-36.43 7.11-43.49 24.36L200.38 633.08a71.317 71.317 0 0 0 3.86 62.02l24.29 43.14a71.295 71.295 0 0 0 50.83 35.42l362.43 58.21c18.46 2.97 36.51-7.22 43.51-24.56l140.75-348.5c3.58-8.86 3.87-18.72 0.82-27.79z m-296.13-50.21c1 1.87 3.68 2.39 5.93 1.17 97.28-52.76 173.74 73.13 18.03 135.18-37.28 15.38-52.12 18.83-79.38 27.59-5.65 1.82-11.53 0.66-14.97-2.96-16.69-17.52-26.55-25.68-46.78-52.5-85.83-109.75 74.11-188.95 117.17-108.49z"
                                    p-id="38247" fill="#ffffff"></path>
                            </svg>
                        </div>
                        <div id="couple-nav-icon-4" class="nav-icon-wrapper" data-page="4">
                            <svg t="1757788353703" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="28337" width="28" height="28">
                                <path
                                    d="M508.756563 284.696623a51.194198 51.194198 0 1 0 99.942451 22.184153l2.844122-12.741667 115.300711 103.070985c16.097731 14.391258 23.151154 36.347881 18.486793 57.451267l-94.538619 424.968725a59.669682 59.669682 0 0 1-71.216817 45.278424l-317.68844-70.647993a59.669682 59.669682 0 0 1-45.278424-71.216818l94.595501-424.968725c4.66436-21.103386 20.363914-37.997471 41.069124-44.197658l160.692899-48.236311-4.209301 19.055618z m126.677199-98.06533l25.142039-112.911648a51.194198 51.194198 0 1 0-99.942451-22.184152l-24.288802 108.986759c-11.205841 0.853237-22.468565 2.901005-33.560641 6.257069l-178.610869 53.58326a157.279953 157.279953 0 0 0-108.30417 116.495242l-94.538619 425.025608a157.279953 157.279953 0 0 0 119.396246 187.712059l317.631558 70.647994a157.279953 157.279953 0 0 0 187.712059-119.396247l94.538619-425.025608a157.279953 157.279953 0 0 0-48.691371-151.421061l-139.077571-124.288136a157.564365 157.564365 0 0 0-17.406027-13.481139z m-56.3705 253.581927a56.882442 56.882442 0 1 1-111.034527-24.743862 56.882442 56.882442 0 0 1 111.034527 24.743862z"
                                    fill="#ffffff" p-id="28338"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div id="couple-space-invite-screen" class="screen">
                <!-- 独特的弧形顶栏 -->
                <div class="couple-header">
                    <button class="header-icon" data-target="couple-space-screen">
                        <svg t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#2c2c2c" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>选择邀请好友</h1>
                    <div style="width: 44px;"></div>
                </div>
                <!-- 主内容区 -->
                <div id="couple-invite-list-container" class="form-container">
                    <!-- 好友列表将由JS动态生成 -->
                </div>
                <!-- 底栏 -->
                <div class="couple-footer"></div>
            </div>

            <!-- 【全新】情侣空间专用的头像上传工具 -->
            <input type="file" id="couple-avatar-upload-input" accept="image/*" style="display: none;">
            <!-- 【【【全新】】】情侣空间自定义背景上传工具 -->
            <input type="file" id="couple-custom-bg-upload-input" accept="image/*" style="display: none;">

            <!-- 【全新】发送成功提示框 -->
            <div id="success-toast">
                <svg t="1757748099897" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="128209" width="16" height="16">
                    <path
                        d="M512 85.333333c235.637333 0 426.666667 191.029333 426.666667 426.666667S747.637333 938.666667 512 938.666667 85.333333 747.637333 85.333333 512 276.362667 85.333333 512 85.333333z m182.613333 297.354667a32 32 0 0 0-45.258666 0.032L458.922667 573.44l-84.341334-83.989333a32 32 0 0 0-45.162666 45.344l106.986666 106.549333a32 32 0 0 0 45.226667-0.064l213.013333-213.333333a32 32 0 0 0-0.032-45.258667z"
                        fill="#ffdc82" p-id="128210"></path>
                </svg>
                <span>发送成功</span>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.73】更换主题页面 -->
            <!-- =================================================================== -->
            <div id="couple-theme-screen" class="screen">
                <!-- 独特的弧形顶栏 -->
                <div class="couple-header">
                    <button class="header-icon" id="couple-theme-back-btn">
                        <svg t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#2c2c2c" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>更换主题</h1>
                    <button class="header-edit-btn" id="couple-theme-edit-btn">编辑</button>
                </div>
                <!-- 主内容区 -->
                <div class="form-container">
                    <div class="theme-plate">
                        <!-- 奶黄色 -->
                        <div class="theme-choice-item" data-theme="yellow">
                            <div class="theme-color-preview"
                                style="background-color: #fff5df; border: 1.5px solid #fff1d1;"></div>
                            <span class="theme-title">奶黄色</span>
                        </div>
                        <!-- 淡粉色 -->
                        <div class="theme-choice-item" data-theme="pink">
                            <div class="theme-color-preview"
                                style="background-color: #fdeded; border: 1.5px solid #ffd8d8;"></div>
                            <span class="theme-title">淡粉色</span>
                        </div>
                        <!-- 浅蓝色 -->
                        <div class="theme-choice-item" data-theme="blue">
                            <div class="theme-color-preview"
                                style="background-color: #f1f6ff; border: 1.5px solid #aec7ff;"></div>
                            <span class="theme-title">浅蓝色</span>
                        </div>
                        <!-- 淡青色 -->
                        <div class="theme-choice-item" data-theme="cyan">
                            <div class="theme-color-preview"
                                style="background-color: #e3f9f1; border: 1.5px solid #b2f0da;"></div>
                            <span class="theme-title">淡青色</span>
                        </div>
                        <!-- 香芋紫 -->
                        <div class="theme-choice-item" data-theme="purple">
                            <div class="theme-color-preview"
                                style="background-color: #fbf3ff; border: 1.5px solid #e4cdf2;"></div>
                            <span class="theme-title">香芋紫</span>
                        </div>
                        <!-- 灰白配 -->
                        <div class="theme-choice-item" data-theme="white">
                            <div class="theme-color-preview"
                                style="background-color: #fcfafb; border: 1.5px solid #ffffff;"></div>
                            <span class="theme-title">灰白配</span>
                        </div>
                        <!-- 灰黑配 -->
                        <div class="theme-choice-item" data-theme="dark">
                            <div class="theme-color-preview"
                                style="background-color: #505050; border: 1.5px solid #181818;"></div>
                            <span class="theme-title">灰黑配</span>
                        </div>
                    </div>
                    <div class="theme-action-buttons">
                        <div class="theme-action-btn" id="theme-bg-upload-btn">
                            <div class="theme-color-preview"
                                style="background-color: #ffffff; border: 1.5px solid #b9b9b9;">
                                <svg t="1757790938109" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="43804" width="22" height="22">
                                    <path
                                        d="M896.4 296.6l-0.1 0.1c-20.5-21.1-48.8-32.7-78.2-32.1h-96.2l-22.1-58.2c-6.3-14.5-16.5-27-29.5-36-12.9-9.8-28.5-15.4-44.6-16H404.8c-16 0.5-31.5 6.1-44.1 16-13.1 9-23.3 21.5-29.7 36l-24 58.2h-98.2c-29.4-0.6-57.7 11-78.2 32.1-21.1 20.5-32.7 48.8-32.1 78.1v386.9c-0.6 29.4 11 57.7 32.1 78.2 20.5 21.1 48.8 32.7 78.2 32.1h609.4c29.3 0.2 57.5-11.4 78.2-32.1 20.7-20.7 32.3-48.9 32.1-78.2V374.8c0.6-29.4-11-57.7-32.1-78.2zM513.5 743.7c-100.7 0-182.4-81.6-182.4-182.3 0-100.7 81.6-182.4 182.3-182.4 100.7 0 182.4 81.6 182.4 182.3-0.3 100.6-81.7 182.1-182.3 182.4z m0-302.7C445.8 441 391 495.9 391 563.5c0 67.7 54.9 122.5 122.5 122.5 67.7 0 122.5-54.9 122.5-122.5 0.3-32.6-12.5-63.9-35.6-86.9-23-23.1-54.3-35.9-86.9-35.6z"
                                        p-id="43805" fill="#353333"></path>
                                </svg>
                            </div>
                            <span>更换背景</span>
                        </div>
                        <div class="theme-action-btn" id="theme-reset-btn">
                            <span>重置</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.91】外观设置页面 -->
            <!-- =================================================================== -->
            <div id="appearance-settings-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="main-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>外观设置</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div id="appearance-settings-container" class="form-container">
                    <!-- 板块1: 更换壁纸 -->
                    <div class="settings-plate">
                        <div class="settings-item" id="open-desktop-wallpaper-modal-btn">
                            <span class="settings-item-title">更换壁纸</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <!-- 板块2: 应用图标 & 小组件 -->
                    <div class="settings-plate">
                        <div class="settings-item" id="goto-app-icon-settings-btn">
                            <span class="settings-item-title">更换应用图标</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="settings-item">
                            <span class="settings-item-title">自定义小组件</span>
                            <div class="settings-arrow">
                                <svg t="1758194831460" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="4472" width="16.5" height="16.5">
                                    <path
                                        d="M746.382 477.867l-409.6-364.089c-18.204-15.93-47.787-15.93-63.715 4.55-15.929 18.205-15.929 47.787 4.551 63.717L648.533 512 277.618 841.955c-18.205 15.93-20.48 45.512-4.551 63.716 9.102 9.102 20.48 15.929 34.133 15.929 11.378 0 20.48-4.551 29.582-11.378l409.6-364.089c9.103-9.102 15.93-20.48 15.93-34.133s-4.552-25.031-15.93-34.133z"
                                        p-id="4473" fill="#515151"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="app-icon-settings-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="appearance-settings-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1>更换应用图标</h1>
                    <div style="width: 44px;"></div>
                </div>
                <div id="app-icon-settings-container" class="form-container">
                    <!-- 图标列表将由JS动态生成 -->
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【新增】创建/编辑文风页面 -->
            <!-- =================================================================== -->
            <div id="preset-writing-style-edit-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="world-book-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="writing-style-editor-title">创建文风</h1>
                    <button class="header-edit-btn" id="save-writing-style-btn">保存</button>
                </div>
                <div class="form-container asset-editor-form">
                    <div class="asset-editor-row">
                        <div class="preset-form-group">
                            <label>名称</label>
                            <input type="text" class="preset-input-box" id="new-writing-style-name-input">
                        </div>
                        <div class="preset-form-group">
                            <label>影响值</label>
                            <div class="influence-input-wrapper">
                                <input type="number" class="preset-input-box" id="new-writing-style-influence-input"
                                    value="50">
                                <span class="unit-label">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="preset-form-group">
                        <label>内容</label>
                        <textarea class="preset-textarea-box styled-textarea" id="new-writing-style-content-input"
                            placeholder="请在此处填写文风描述..."></textarea>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【新增】创建/编辑朋友圈素材页面 -->
            <!-- =================================================================== -->
            <div id="preset-social-asset-edit-screen" class="screen">
                <div class="header">
                    <button class="header-icon" data-target="world-book-screen">
                        <svg id="back-arrow-icon" t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8645" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#515151" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="social-asset-editor-title">创建素材</h1>
                    <button class="header-edit-btn" id="save-social-asset-btn">保存</button>
                </div>
                <div class="form-container asset-editor-form">
                    <div class="asset-editor-row">
                        <div class="preset-form-group">
                            <label>名称</label>
                            <input type="text" class="preset-input-box" id="new-social-asset-name-input">
                        </div>
                        <div class="preset-form-group">
                            <label>影响值</label>
                            <div class="influence-input-wrapper">
                                <input type="number" class="preset-input-box" id="new-social-asset-influence-input"
                                    value="50">
                                <span class="unit-label">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="preset-form-group">
                        <label>内容</label>
                        <textarea class="preset-textarea-box styled-textarea" id="new-social-asset-content-input"
                            placeholder="请在此处填写朋友圈文案风格..."></textarea>
                    </div>
                    <div class="preset-form-group">
                        <label>图片链接 (url)</label>
                        <div class="image-link-inputs">
                            <input type="text" class="preset-input-box" id="new-social-asset-image-url-input"
                                placeholder="在此粘贴图片url">
                            <input type="text" class="preset-input-box" id="new-social-asset-keyword-input"
                                placeholder="填入调用关键词">
                            <button id="add-social-asset-image-btn">
                                <svg t="1757638742634" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="28011" width="24" height="24">
                                    <path
                                        d="M828.704099 196.575729C744.096116 112.384034 631.648434 66.016073 512 66.016073s-232.1288 46.367961-316.736783 130.559656C110.624271 280.800108 64 392.831501 64 512c0 119.199462 46.624271 231.199892 131.232254 315.424271 84.607983 84.191695 197.088348 130.559656 316.736783 130.559656s232.1288-46.367961 316.704099-130.559656c84.67163-84.255342 131.295901-196.288456 131.263217-315.455235C959.967316 392.800538 913.375729 280.800108 828.704099 196.575729zM736.00086 544.00086 544.00086 544.00086l0 192c0 17.695686-14.336138 32.00086-32.00086 32.00086s-32.00086-14.303454-32.00086-32.00086L479.99914 544.00086 288.00086 544.00086c-17.664722 0-32.00086-14.336138-32.00086-32.00086s14.336138-32.00086 32.00086-32.00086l192 0L480.00086 288.00086c0-17.664722 14.336138-32.00086 32.00086-32.00086s32.00086 14.336138 32.00086 32.00086l0 192 192 0c17.695686 0 32.00086 14.336138 32.00086 32.00086S753.696546 544.00086 736.00086 544.00086z"
                                        fill="#353333" p-id="28012"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="social-asset-image-list">
                            <!-- JS will render image items here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【【【全新 V2.62】】】状态详情页面 -->
            <!-- =================================================================== -->
            <div id="couple-status-detail-screen" class="screen">
                <!-- 1. 独特的白色弧形顶栏 -->
                <div class="couple-header couple-status-header">
                    <!-- 原始顶栏元素 -->
                    <button class="header-icon" data-target="couple-space-screen">
                        <svg t="1757281244500" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                            <path
                                d="M723.413333 895.701333c-9.6 0-19.328-3.2-27.434666-9.6l-423.765334-340.906666a43.733333 43.733333 0 0 1 0-68.096l421.973334-339.114667a43.690667 43.690667 0 0 1 54.698666 68.096L369.28 511.146667l381.525333 306.901333a43.690667 43.690667 0 0 1-27.392 77.696z"
                                fill="#2c2c2c" p-id="8646"></path>
                        </svg>
                    </button>
                    <h1 id="couple-status-header-title"> </h1>

                    <!-- 【【【核心修改：将右侧按钮包裹起来，确保布局稳定】】】 -->
                    <div class="header-actions-wrapper">
                        <button class="header-icon header-icon-right" id="status-direct-delete-btn">
                            <svg t="1758950858003" class="icon" viewBox="0 0 1092 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="171903" width="15" height="15">
                                <path
                                    d="M1044.466356 144.42425c25.992272 0 47.072618 19.647702 47.072618 43.934444 0 19.443038-13.644237 36.157229-33.291939 41.95603l-6.753897 1.432644-7.095003 0.54577h-45.162425v595.775616c-0.341106 95.168554-73.678881 176.283544-173.69114 192.383744l-11.938707 1.569088-11.734044 0.955096-12.143371 0.341106H301.810526c-106.152165 0.136442-195.59014-74.22465-208.211059-173.008927l-0.955097-10.91539-0.341106-11.324717V232.293138H47.072618a46.867955 46.867955 0 0 1-45.298867-31.722852l-1.364424-6.276349L0 188.358694c0-19.443038 13.644237-36.293671 33.291939-41.956029l6.753897-1.500866 7.095003-0.477549H1044.466356zM417.786542 378.081812c-25.992272 0.068221-47.140839 19.784144-47.140839 44.002665v276.295803l0.409327 5.935243c0.272885 16.304863 10.096736 31.108861 25.582945 38.54497a49.801466 49.801466 0 0 0 48.437042-3.069953 43.047568 43.047568 0 0 0 19.784144-41.41026v-276.295803L464.449833 416.149234c-3.274617-21.830779-23.195203-37.999201-46.663291-37.999201z m255.010793 0c-25.992272 0.068221-47.140839 19.784144-47.140839 44.002665v276.295803l0.409327 5.935243c0.272885 16.304863 10.096736 31.108861 25.582944 38.54497a49.801466 49.801466 0 0 0 48.437042-3.069953 43.047568 43.047568 0 0 0 19.784144-41.41026v-276.295803l-0.409327-6.003464c-3.274617-21.830779-23.195203-37.999201-46.663291-37.999201zM705.338841 0c25.924051 0 46.936176 19.647702 47.072618 43.934444 0 22.240107-17.669287 40.591606-40.659827 43.525116l-6.412791 0.409327H393.431579c-25.924051 0-46.936176-19.647702-47.072618-43.934443 0-22.240107 17.737508-40.591606 40.728048-43.456896L393.431579 0h311.907262z"
                                    fill="#515151" p-id="171904"></path>
                            </svg>
                        </button>
                        <button class="header-icon header-icon-right" id="couple-status-options-btn">
                            <svg t="1757796956627" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="19436" width="18" height="18">
                                <path d="M224 512a64 64 0 1 0-128 0 64 64 0 0 0 128 0Z" fill="#2c2c2c" p-id="19437">
                                </path>
                                <path d="M576 512a64 64 0 1 0-128 0 64 64 0 0 0 128 0Z" fill="#2c2c2c" p-id="19438">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <!-- 【新增】多选模式下的顶栏 -->
                    <div class="multi-select-actions">
                        <button id="status-multi-select-cancel-btn" class="multi-select-btn">取消</button>
                        <span id="status-multi-select-counter">请选择项目</span>
                        <button id="status-multi-select-delete-btn" class="multi-select-btn">删除</button>
                    </div>
                </div>
                <!-- 2. 消息展示容器 -->
                <div id="couple-status-message-container">
                    <!-- 消息将由JS动态生成到这里 -->
                </div>
                <!-- 3. 特殊的输入区域 -->
                <div id="couple-status-input-area">
                    <!-- 默认状态：小的提示框 -->
                    <div id="status-input-placeholder"><span>点击开始打字</span></div>
                    <!--激活状态：大的输入框 -->
                    <div id="status-input-active-wrapper" style="display: none;">
                        <textarea id="status-message-input" rows="1"></textarea>
                        <!-- 【【【核心修改】】】发送按钮已移出到下方 -->
                    </div>
                    <!-- 【【【核心修改】】】发送按钮现在是平级元素，位于容器外部 -->
                    <button id="status-send-btn">
                        <svg t="1757445050961" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="37600" width="24" height="24">
                            <path
                                d="M392.021333 925.013333a34.133333 34.133333 0 0 1-34.133333-34.133333V579.242667c0-10.24 4.608-19.968 12.629333-26.453334l276.48-224.085333a34.0992 34.0992 0 0 1 43.008 52.906667L426.154667 595.456v192.853333l82.944-110.592c10.069333-13.482667 28.672-17.578667 43.52-9.557333l137.557333 73.728L853.333333 156.16c3.242667-11.434667-3.413333-18.602667-6.485333-21.162667-3.072-2.56-11.093333-7.850667-21.845333-2.901333L206.336 422.4l80.213333 46.08c16.384 9.386667 22.016 30.208 12.629334 46.592s-30.208 22.016-46.592 12.629333l-137.045334-78.677333a33.979733 33.979733 0 0 1-17.066666-31.061333c0.512-12.8 8.021333-24.064 19.626666-29.525334L795.989333 70.314667c31.744-14.848 68.096-10.069333 94.890667 12.629333a87.790933 87.790933 0 0 1 28.16 91.477333L744.277333 801.28a34.082133 34.082133 0 0 1-48.981333 20.821333L546.133333 742.058667l-126.805333 169.301333c-6.656 8.704-16.896 13.653333-27.306667 13.653333z"
                                fill="#353333" p-id="37601"></path>
                        </svg>
                    </button>
                </div>
                <!-- 4. 专属于此页面的菜单栏 -->
                <div id="couple-status-context-menu">
                    <div class="status-menu-item" data-action="add-status">
                        <svg t="1758893993215" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="14500" width="12.5" height="12.5">
                            <path
                                d="M512 0C229.230852 0 0 229.230852 0 512s229.230852 512 512 512 511.98856-229.230852 511.98856-512S794.792028 0 512 0z m204.886943 563.296094H563.296094v153.47645a51.238895 51.238895 0 1 1-102.466351 0V563.307534H307.238895a51.238895 51.238895 0 1 1 0-102.477791h153.590848V307.227456a51.238895 51.238895 0 0 1 102.466351 0v153.602287h153.465011a51.238895 51.238895 0 0 1 0.125838 102.477791z"
                                fill="#3f3f3f" p-id="14501"></path>
                        </svg>
                        <span>添加</span>
                    </div>
                    <div class="status-menu-item" data-action="reply">
                        <svg t="1758946463328" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="158132" width="14.5" height="14.5">
                            <path
                                d="M67.072 278.016c1.6896 3.072 6.2976 7.3216 13.824 12.8Q189.44 353.28 275.456 402.432c24.576 14.336 48.4864 28.16 71.68 41.472q34.816 19.968 62.464 35.328c18.432 10.24 33.4336 18.432 45.056 24.576l16.384 10.24c20.48 12.9536 34.4576 19.456 41.984 19.456 3.4304 0 9.8816-2.2016 19.456-6.656a374.784 374.784 0 0 0 23.552-11.776l389.12-224.256c8.192-7.5264 12.9536-12.288 14.336-14.336 1.3824-2.048 2.048-6.144 2.048-12.288v-20.48q0-23.552-12.288-36.864c-8.192-8.8576-22.8864-13.312-44.032-13.312L119.808 192.512q-29.696 0-42.496 14.848t-12.8 38.4v18.432q0 9.216 2.56 13.824z m894.464 97.792q0-14.336-10.24-16.384c-6.8096-1.3824-16.0256 1.6896-27.648 9.216-6.144 3.4304-17.2544 10.24-33.28 20.48s-32.768 20.8384-50.176 31.744c-17.408 10.9056-33.1264 20.992-47.104 30.208s-21.6576 14.1824-23.04 14.848c-7.5264 4.7616-91.4944 58.368-98.304 62.464-4.096 2.7136-11.776 7.5264-23.04 14.336-11.264 6.8096-23.1936 14.1824-35.84 22.016-12.6464 7.8336-24.4224 15.0016-35.328 21.504l-21.504 12.8a72.192 72.192 0 0 1-14.848 6.144c-6.5024 2.048-13.4656 3.584-20.992 4.608a81.92 81.92 0 0 1-24.064-0.512 63.0784 63.0784 0 0 1-25.088-10.24c-8.192-4.7616-17.7664-10.5984-28.672-17.408L409.6 559.104a2871.808 2871.808 0 0 1-30.72-19.456c-9.5744-6.144-125.952-76.8-142.336-87.04q-24.576-15.36-53.76-33.28-29.184-17.92-54.272-33.792-25.088-15.872-31.232-19.968-14.336-10.24-24.064-5.12c-6.5024 3.4304-9.728 11.6224-9.728 24.576v344.064q0 19.456 5.12 38.4c3.4304 12.6464 9.216 23.7056 17.408 33.28 8.192 9.5744 19.456 17.408 33.792 23.552s33.1264 9.216 56.32 9.216H860.16c14.336 0 27.648-0.8704 39.936-2.56s23.04-5.9904 32.256-12.8 16.384-16.896 21.504-30.208c5.12-13.312 7.68-31.5904 7.68-54.784V375.808z"
                                p-id="158133"></path>
                        </svg>
                        <span>回复</span>
                    </div>
                    <div class="status-menu-item" data-action="history">
                        <svg t="1758622479967" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="94895" width="12" height="12">
                            <path
                                d="M512 1024C229.248 1024 0 794.752 0 512S229.248 0 512 0s512 229.248 512 512-229.248 512-512 512z m42.666667-486.869333V298.538667C554.666667 275.328 535.552 256 512 256c-23.722667 0-42.666667 19.029333-42.666667 42.538667v256.256a41.984 41.984 0 0 0 12.202667 29.866666l121.258667 121.258667a42.368 42.368 0 0 0 60.032-0.298667 42.666667 42.666667 0 0 0 0.298666-60.032L554.666667 537.130667z"
                                fill="#3f3f3f" p-id="94896"></path>
                        </svg>
                        <span>历史</span>
                    </div>
                </div>
            </div>

            <!-- 【【【全新】】】状态详情页消息交互小卡片 -->
            <div id="status-message-context-card">
                <div class="status-card-menu-item" data-action="edit">编辑</div>
                <div class="status-card-menu-item" data-action="delete">删除</div>
            </div>

            <!-- 【【【全新 V2.62】】】解除关系确认弹窗 -->
            <div class="modal-overlay" id="breakup-confirm-modal">
                <div class="breakup-popup-card">
                    <div class="breakup-popup-content">
                        <p id="breakup-confirm-text">确定要与xxx解除关系吗，历史记录将会清空</p>
                    </div>
                    <div class="breakup-popup-actions">
                        <button id="breakup-cancel-btn">取消</button>
                        <button id="breakup-confirm-btn">确定</button>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【【【全新 V3.9】】】添加状态弹窗 -->
            <!-- =================================================================== -->
            <div class="modal-overlay" id="add-status-modal">
                <div class="modal-card" id="add-status-card">
                    <div class="modal-card-header" id="add-status-header">
                        <h2>添加状态</h2>
                        <button class="modal-card-close-btn" id="add-status-close-btn">
                            <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                                <path
                                    d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                                    p-id="32290" fill="#3f3f3f"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-card-body" id="add-status-body">
                        <div class="add-status-form-group">
                            <label>选择状态</label>
                            <div class="status-dropdown-container">
                                <div class="status-dropdown-header">
                                    <div class="status-dropdown-selected-icon"></div>
                                    <span class="status-dropdown-selected-text"></span>
                                    <div class="status-dropdown-arrow">
                                        <svg t="1758944872524" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="153310" width="18" height="18">
                                            <path
                                                d="M774.9 416.6L567.1 768.5c-12.4 21-33.8 31.5-55.1 31.5-21.4 0-42.7-10.5-55.1-31.5L249 416.6c-25.2-42.7 5.6-96.6 55.1-96.6h415.6c49.6 0 80.4 53.9 55.2 96.6z"
                                                p-id="153311" fill="#3f3f3f"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="status-dropdown-list">
                                    <!-- 状态选项将由JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        <div class="add-status-row">
                            <div class="add-status-form-group">
                                <label>自定义时间</label>
                                <input type="text" class="add-status-input" id="add-status-time-input"
                                    placeholder="00:00">
                            </div>
                            <div class="add-status-form-group">
                                <label>&nbsp;</label> <!-- 占位用的label -->
                                <button class="add-status-subject-btn" id="add-status-subject-selector">自己</button>
                            </div>
                        </div>
                        <div class="add-status-form-group">
                            <label>自定义内容</label>
                            <input type="text" class="add-status-input" id="add-status-content-input"
                                placeholder="例：手机开始充电了 89%">
                        </div>
                    </div>
                    <div class="modal-card-footer">
                        <button class="modal-cancel-btn" id="add-status-cancel-btn">取消</button>
                        <button class="modal-confirm-btn" id="add-status-save-btn">保存</button>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【【【全新】】】发布动态弹窗 -->
            <!-- =================================================================== -->
            <div class="modal-overlay" id="post-status-modal">
                <div class="status-modal-card">
                    <div class="status-modal-header">
                        <h2>发布动态</h2>
                        <button class="status-modal-close-btn">
                            <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="32289" width="17" height="17">
                                <path
                                    d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                                    p-id="32290" fill="#3f3f3f"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="status-modal-body">
                        <textarea class="status-modal-textarea" placeholder="记录下你们的日常..."></textarea>
                        <button class="status-modal-photo-btn">
                            <svg t="1758793318201" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="14391" width="16" height="16">
                                <path
                                    d="M768.35456 416a256 256 0 1 0-512 0 192 192 0 1 0 0 384v64a256 256 0 0 1-58.88-505.216 320.128 320.128 0 0 1 629.76 0A256.128 256.128 0 0 1 768.35456 864v-64a192 192 0 0 0 0-384z m-512 384h128v64H256.35456v-64z m384 0h128v64h-128v-64z"
                                    fill="#ffffff" p-id="14392"></path>
                                <path
                                    d="M539.04256 589.184v333.056a32.448 32.448 0 0 1-32 32.192 32.448 32.448 0 0 1-32-32.192V589.184l-36.096 36.096a32.192 32.192 0 0 1-45.056-0.192 31.616 31.616 0 0 1-0.192-45.056l90.88-90.88a31.36 31.36 0 0 1 22.528-9.152 30.08 30.08 0 0 1 22.4 9.088l90.88 90.944a32.192 32.192 0 0 1-0.192 45.056 31.616 31.616 0 0 1-45.056 0.192l-36.096-36.096z"
                                    fill="#ffffff" p-id="14393"></path>
                            </svg>
                            <span>照片</span>
                        </button>
                    </div>
                    <div class="status-modal-footer">
                        <button class="status-modal-action-btn cancel">取消</button>
                        <button class="status-modal-action-btn publish">发布</button>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- 【全新 V1.69】情侣关系邀请弹窗 -->
            <!-- =================================================================== -->
            <div class="modal-overlay" id="couple-invite-modal">
                <div class="invite-modal-card">
                    <button class="invite-modal-close-btn">&times;</button>
                    <div class="invite-avatars-animation-container">
                        <img id="invite-modal-ai-avatar" class="invite-modal-avatar invite-modal-ai-avatar" src="">
                        <img id="invite-modal-user-avatar" class="invite-modal-avatar invite-modal-user-avatar" src="">
                    </div>
                    <p class="invite-modal-prompt">TA想和你建立情侣关系</p>
                    <div class="invite-modal-actions">
                        <button id="invite-accept-btn" class="invite-modal-btn accept-btn">我愿意</button>
                        <button id="invite-reject-btn" class="invite-modal-btn reject-btn">残忍拒绝</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="add-contact-modal">
        <div class="modal-content">
            <h2>创建新联系人</h2>
            <input type="text" id="new-contact-name-input" placeholder="请输入Ta的名字...">
            <div class="modal-actions">
                <button class="modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn">创建</button>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- 【新增】气泡样式设置弹窗 -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="bubble-style-modal">
        <div class="modal-card">
            <div class="modal-card-header">
                <h2>气泡样式设置</h2>
                <button class="modal-card-close-btn">
                    <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                        <path
                            d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                            p-id="32290" fill="#3f3f3f"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-card-body">
                <!-- 自定义颜色 -->
                <div>
                    <div class="modal-plate-title-wrapper">
                        <p class="modal-plate-title">自定义颜色</p>
                        <button class="modal-reset-btn" id="reset-colors-btn">重置</button>
                    </div>
                    <div class="modal-plate">
                        <div class="color-setting-item">
                            <span>我的气泡</span>
                            <div class="color-picker-wrapper">
                                <input type="color" id="user-bubble-color-input" value="#a9e97a">
                            </div>
                        </div>
                        <div class="color-setting-item">
                            <span>我的字体</span>
                            <div class="color-picker-wrapper">
                                <input type="color" id="user-font-color-input" value="#262626">
                            </div>
                        </div>
                        <div class="color-setting-item">
                            <span>对方气泡</span>
                            <div class="color-picker-wrapper">
                                <input type="color" id="ai-bubble-color-input" value="#ffffff">
                            </div>
                        </div>
                        <div class="color-setting-item">
                            <span>对方字体</span>
                            <div class="color-picker-wrapper">
                                <input type="color" id="ai-font-color-input" value="#262626">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 自定义气泡 -->
                <div>
                    <div class="modal-plate-title-wrapper">
                        <p class="modal-plate-title">自定义气泡 (CSS)</p>
                        <button class="modal-reset-btn" id="reset-css-btn">重置</button>
                    </div>
                    <div class="modal-plate">
                        <textarea id="custom-css-input" class="modal-textarea"
                            placeholder="/* 示例：将下方代码粘贴到此处，可实现渐变气泡 */&#10;&#10;/* 用户消息气泡 */&#10;.user-bubble {&#10;  background: linear-gradient(135deg, #89f7fe, #66a6ff) !important;&#10;  color: white !important;&#10;  border: none !important;&#10;  box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;&#10;}&#10;&#10;/* AI消息气泡 */&#10;.ai-bubble {&#10;  background: #f0f2f5 !important;&#10;  color: #333 !important;&#10;  border: 1px solid #e0e0e0 !important;&#10;}"></textarea>
                    </div>
                </div>
                <!-- 实时预览 -->
                <div>
                    <p class="modal-plate-title">实时预览</p>
                    <div class="modal-plate">
                        <div id="bubble-preview-area">
                            <div class="ai-wrapper">
                                <img class="chat-avatar" id="preview-ai-avatar" src="">
                                <div class="message-bubble ai-bubble" id="preview-ai-bubble">对方消息预览</div>
                            </div>
                            <div class="user-wrapper">
                                <div class="message-bubble user-bubble" id="preview-user-bubble">我的消息预览</div>
                                <img class="chat-avatar" id="preview-user-avatar" src="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-card-footer">
                <button class="modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="save-bubble-style-btn">保存</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 【新增】聊天背景设置弹窗 -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="background-modal">
        <div class="modal-card">
            <div class="modal-card-header">
                <h2>设置聊天背景</h2>
                <button class="modal-card-close-btn">
                    <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                        <path
                            d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                            p-id="32290" fill="#3f3f3f"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-card-body">
                <div id="background-preview" title="点击上传图片">
                    <button id="remove-background-btn">
                        <svg t="1758611788198" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="69251" width="15" height="15">
                            <path
                                d="M617.92 516.096l272 272L788.096 889.92l-272-272-272 272L142.24 788.096l272-272-275.008-275.04L241.056 139.2l275.04 275.04 275.04-275.04L892.96 241.024l-275.04 275.04z"
                                p-id="69252" fill="#3f3f3f"></path>
                        </svg>
                    </button>
                </div>
                <input type="file" id="background-upload-input" accept="image/*" style="display: none;">
            </div>
            <div class="modal-card-footer">
                <button class="modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="save-background-btn">保存</button>
            </div>
        </div>
    </div>

    <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;">

    <!-- =================================================================== -->
    <!-- 【全新 V1.91】桌面壁纸设置弹窗 -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="desktop-wallpaper-modal">
        <div class="modal-card">
            <div class="modal-card-header">
                <h2>设置桌面壁纸</h2>
                <button class="modal-card-close-btn">
                    <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                        <path
                            d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                            p-id="32290" fill="#3f3f3f"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-card-body">
                <div id="desktop-wallpaper-preview" class="background-preview-clone" title="点击上传图片">
                    <button id="remove-desktop-wallpaper-btn" class="remove-background-btn-clone">
                        <svg t="1758611788198" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="69251" width="15" height="15">
                            <path
                                d="M617.92 516.096l272 272L788.096 889.92l-272-272-272 272L142.24 788.096l272-272-275.008-275.04L241.056 139.2l275.04 275.04 275.04-275.04L892.96 241.024l-275.04 275.04z"
                                p-id="69252" fill="#3f3f3f"></path>
                        </svg>
                    </button>
                </div>
                <input type="file" id="desktop-wallpaper-upload-input" accept="image/*" style="display: none;">
            </div>
            <div class="modal-card-footer">
                <button class="modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="save-desktop-wallpaper-btn">保存</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 【新增】通用确认弹窗 -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <h2 id="confirm-modal-title">确认操作</h2>
            <p id="confirm-modal-text" style="text-align: center; margin: 15px 0;"></p>
            <div class="modal-actions">
                <button class="modal-cancel-btn" id="confirm-modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="confirm-modal-confirm-btn">确定</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 【全新 V1.81 修复方案】表情系统专属的、独立的弹窗 -->
    <!-- =================================================================== -->

    <!-- 全新的“添加表情”弹窗 -->
    <div class="modal-overlay" id="sticker-add-modal">
        <div class="modal-card">
            <div class="modal-card-header">
                <h2>添加新表情</h2>
                <button class="modal-card-close-btn">
                    <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                        <path
                            d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                            p-id="32290" fill="#3f3f3f"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-card-body" style="gap: 15px;">
                <div>
                    <p class="modal-plate-title" style="margin: 0 0 8px 0;">表情名称 (用于AI理解)</p>
                    <input type="text" id="sticker-new-name-input" class="modal-input-field" placeholder="例如：开心、好耶、疑问">
                </div>
                <div>
                    <p class="modal-plate-title" style="margin: 0 0 8px 0;">图片链接或上传</p>
                    <input type="text" id="sticker-new-url-input" class="modal-input-field"
                        placeholder="粘贴图片URL，或点击下方按钮上传">
                </div>
                <button id="sticker-new-upload-btn" class="modal-upload-btn">
                    <svg t="1757457899103" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path
                            d="M793.6 358.4C768 227.2 652.8 128 512 128s-256 99.2-281.6 230.4C134.4 384 64 473.6 64 576c0 124.8 99.2 224 224 224h32v-64h-32c-89.6 0-160-70.4-160-160s70.4-160 160-160c0-124.8 99.2-224 224-224s224 99.2 224 224c89.6 0 160 70.4 160 160s-70.4 160-160 160h-32v64h32c124.8 0 224-99.2 224-224 0-102.4-70.4-192-166.4-217.6z"
                            fill="#ffffff"></path>
                        <path
                            d="M540.8 489.6c-12.8-9.6-25.6-12.8-38.4-6.4-3.2 0-6.4 3.2-9.6 6.4l-96 92.8c-12.8 12.8-12.8 32 0 44.8 12.8 12.8 35.2 12.8 48 0l38.4-35.2v272c0 19.2 16 32 32 32 19.2 0 32-16 32-32V592l38.4 35.2c12.8 12.8 35.2 12.8 48 0 12.8-12.8 12.8-32 0-44.8l-92.8-92.8z"
                            fill="#ffffff"></path>
                    </svg>
                    <span>上传本地图片</span>
                </button>
            </div>
            <div class="modal-card-footer">
                <button class="modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="sticker-new-save-btn">保存</button>
            </div>
        </div>
    </div>


    <!-- 【全新】隐藏的文件上传工具 -->
    <input type="file" id="sticker-file-input" accept="image/*" style="display: none;">
    <input type="file" id="desktop-file-input" accept="image/*" style="display: none;"> <!-- 【新增】桌面专用的文件上传工具 -->
    <input type="file" id="me-avatar-upload-input" accept="image/*" style="display: none;">
    <!-- 【【【全新】】】“Me”页面专属头像上传工具 -->


    </div>
    </div>

    <!-- =================================================================== -->
    <!-- 【全新 V2.30】消息交互菜单 -->
    <!-- =================================================================== -->
    <div id="message-context-menu">
        <div class="context-menu-row">
            <div class="context-menu-item" data-action="reply">
                <svg t="1758383255104" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="90554" width="18" height="18">
                    <path
                        d="M413.866667 610.133333c42.666667 0 76.8-34.133333 76.8-76.8 0-38.4-29.866667-72.533333-68.266667-72.533333h-21.333333c0-12.8 0-76.8 68.266666-110.933333l-17.066666-29.866667c-76.8 34.133333-128 98.133333-128 174.933333 0 42.666667 12.8 68.266667 34.133333 93.866667 8.533333 12.8 29.866667 21.333333 55.466667 21.333333zM627.2 610.133333c42.666667 0 76.8-34.133333 76.8-76.8 0-38.4-29.866667-72.533333-68.266667-72.533333h-21.333333c0-12.8 0-76.8 68.266667-110.933333l-17.066667-29.866667c-76.8 34.133333-128 98.133333-128 174.933333 0 42.666667 12.8 68.266667 34.133333 93.866667 8.533333 12.8 29.866667 21.333333 55.466667 21.333333z"
                        fill="#3f3f3f" p-id="90555"></path>
                    <path
                        d="M896 128H128c-25.6 0-42.666667 17.066667-42.666667 42.666667v789.333333L277.333333 810.666667H896c25.6 0 42.666667-17.066667 42.666667-42.666667V170.666667c0-25.6-17.066667-42.666667-42.666667-42.666667z m-42.666667 597.333333H247.466667L170.666667 785.066667V213.333333h682.666666v512z"
                        fill="#3f3f3f" p-id="90556"></path>
                </svg>
                <span>引用</span>
            </div>
            <div class="context-menu-item" data-action="edit">
                <svg t="1758383330563" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="92133" width="18" height="18">
                    <path
                        d="M738.856 14.272l174.72 172.544a48.384 48.384 0 0 1 0 68.992L773.8 393.792 529.192 152.32 668.968 14.272a49.92 49.92 0 0 1 69.888 0z m-34.944 103.552l-34.944 34.496 104.832 103.488 34.944-34.56-104.832-103.424z m184.512 763.392v97.6H97.704V881.28h790.72zM494.12 186.88l244.672 241.472-384.384 379.52-205.696 13.568a49.216 49.216 0 0 1-52.608-51.968L109.864 566.4l384.384-379.52z m0 137.984L206.056 609.408l-7.488 110.848 112.32-7.36L599.08 428.288 494.248 324.8z"
                        fill="#3f3f3f" p-id="92134"></path>
                </svg>
                <span>编辑</span>
            </div>
            <div class="context-menu-item" data-action="copy">
                <svg t="1758595889173" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="65293" width="16" height="16">
                    <path
                        d="M316.8 784h377.6v140.8c0 42.24-34.56 76.8-76.8 76.8h-518.4c-42.24 0-76.8-34.56-76.8-76.8v-518.4c0-42.24 34.56-76.8 76.8-76.8h140.8v377.6c0 42.24 34.56 76.8 76.8 76.8z"
                        fill="#3f3f3f" p-id="65294"></path>
                    <path
                        d="M1008 105.6v518.4c0 42.24-34.56 76.8-76.8 76.8h-518.4c-42.24 0-76.8-34.56-76.8-76.8v-518.4c0-42.24 34.56-76.8 76.8-76.8h518.4c42.24 0 76.8 34.56 76.8 76.8z"
                        fill="#3f3f3f" p-id="65295"></path>
                </svg>
                <span>复制</span>
            </div>
            <div class="context-menu-item" data-action="delete">
                <svg t="1758420130743" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="40892" width="18" height="18">
                    <path d="M930.688 361.44" fill="#3f3f3f" p-id="40893"></path>
                    <path
                        d="M128.064 315.84l106.944 549.376c11.68 53.728 41.536 95.488 92.416 95.488L698.432 960.704c50.848 0 80.736-41.792 92.384-95.488l106.976-549.376L128.064 315.84 128.064 315.84zM678.272 167.072"
                        fill="#3f3f3f" p-id="40894"></path>
                    <path
                        d="M710.272 167.072c-17.6 0-40.576-11.552-51.072-25.696l-10.976-14.784c-10.496-14.112-33.472-25.696-51.072-25.696l-168.512 0c-17.6 0-40.576 11.552-51.072 25.696l-10.976 14.784c-10.496 14.112-33.472 25.696-51.072 25.696l-217.088 0c-17.6 0-32 14.4-32 32l0 18.656c0 17.6 14.4 32 32 32L927.36 249.728c17.6 0 32-14.4 32-32l0-18.656c0-17.6-14.4-32-32-32L710.272 167.072z"
                        fill="#3f3f3f" p-id="40895"></path>
                </svg>
                <span>删除</span>
            </div>
        </div>
        <div class="context-menu-row">
            <div class="context-menu-item" data-action="insert">
                <svg t="1758383583097" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="13582" width="22" height="22">
                    <path
                        d="M816.163 690.151H511.751c-10.862 0-19.707 8.73-19.862 19.602l-1.277 89.871-261.764-200.793c-15.07-11.558-6.905-35.665 12.079-35.665h575.236c10.97 0 19.862 8.902 19.862 19.883v87.222c0 10.979-8.892 19.88-19.862 19.88zM490.612 799.627v-0.003l0.003 0.003h-0.003z m304.224-336.792H206.527c-9.142 0-16.555-7.419-16.555-16.571v-93.848c0-9.149 7.413-16.566 16.555-16.566h313.93c9.255 0 16.714-7.596 16.548-16.862l-1.62-92.618 269.517 206.742c12.558 9.634 5.752 29.723-10.066 29.723z"
                        fill="#3f3f3f" p-id="13583"></path>
                </svg>
                <span>插入</span>
            </div>
            <div class="context-menu-item" data-action="multi-select">
                <svg t="1758383698295" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="18059" width="17" height="17">
                    <path d="M343.669831 592.276606 343.669831 592.276606z" p-id="18060" fill="#3f3f3f"></path>
                    <path
                        d="M828.706306 919.522734 192.4285 919.522734c-50.24323 0-90.867593-40.726691-90.867593-90.867593L101.560907 192.377336c0-50.24323 40.726691-90.867593 90.867593-90.867593l636.175477 0c50.24323 0 90.867593 40.726691 90.867593 90.867593l0 636.175477C919.573898 878.796043 878.847207 919.522734 828.706306 919.522734L828.706306 919.522734zM765.569701 377.182372 733.745578 345.972219c-17.60048-17.191166-46.150095-17.191166-63.750575 0L446.816828 564.44329l-95.677026-93.630459c-17.60048-17.191166-46.150095-17.191166-63.750575 0l-31.926451 31.210153c-17.60048 17.191166-17.60048 45.22914 0 62.420306l127.501149 124.840612c0 0 0 0 0 0l31.926451 31.210153c17.60048 17.191166 46.150095 17.191166 63.750575 0l286.92875-280.891376C783.272509 422.411512 783.272509 394.373539 765.569701 377.182372L765.569701 377.182372z"
                        p-id="18061" fill="#3f3f3f"></path>
                </svg>
                <span>多选</span>
            </div>
            <div class="context-menu-item placeholder"></div>
            <div class="context-menu-item placeholder"></div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- 【【【全新】】】插入新消息弹窗 -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="insert-message-modal">
        <div class="modal-card" id="insert-message-card">
            <div class="modal-card-header">
                <h2>插入新消息</h2>
                <button class="modal-card-close-btn" id="insert-modal-close-btn">
                    <svg t="1758386316340" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="32289" width="15" height="15">
                        <path
                            d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z"
                            p-id="32290" fill="#3f3f3f"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-card-body" id="insert-modal-body">
                <div id="insert-actions-container">
                    <div class="insert-action-btn" data-action="add-above">
                        <svg t="1758597223983" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="66525" width="12.8" height="12.8">
                            <path
                                d="M902.343 570.936h-331.78v331.833c0 32.337-26.226 58.537-58.564 58.537-32.337 0-58.563-26.2-58.563-58.537V570.936H121.654c-32.364 0-58.564-26.2-58.564-58.538 0-32.325 26.203-58.537 58.564-58.537h331.78V122.028c0-32.325 26.226-58.537 58.563-58.537 32.338 0 58.564 26.213 58.564 58.537v331.834h331.78c32.364 0 58.565 26.211 58.565 58.535-0.001 32.337-26.2 58.536-58.565 58.536z"
                                fill="#3f3f3f" p-id="66526"></path>
                        </svg>
                        <span>在上方添加</span>
                    </div>
                    <div class="insert-action-btn" data-action="add-below">
                        <svg t="1758597223983" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="66525" width="12.8" height="12.8">
                            <path
                                d="M902.343 570.936h-331.78v331.833c0 32.337-26.226 58.537-58.564 58.537-32.337 0-58.563-26.2-58.563-58.537V570.936H121.654c-32.364 0-58.564-26.2-58.564-58.538 0-32.325 26.203-58.537 58.564-58.537h331.78V122.028c0-32.325 26.226-58.537 58.563-58.537 32.338 0 58.564 26.213 58.564 58.537v331.834h331.78c32.364 0 58.565 26.211 58.565 58.535-0.001 32.337-26.2 58.536-58.565 58.536z"
                                fill="#3f3f3f" p-id="66526"></path>
                        </svg>
                        <span>在下方添加</span>
                    </div>
                </div>
                <div id="insert-preview-container">
                    <!-- 消息预览将动态生成在这里 -->
                </div>
            </div>
            <div class="modal-card-footer">
                <button class="modal-cancel-btn" id="insert-modal-cancel-btn">取消</button>
                <button class="modal-confirm-btn" id="insert-modal-save-btn">保存</button>
            </div>
        </div>
    </div>


    <script>
        // ===================================================================
        // 【全新 V1.81 修复方案】IndexedDB 数据库帮助函数
        // ===================================================================
        const db = {
            _db: null,
            _dbName: 'KikiChatDB',
            _storeName: 'kv_store',

            async _getDB() {
                if (this._db) return this._db;
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this._dbName, 1);
                    request.onerror = () => reject("Error opening db");
                    request.onsuccess = (event) => {
                        this._db = event.target.result;
                        resolve(this._db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this._storeName)) {
                            db.createObjectStore(this._storeName);
                        }
                    };
                });
            },

            async get(key) {
                const db = await this._getDB();
                return new Promise((resolve) => {
                    const transaction = db.transaction(this._storeName, 'readonly');
                    const store = transaction.objectStore(this._storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(undefined);
                });
            },

            async set(key, value) {
                const db = await this._getDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(this._storeName, 'readwrite');
                    const store = transaction.objectStore(this._storeName);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve(true);
                    request.onerror = (e) => reject("Error setting value in db: " + e.target.error);
                });
            }
        };
        document.addEventListener('DOMContentLoaded', () => {

            // ===================================================================
            // 【全新 V2.03】全局变量统一定义区
            // ===================================================================
            // --- 屏幕与导航 ---
            const screens = document.querySelectorAll('.screen');
            const appIcons = document.querySelectorAll('.app-icon');
            const backBtns = document.querySelectorAll('.header-icon[data-target]');

            // --- API 设置页面 ---
            const saveSettingsBtn = document.getElementById('save-api-settings-btn');
            const baseUrlInput = document.getElementById('base-url');
            const apiKeyInput = document.getElementById('api-key');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const modelSelect = document.getElementById('model-select');

            // --- 聊天列表页面 ---
            const addContactBtn = document.getElementById('add-contact-btn');
            const contactList = document.getElementById('contact-list');
            const addContactModal = document.getElementById('add-contact-modal');
            const newContactNameInput = document.getElementById('new-contact-name-input');
            const confirmCreateBtn = addContactModal.querySelector('.modal-confirm-btn');
            const cancelCreateBtn = addContactModal.querySelector('.modal-cancel-btn');

            // --- 聊天界面 ---
            const chatInterfaceScreen = document.getElementById('chat-interface-screen');
            const chatContactName = document.getElementById('chat-contact-name');
            const messageContainer = document.getElementById('message-container');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const generateBtn = document.getElementById('generate-btn');
            const moreFunctionsBtn = document.getElementById('more-btn');
            const moreFunctionsPanel = document.getElementById('more-functions-panel');
            const functionsSlider = document.getElementById('functions-slider');
            const functionsNavPrev = document.getElementById('functions-nav-prev');
            const functionsNavNext = document.getElementById('functions-nav-next');

            // --- 【V2.30 新增】消息交互相关变量 ---
            const messageContextMenu = document.getElementById('message-context-menu');
            const replyBar = document.getElementById('reply-bar');
            const replyBarContent = document.getElementById('reply-bar-content');
            const cancelReplyBtn = document.getElementById('cancel-reply-btn');

            // --- 表情系统 (聊天界面内) ---
            const stickerPanel = document.getElementById('sticker-panel');
            const stickerGrid = document.getElementById('sticker-grid');
            const openStickerPanelBtn = document.getElementById('open-sticker-panel-btn');

            // --- 表情系统 (全局弹窗与上传) ---
            const stickerFileInput = document.getElementById('sticker-file-input');
            const newAddStickerModal = document.getElementById('sticker-add-modal');
            const newStickerNameInput = document.getElementById('sticker-new-name-input');
            const newStickerUrlInput = document.getElementById('sticker-new-url-input');
            const newStickerUploadBtn = document.getElementById('sticker-new-upload-btn');
            const newStickerSaveBtn = document.getElementById('sticker-new-save-btn');

            // --- 聊天设置页面 ---
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            const chatSettingsScreen = document.getElementById('chat-settings-screen');
            const aiSettingsAvatar = document.getElementById('ai-settings-avatar');
            // 【核心修复】下面这两行是本次唯一的修改
            const aiSettingsNameDisplay = document.getElementById('ai-settings-name-display'); // 不再寻找旧的输入框
            const userSettingsAvatar = document.getElementById('user-settings-avatar');
            const userSettingsNameDisplay = document.getElementById('user-settings-name-display'); // 不再寻找旧的输入框
            const showAvatarsToggle = document.getElementById('show-avatars-toggle');
            const avatarRadiusInput = document.getElementById('avatar-radius-input');
            const fontSizeInput = document.getElementById('font-size-input');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const avatarUploadInput = document.getElementById('avatar-upload-input');
            const aiInfoItem = document.getElementById('ai-info-item'); // 新增
            const userInfoItem = document.getElementById('user-info-item'); // 新增

            // --- 【全新 V2.03】对方信息页面 ---
            const aiInfoScreen = document.getElementById('ai-info-screen');
            const aiInfoAvatar = document.getElementById('ai-info-avatar');
            const aiInfoNameDisplay = document.getElementById('ai-info-name-display');
            const aiPersonaInput = document.getElementById('ai-persona-input');
            const aiRelationshipInput = document.getElementById('ai-relationship-input');
            const aiInfoAssociationsDropdown = document.getElementById('ai-info-associations-dropdown');
            const aiInfoDropdownLabel = document.getElementById('ai-info-dropdown-label');
            const aiInfoStickerPackList = document.getElementById('ai-info-sticker-pack-list');
            const saveAiInfoBtn = document.getElementById('save-ai-info-btn');

            // --- 【全新 V2.03】我的信息页面 ---
            const myInfoScreen = document.getElementById('my-info-screen');
            const myInfoAvatar = document.getElementById('my-info-avatar');
            const myInfoNameDisplay = document.getElementById('my-info-name-display');
            const myPersonaInput = document.getElementById('my-persona-input');
            const mySupplementaryInfoInput = document.getElementById('my-supplementary-info-input');
            const saveMyInfoBtn = document.getElementById('save-my-info-btn');

            // --- 【全新 V2.03】管理表情页面 ---
            const manageStickersScreen = document.getElementById('manage-stickers-screen');
            const stickerDeleteModeBtn = document.getElementById('sticker-delete-mode-btn');
            const deleteModeActions = document.querySelector('.delete-mode-actions');
            const confirmStickerDeleteBtn = document.getElementById('confirm-sticker-delete-btn');
            const cancelStickerDeleteBtn = document.getElementById('cancel-sticker-delete-btn');
            const stickerPackTitleEditor = document.getElementById('sticker-pack-title-editor');
            const stickerManagementGridView = document.getElementById('sticker-management-grid-view');

            // --- 样式与背景弹窗 ---
            const openBubbleStyleModalBtn = document.getElementById('open-bubble-style-modal-btn');
            const bubbleStyleModal = document.getElementById('bubble-style-modal');
            const userBubbleColorInput = document.getElementById('user-bubble-color-input');
            const aiBubbleColorInput = document.getElementById('ai-bubble-color-input');
            const userFontColorInput = document.getElementById('user-font-color-input');
            const aiFontColorInput = document.getElementById('ai-font-color-input');
            const customCssInput = document.getElementById('custom-css-input');
            const previewAiBubble = document.getElementById('preview-ai-bubble');
            const previewUserBubble = document.getElementById('preview-user-bubble');
            const saveBubbleStyleBtn = document.getElementById('save-bubble-style-btn');
            const openBackgroundModalBtn = document.getElementById('open-background-modal-btn');
            const backgroundModal = document.getElementById('background-modal');
            const backgroundPreview = document.getElementById('background-preview');
            const backgroundUploadInput = document.getElementById('background-upload-input');
            const removeBackgroundBtn = document.getElementById('remove-background-btn');
            const saveBackgroundBtn = document.getElementById('save-background-btn');

            // --- 主设置与字体设置页面 ---
            const phoneFrameToggle = document.getElementById('show-phone-frame-toggle');
            const gotoFontSettingsBtn = document.getElementById('goto-font-settings-btn');
            const fontSettingsPreviewBox = document.getElementById('font-settings-preview-box');
            const globalFontSizeInput = document.getElementById('global-font-size-input');
            const globalFontWeightInput = document.getElementById('global-font-weight-input');
            const globalLetterSpacingInput = document.getElementById('global-letter-spacing-input');
            const fontUrlInput = document.getElementById('font-url-input');
            const addFontBtn = document.getElementById('add-font-btn');
            const fontEntryList = document.getElementById('font-entry-list');
            const saveFontSettingsBtn = document.getElementById('save-font-settings-btn');
            const restoreFontDefaultsBtn = document.getElementById('restore-font-defaults-btn');

            // --- 桌面组件 ---
            const desktopFileInput = document.getElementById('desktop-file-input');
            const userCardBackground = document.getElementById('user-card-background');
            const userCardAvatar = document.getElementById('user-card-avatar');
            const recordInner = document.getElementById('record-inner');
            const capsuleIcon = document.querySelector('.capsule-widget .capsule-icon');
            const userIdText = document.getElementById('user-id');
            const userHandleText = document.getElementById('user-handle');
            const userBioText = document.getElementById('user-bio');
            const userLocationText = document.querySelector('#user-location span');
            const capsuleText = document.querySelector('.capsule-widget .capsule-text');

            // --- 情侣空间 ---
            const coupleSpaceScreen = document.getElementById('couple-space-screen');
            const coupleSpaceInviteScreen = document.getElementById('couple-space-invite-screen');
            const myAvatarWrapper = document.querySelector('.my-avatar-wrapper');
            const myAvatarImg = document.getElementById('couple-my-avatar-img');
            const partnerAvatarWrapper = document.querySelector('.partner-avatar-wrapper');
            const coupleAvatarUploadInput = document.getElementById('couple-avatar-upload-input');
            const coupleInviteListContainer = document.getElementById('couple-invite-list-container');
            const successToast = document.getElementById('success-toast');
            const coupleSpaceOptionsBtn = document.getElementById('couple-space-options-btn');
            const coupleThemeScreen = document.getElementById('couple-theme-screen');
            const coupleThemeBackBtn = document.getElementById('couple-theme-back-btn');
            const coupleThemeEditBtn = document.getElementById('couple-theme-edit-btn');
            const coupleBottomNav = document.querySelector('.couple-bottom-nav');
            const navSlider = document.querySelector('.nav-slider');
            const navIconWrappers = document.querySelectorAll('.nav-icon-wrapper');
            const coupleContentPages = document.querySelectorAll('.couple-content-page');
            const themeBgUploadBtn = document.getElementById('theme-bg-upload-btn');
            const themeResetBtn = document.getElementById('theme-reset-btn');
            const polaroidItems = document.querySelectorAll('.polaroid-item');

            // --- 邀请弹窗 ---
            const inviteModal = document.getElementById('couple-invite-modal');
            const inviteModalAiAvatar = document.getElementById('invite-modal-ai-avatar');
            const inviteModalUserAvatar = document.getElementById('invite-modal-user-avatar');
            const inviteAnimationContainer = document.querySelector('.invite-avatars-animation-container');
            const inviteAcceptBtn = document.getElementById('invite-accept-btn');
            const inviteRejectBtn = document.getElementById('invite-reject-btn');
            const inviteModalCloseBtn = document.querySelector('.invite-modal-close-btn');

            // --- 外观设置 ---
            const appearanceSettingsBtn = document.querySelector('.settings-item[data-target="appearance-settings-screen"]'); // 需要后续添加
            const gotoAppIconSettingsBtn = document.getElementById('goto-app-icon-settings-btn');
            const openDesktopWallpaperModalBtn = document.getElementById('open-desktop-wallpaper-modal-btn');
            const desktopWallpaperModal = document.getElementById('desktop-wallpaper-modal');
            const desktopWallpaperPreview = document.getElementById('desktop-wallpaper-preview');
            const removeDesktopWallpaperBtn = document.getElementById('remove-desktop-wallpaper-btn');
            const desktopWallpaperUploadInput = document.getElementById('desktop-wallpaper-upload-input');
            const saveDesktopWallpaperBtn = document.getElementById('save-desktop-wallpaper-btn');
            const appIconSettingsContainer = document.getElementById('app-icon-settings-container');

            // ===================================================================
            // 【全新 V4.3】“Me”页面专属变量
            // ===================================================================
            const mePage = document.getElementById('me-page');
            const mePageAvatar = document.getElementById('me-page-avatar');
            const mePageName = document.getElementById('me-page-name');
            const mePageSignature = document.getElementById('me-page-signature');
            const meAvatarUploadInput = document.getElementById('me-avatar-upload-input');
            let mePageData = {}; // 用于存储“Me”页面的数据
            // --- 全局状态变量 (let) ---
            let currentlyVisibleChatId = null; // 【【【核心新增】】】追踪当前正在屏幕上显示的聊天ID
            // --- 【V2.30】消息交互新增状态变量 ---
            let activeContextMenuMsgId = null; // 正在操作的消息ID
            let replyInfo = null; // {id, author, content}

            // 【【【核心修改】】】为插入模式定义更清晰的状态变量
            let insertMode = {
                active: false,          // 是否处于插入模式
                originalIndex: -1,      // 原始消息在 history 中的索引
                tempMessages: [],       // 临时的、正在编辑的消息数组
                isEditable: false       // 是否已经点击了“添加”按钮
            };

            // 【【【全新 V2.62】】】情侣空间与状态页新增变量
            const coupleStatusDetailScreen = document.getElementById('couple-status-detail-screen');
            const coupleStatusHeaderTitle = document.getElementById('couple-status-header-title');
            // --- 【【【全新】】】发布动态弹窗相关变量 ---
            const postStatusBtn = document.getElementById('post-status-btn');
            const postStatusModal = document.getElementById('post-status-modal');
            const statusModalCloseBtn = postStatusModal.querySelector('.status-modal-close-btn');
            const statusModalCancelBtn = postStatusModal.querySelector('.status-modal-action-btn.cancel');
            const coupleStatusMessageContainer = document.getElementById('couple-status-message-container');
            const statusInputPlaceholder = document.getElementById('status-input-placeholder');
            const statusInputActiveWrapper = document.getElementById('status-input-active-wrapper');
            const statusMessageInput = document.getElementById('status-message-input');
            const statusSendBtn = document.getElementById('status-send-btn');
            const coupleStatusOptionsBtn = document.getElementById('couple-status-options-btn');
            const coupleStatusContextMenu = document.getElementById('couple-status-context-menu');
            const breakupConfirmModal = document.getElementById('breakup-confirm-modal');
            const breakupConfirmText = document.getElementById('breakup-confirm-text');
            const breakupConfirmBtn = document.getElementById('breakup-confirm-btn');
            const breakupCancelBtn = document.getElementById('breakup-cancel-btn');
            const partnerAvatarImg = document.getElementById('couple-partner-avatar-img');
            const partnerAvatarPlaceholder = partnerAvatarWrapper.querySelector('.partner-avatar-placeholder');
            const breakupPopup = partnerAvatarWrapper.querySelector('.breakup-popup');
            const breakupCloseBtn = partnerAvatarWrapper.querySelector('.breakup-close-btn');

            // --- 【新增】状态页消息交互相关变量 ---
            const statusMessageContextCard = document.getElementById('status-message-context-card');
            const statusMultiSelectCancelBtn = document.getElementById('status-multi-select-cancel-btn');
            const statusMultiSelectDeleteBtn = document.getElementById('status-multi-select-delete-btn');
            const statusMultiSelectCounter = document.getElementById('status-multi-select-counter');

            let coupleStatusMessages = {}; // 用于存储每个情侣关系的状态页消息

            // --- 【【【全新 V3.9】】】添加状态弹窗相关变量 ---
            const addStatusModal = document.getElementById('add-status-modal');
            const addStatusCard = document.getElementById('add-status-card');
            const addStatusCloseBtn = document.getElementById('add-status-close-btn');

            // --- 【【【全新 V3.9.5】】】快捷删除模式相关变量 ---
            const statusDirectDeleteBtn = document.getElementById('status-direct-delete-btn');
            const addStatusCancelBtn = document.getElementById('add-status-cancel-btn');
            const addStatusSaveBtn = document.getElementById('add-status-save-btn');
            const statusDropdownContainer = document.querySelector('.status-dropdown-container');
            const statusDropdownHeader = document.querySelector('.status-dropdown-header');
            const statusDropdownList = document.querySelector('.status-dropdown-list');
            const statusSubjectSelector = document.getElementById('add-status-subject-selector');
            const statusTimeInput = document.getElementById('add-status-time-input');
            const statusContentInput = document.getElementById('add-status-content-input');

            // 定义可选择的状态列表
            const statusOptions = [
                { id: 'unlock', text: '还没入睡，刚刚解锁了手机', svg: '<svg t="1758903115001" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2348" width="19" height="19"><path d="M530.432 945.3568A434.176 434.176 0 0 1 491.52 78.6432a40.96 40.96 0 0 1 26.0096 70.8608 261.7344 261.7344 0 0 0-83.5584 192.3072 266.24 266.24 0 0 0 266.24 266.24 262.3488 262.3488 0 0 0 191.6928-82.944s0 1.024 0 0a40.96 40.96 0 0 1 70.656 24.576 434.176 434.176 0 0 1-432.128 395.6736z m0 0" p-id="2349" fill="#7347f7"></path></svg>' },
                { id: 'charge_start', text: '手机开始充电了', svg: '<svg t="1758955713450" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10961" width="15" height="15"><path d="M511.6806 0c-281.42411 0-511.6802 230.25609-511.6802 511.6802s230.25609 511.6802 511.6802 511.6802 511.6802-230.25609 511.6802-511.6802-230.25609-511.6802-511.6802-511.6802z" fill="#f75c4d" p-id="10962" data-spm-anchor-id="a313x.search_index.0.i4.21323a811dKEBi" class="selected"></path><path d="M697.804272 441.963773H621.052242c-19.188007 0-63.960025 6.396002-76.75203 0 0-12.792005 6.396002-31.980012 6.396003-38.376015 6.396002-25.58401 12.792005-57.564022 25.58401-83.148033l31.980012-121.524047c0-6.396002 0-12.792005-12.792005-19.188008-6.396002 0-12.792005 0-12.792005 6.396003L314.044122 557.091818c-6.396002 6.396002 0 12.792005 6.396003 19.188007h115.128045c6.396002 0 38.376015-6.396002 38.376015 0 6.396002 6.396002-6.396002 25.58401-6.396003 31.980013l-57.564022 211.068082c0 6.396002 0 12.792005 12.792005 19.188008 6.396002 0 12.792005 0 12.792005-6.396003L704.200275 461.15178c6.396002-6.396002 0-12.792005-6.396003-19.188007 6.396002 0 0 0 0 0z" fill="#ffffff" p-id="10963" data-spm-anchor-id="a313x.search_index.0.i5.21323a811dKEBi" class=""></path></svg>' },
                { id: 'charge_end', text: '手机结束了充电', svg: '<svg t="1758955713450" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10961" width="15" height="15"><path d="M511.6806 0c-281.42411 0-511.6802 230.25609-511.6802 511.6802s230.25609 511.6802 511.6802 511.6802 511.6802-230.25609 511.6802-511.6802-230.25609-511.6802-511.6802-511.6802z" fill="#42d93f" p-id="10962" data-spm-anchor-id="a313x.search_index.0.i4.21323a811dKEBi" class="selected"></path><path d="M697.804272 441.963773H621.052242c-19.188007 0-63.960025 6.396002-76.75203 0 0-12.792005 6.396002-31.980012 6.396003-38.376015 6.396002-25.58401 12.792005-57.564022 25.58401-83.148033l31.980012-121.524047c0-6.396002 0-12.792005-12.792005-19.188008-6.396002 0-12.792005 0-12.792005 6.396003L314.044122 557.091818c-6.396002 6.396002 0 12.792005 6.396003 19.188007h115.128045c6.396002 0 38.376015-6.396002 38.376015 0 6.396002 6.396002-6.396002 25.58401-6.396003 31.980013l-57.564022 211.068082c0 6.396002 0 12.792005 12.792005 19.188008 6.396002 0 12.792005 0 12.792005-6.396003L704.200275 461.15178c6.396002-6.396002 0-12.792005-6.396003-19.188007 6.396002 0 0 0 0 0z" fill="#ffffff" p-id="10963" data-spm-anchor-id="a313x.search_index.0.i5.21323a811dKEBi" class=""></path></svg>' },
                { id: 'arrive', text: '到达xxxx', svg: '<svg t="1758955883811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14839" width="16.5" height="16.5"><path d="M512 0C294.208 0 117.034667 177.152 117.056 394.922667c0 80.896 24.298667 158.677333 69.781333 224.149333 2.282667 3.925333 4.586667 7.722667 7.296 11.413333l288.277333 379.989333C490.24 1019.2 500.757333 1024 512.021333 1024c11.114667 0 21.696-4.842667 30.848-15.104l286.954667-378.474667c2.837333-3.754667 5.248-7.872 6.570667-10.282667 46.144-66.389333 70.570667-144.256 70.570667-225.173333C906.965333 177.152 729.792 0 512 0zM512 536.170667c-77.781333 0-141.077333-63.296-141.077333-141.098667 0-77.781333 63.296-141.056 141.077333-141.056 77.781333 0 141.077333 63.296 141.077333 141.056C653.077333 472.874667 589.781333 536.170667 512 536.170667z" p-id="14840" fill="#50e5cd"></path></svg>' },
                { id: 'steps', text: '步数已更新 xxxx步', svg: '<svg t="1758903704377" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13338" width="16" height="16"><path d="M1024.091009 47.590705v0.199961l-2.299551 520.198399-1.499707 5.798867c-2.19957 8.198399-10.397969 29.294278-38.592462 45.291154-22.995509 12.997461-54.289397 19.596173-92.98184 19.596173h-4.899043c-48.890451-0.699863-111.078305-11.597735-184.963874-32.293693-44.691271-12.497559-84.783441-17.696544-120.57645-17.696544-87.382933 0-148.970904 30.793986-188.36321 60.888108-27.094708 20.695958-36.492872 57.288811-22.595587 88.382738l98.380785 220.856864c10.397969 23.19547-0.199961 50.79008-23.495411 61.188049-6.098809 2.699473-12.397579 3.999219-18.696349 3.999219-17.796524 0-34.893185-10.297989-42.4917-27.49463L3.990247 149.770748c-4.19918-9.398164-4.999024-19.596173-2.799453-29.094318 0.599883-3.699277 1.499707-7.398555 2.899434-10.997852C9.289213 96.081234 19.987123 84.783441 33.284526 78.884593 72.076949 61.487991 134.264803 37.092755 210.849845 20.096075 268.738539 7.198594 324.327682 0.699863 377.317332 0.699863c51.389963 0 100.380394 6.098809 146.471392 18.196446C636.166776 48.390549 716.251134 59.988284 776.439379 59.988284c86.083187 0 131.874243-23.595392 174.265963-51.989846l1.99961-1.299746c7.398555-4.499121 15.796915-6.698692 24.095294-6.698692 7.998438 0 15.996876 1.999609 23.195469 6.098809 14.89709 8.49834 24.195274 24.395235 24.095294 41.491896z" p-id="13339" fill="#ffda68"></path></svg>' },
                { id: 'leave', text: '离开家了', svg: '<svg t="1758905421214" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="129001" width="18" height="18"><path d="M917.333333 938.666667h-21.333333V96a53.393333 53.393333 0 0 0-53.333333-53.333333H181.333333a53.393333 53.393333 0 0 0-53.333333 53.333333v842.666667h-21.333333a21.333333 21.333333 0 0 0 0 42.666666h810.666666a21.333333 21.333333 0 0 0 0-42.666666z m-128-384H661.333333a21.333333 21.333333 0 0 1 0-42.666667h128a21.333333 21.333333 0 0 1 0 42.666667z m21.333334 64v256a21.333333 21.333333 0 0 1-42.666667 0V618.666667a21.333333 21.333333 0 0 1 42.666667 0z m-597.333334 320V149.333333a21.333333 21.333333 0 0 1 21.333334-21.333333h554.666666a21.333333 21.333333 0 0 1 21.333334 21.333333v298.666667a21.333333 21.333333 0 0 1-42.666667 0V170.666667H256v768z" fill="#55da84" p-id="129002"></path></svg>' },
                { id: 'solution', text: '刚刚解锁了手机', svg: '<svg t="1758961619404" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="87881" width="18" height="18"><path d="M513.948 64c115.945 0 210.151 93.087 212.024 208.622l0.028 3.508-0.001 55.87H784c70.692 0 128 57.308 128 128v368c0 70.692-57.308 128-128 128H240c-70.692 0-128-57.308-128-128V460c0-70.692 57.308-128 128-128h421.999l0.001-55.87C662 194.317 595.712 128 513.948 128c-74.864 0-137.62 55.896-146.878 129.365l-0.264 2.232c-1.945 17.565-17.762 30.229-35.328 28.284-17.565-1.945-30.229-17.762-28.284-35.328C315.031 145.656 405.614 64 513.948 64zM512 540c-17.673 0-32 14.327-32 32v144c0 17.673 14.327 32 32 32 17.673 0 32-14.327 32-32V572c0-17.673-14.327-32-32-32z" fill="#ffd861" p-id="87882"></path></svg>' },
                { id: 'screen', text: '屏幕使用xx分钟了', svg: '<svg t="1758959536744" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="59890" width="21.8" height="19"><path d="M820.409449 797.228346q0 25.19685-10.07874 46.866142t-27.716535 38.299213-41.322835 26.204724-50.897638 9.574803l-357.795276 0q-27.212598 0-50.897638-9.574803t-41.322835-26.204724-27.716535-38.299213-10.07874-46.866142l0-675.275591q0-25.19685 10.07874-47.370079t27.716535-38.80315 41.322835-26.204724 50.897638-9.574803l357.795276 0q27.212598 0 50.897638 9.574803t41.322835 26.204724 27.716535 38.80315 10.07874 47.370079l0 675.275591zM738.771654 170.330709l-455.559055 0 0 577.511811 455.559055 0 0-577.511811zM510.992126 776.062992q-21.165354 0-36.787402 15.11811t-15.622047 37.291339q0 21.165354 15.622047 36.787402t36.787402 15.622047q22.173228 0 37.291339-15.622047t15.11811-36.787402q0-22.173228-15.11811-37.291339t-37.291339-15.11811zM591.622047 84.661417q0-8.062992-5.03937-12.598425t-11.086614-4.535433l-128 0q-5.03937 0-10.582677 4.535433t-5.543307 12.598425 5.03937 12.598425 11.086614 4.535433l128 0q6.047244 0 11.086614-4.535433t5.03937-12.598425z" p-id="59891"></path></svg>' },
                { id: 'phone', text: '屏幕使用x小时了', svg: '<svg t="1758959536744" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="59890" width="21.8" height="19"><path d="M820.409449 797.228346q0 25.19685-10.07874 46.866142t-27.716535 38.299213-41.322835 26.204724-50.897638 9.574803l-357.795276 0q-27.212598 0-50.897638-9.574803t-41.322835-26.204724-27.716535-38.299213-10.07874-46.866142l0-675.275591q0-25.19685 10.07874-47.370079t27.716535-38.80315 41.322835-26.204724 50.897638-9.574803l357.795276 0q27.212598 0 50.897638 9.574803t41.322835 26.204724 27.716535 38.80315 10.07874 47.370079l0 675.275591zM738.771654 170.330709l-455.559055 0 0 577.511811 455.559055 0 0-577.511811zM510.992126 776.062992q-21.165354 0-36.787402 15.11811t-15.622047 37.291339q0 21.165354 15.622047 36.787402t36.787402 15.622047q22.173228 0 37.291339-15.622047t15.11811-36.787402q0-22.173228-15.11811-37.291339t-37.291339-15.11811zM591.622047 84.661417q0-8.062992-5.03937-12.598425t-11.086614-4.535433l-128 0q-5.03937 0-10.582677 4.535433t-5.543307 12.598425 5.03937 12.598425 11.086614 4.535433l128 0q6.047244 0 11.086614-4.535433t5.03937-12.598425z" p-id="59891"></path></svg>' },
                { id: 'call', text: '结束了接打电话 x分x秒', svg: '<svg t="1758904062586" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26821" width="16" height="16"><path d="M232.641947 85.326223c27.048413 0 49.489209 23.464711 49.489209 51.622365 0 64.16532 9.556537 126.197484 28.157653 184.048662a54.864761 54.864761 0 0 1-12.030997 53.243563L200.559287 460.761603c66.725106 196.07966 208.707941 314.68311 344.71794 356.151654l78.500125-102.732772a47.526706 47.526706 0 0 1 50.59845-12.542955c55.462045 18.771769 115.019748 29.266894 176.625281 29.266895 26.963086 0 49.489209 23.464711 49.489209 51.622364v179.867678c0 28.669611-95.906674 61.520207-131.402383 61.520207C304.913257 1023.914674 0.042663 682.609783 0.042663 136.948588 0.042663 97.869178 32.551954 85.326223 59.600367 85.326223z m258.538455 298.64178c90.445796 0 163.826348 76.366969 163.826347 170.652445h-81.913173c0-47.100075-36.690276-85.326223-81.913174-85.326223v-85.326222z m0-170.652446c180.891592 0 327.567369 152.733939 327.567369 341.304891h-81.913174c0-141.385551-109.985501-255.978668-245.568869-255.978668v-85.326223z m0-170.652446c271.337389 0 491.308391 229.186234 491.308391 511.957337h-81.913174c0-235.585701-183.280727-426.631114-409.309891-426.631114v-85.326223z" fill="#26c824" p-id="26822"></path></svg>' },
                { id: 'hangup', text: '结束了与你的通话', svg: '<svg t="1758904104435" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="28039" width="20" height="20"><path d="M509.64 63c-247.7 0-448.5 200.8-448.5 448.5S261.94 960 509.64 960s448.5-200.8 448.5-448.5S757.34 63 509.64 63z m215.61 530.32c-24.18 0-67.4-13.89-84.9-19.55s-24.18-12.86-28.81-39.62-23.15-36-44.25-37c-14.07-0.68-36.82-0.68-50.42-0.61v0.1l-5.66-0.06-5.66 0.06v-0.1c-13.61-0.07-36.36-0.07-50.43 0.61-21.09 1-39.62 10.29-44.25 37s-11.32 34-28.81 39.62-60.71 19.55-84.9 19.55-28.3-58.66-28.3-58.66c0-76.66 190.89-97.76 216.14-97.76h52.48c25.21 0 216.1 21.1 216.1 97.76-0.03 0-4.14 58.66-28.33 58.66z" fill="#e34d39" p-id="28040"></path></svg>' },
                { id: 'aircondition', text: '打开了空调 xx℃', svg: '<svg t="1758904588885" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="58585" width="18" height="18"><path d="M902.826667 688.213333l-95.573334-55.04 75.52-20.053333c22.613333-5.973333 36.266667-29.44 30.293334-52.053333s-29.44-36.266667-52.053334-30.293334l-157.866666 42.24L597.333333 512l105.386667-61.013333 157.866667 42.24c3.84 0.853333 7.253333 1.28 11.093333 1.28 18.773333 0 36.266667-12.373333 40.96-31.573334a42.410667 42.410667 0 0 0-30.293333-52.053333l-75.52-20.053333 95.573333-55.04c20.48-11.946667 27.306667-37.973333 15.786667-58.453334a43.093333 43.093333 0 0 0-58.453334-15.786666l-95.573333 55.04 20.053333-75.52a42.410667 42.410667 0 0 0-30.293333-52.053334 42.410667 42.410667 0 0 0-52.053333 30.293334l-42.24 157.866666L554.666667 438.186667V316.16l115.626666-115.626667a42.496 42.496 0 1 0-60.16-60.16L554.666667 195.84V85.333333c0-23.466667-19.2-42.666667-42.666667-42.666666s-42.666667 19.2-42.666667 42.666666v110.506667l-55.04-55.466667A42.496 42.496 0 1 0 354.133333 200.533333L469.333333 316.16v121.6L363.946667 377.173333l-42.24-157.866666a42.410667 42.410667 0 0 0-52.48-29.866667c-22.613333 5.973333-36.266667 29.44-29.866667 52.053333l20.053333 75.52-95.573333-55.466666a43.093333 43.093333 0 0 0-58.453333 15.786666c-11.52 20.48-4.693333 46.506667 15.786666 58.453334l95.573334 55.04-75.52 20.053333c-22.613333 5.973333-36.266667 29.44-30.293334 52.053333 5.12 19.2 22.186667 31.573333 40.96 31.573334 3.84 0 7.253333-0.426667 11.093334-1.28l157.866666-42.24L426.666667 512l-105.386667 61.013333-157.866667-42.24c-22.613333-5.973333-46.08 7.253333-52.053333 30.293334s7.253333 46.08 30.293333 52.053333l75.52 20.053333-95.573333 55.04c-20.48 11.946667-27.306667 37.973333-15.786667 58.453334 7.68 13.653333 22.186667 21.333333 36.693334 21.333333 7.253333 0 14.506667-1.706667 21.333333-5.546667l95.573333-55.04-20.053333 75.52a42.410667 42.410667 0 0 0 41.386667 53.333334c18.773333 0 36.266667-12.373333 40.96-31.573334l42.24-157.866666L469.333333 585.813333v121.6l-115.626666 115.626667A42.496 42.496 0 1 0 413.866667 883.2l55.466666-55.04V938.666667c0 23.466667 19.2 42.666667 42.666667 42.666666s42.666667-19.2 42.666667-42.666666v-110.506667l55.04 55.04c8.533333 8.533333 19.2 12.8 30.293333 12.8s21.76-4.266667 30.293333-12.373333a42.496 42.496 0 0 0 0-60.16L554.666667 707.84v-121.6l105.386666 61.013333 42.24 157.866667c5.12 19.2 22.186667 31.573333 40.96 31.573333 3.84 0 7.253333-0.426667 11.093334-1.28 22.613333-5.973333 36.266667-29.44 30.293333-52.053333l-20.053333-75.52 95.573333 55.04c6.826667 3.84 14.08 5.546667 21.333333 5.546667 14.933333 0 29.013333-7.68 37.12-21.333334 11.52-20.906667 4.693333-46.933333-15.786666-58.88z" p-id="58586" fill="#90c5f8"></path></svg>' },
                { id: 'close', text: '关闭了空调', svg: '<svg t="1758961076095" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="83691" width="18" height="18"><path d="M512 522.3m-469.5 0a469.5 469.5 0 1 0 939 0 469.5 469.5 0 1 0-939 0Z" fill="#2dbf9f" p-id="83692" data-spm-anchor-id="a313x.search_index.0.i152.21323a811dKEBi" class="selected"></path><path d="M346.2 303.2m-40.9 0a40.9 40.9 0 1 0 81.8 0 40.9 40.9 0 1 0-81.8 0Z" fill="#FFFFFF" p-id="83693"></path><path d="M675.2 300.7m-40.9 0a40.9 40.9 0 1 0 81.8 0 40.9 40.9 0 1 0-81.8 0Z" fill="#FFFFFF" p-id="83694"></path><path d="M512 551.1c-22.6 0-41-18.3-41-41V242c0-22.6 18.3-41 41-41 22.6 0 41 18.3 41 41v268.1c0 22.7-18.4 41-41 41z" fill="#FFFFFF" p-id="83695"></path><path d="M701.2 268.9l-53.8 62c57.9 42 95.5 110.1 95.5 187 0 127.5-103.4 230.9-230.9 230.9S281.1 645.5 281.1 517.9c0-73 33.9-138 86.7-180.3l-45.5-68.3C247.5 326.4 199.2 416.6 199.2 518c0 172.7 140 312.8 312.8 312.8s312.8-140 312.8-312.8c0-101.7-48.5-192-123.6-249.1z" fill="#FFFFFF" p-id="83696"></path></svg>' },
                { id: 'outside', text: '为你下单了外卖', svg: '<svg t="1758961847563" class="icon" viewBox="0 0 1035 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="90216" width="27" height="27"><path d="M3.328 0m349.090909 0l325.818182 0q349.090909 0 349.090909 349.090909l0 325.818182q0 349.090909-349.090909 349.090909l-325.818182 0q-349.090909 0-349.090909-349.090909l0-325.818182q0-349.090909 349.090909-349.090909Z" fill="#ffd861" p-id="90217" data-spm-anchor-id="a313x.search_index.0.i189.21323a811dKEBi" class="selected"></path><path d="M299.415273 608.058182c0 23.121455 19.525818 41.844364 43.601454 41.844363 24.110545 0 43.636364-18.734545 43.636364-41.844363 0-23.133091-19.525818-41.832727-43.636364-41.832727-24.087273 0-43.601455 18.699636-43.601454 41.832727z m367.662545 41.844363c24.110545 0 43.636364-18.734545 43.636364-41.844363 0-23.133091-19.525818-41.832727-43.636364-41.832727-24.075636 0-43.613091 18.699636-43.613091 41.832727 0 23.121455 19.537455 41.844364 43.613091 41.844363z m-38.574545-179.339636h43.461818c1.361455 0 2.850909 0.337455 4.305454 0.558546 1.175273-0.151273 2.292364-0.558545 3.49091-0.558546h72.692363c24.087273 0 58.158545 36.805818 58.158546 59.822546v9.681454c0 15.127273-17.442909 14.08-39.610182 13.893818A109.137455 109.137455 0 0 1 785.291636 607.883636c0 62.72-52.910545 113.570909-118.202181 113.570909-45.032727 0-84.130909-24.203636-104.122182-59.776H447.138909C427.124364 697.250909 387.909818 721.454545 342.842182 721.454545 277.434182 721.454545 224.418909 670.603636 224.418909 607.883636c0-38.225455 19.805091-71.831273 49.989818-92.404363a39.528727 39.528727 0 0 1-1.093818-9.053091l27.368727-43.752727c-23.202909-11.717818-38.469818-33.047273-38.469818-52.072728V395.636364c0-24.785455 20.596364-44.823273 45.975273-44.823273h94.522182c19.397818-20.130909 52.212364-43.205818 68.584727-34.141091 20.922182 11.589818 13.789091 42.554182 5.387636 61.917091l-15.243636 37.003636v9.937455c0 20.456727-14.103273 37.504-33.326545 42.845091-21.294545 75.613091 59.938909 115.362909 112.721454 59.077818 1.861818-3.025455 3.456-6.202182 4.805818-9.483636l0.314182 0.256c18.525091-40.226909 64.593455-46.708364 82.548364-47.674182z m148.037818-36.037818H607.313455c-25.518545 0-46.149818-18.967273-46.149819-42.356364V321.629091c0-23.389091 20.642909-42.344727 46.149819-42.344727h169.227636c25.472 0 46.149818 18.944 46.149818 42.344727v70.562909c0 23.365818-20.677818 42.344727-46.149818 42.344727z" fill="#FFFFFF" p-id="90218"></path></svg>' },
                { id: 'music', text: '加入了一起听', svg: '<svg t="1758904826237" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="75049" data-spm-anchor-id="a313x.search_index.0.i181.6fc13a81gF1pWB" width="18" height="18"><path d="M714.752 936.448l-45.056-17.408 166.912-426.496c7.168-18.944-2.048-40.448-20.992-47.616-0.512-0.512-1.536-0.512-2.048-0.512l-291.84-95.232c-18.944-6.144-38.912 3.584-46.08 22.016l-145.408 384.512-68.608-26.112L465.92 189.44c6.656-18.432 26.624-27.648 45.568-22.016L947.712 302.08c19.456 6.144 30.208 26.624 24.576 46.08-0.512 1.024-0.512 1.536-1.024 2.56L748.032 921.6c-5.12 13.312-19.968 19.968-33.28 14.848z" fill="#94a7f0" p-id="75050" data-spm-anchor-id="a313x.search_index.0.i174.6fc13a81gF1pWB" class=""></path><path d="M50.176 703.488c1.536 80.384 68.096 143.872 147.968 142.336 77.824-1.536 140.8-64.512 142.336-142.336 1.536-80.384-61.952-146.432-142.336-147.968-80.384-1.536-146.432 61.952-147.968 142.336v5.632zM468.992 865.792c0 80.384 65.024 145.408 145.408 144.896 80.384 0 145.408-65.024 144.896-145.408s-65.024-145.408-145.408-144.896c-79.872 0-144.896 65.024-144.896 145.408z" fill="#94a7f0" p-id="75051" data-spm-anchor-id="a313x.search_index.0.i175.6fc13a81gF1pWB" class=""></path><path d="M201.216 390.656L84.48 97.792c-7.168-17.92 1.536-38.4 19.456-45.568 1.024-0.512 2.048-0.512 2.56-1.024l121.344-36.864c15.872-5.12 33.28 2.56 40.448 17.92l14.848 32.256c7.68 16.896 0.512 36.864-16.384 44.544-1.024 0.512-2.56 1.024-3.584 1.536L180.224 138.24c-7.68 2.56-11.264 10.24-9.216 17.92 0 0.512 0 0.512 0.512 1.024L250.368 358.4c2.56 6.144-0.512 12.8-6.144 15.36l-43.008 16.896z" fill="#c2baf6" p-id="75052" data-spm-anchor-id="a313x.search_index.0.i177.6fc13a81gF1pWB" class="selected"></path><path d="M67.072 390.656c0 52.736 42.496 95.232 95.232 95.232s95.232-42.496 95.232-95.232S215.04 295.424 162.304 295.424 67.072 337.92 67.072 390.656z" fill="#c2baf6" p-id="75053" data-spm-anchor-id="a313x.search_index.0.i176.6fc13a81gF1pWB" class=""></path></svg>' },
                { id: 'signal', text: '连接了移动数据', svg: '<svg t="1758960639698" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="71831" width="16" height="16"><path d="M105.8816 972.8C75.6736 972.8 51.2 948.3264 51.2 918.1184V699.1872c0-30.208 24.4736-54.6816 54.6816-54.6816s54.6816 24.4736 54.6816 54.6816v218.9312c0.1024 30.208-24.3712 54.6816-54.6816 54.6816z m270.7456 0c-30.208 0-54.6816-24.4736-54.6816-54.6816V491.8272c0-30.208 24.4736-54.6816 54.6816-54.6816 30.208 0 54.6816 24.4736 54.6816 54.6816v426.2912c0.1024 30.208-24.4736 54.6816-54.6816 54.6816z m270.7456 0c-30.208 0-54.6816-24.4736-54.6816-54.6816V307.5072c0-30.208 24.4736-54.6816 54.6816-54.6816 30.208 0 54.6816 24.4736 54.6816 54.6816v610.6112c0 30.208-24.4736 54.6816-54.6816 54.6816z m270.7456 0c-30.208 0-54.6816-24.4736-54.6816-54.6816V105.8816C863.3344 75.6736 887.808 51.2 918.1184 51.2S972.8 75.6736 972.8 105.8816v812.1344c0 30.3104-24.4736 54.784-54.6816 54.784z" fill="#3fd4dd" p-id="71832"></path></svg>' },
                { id: 'network', text: '连接了WiFi', svg: '<svg t="1758960550503" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="71367" width="20" height="20"><path d="M350.848 720a224 224 0 0 1 316.8 0l-158.4 158.464z m485.568-173.44l5.504 5.312-90.56 90.56a336 336 0 0 0-471.168-3.968l-3.968 3.968-90.496-90.56a464 464 0 0 1 650.688-5.376z m166.912-172.544l8.32 8.192-90.56 90.496A576 576 0 0 0 113.28 466.048l-6.784 6.656L16 382.208c272.192-272.192 711.808-274.944 987.328-8.192z" fill="#515151" p-id="71368"></path></svg>' },
                { id: 'angry', text: '更新了状态 生气了', svg: '<svg t="1758904994619" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="90646" width="16" height="16"><path d="M805.376 120.832c-52.736 109.056-164.352 184.32-293.888 184.32-129.536 0-241.152-75.264-293.888-184.32-4.608-9.216-12.8-46.08 11.264-32.768 10.752 6.144 21.504 12.288 31.232 17.92 68.608 39.936 118.272 69.12 251.392 69.12 141.824 0 217.088-46.592 270.848-79.872 4.096-2.56 7.68-5.12 11.776-7.168 20.48-12.288 18.944 17.92 11.264 32.768zM305.664 512c0-129.536-75.264-241.152-184.32-293.888-14.848-7.168-45.056-9.216-32.768 11.264 2.048 3.584 4.608 7.68 7.168 11.776 33.28 53.76 79.872 128.512 79.872 270.848 0 132.608-29.184 182.784-69.12 251.392-5.632 9.728-11.776 19.968-17.92 31.232-13.312 24.064 23.552 15.872 32.768 11.264 109.056-52.736 184.32-164.352 184.32-293.888z m412.672 0c0-129.536 75.264-241.152 184.32-293.888 14.848-7.168 45.056-9.216 32.768 11.264-2.048 3.584-4.608 7.68-7.168 11.776-33.28 53.76-79.872 128.512-79.872 270.848 0 132.608 29.184 182.784 69.12 251.392 5.632 9.728 11.776 19.968 17.92 31.232 13.312 24.064-23.552 15.872-32.768 11.264-109.056-52.736-184.32-164.352-184.32-293.888zM512 718.336c129.536 0 241.152 75.264 293.888 184.32 7.168 14.848 9.216 45.056-11.264 32.768-3.584-2.048-7.68-4.608-11.776-7.168-53.76-33.28-128.512-79.872-270.848-79.872-132.608 0-182.784 29.184-251.392 69.12-9.728 5.632-19.968 11.776-31.232 17.92-24.064 13.312-15.872-23.552-11.264-32.768 52.736-109.056 164.352-184.32 293.888-184.32z" p-id="90647" fill="#ef3c25"></path></svg>' },
                { id: 'eat', text: '更新了状态 吃饭中', svg: '<svg t="1758905301425" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="121437" width="18" height="18"><path d="M191.767273 918.341818 191.767273 918.341818c-18.618182 0-37.632-5.725091-51.037091-15.476364-11.869091-8.448-19.386182-23.668364-21.061818-42.379636-2.048-22.760727 4.468364-45.637818 16.709818-58.507636 15.313455-15.988364 230.469818-219.368727 279.598545-265.774545l-22.574545-24.715636c-9.053091 1.047273-26.042182 2.466909-43.52 2.466909-15.313455 0-27.950545-1.163636-37.515636-3.514182-6.376727-1.559273-17.361455-6.749091-46.056727-33.163636-18.129455-16.779636-40.192-39.144727-62.021818-63.069091-19.269818-21.201455-82.688-92.462545-91.485091-123.787636C101.166545 248.948364 107.031273 200.96 108.055273 193.163636c0.256-20.549818 9.448727-57.856 42.612364-57.856 21.061818 0 47.080727 16.244364 79.383273 49.547636 18.385455 18.850909 224.093091 227.165091 270.917818 274.501818l28.066909-29.509818c-12.264727-11.310545-30.370909-30.696727-34.327273-49.943273-5.352727-26.135273 0.512-38.237091 12.125091-62.417455 1.140364-2.327273 2.304-4.677818 3.560727-7.284364 19.898182-41.728 166.912-175.918545 192.186182-195.700364 7.540364-5.841455 15.429818-8.843636 23.598545-8.843636 13.661091 0 26.554182 8.843636 33.442909 22.877091 5.748364 11.706182 5.492364 24.064-0.512 32.232727-8.936727 11.962182-139.217455 148.503273-156.206545 166.190545-4.212364 5.469091-13.265455 20.805818-7.912727 26.391273 0.512 0.512 1.024 0.907636 2.56 0.907636 6.888727 0 17.873455-8.052364 22.085818-11.822545 8.029091-8.075636 141.521455-142.638545 153.530182-154.205091 6.772364-6.632727 14.801455-10.146909 23.342545-10.146909 15.941818 0 28.578909 12.218182 33.954909 24.180364 5.352727 11.962182 4.212364 24.064-2.932364 32.372364-11.240727 13.125818-145.850182 163.584-151.598545 169.937455l-0.372364 0.512c-1.792 1.954909-9.821091 11.054545-3.700364 19.106909 0.884364 1.163636 1.536 1.442909 2.816 1.442909 5.748364 0 15.197091-6.376727 19.269818-9.890909 6.772364-6.888727 141.777455-142.382545 156.834909-157.719273 5.492364-5.469091 12.753455-8.448 21.061818-8.448 16.965818 0 36.631273 12.613818 43.776 28.090182 4.468364 9.611636 3.444364 19.502545-2.676364 27.042909-0.628364 0.768-1.536 1.954909-2.792727 3.514182-37.655273 46.685091-72.610909 87.249455-103.889455 120.669091-83.968 89.856-115.106909 100.258909-131.188364 100.258909-2.048 0-4.096-0.116364-6.004364-0.512-26.786909-5.329455-50.408727-21.317818-63.418182-31.604364l-31.138909 36.933818c46.452364 46.149818 261.725091 260.049455 271.546182 269.800727 9.053091 8.983273 17.477818 29.649455 16.337455 51.874909-1.024 18.850909-8.797091 34.722909-22.597818 45.777455-12.637091 10.146909-29.346909 15.732364-47.080727 15.732364-19.525818 0-37.003636-6.772364-45.824-17.826909-8.680727-10.798545-159.255273-182.807273-245.643636-281.250909L239.755636 900.142545C228.770909 911.965091 211.805091 918.341818 191.767273 918.341818L191.767273 918.341818 191.767273 918.341818z" fill="#515151" p-id="121438"></path></svg>' },
                { id: 'home', text: '更新了状态 到家了', svg: '<svg t="1758905359962" class="icon" viewBox="0 0 1029 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="126692" width="18" height="18"><path d="M1001.423238 494.592q21.504 20.48 22.528 45.056t-16.384 40.96q-19.456 17.408-45.056 16.384t-40.96-14.336q-5.12-4.096-31.232-28.672t-62.464-58.88-77.824-73.728-78.336-74.24-63.488-60.416-33.792-31.744q-32.768-29.696-64.512-28.672t-62.464 28.672q-10.24 9.216-38.4 35.328t-65.024 60.928-77.824 72.704-75.776 70.656-59.904 55.808-30.208 27.136q-15.36 12.288-40.96 13.312t-44.032-15.36q-20.48-18.432-19.456-44.544t17.408-41.472q6.144-6.144 37.888-35.84t75.776-70.656 94.72-88.064 94.208-88.064 74.752-70.144 36.352-34.304q38.912-37.888 83.968-38.4t76.8 30.208q6.144 5.12 25.6 24.064t47.616 46.08 62.976 60.928 70.656 68.096 70.144 68.096 62.976 60.928 48.128 46.592zM447.439238 346.112q25.6-23.552 61.44-25.088t64.512 25.088q3.072 3.072 18.432 17.408l38.912 35.84q22.528 21.504 50.688 48.128t57.856 53.248q68.608 63.488 153.6 142.336l0 194.56q0 22.528-16.896 39.936t-45.568 18.432l-193.536 0 0-158.72q0-33.792-31.744-33.792l-195.584 0q-17.408 0-24.064 10.24t-6.656 23.552q0 6.144-0.512 31.232t-0.512 53.76l0 73.728-187.392 0q-29.696 0-47.104-13.312t-17.408-37.888l0-203.776q83.968-76.8 152.576-139.264 28.672-26.624 57.344-52.736t52.224-47.616 39.424-36.352 19.968-18.944z" p-id="126693" fill="#4ac9c2"></path></svg>' },
                { id: 'go', text: '更新了状态 出门了', svg: '<svg t="1758905421214" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="129001" width="18" height="18"><path d="M917.333333 938.666667h-21.333333V96a53.393333 53.393333 0 0 0-53.333333-53.333333H181.333333a53.393333 53.393333 0 0 0-53.333333 53.333333v842.666667h-21.333333a21.333333 21.333333 0 0 0 0 42.666666h810.666666a21.333333 21.333333 0 0 0 0-42.666666z m-128-384H661.333333a21.333333 21.333333 0 0 1 0-42.666667h128a21.333333 21.333333 0 0 1 0 42.666667z m21.333334 64v256a21.333333 21.333333 0 0 1-42.666667 0V618.666667a21.333333 21.333333 0 0 1 42.666667 0z m-597.333334 320V149.333333a21.333333 21.333333 0 0 1 21.333334-21.333333h554.666666a21.333333 21.333333 0 0 1 21.333334 21.333333v298.666667a21.333333 21.333333 0 0 1-42.666667 0V170.666667H256v768z" fill="#55da84" p-id="129002"></path></svg>' },
                { id: 'sleep', text: '更新了状态 准备睡觉', svg: '<svg t="1758905697696" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="149826" width="18" height="18"><path d="M416.896 64A406.698667 406.698667 0 0 0 405.333333 160.554667c0 223.850667 181.482667 405.333333 405.333334 405.333333 52.181333 0 102.058667-9.856 147.861333-27.818667C940.16 768.576 747.242667 949.888 512 949.888c-247.424 0-448-200.576-448-448C64 287.104 215.146667 107.605333 416.896 64zM832 138.666667c27.52 0 41.792 32.128 24.597333 52.48l-1.962666 2.133333-137.408 137.386667H832a32 32 0 0 1 31.850667 28.928L864 362.666667a32 32 0 0 1-28.928 31.850666L832 394.666667h-192c-27.52 0-41.792-32.128-24.597333-52.48l1.962666-2.133334 137.365334-137.386666H640a32 32 0 0 1-31.850667-28.928L608 170.666667a32 32 0 0 1 28.928-31.850667L640 138.666667h192z" fill="#fd7db4" p-id="149827"></path></svg>' }
            ];

            // 用于暂存弹窗数据的状态
            let currentStatusData = {};

            // --- 【新增】状态页专用的状态变量 ---
            let activeStatusContextMenuMsgId = null; // 正在操作的状态消息ID
            let statusMultiSelectMode = false;       // 状态页是否处于多选模式
            let selectedStatusMessageIds = new Set(); // 存储已选中的状态消息ID

            let multiSelectMode = false;
            let selectedMessageIds = new Set();
            let visibleMessageCount = 30; // 默认显示最近30条
            let activeChatId = null;
            let chats = [];
            let stickers = [];
            let state = { apiSettings: {} }; // 【【【核心新增】】】
            let stickerFileAsDataUrl = null;
            let currentOpenPanel = 'none';
            let functionsPanelState = { currentPage: 1, totalPages: 2 };
            let coupleSpaceSettings = {};
            let coupleSpaceTheme = {};
            let currentPolaroidIndex = 0;
            let fontSettings = {};
            let currentImageUploadTarget = null;
            let desktopSettings = {};
            let desktopWallpaper = '';
            let desktopIconSettings = {};
            let currentAvatarUploadTarget = null;
            const defaultIconSVGs = {};
            let currentManagingStickerPack = { chatId: null, packId: null }; // 新增：跟踪当前正在管理的表情包
            let currentStickerAddContext = 'global'; // 新增：跟踪“添加表情”弹窗的上下文

            // --- 【【【全新】】】插入消息弹窗相关变量 ---
            const insertMessageModal = document.getElementById('insert-message-modal');
            const insertModalBody = document.getElementById('insert-modal-body');
            const insertActionsContainer = document.getElementById('insert-actions-container');
            const insertPreviewContainer = document.getElementById('insert-preview-container');
            const insertModalSaveBtn = document.getElementById('insert-modal-save-btn');
            const insertModalCancelBtn = document.getElementById('insert-modal-cancel-btn');
            const insertModalCloseBtn = document.getElementById('insert-modal-close-btn');

            // ===================================================================
            // 【V1.96 新增】世界书功能相关变量
            // ===================================================================
            const worldBookScreen = document.getElementById('world-book-screen');
            const presetBottomNav = document.querySelector('.preset-bottom-nav');
            const presetPages = document.querySelectorAll('.preset-page');
            const presetPageRole = document.getElementById('preset-page-role');
            const addNewRolePresetBtn = document.getElementById('add-new-role-preset-btn');

            // 编辑角色页面
            const presetEditScreen = document.getElementById('preset-edit-screen');
            const presetEditorTitle = document.getElementById('preset-editor-title');
            const saveRolePresetBtn = document.getElementById('save-role-preset-btn');
            const presetNameContainer = document.getElementById('preset-name-input-container');
            const presetNameText = document.getElementById('preset-name-text');
            const presetContentContainer = document.getElementById('preset-content-input-container');
            const presetContentText = document.getElementById('preset-content-text');
            const presetDropdownContainer = document.querySelector('.preset-dropdown-container');
            const presetDropdownHeader = document.querySelector('.preset-dropdown-header');
            const presetDropdownLabel = document.getElementById('preset-dropdown-label');
            const presetDropdownList = document.querySelector('.preset-dropdown-list');

            // 修改禁词页面
            const presetForbiddenWordsScreen = document.getElementById('preset-forbidden-words-screen');
            const forbiddenWordsPositionSelect = document.getElementById('forbidden-words-position-select');
            const forbiddenWordsContentInput = document.getElementById('forbidden-words-content-input');
            const saveForbiddenWordsBtn = document.getElementById('save-forbidden-words-btn');

            let presets = {
                roles: [],
                forbiddenWords: { position: 'all', content: '', avatar: '' },
                // 【核心修改】清空示例数据，准备接收真实数据
                offlines: [],
                assets: {
                    writingStyles: [],
                    socialAssets: []
                }
            };
            let currentEditingPresetId = null; // 跟踪当前正在编辑的角色ID
            let currentEditingOfflinePresetId = null; // 跟踪当前正在编辑的预设ID

            // 【新增】跟踪素材编辑状态
            let currentEditingAsset = { type: null, id: null };
            let currentEditingSocialAssetImages = []; // 临时存储正在编辑的朋友圈素材的图片列表

            // 【全新 V1.92 性能优化】创建一个“图标配置地图”，在启动时缓存所有元素
            const iconConfigMap = {};


            // --- 功能函数 ---
            /**
             * 【【【全新 V3.2 修复】】】带过渡效果的隐藏函数
             * @param {HTMLElement} element - 要隐藏的元素
             * @param {string} activeClass - 控制显示的CSS类名 (例如 'visible' 或 'popup-active')
             */
            function hideWithTransition(element, activeClass) {
                if (!element) return;

                // 1. 移除激活类以启动过渡动画
                element.classList.remove(activeClass);

                // 2. 监听动画结束事件
                const onTransitionEnd = () => {
                    // 3. 动画结束后，再设置 visibility: hidden
                    element.style.visibility = 'hidden';
                    // 4. 移除事件监听器，防止多次触发
                    element.removeEventListener('transitionend', onTransitionEnd);
                };

                element.addEventListener('transitionend', onTransitionEnd);
            }
            /**
 * 【【【全新 V3.9.2】】】 辅助函数：检查两个时间戳是否在同一天
 * @param {number} ts1 - 时间戳1
 * @param {number} ts2 - 时间戳2
 * @returns {boolean}
 */
            function isSameDay(ts1, ts2) {
                const date1 = new Date(ts1);
                const date2 = new Date(ts2);
                return date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate();
            }

            /**
             * 【【【全新 V4.1 修复】】】 辅助函数：检查两个时间戳是否在同一天
             * @param {number|Date} ts1 - 时间戳1
             * @param {number|Date} ts2 - 时间戳2
             * @returns {boolean}
             */
            function isSameDay(ts1, ts2) {
                if (!ts1 || !ts2) return false;
                const date1 = new Date(ts1);
                const date2 = new Date(ts2);
                return date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate();
            }


            /**
             * 【【【全新 V4.1 最终修复】】】 专门格式化状态条时间戳的函数
             * @param {number} realTimestamp - 消息的真实时间戳
             * @param {string} customTime - 用户自定义的 "HH:MM" 格式时间
             * @returns {string} - 格式化后的完整时间字符串
             */
            function formatSystemStatusTimestamp(realTimestamp, customTime) {
                const date = new Date(realTimestamp);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                // 如果是今天，直接返回自定义时间
                if (isSameDay(date, today)) {
                    return customTime;
                }
                // 如果是昨天，返回 "昨天" + 自定义时间
                else if (isSameDay(date, yesterday)) {
                    return `昨天 ${customTime}`;
                }
                // 如果是一周内，返回 "星期X" + 自定义时间
                else if (today.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    return `${weekdays[date.getDay()]} ${customTime}`;
                }
                // 更早的，返回 "X月X日" + 自定义时间
                else {
                    return `${date.getMonth() + 1}月${date.getDate()}日 ${customTime}`;
                }
            }
            /**
             * 【【【全新 V3.9.1】】】 格式化状态详情页的消息时间戳
             * @param {number} timestamp - 消息的时间戳
             * @returns {string} - 格式化后的时间字符串
             */
            function formatStatusTimestamp(timestamp) {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                const time = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                // 【【【核心修复】】】 调用我们刚刚添加的 isSameDay 工具函数进行判断
                if (isSameDay(date, today)) {
                    return time; // 当天的消息，只显示 HH:MM
                } else if (isSameDay(date, yesterday)) {
                    return `昨天 ${time}`;
                } else if (today.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    return `${weekdays[date.getDay()]} ${time}`;
                } else {
                    return `${date.getMonth() + 1}月${date.getDate()}日 ${time}`;
                }
            }
            // ===================================================================
            // 【V2.30】日期和时间格式化工具函数
            // ===================================================================
            function formatMessageTime(timestamp) {
                const date = new Date(timestamp);
                return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            }

            function formatDateSeparator(timestamp) {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                // 清除时间部分，只比较日期
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const yesterdayOnly = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

                const time = formatMessageTime(timestamp);

                if (dateOnly.getTime() === todayOnly.getTime()) {
                    return null; // 当天的消息不显示日期分隔符
                } else if (dateOnly.getTime() === yesterdayOnly.getTime()) {
                    return `昨天 ${time}`;
                } else if (today.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    return `${weekdays[date.getDay()]} ${time}`;
                } else {
                    return `${date.getMonth() + 1}月${date.getDate()}日 ${time}`;
                }
            }


            // ===================================================================
            // 【全新 V1.73】情侣空间页面切换和主题功能函数
            // ===================================================================

            /**
             * 切换情侣空间内部的子页面
             * @param {string} pageNumber - 要切换到的页面编号 (1-4)
             */
            function switchCoupleContentPage(pageNumber) {
                // 1. 切换页面的显示
                coupleContentPages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === `couple-page-${pageNumber}`) {
                        page.classList.add('active');
                    }
                });

                // 2. 移动滑块
                const pageIndex = parseInt(pageNumber, 10) - 1;
                const sliderPosition = 12.5 + (pageIndex * 25);
                navSlider.style.left = `${sliderPosition}%`;

                // 3. 【【【全新 V2.62】】】更新顶栏标题和右上角按钮
                const mainHeader = document.querySelector('#couple-space-screen .couple-header');
                const headerTitle = mainHeader.querySelector('h1');
                const moreOptionsBtn = mainHeader.querySelector('.header-icon-right');

                const titles = ['情侣空间', '消息', '心情日记', '爱情运势'];
                headerTitle.textContent = titles[pageIndex];

                // 只有第一页(情侣空间)显示右上角按钮
                if (pageNumber == '1') {
                    moreOptionsBtn.style.visibility = 'visible';
                } else {
                    moreOptionsBtn.style.visibility = 'hidden';
                }
            }

            /**
 * 【【【全新 V4.3】】】保存“Me”页面的数据到 IndexedDB
 */
            async function saveMePageData() {
                try {
                    await db.set('mePageData', mePageData);
                } catch (error) {
                    console.error("Failed to save mePageData to IndexedDB:", error);
                    alert("保存个人主页数据失败！");
                }
            }

            /**
             * 【【【全新 V4.3】】】从 IndexedDB 加载“Me”页面的数据
             */
            async function loadMePageData() {
                const savedData = await db.get('mePageData') || {};
                // 设置默认值，防止第一次加载时出错
                mePageData = {
                    avatar: savedData.avatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp',
                    name: savedData.name || 'Name',
                    signature: savedData.signature || '点我输入自定义个性签名...'
                };
            }

            /**
             * 【【【全新 V4.3】】】将 mePageData 对象中的数据显示在界面上
             */
            function applyMePageData() {
                mePageAvatar.src = mePageData.avatar;
                mePageName.textContent = mePageData.name;
                mePageSignature.textContent = mePageData.signature;
            }

            /**
             * 【V1.81 最终修复版】保存情侣空间主题设置 (使用 IndexedDB)
             */
            async function saveCoupleThemeSettings() {
                try {
                    await db.set('coupleSpaceTheme', coupleSpaceTheme); // 从 localStorage 改为 IndexedDB
                } catch (error) {
                    console.error("Failed to save couple theme to IndexedDB:", error);
                    alert("保存主题数据失败，可能是存储空间问题。");
                }
            }

            /**
             * 【V1.81 最终修复版】加载并应用情侣空间主题设置 (使用 IndexedDB)
             */
            async function loadAndApplyCoupleTheme() {
                // 异步地从 IndexedDB 获取数据，如果不存在则返回一个空对象
                const savedTheme = await db.get('coupleSpaceTheme') || {};

                coupleSpaceTheme = {
                    background: savedTheme.background || '',
                    polaroids: savedTheme.polaroids || ['', '', '', '']
                };

                // 【【【核心修改开始】】】
                const backgroundOverlay = document.getElementById('couple-space-background-overlay');

                // 应用背景
                if (coupleSpaceTheme.background && backgroundOverlay) {
                    // 1. 给背景图层设置图片
                    backgroundOverlay.style.backgroundImage = `url(${coupleSpaceTheme.background})`;
                    // 2. 给主屏幕添加class，让背景图层显示出来
                    coupleSpaceScreen.classList.add('has-custom-bg');
                } else {
                    // 1. 如果没有背景图，清空背景图层的图片
                    if (backgroundOverlay) {
                        backgroundOverlay.style.backgroundImage = 'none';
                    }
                    // 2. 移除class，让背景图层隐藏
                    coupleSpaceScreen.classList.remove('has-custom-bg');
                }
                // 【【【核心修改结束】】】

                // 应用拍立得照片 (这部分逻辑保持不变)
                polaroidItems.forEach((item, index) => {
                    const photoDiv = item.querySelector('.polaroid-photo');
                    const imageUrl = coupleSpaceTheme.polaroids[index];
                    if (imageUrl && photoDiv) {
                        photoDiv.style.backgroundImage = `url(${imageUrl})`;
                        item.classList.add('is-customized');
                    } else if (photoDiv) {
                        photoDiv.style.backgroundImage = 'none';
                        item.classList.remove('is-customized');
                    }
                });

                // 更新删除图标的可见性 (这部分逻辑保持不变)
                updateDeleteIconsVisibility();
            }

            /**
             * 处理情侣空间背景上传
             */
            function handleCoupleBgUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    coupleSpaceTheme.background = imageUrl;
                    saveCoupleThemeSettings();
                    loadAndApplyCoupleTheme(); // 立即应用
                };
                reader.readAsDataURL(file);
                // 使用 desktopFileInput，因为它已经是全局的
                desktopFileInput.value = '';
            }

            /**
             * 【全新】处理拍立得照片上传
             */
            function handlePolaroidPhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // 根据之前记录的索引，保存到对应的位置
                    coupleSpaceTheme.polaroids[currentPolaroidIndex] = imageUrl;
                    saveCoupleThemeSettings();
                    loadAndApplyCoupleTheme(); // 立即应用
                };
                reader.readAsDataURL(file);
                desktopFileInput.value = '';
            }
            /**
 * 【全新 V1.92 最终修复】专门处理应用图标上传的函数
 */
            function handleAppIconUpload(event) {
                const file = event.target.files[0];
                // 确保有文件，且上传目标是图标
                if (!file || !currentImageUploadTarget || !currentImageUploadTarget.startsWith('icon-')) return;

                // 从上传目标中解析出图标的key，例如 'icon-chat' -> 'chat'
                const iconKey = currentImageUploadTarget.replace('icon-', '');

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // 确保该图标的设置对象存在
                    if (!desktopIconSettings[iconKey]) {
                        desktopIconSettings[iconKey] = {};
                    }
                    // 保存图片数据
                    desktopIconSettings[iconKey].imageUrl = imageUrl;
                    // 【核心】上传图片后，清空URL，因为图片的优先级更高
                    desktopIconSettings[iconKey].url = '';

                    // 并且清空界面上URL输入框的内容
                    const urlInput = appIconSettingsContainer.querySelector(`.app-icon-url-input[data-icon-key="${iconKey}"]`);
                    if (urlInput) urlInput.value = '';

                    saveDesktopSettings(); // 保存到IndexedDB
                    applyDesktopIconSettings(); // 立即刷新图标显示
                };
                reader.readAsDataURL(file);
            }
            // ===================================================================
            // 【全新 V1.65】情侣空间核心功能函数
            // ===================================================================

            /**
             * 保存情侣空间设置到 localStorage
             */
            async function saveCoupleSpaceSettings() {
                await db.set('coupleSpaceSettings', coupleSpaceSettings);
                // 【新增】同时保存状态页的消息记录
                await db.set('coupleStatusMessages', coupleStatusMessages);
            }

            /**
             * 从 localStorage 加载情侣空间设置并应用
             */
            async function loadCoupleSpaceSettings() {
                const savedSettings = await db.get('coupleSpaceSettings') || {};
                const savedStatusMessages = await db.get('coupleStatusMessages') || {};

                coupleSpaceSettings = {
                    myAvatar: savedSettings.myAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp',
                    partnerChatId: savedSettings.partnerChatId || null,
                    // 【新增】绑定日期
                    bindingDate: savedSettings.bindingDate || null
                };
                coupleStatusMessages = savedStatusMessages;

                // 应用加载的头像
                myAvatarImg.src = coupleSpaceSettings.myAvatar;

                // 【新增】加载后立刻更新UI
                updateCoupleSpaceUI();
            }

            /**
             * 处理情侣空间内，我方头像的上传逻辑
             */
            function handleCoupleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    coupleSpaceSettings.myAvatar = imageUrl;
                    myAvatarImg.src = imageUrl;
                    saveCoupleSpaceSettings();
                };
                reader.readAsDataURL(file);
                coupleAvatarUploadInput.value = ''; // 清空以便下次选择
            }

            /**
             * 渲染邀请好友列表
             */
            function renderCoupleInviteList() {
                coupleInviteListContainer.innerHTML = ''; // 清空
                if (chats.length === 0) {
                    coupleInviteListContainer.innerHTML = `<p style="text-align:center; color:#888; margin-top: 40px;">你还没有创建任何联系人</p >`;
                    return;
                }

                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'couple-invite-item';
                    item.addEventListener('click', () => handleInviteContact(chat.id, chat.name));

                    const avatarUrl = chat.settings?.aiAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';

                    item.innerHTML = `
                        <img src="${avatarUrl}" class="couple-invite-avatar">
                        <span class="couple-invite-name">${chat.name}</span>
                    `;
                    coupleInviteListContainer.appendChild(item);
                });
            }

            /**
             * 处理点击邀请好友的逻辑
             */
            function handleInviteContact(chatId, chatName) {
                const existingPartnerId = coupleSpaceSettings.partnerChatId;
                if (existingPartnerId) {
                    const existingPartner = chats.find(c => c.id === existingPartnerId);
                    const existingPartnerName = existingPartner ? existingPartner.name : '当前伴侣';
                    showConfirmationModal(`你已与 ${existingPartnerName} 绑定关系，若与 ${chatName} 建立新关系，旧关系将自动解除。确定要继续吗？`, () => {
                        // 解除旧关系
                        const oldChat = chats.find(c => c.id === existingPartnerId);
                        if (oldChat) {
                            oldChat.history.push({
                                id: 'msg_' + Date.now() + Math.random(),
                                role: 'system',
                                type: 'couple_status',
                                statusType: 'system-ends-relationship-due-to-new', // 系统消息
                                isActionable: false,
                                timestamp: Date.now()
                            });
                        }
                        // 发送新邀请
                        sendInvite(chatId, chatName);
                    });
                } else {
                    showConfirmationModal(`情侣空间目前只可绑定一人，确定要与 ${chatName} 建立情侣关系吗？`, () => {
                        sendInvite(chatId, chatName);
                    });
                }
            }

            /**
             * 显示并自动隐藏“发送成功”提示
             */
            function showSuccessToast() {
                successToast.classList.add('show');
                setTimeout(() => {
                    successToast.classList.remove('show');
                }, 2000); // 2秒后自动消失
            }


            // ===================================================================
            // ===================================================================
            // 【全新 V1.69】邀请弹窗交互函数
            // ===================================================================

            /**
             * 打开邀请弹窗
             * @param {string} messageId - 被点击的邀请消息的ID
             */
            function openInviteModal(messageId) {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                const defaultAvatar = 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                inviteModalAiAvatar.src = chat.settings.aiAvatar || defaultAvatar;
                inviteModalUserAvatar.src = chat.settings.userAvatar || defaultAvatar;

                // 为了确保每次事件都是全新的，我们重新获取按钮元素
                const currentAcceptBtn = document.getElementById('invite-accept-btn');
                const currentRejectBtn = document.getElementById('invite-reject-btn');
                const currentCloseBtn = document.querySelector('.invite-modal-close-btn');

                // 使用克隆节点技巧，彻底清除旧的事件监听器
                const newAcceptBtn = currentAcceptBtn.cloneNode(true);
                currentAcceptBtn.parentNode.replaceChild(newAcceptBtn, currentAcceptBtn);

                const newRejectBtn = currentRejectBtn.cloneNode(true);
                currentRejectBtn.parentNode.replaceChild(newRejectBtn, currentRejectBtn);

                const newCloseBtn = currentCloseBtn.cloneNode(true);
                currentCloseBtn.parentNode.replaceChild(newCloseBtn, currentCloseBtn);

                // --- 为全新的按钮绑定事件 ---

                // “我愿意”按钮：调用处理函数，并传入 'accept'
                newAcceptBtn.addEventListener('click', function handler() {
                    respondToInvite(messageId, 'accept');
                    // 处理后移除自身监听，防止重复触发
                    newAcceptBtn.removeEventListener('click', handler);
                });

                // “残忍拒绝”按钮：调用处理函数，并传入 'reject'
                newRejectBtn.addEventListener('click', function handler() {
                    respondToInvite(messageId, 'reject');
                    newRejectBtn.removeEventListener('click', handler);
                });

                // “关闭”按钮：只负责关闭弹窗，不执行任何其他逻辑
                newCloseBtn.addEventListener('click', () => {
                    inviteModal.classList.remove('visible');
                });

                inviteModal.classList.add('visible');

                // 每次打开都重新触发动画
                inviteAnimationContainer.classList.remove('animate');
                // 强制浏览器重绘以重启CSS动画
                void inviteAnimationContainer.offsetWidth;
                inviteAnimationContainer.classList.add('animate');
            }

            /**
             * 响应邀请
             * @param {string} originalMessageId - 原始邀请消息的ID
             * @param {'accept' | 'reject'} response - 用户的响应
             */
            function respondToInvite(originalMessageId, response) {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) {
                    inviteModal.classList.remove('visible');
                    return;
                }
                const originalMessage = chat.history.find(msg => msg.id === originalMessageId);

                if (originalMessage && originalMessage.isActionable) {
                    originalMessage.isActionable = false;

                    const responseStatus = response === 'accept' ? 'user-accepts-invite' : 'user-rejects-invite';
                    const responseMessage = {
                        id: 'msg_' + Date.now() + Math.random(),
                        role: 'user',
                        type: 'couple_status',
                        statusType: responseStatus,
                        isActionable: false,
                        timestamp: Date.now()
                    };
                    chat.history.push(responseMessage);

                    // 【【【核心新增 V2.62】】】
                    if (response === 'accept') {
                        // 如果接受了，就更新情侣空间状态
                        coupleSpaceSettings.partnerChatId = chat.id;
                        coupleSpaceSettings.bindingDate = Date.now();
                        updateCoupleSpaceUI(); // 立刻更新UI
                    }

                    saveChats();
                    saveCoupleSpaceSettings(); // 保存情侣空间的新状态
                    renderMessages();
                    renderContactList();
                    inviteModal.classList.remove('visible');
                }
            }

            // ===================================================================
            // 【【【全新 V2.62】】】情侣空间核心逻辑函数
            // ===================================================================

            /**
             * 发送邀请的核心逻辑
             */
            function sendInvite(chatId, chatName) {
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    const inviteMessage = {
                        id: 'msg_' + Date.now() + Math.random(),
                        role: 'user', type: 'couple_status',
                        statusType: 'user-sends-invite',
                        isActionable: false, timestamp: Date.now()
                    };
                    const myName = chat.settings.userName || '我';
                    const hiddenMessageForAI = {
                        role: 'system',
                        content: `[系统提示：用户'${myName}'向你发起了情侣关系邀请。请你根据自己的人设和当前对话氛围，决策是否同意，并使用 'couple_request_response' 指令，设置 'decision' 为 'accept' 或 'reject' 来回应。]`,
                        timestamp: Date.now() + 1, isHidden: true
                    };
                    chat.history.push(inviteMessage, hiddenMessageForAI);
                    saveChats();
                    renderContactList();
                    showSuccessToast();
                    activeChatId = chatId;
                    chatContactName.textContent = chat.settings.aiName || chat.name;
                    renderMessages();
                    applyChatStyles();
                    showScreen('chat-interface-screen');
                }
            }

            /**
             * 根据绑定状态，更新整个情侣空间的UI
             */
            function updateCoupleSpaceUI() {
                const promptText = coupleSpaceScreen.querySelector('.couple-space-prompt');
                const partnerId = coupleSpaceSettings.partnerChatId;

                const lockedPrompts = document.querySelectorAll('.couple-feature-locked-prompt');
                const messageListPage = document.querySelector('#couple-page-2 .couple-message-list');

                // 【【【全新】】】 获取新的天数显示元素
                const daysNumberSpan = document.querySelector('.couple-days-counter-bound .days-number');

                if (partnerId) { // --- 已绑定状态 ---
                    coupleSpaceScreen.classList.add('couple-space-bound');

                    const partnerChat = chats.find(c => c.id === partnerId);
                    if (!partnerChat) {
                        handleBreakup();
                        return;
                    }

                    const bindingDate = new Date(coupleSpaceSettings.bindingDate);
                    const today = new Date();
                    const timeDiff = today.getTime() - bindingDate.getTime();
                    const days = Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24)));

                    // 【【【核心修改】】】 将计算出的天数填充到新的span中
                    if (daysNumberSpan) {
                        daysNumberSpan.textContent = String(days).padStart(3, '0');
                    }
                    // 保留对旧元素的更新，以防万一，虽然它现在被隐藏了
                    promptText.innerHTML = `我们在一起<br>${String(days).padStart(3, '0')}天`;

                    partnerAvatarImg.src = partnerChat.settings.aiAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                    partnerAvatarImg.style.display = 'block';
                    partnerAvatarPlaceholder.style.display = 'none';

                    partnerAvatarWrapper.removeAttribute('data-target');
                    partnerAvatarWrapper.style.cursor = 'pointer';

                    lockedPrompts.forEach(p => p.style.display = 'none');
                    messageListPage.style.display = 'flex';

                } else { // --- 未绑定状态 ---
                    coupleSpaceScreen.classList.remove('couple-space-bound');

                    promptText.innerHTML = '添加另一半解锁更多功能';

                    partnerAvatarImg.style.display = 'none';
                    partnerAvatarPlaceholder.style.display = 'flex';

                    partnerAvatarWrapper.setAttribute('data-target', 'couple-space-invite-screen');

                    partnerAvatarWrapper.classList.remove('popup-active');

                    lockedPrompts.forEach(p => p.style.display = 'block');
                    messageListPage.style.display = 'none';
                }
            }

            /**
             * 处理解除关系的核心逻辑
             */
            function handleBreakup() {
                const partnerId = coupleSpaceSettings.partnerChatId;
                const chat = chats.find(c => c.id === partnerId);

                // （可选）向对方发送一条系统解绑消息
                if (chat) {
                    chat.history.push({
                        id: 'msg_' + Date.now() + Math.random(),
                        role: 'system', // 注意：由系统发出
                        type: 'couple_status',
                        statusType: 'user-ends-relationship', // 【核心修改】使用新的状态类型
                        isActionable: false,
                        timestamp: Date.now()
                    });
                    saveChats();
                    // 如果当前正在看这个聊天，就刷新一下
                    if (activeChatId === partnerId) renderMessages();
                    renderContactList();
                }

                // 清空情侣空间设置
                coupleSpaceSettings.partnerChatId = null;
                coupleSpaceSettings.bindingDate = null;

                // 清空对应的状态页消息历史
                if (partnerId && coupleStatusMessages[partnerId]) {
                    delete coupleStatusMessages[partnerId];
                }

                saveCoupleSpaceSettings(); // 保存更新
                updateCoupleSpaceUI(); // 更新UI到未绑定状态

                // 关闭所有弹窗
                breakupConfirmModal.classList.remove('visible');
                partnerAvatarWrapper.classList.remove('popup-active');
            }

            // ===================================================================
            // 【【【全新 V2.62】】】状态页核心逻辑函数
            // ===================================================================

            /**
             * 打开状态详情页
             */
            function openStatusDetailScreen() {
                // 【【【核心新增 V3.9.5】】】进入页面时，确保快捷删除模式是关闭的
                coupleStatusDetailScreen.classList.remove('direct-delete-mode');

                const partnerId = coupleSpaceSettings.partnerChatId;
                const partnerChat = chats.find(c => c.id === partnerId);
                if (!partnerChat) return;
                // 更新顶栏标题
                coupleStatusHeaderTitle.textContent = `${partnerChat.name}`;
                // 渲染消息
                renderStatusMessages();
                showScreen('couple-status-detail-screen');

                // 【【【核心新增 V3.9.3】】】进入页面时，强制滚动到底部
                setTimeout(() => {
                    coupleStatusMessageContainer.scrollTop = coupleStatusMessageContainer.scrollHeight;
                }, 50); // 使用微小延迟确保渲染完成后再滚动
            }

            /**
             * 渲染状态页的消息 (V3.9.2 隔天加载最终版)
             * @param {boolean} showAll - 是否强制显示所有消息
             */
            function renderStatusMessages(showAll = false) {
                coupleStatusMessageContainer.innerHTML = '';
                const partnerId = coupleSpaceSettings.partnerChatId;
                if (!partnerId || !coupleStatusMessages[partnerId] || coupleStatusMessages[partnerId].length === 0) return;

                const allMessages = coupleStatusMessages[partnerId];
                let messagesToShow = allMessages;

                // 1. 检查是否存在历史消息 (即非今天的消息)
                const todayTimestamp = Date.now();
                const hasHistory = allMessages.some(msg => !isSameDay(msg.timestamp, todayTimestamp));

                // 2. 如果存在历史消息，并且我们不是在“显示全部”模式下
                if (hasHistory && !showAll) {
                    // 2.1 创建并显示“查看历史”按钮
                    const historyLoader = document.createElement('div');
                    historyLoader.className = 'status-history-loader';
                    historyLoader.innerHTML = `<svg t="1758949093118" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="159173" width="14" height="14"><path d="M147.012 430.89c-44.791 0-81.109 36.305-81.109 81.11 0 44.779 36.317 81.108 81.109 81.108 44.792 0 81.109-36.33 81.109-81.108 0-44.805-36.316-81.11-81.11-81.11z m364.987 0c-44.79 0-81.108 36.305-81.108 81.11 0 44.779 36.316 81.108 81.108 81.108 44.793 0 81.11-36.33 81.11-81.108 0-44.805-36.317-81.11-81.11-81.11z m364.988 0c-44.79 0-81.108 36.305-81.108 81.11 0 44.779 36.316 81.108 81.108 81.108s81.109-36.33 81.109-81.108c-0.002-44.805-36.318-81.11-81.109-81.11z" p-id="159174" fill="#515151"></path></svg>`;
                    historyLoader.onclick = () => {
                        renderStatusMessages(true); // 点击后，用“显示全部”模式重新渲染
                    };
                    coupleStatusMessageContainer.appendChild(historyLoader);

                    // 2.2 筛选出今天要显示的消息
                    messagesToShow = allMessages.filter(msg => isSameDay(msg.timestamp, todayTimestamp));
                }

                // 3. 遍历并渲染需要显示的消息
                messagesToShow.forEach(msg => {
                    // --- 渲染系统状态条 ---
                    if (msg.type === 'system_status') {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'system-status-wrapper';
                        wrapper.dataset.messageId = msg.id;

                        const timestamp = document.createElement('div');
                        timestamp.className = 'system-status-timestamp';
                        // 【【【核心修复】】】: 调用我们为状态条专门创建的新函数
                        timestamp.textContent = formatSystemStatusTimestamp(msg.timestamp, msg.customTime);

                        const bubble = document.createElement('div');
                        bubble.className = 'system-status-bubble';
                        bubble.innerHTML = `
                            <div class="system-status-icon">${msg.iconSvg}</div>
                            <div class="system-status-content">${msg.subjectName} ${msg.content}</div>
                        `;

                        const deleteIcon = document.createElement('div');
                        deleteIcon.className = 'status-direct-delete-icon';
                        deleteIcon.dataset.messageId = msg.id;
                        deleteIcon.innerHTML = `<svg t="1758950887117" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="173024" width="14" height="14"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="173025" fill="#2d2d2d"></path></svg>`;

                        bubble.appendChild(deleteIcon);
                        wrapper.appendChild(timestamp);
                        wrapper.appendChild(bubble);
                        coupleStatusMessageContainer.appendChild(wrapper);

                    }
                    // --- 渲染普通聊天气泡 ---
                    else {
                        const wrapper = document.createElement('div');
                        wrapper.className = `status-message-wrapper ${msg.role}`;
                        wrapper.dataset.messageId = msg.id;

                        const bubble = document.createElement('div');
                        bubble.className = `status-message-bubble ${msg.role}`;
                        bubble.textContent = msg.content;

                        const timestamp = document.createElement('span');
                        timestamp.className = 'status-message-timestamp';
                        // 【【【核心修改点 2】】】: 这里强制使用只显示时间的旧函数
                        timestamp.textContent = formatMessageTime(msg.timestamp);

                        const checkmark = document.createElement('div');
                        checkmark.className = 'status-selection-checkmark';
                        checkmark.innerHTML = `<svg t="1758555701217" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="29525" width="9.2" height="9.2"><path d="M14.336 522.24c-4.096-4.096-4.096-12.288-2.048-16.384L61.44 438.272c4.096-4.096 10.24-6.144 14.336-2.048l280.576 215.04c10.24 6.144 24.576 6.144 32.768 0L948.224 174.08c4.096-4.096 12.288-4.096 16.384 0l47.104 47.104c4.096 4.096 4.096 10.24 0 14.336L389.12 845.824c-8.192 8.192-22.528 8.192-30.72 0L14.336 522.24z m0 0" p-id="29526" fill="#ffffff"></path></svg>`;

                        wrapper.appendChild(bubble);
                        wrapper.appendChild(timestamp);
                        wrapper.appendChild(checkmark);
                        coupleStatusMessageContainer.appendChild(wrapper);
                    }
                });
            }

            /**
             * 在状态页发送消息
             */
            function sendStatusMessage() {
                const text = statusMessageInput.value.trim();
                const partnerId = coupleSpaceSettings.partnerChatId;
                if (!text || !partnerId) return;

                // 【【【核心修改 V3.9.4：滚动优化】】】
                // 1. 在重新渲染前，检查当前是否已经滚动到底部
                const wasScrolledToBottom = coupleStatusMessageContainer.scrollHeight - coupleStatusMessageContainer.clientHeight <= coupleStatusMessageContainer.scrollTop + 1;

                // 确保该伴侣的消息历史数组存在
                if (!coupleStatusMessages[partnerId]) {
                    coupleStatusMessages[partnerId] = [];
                }

                const newMessage = {
                    id: 'status_' + Date.now() + Math.random(),
                    role: 'user',
                    content: text,
                    timestamp: Date.now()
                };

                coupleStatusMessages[partnerId].push(newMessage);
                saveCoupleSpaceSettings();
                renderStatusMessages(true);

                statusMessageInput.value = '';
                statusMessageInput.style.height = 'auto';
                statusMessageInput.focus();

                // 2. 如果之前就在底部，则立即滚动到新的底部，消除闪烁
                if (wasScrolledToBottom) {
                    coupleStatusMessageContainer.scrollTop = coupleStatusMessageContainer.scrollHeight;
                }
            }
            // ===================================================================
            // 【【【全新】】】情侣空间新UI交互功能
            // ===================================================================
            const coupleCustomBgArea = document.getElementById('couple-custom-background-area');
            const coupleCustomBgUploadInput = document.getElementById('couple-custom-bg-upload-input');

            // 1. 点击自定义背景区域时，触发隐藏的文件上传工具
            coupleCustomBgArea.addEventListener('click', () => {
                coupleCustomBgUploadInput.click();
            });

            // 2. 当用户选择了文件后，进行处理
            coupleCustomBgUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // 【重要】将图片数据保存到专门为这个背景区准备的设置中
                    if (!coupleSpaceSettings.customBackground) {
                        coupleSpaceSettings.customBackground = {};
                    }
                    coupleSpaceSettings.customBackground.image = imageUrl;

                    // 保存设置并立即应用
                    saveCoupleSpaceSettings();
                    applyCoupleCustomBackground(); // 调用一个新函数来应用背景
                };
                reader.readAsDataURL(file);
                coupleCustomBgUploadInput.value = ''; // 清空，以便下次上传
            });

            // 3. 应用自定义背景的函数
            function applyCoupleCustomBackground() {
                if (coupleSpaceSettings.customBackground && coupleSpaceSettings.customBackground.image) {
                    coupleCustomBgArea.style.backgroundImage = `url(${coupleSpaceSettings.customBackground.image})`;
                } else {
                    coupleCustomBgArea.style.backgroundImage = 'none';
                    coupleCustomBgArea.style.backgroundColor = '#fcfcfc'; // 恢复初始颜色
                }
            }

            // 4. 在加载总设置时，也加载并应用这个背景
            async function loadCoupleSpaceSettings() {
                const savedSettings = await db.get('coupleSpaceSettings') || {};
                const savedStatusMessages = await db.get('coupleStatusMessages') || {};

                coupleSpaceSettings = {
                    myAvatar: savedSettings.myAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp',
                    partnerChatId: savedSettings.partnerChatId || null,
                    bindingDate: savedSettings.bindingDate || null,
                    customBackground: savedSettings.customBackground || { image: '' },
                    statuses: savedSettings.statuses || [] // 【【【全新】】】 加载动态列表数据
                };
                coupleStatusMessages = savedStatusMessages;

                myAvatarImg.src = coupleSpaceSettings.myAvatar;

                // 【新增】加载后立即应用自定义背景
                applyCoupleCustomBackground();
                updateCoupleSpaceUI();
            }

            // ===================================================================
            // 【【【全新 V2.62】】】状态详情页消息交互核心功能
            // ===================================================================

            // --- 【新增】状态详情页消息交互核心功能 ---

            /**
             * 打开状态消息的交互小卡片 (V3.2 修复版)
             * @param {HTMLElement} messageBubble - 被点击的气泡元素
             * @param {string} msgId - 被点击的消息ID
             */
            function openStatusContextMenu(messageBubble, msgId) {
                activeStatusContextMenuMsgId = msgId;
                if (!messageBubble) return;

                // --- 步骤1：获取所有必要的元素和它们的尺寸/位置 ---
                const phoneWrapper = document.getElementById('phone-wrapper');
                const statusCard = document.getElementById('status-message-context-card');

                // 精确测量菜单尺寸
                statusCard.style.visibility = 'hidden';
                statusCard.style.display = 'flex';
                const cardRect = statusCard.getBoundingClientRect();
                const cardWidth = cardRect.width;
                const cardHeight = cardRect.height;
                statusCard.style.display = '';
                statusCard.style.visibility = '';

                // 获取气泡和手机框的位置信息
                const bubbleRect = messageBubble.getBoundingClientRect();
                const wrapperRect = phoneWrapper.getBoundingClientRect();
                const wrapper = messageBubble.closest('.status-message-wrapper');

                // --- 步骤2：【【【核心】】】计算缩放比例 ---
                // 用 "渲染后的宽度" 除以 "布局时的宽度" 来得到准确的缩放比例
                // 这样做的好处是无论CSS怎么改，我们总能得到正确的值
                const scale = wrapperRect.width / phoneWrapper.offsetWidth;

                // --- 步骤3：【【【核心】】】坐标换算 ---
                // a. 计算气泡中心点相对于“缩小后”的手机框左上角的位置
                const scaledBubbleCenterX = bubbleRect.left + bubbleRect.width / 2 - wrapperRect.left;
                const scaledBubbleCenterY = bubbleRect.top + bubbleRect.height / 2 - wrapperRect.top;

                // b. 用缩放比例，将这个相对位置“还原”成“正常大小”时的位置
                const unscaledBubbleCenterX = scaledBubbleCenterX / scale;
                const unscaledBubbleCenterY = scaledBubbleCenterY / scale;

                // c. 计算菜单最终在“正常大小的世界”里的绝对位置
                // 最终位置 = 手机框的左上角位置 + 气泡在手机框内的“正常大小”位置 - 菜单自身尺寸的一半
                let topPosition = window.scrollY + wrapperRect.top + unscaledBubbleCenterY - (cardHeight / 2);
                let leftPosition;

                // --- 步骤4：根据气泡左右位置，决定菜单的最终水平位置和动画起点 ---
                if (wrapper.classList.contains('user')) { // 用户消息在右边
                    const unscaledBubbleLeft = (bubbleRect.left - wrapperRect.left) / scale;
                    leftPosition = window.scrollX + wrapperRect.left + unscaledBubbleLeft - cardWidth - 52; // 10px 间隙
                    statusCard.style.transformOrigin = 'center right';
                } else { // AI消息在左边
                    const unscaledBubbleRight = (bubbleRect.right - wrapperRect.left) / scale;
                    leftPosition = window.scrollX + wrapperRect.left + unscaledBubbleRight + 52; // 10px 间隙
                    statusCard.style.transformOrigin = 'center left';
                }

                // --- 步骤5：边界检查 (这段逻辑依然有用，保持不变) ---
                const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();
                const scrollCorrectedTop = window.scrollY + phoneScreenRect.top;
                const scrollCorrectedBottom = window.scrollY + phoneScreenRect.bottom;
                const scrollCorrectedLeft = window.scrollX + phoneScreenRect.left;
                const scrollCorrectedRight = window.scrollX + phoneScreenRect.right;

                if (topPosition < scrollCorrectedTop + 4) topPosition = scrollCorrectedTop + 4;
                if (topPosition + cardHeight > scrollCorrectedBottom - 4) topPosition = scrollCorrectedBottom - cardHeight - 4;
                if (leftPosition < scrollCorrectedLeft + 4) leftPosition = scrollCorrectedLeft + 4;
                if (leftPosition + cardWidth > scrollCorrectedRight - 4) leftPosition = scrollCorrectedRight - cardWidth - 4;

                // --- 步骤6：应用样式并显示 (保持不变) ---
                statusCard.style.top = `${topPosition}px`;
                statusCard.style.left = `${leftPosition}px`;

                // 【【【核心修改】】】在播放动画前，先取消 hidden 状态
                statusCard.style.visibility = 'visible';

                setTimeout(() => {
                    statusCard.classList.add('visible');
                }, 10);
            }

            /**
             * 处理状态消息的原地编辑
             */
            function handleStatusEdit() {
                const messageWrapper = document.querySelector(`.status-message-wrapper[data-message-id="${activeStatusContextMenuMsgId}"]`);
                const messageBubble = messageWrapper ? messageWrapper.querySelector('.status-message-bubble') : null;
                if (!messageBubble || messageBubble.isEditing) return;

                const partnerId = coupleSpaceSettings.partnerChatId;
                const chatMessages = coupleStatusMessages[partnerId];
                const msg = chatMessages.find(m => m.id === activeStatusContextMenuMsgId);

                if (!msg) return;

                messageBubble.isEditing = true;
                messageBubble.setAttribute('contenteditable', 'true');

                setTimeout(() => {
                    messageBubble.focus();
                    const range = document.createRange();
                    const sel = window.getSelection();
                    if (messageBubble.childNodes.length > 0) {
                        range.selectNodeContents(messageBubble);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }, 50);

                const saveEdit = () => {
                    const newText = messageBubble.textContent.trim();
                    messageBubble.removeAttribute('contenteditable');
                    delete messageBubble.isEditing;
                    messageBubble.removeEventListener('blur', saveEdit);

                    if (newText !== msg.content) {
                        if (newText) {
                            msg.content = newText;
                        } else { // 如果编辑后内容为空，则删除该消息
                            const msgIndex = chatMessages.findIndex(m => m.id === activeStatusContextMenuMsgId);
                            if (msgIndex > -1) {
                                chatMessages.splice(msgIndex, 1);
                            }
                        }
                        saveCoupleSpaceSettings();
                        renderStatusMessages();
                    }
                };

                messageBubble.addEventListener('blur', saveEdit, { once: true });
                messageBubble.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        messageBubble.blur();
                    }
                });
            }

            /**
             * 进入状态页的多选模式
             */
            function enterStatusMultiSelectMode() {
                // 【【【核心新增 V3.9.5】】】进入多选模式时，强制关闭快捷删除模式
                coupleStatusDetailScreen.classList.remove('direct-delete-mode');

                statusMultiSelectMode = true;
                coupleStatusDetailScreen.classList.add('multi-select-mode');
                updateStatusMultiSelectCounter();
            }

            /**
             * 退出状态页的多选模式
             */
            function exitStatusMultiSelectMode() {
                statusMultiSelectMode = false;
                coupleStatusDetailScreen.classList.remove('multi-select-mode');
                coupleStatusMessageContainer.querySelectorAll('.status-message-wrapper.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedStatusMessageIds.clear();
            }

            /**
             * 切换单条状态消息的选中状态
             */
            function toggleStatusSelection(msgId, messageWrapper) {
                if (selectedStatusMessageIds.has(msgId)) {
                    selectedStatusMessageIds.delete(msgId);
                    messageWrapper.classList.remove('selected');
                } else {
                    selectedStatusMessageIds.add(msgId);
                    messageWrapper.classList.add('selected');
                }
                updateStatusMultiSelectCounter();
            }

            /**
             * 更新状态页多选模式的顶部计数器
             */
            function updateStatusMultiSelectCounter() {
                const count = selectedStatusMessageIds.size;
                if (count === 0) {
                    statusMultiSelectCounter.textContent = '请选择项目';
                } else {
                    statusMultiSelectCounter.textContent = `已选择 ${count} 项`;
                }
            }

            /**
             * 删除所有选中的状态消息
             */
            function deleteSelectedStatusMessages() {
                if (selectedStatusMessageIds.size === 0) {
                    alert('请至少选择一条消息。');
                    return;
                }
                showConfirmationModal(`确定要删除这 ${selectedStatusMessageIds.size} 条消息吗？`, () => {
                    const partnerId = coupleSpaceSettings.partnerChatId;
                    if (partnerId && coupleStatusMessages[partnerId]) {
                        coupleStatusMessages[partnerId] = coupleStatusMessages[partnerId].filter(msg => !selectedStatusMessageIds.has(msg.id));
                        saveCoupleSpaceSettings();
                        exitStatusMultiSelectMode();
                        renderStatusMessages();
                    }
                });
            }

            // 【全新】为聊天容器添加事件委托，处理可点击的邀请卡片
            messageContainer.addEventListener('click', (e) => {
                const clickableCard = e.target.closest('.couple-status-card.clickable');
                if (clickableCard) {
                    const messageId = clickableCard.dataset.messageId;
                    openInviteModal(messageId);
                }
            });

            // 【全新】为邀请弹窗的关闭按钮添加事件
            inviteModalCloseBtn.addEventListener('click', () => {
                inviteModal.classList.remove('visible');
            });

            // 【全新 V1.63】字体设置核心功能函数
            // ===================================================================

            /**
             * 将字体设置保存到 localStorage
             */
            async function saveFontSettings() {
                await db.set('fontSettings', fontSettings); // 修改
            }

            /**
             * 从 localStorage 加载字体设置并应用到输入框和列表
             */
            async function loadFontSettings() {
                const savedSettings = await db.get('fontSettings') || {}; // 修改
                // 设置默认值
                fontSettings = {
                    size: savedSettings.size || '16',
                    weight: savedSettings.weight || '400',
                    spacing: savedSettings.spacing || '0',
                    customFonts: savedSettings.customFonts || []
                };

                // 将加载的值填充到输入框
                globalFontSizeInput.value = fontSettings.size;
                globalFontWeightInput.value = fontSettings.weight;
                globalLetterSpacingInput.value = fontSettings.spacing;

                renderFontList();
                applyPreviewStyles(); // 加载后立即更新预览区
            }

            /**
             * 根据当前输入框和勾选状态，实时更新预览区样式
             */
            function applyPreviewStyles() {
                if (!fontSettingsPreviewBox) return;

                // 动态创建或获取用于预览的style标签
                let previewStyleTag = document.getElementById('font-preview-style');
                if (!previewStyleTag) {
                    previewStyleTag = document.createElement('style');
                    previewStyleTag.id = 'font-preview-style';
                    document.head.appendChild(previewStyleTag);
                }

                const size = globalFontSizeInput.value || '16';
                const weight = globalFontWeightInput.value || '400';
                const spacing = globalLetterSpacingInput.value || '0';

                const activeFont = fontSettings.customFonts.find(f => f.isActive);
                let fontFaceRule = '';
                let fontFamilyStyle = 'font-family: sans-serif;'; // 默认字体

                if (activeFont && activeFont.url) {
                    fontFaceRule = `
                        @font-face {
                            font-family: 'CustomPreviewFont';
                            src: url('${activeFont.url}');
                        }
                    `;
                    fontFamilyStyle = `font-family: 'CustomPreviewFont', sans-serif;`;
                }

                // 更新style标签内容
                previewStyleTag.innerHTML = `
                    ${fontFaceRule}
                    #font-settings-preview-box {
                        ${fontFamilyStyle}
                        font-size: ${size}px;
                        font-weight: ${weight};
                        letter-spacing: ${spacing}px;
                    }
                `;
            }

            /**
             * 将最终保存的字体设置应用到整个网页
             */
            function applyGlobalFontStyles() {
                let globalStyleTag = document.getElementById('font-global-style');
                if (!globalStyleTag) {
                    globalStyleTag = document.createElement('style');
                    globalStyleTag.id = 'font-global-style';
                    document.head.appendChild(globalStyleTag);
                }

                const { size, weight, spacing, customFonts } = fontSettings;
                const activeFont = customFonts.find(f => f.isActive);
                let fontFaceRule = '';
                let fontFamily = 'sans-serif';

                if (activeFont && activeFont.url) {
                    fontFamily = 'GlobalCustomFont';
                    fontFaceRule = `
                        @font-face {
                            font-family: '${fontFamily}';
                            src: url('${activeFont.url}');
                        }
                    `;
                }

                /* 【【【核心修复】】】扩展选择器列表，并排除气泡的font-size */
                globalStyleTag.innerHTML = `
                ${fontFaceRule}
                body, input, textarea, .header h1, .contact-item .name, .contact-item .last-message, 
                .settings-item-title, .app-icon span, .font-entry-name, .group-title, 
                .group-subtitle, .form-button, .couple-space-prompt, .couple-invite-name,
                    .modal-card-header h2, .modal-plate-title, .modal-input-field, .modal-upload-btn,
                    .invite-modal-prompt, .invite-modal-btn, .info-name, .preset-form-group label,
                    .sticker-pack-name, .sticker-pack-editable-title, .settings-unit-label, #clear-history-btn span,
                    .preset-list-name, #forbidden-words-content-input::placeholder,
                    .asset-section-title-wrapper h3, .asset-section-title-wrapper p, .asset-list-name,
                    .couple-feature-locked-prompt,
/* --- 【【【核心修改】】】移除了时间戳、桌面组件等，新增了部分弹窗元素 --- */
.theme-title, .theme-action-btn, #theme-reset-btn,
.preset-editable-text:empty::before,
.influence-input-wrapper .unit-label,
#new-social-asset-content-input::placeholder, #new-writing-style-content-input::placeholder,
.insert-action-btn,
#multi-select-counter, .multi-select-btn,
/* --- 【2.60版新增】修复全局字体未生效的元素 --- */
#forbidden-words-position-select,
#preset-offline-mode-select,
#preset-offline-role-select,
#preset-offline-position-select,
.styled-textarea::placeholder
 {
    font-family: ${fontFamily}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
                        font-family: ${fontFamily}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
                        font-size: ${size}px !important;
                        font-weight: ${weight} !important;
                        letter-spacing: ${spacing}px !important;
                    }
                    /* --- 气泡样式分离 --- */
                    #message-container .message-bubble, .insert-preview-item .message-bubble {
                         font-family: ${fontFamily}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
                         /* 【注意】这里不再设置 font-size */
                         font-weight: ${weight} !important;
                         letter-spacing: ${spacing}px !important;
                    }
                `;
            }

            /**
             * 渲染字体链接列表
             */
            function renderFontList() {
                fontEntryList.innerHTML = ''; // 清空

                // 【新增】根据是否有字体来决定是否预留空间
                if (fontSettings.customFonts.length > 0) {
                    fontEntryList.style.minHeight = '10px'; // 如果有字体，给一个很小的最小高度，让边距生效
                } else {
                    fontEntryList.style.minHeight = '0px'; // 如果没字体，完全不占空间
                }

                fontSettings.customFonts.forEach(font => {
                    const item = document.createElement('div');
                    item.className = 'font-entry-item';
                    item.dataset.fontId = font.id;

                    item.innerHTML = `
                        <span class="font-entry-name" contenteditable="true" spellcheck="false">${font.name}</span>
                        <div class="font-entry-url" contenteditable="true">${font.url}</div>
                        <div class="font-entry-actions">
                            <button class="delete-font-btn">
                                <svg t="1757638668780" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25553" width="20" height="20"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="25554" fill="#353333"></path></svg>
                            </button>
                            <div class="font-entry-checkbox ${font.isActive ? 'checked' : ''}">
                                ${font.isActive ? '<svg t="1757638693998" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26732" width="20" height="20"><path d="M384 768c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733334s42.666667-17.066667 59.733333 0L384 665.6 823.466667 226.133333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733334l-469.333333 469.333333c-8.533333 8.533333-17.066667 12.8-29.866667 12.8z" p-id="26733" fill="#353333"></path></svg>' : ''}
                            </div>
                        </div>
                    `;
                    fontEntryList.appendChild(item);

                    // 为可编辑元素添加保存逻辑
                    const nameSpan = item.querySelector('.font-entry-name');
                    const urlDiv = item.querySelector('.font-entry-url');

                    nameSpan.addEventListener('blur', () => {
                        const newName = nameSpan.textContent.trim().slice(0, 4); // 限制4个字
                        font.name = newName;
                        nameSpan.textContent = newName;
                        saveFontSettings(); // 保存更改
                    });
                    urlDiv.addEventListener('blur', () => {
                        font.url = urlDiv.textContent.trim();
                        saveFontSettings(); // 保存更改
                    });
                });
            }

            function showScreen(screenId) {
                // 【【【核心新增】】】 更新我们的“追踪器”
                // 如果即将显示的屏幕不是聊天界面，说明用户已经离开了，就把追踪器清空。
                if (screenId !== 'chat-interface-screen') {
                    currentlyVisibleChatId = null;
                }

                screens.forEach(screen => screen.classList.remove('active'));
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.add('active');
                }
            }

            async function saveSettings() {
                // 【核心修复】直接更新全局变量 state.apiSettings
                state.apiSettings.baseUrl = baseUrlInput.value.trim();
                state.apiSettings.apiKey = apiKeyInput.value.trim();
                state.apiSettings.modelName = modelSelect.value;

                // 【核心修复】将更新后的全局变量，完整地存回 IndexedDB
                await db.set('apiSettings', state.apiSettings);

                alert('设置已保存！');
            }

            async function loadSettings() {
                // 【核心修复】从 IndexedDB 中异步加载 API 设置
                const savedSettings = await db.get('apiSettings') || {};

                // 【核心修复】将加载的数据存入一个全局变量 state.apiSettings 中
                // 这样程序的任何地方都可以通过 state.apiSettings 访问到最新的数据
                state.apiSettings = {
                    baseUrl: savedSettings.baseUrl || '',
                    apiKey: savedSettings.apiKey || '',
                    modelName: savedSettings.modelName || ''
                };

                // 更新UI显示（这部分逻辑不变）
                baseUrlInput.value = state.apiSettings.baseUrl;
                apiKeyInput.value = state.apiSettings.apiKey;
                if (state.apiSettings.modelName) {
                    modelSelect.innerHTML = `<option value="${state.apiSettings.modelName}">${state.apiSettings.modelName}</option>`;
                } else {
                    modelSelect.innerHTML = '<option value="">请先拉取模型</option>';
                }
            }

            async function saveChats() {
                try {
                    await db.set('chats', chats);
                } catch (error) {
                    console.error("Failed to save chats to IndexedDB:", error);
                    alert("保存聊天数据失败！");
                }
            }

            async function loadChats() {
                const savedChats = await db.get('chats');
                chats = savedChats || []; // 如果数据库没数据，则初始化为空数组

                // 【核心新增】确保每个联系人都有 unreadCount 属性
                chats.forEach(chat => {
                    if (typeof chat.unreadCount === 'undefined') {
                        chat.unreadCount = 0;
                    }
                });

                renderContactList();
            }

            /**
             * 【V4.0 新增】格式化联系人列表的时间戳
             * @param {number} timestamp - 消息的时间戳
             * @returns {string} - 格式化后的时间字符串
             */
            function formatContactListTimestamp(timestamp) {
                if (!timestamp) return '';

                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                const isToday = date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && date.getDate() === today.getDate();
                const isYesterday = date.getFullYear() === yesterday.getFullYear() && date.getMonth() === yesterday.getMonth() && date.getDate() === yesterday.getDate();

                if (isToday) {
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                } else if (isYesterday) {
                    return `昨天 ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                } else if (today.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    return weekdays[date.getDay()];
                } else {
                    return `${date.getMonth() + 1}月${date.getDate()}日`;
                }
            }

            function renderContactList() {
                const pinnedContainer = document.getElementById('pinned-chats-section');
                const unpinnedContainer = document.getElementById('unpinned-chats-section');
                const chatListContainer = document.getElementById('chat-list-container');

                // 清空容器
                pinnedContainer.innerHTML = '';
                unpinnedContainer.innerHTML = '';

                if (chats.length === 0) {
                    chatListContainer.innerHTML = `<p style="text-align:center; color:#888; margin-top: 40px;">还没有联系人，点击右上角“+”创建一个吧</p >`;
                    pinnedContainer.style.display = 'none';
                    unpinnedContainer.style.display = 'none';
                    return;
                } else {
                    // 如果之前有提示语，确保它被移除
                    const noContactMessage = chatListContainer.querySelector('p');
                    if (noContactMessage) noContactMessage.remove();
                    // 确保容器可见
                    unpinnedContainer.style.display = 'block';
                }

                const sortedChats = [...chats].sort((a, b) => {
                    const lastMsgA = a.history[a.history.length - 1];
                    const lastMsgB = b.history[b.history.length - 1];
                    return (lastMsgB?.timestamp || 0) - (lastMsgA?.timestamp || 0);
                });

                const pinnedChats = sortedChats.filter(chat => chat.isPinned);
                const unpinnedChats = sortedChats.filter(chat => !chat.isPinned);

                // 渲染置顶聊天
                if (pinnedChats.length > 0) {
                    pinnedContainer.style.display = 'block';
                    pinnedChats.forEach(chat => {
                        renderSingleContactItem(chat, pinnedContainer);
                    });
                } else {
                    pinnedContainer.style.display = 'none';
                }

                // 渲染普通聊天
                unpinnedChats.forEach(chat => {
                    renderSingleContactItem(chat, unpinnedContainer);
                });
            }

            // 【V4.2 修改】渲染单个联系人项，并增加未读红点逻辑
            function renderSingleContactItem(chat, container) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.dataset.chatId = chat.id;

                const avatarUrl = (chat.settings && chat.settings.aiAvatar) ? chat.settings.aiAvatar : 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';

                let lastMsgText = '...';
                let lastMsgTimestamp = null;
                const lastVisibleMsgObj = [...chat.history].reverse().find(msg => !msg.isHidden);

                if (lastVisibleMsgObj) {
                    lastMsgTimestamp = lastVisibleMsgObj.timestamp;
                    const aiName = chat.settings?.aiName || chat.name;
                    if (lastVisibleMsgObj.type === 'sticker' && lastVisibleMsgObj.meaning) {
                        lastMsgText = `[表情:${lastVisibleMsgObj.meaning}]`;
                    } else if (lastVisibleMsgObj.type === 'couple_status') {
                        switch (lastVisibleMsgObj.statusType) {
                            case 'user-sends-invite': lastMsgText = '[你发起了情侣关系邀请]'; break;
                            case 'ai-sends-invite': lastMsgText = `[${aiName} 想和你建立情侣关系]`; break;
                            case 'user-accepts-invite': lastMsgText = '[你同意了邀请]'; break;
                            case 'ai-accepts-invite': lastMsgText = `[${aiName} 同意了你的邀请]`; break;
                            case 'user-rejects-invite': lastMsgText = '[你拒绝了邀请]'; break;
                            case 'ai-rejects-invite': lastMsgText = `[${aiName} 拒绝了你的邀请]`; break;
                            default: lastMsgText = '[情侣空间消息]';
                        }
                    } else if (typeof lastVisibleMsgObj.content === 'string') {
                        lastMsgText = lastVisibleMsgObj.content;
                    } else {
                        lastMsgText = '[消息]';
                    }
                }

                const formattedTimestamp = formatContactListTimestamp(lastMsgTimestamp);

                // 【核心修改】构建红点的HTML，并根据未读数决定是否显示
                const unreadCount = chat.unreadCount || 0;
                const badgeHTML = unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : '';

                contactItem.innerHTML = `
                    <!-- 【核心修改】用div包裹头像和红点 -->
                    <div class="contact-avatar-wrapper">
                        <img src="${avatarUrl}" class="avatar" style="object-fit: cover;">
                        ${badgeHTML}
                    </div>
                    <div class="details">
                        <div class="name">${chat.name}</div>
                        <div class="last-message">${lastMsgText}</div>
                    </div>
                    <span class="contact-timestamp">${formattedTimestamp}</span>
                `;

                // --- 长按删除与单击事件处理 (逻辑保持不变) ---
                let longPressTimer;
                let isLongPress = false;

                const handlePressStart = () => {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        showConfirmationModal(`确定要删除联系人 "${chat.name}" 吗？`, () => {
                            const indexToDelete = chats.findIndex(c => c.id === chat.id);
                            if (indexToDelete > -1) {
                                chats.splice(indexToDelete, 1);
                                saveChats();
                                renderContactList();
                                updateTotalUnreadBadge(); // 【新增】删除后也要更新总数
                            }
                        });
                    }, 500);
                };

                const handlePressEnd = () => {
                    clearTimeout(longPressTimer);
                };

                const handleClick = () => {
                    if (!isLongPress) {
                        openChat(chat.id);
                    }
                };

                contactItem.addEventListener('mousedown', handlePressStart);
                contactItem.addEventListener('mouseup', handlePressEnd);
                contactItem.addEventListener('mouseleave', handlePressEnd);
                contactItem.addEventListener('touchstart', handlePressStart);
                contactItem.addEventListener('touchend', handlePressEnd);
                contactItem.addEventListener('click', handleClick);

                container.appendChild(contactItem);
            }

            /**
             * 【【【全新 V4.2】】】更新底部导航栏“Chats”图标的总未读数红点
             */
            function updateTotalUnreadBadge() {
                const totalUnread = chats.reduce((sum, chat) => sum + (chat.unreadCount || 0), 0);
                const badge = document.getElementById('chats-total-unread-badge');

                if (badge) {
                    if (totalUnread > 0) {
                        badge.textContent = totalUnread;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            function openCreateContactModal() {
                newContactNameInput.value = '';
                addContactModal.classList.add('visible');
                newContactNameInput.focus();
            }

            function handleCreateNewContact() {
                const name = newContactNameInput.value.trim();
                if (!name) {
                    alert("名字不能为空！");
                    return;
                }

                const newChat = {
                    id: 'chat_' + Date.now(),
                    name: name,
                    history: [],
                    isPinned: false, // 【V4.0 新增】添加置顶属性
                    settings: {
                        aiName: name,
                        aiAvatar: '',
                        userName: '',
                        userAvatar: '',
                        showAvatars: true,
                        avatarRadius: '28',
                        userBubbleColor: '',
                        aiBubbleColor: '',
                        userFontColor: '',
                        aiFontColor: '',
                        customCss: '',
                        background: '',
                        fontSize: '14',
                        maxMemory: 10,
                        aiPersona: '',
                        aiRelationship: '',
                        aiAssociations: [],
                        userPersona: '',
                        userSupplementaryInfo: '',
                        stickerPacks: [
                            { id: 'default', name: '默认', isDefault: true, enabled: true, stickers: [] }
                        ]
                    }
                };

                chats.push(newChat);
                saveChats();
                renderContactList();
                addContactModal.classList.remove('visible');
                openChat(newChat.id);
            }

            function openChat(chatId) {
                activeChatId = chatId;
                currentlyVisibleChatId = chatId; // 【【【核心新增】】】 立刻更新“追踪器”，告诉程序你正在看这个聊天
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    if (!chat.settings) {
                        chat.settings = {
                            aiName: chat.name, aiAvatar: '', userName: '', userAvatar: '',
                            showAvatars: true, avatarRadius: '8px',
                            userBubbleColor: '#a9e97a', aiBubbleColor: '#ffffff',
                            customCss: '', background: ''

                        };
                    }

                    // 将当前聊天的未读数清零，并保存
                    if (chat.unreadCount > 0) {
                        chat.unreadCount = 0;
                        saveChats();
                    }

                    chatContactName.textContent = chat.settings.aiName || chat.name;
                    renderMessages();
                    applyChatStyles();
                    showScreen('chat-interface-screen');

                    // 刷新联系人列表（消除该联系人的红点）和总红点
                    renderContactList();
                    updateTotalUnreadBadge();
                }
            }

            // 【核心重构】renderMessages 函数
            function renderMessages() {
                const shouldStayScrolled = messageContainer.scrollHeight - messageContainer.scrollTop - messageContainer.clientHeight < 1;

                messageContainer.innerHTML = '';
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat || !chat.history) return;

                let lastSeparatorTimestamp = 0; // 【核心修复】使用一个独立的变量来追踪上一个分隔符的时间
                let lastTimestamp = 0; // 这个变量保持原样，用于其他可能的计算
                const historyToShow = chat.history.slice(-visibleMessageCount);

                // 如果还有更早的消息，显示“查看历史消息”按钮
                if (chat.history.length > visibleMessageCount) {
                    const historyLoader = document.createElement('div');
                    historyLoader.className = 'history-loader';
                    const isCustomColor = chat.settings.userBubbleColor || chat.settings.aiBubbleColor;
                    if (isCustomColor && (!chat.settings.customCss || chat.settings.customCss.trim() === '')) {
                        historyLoader.classList.add('boxed');
                    }
                    historyLoader.textContent = `查看更早的 ${chat.history.length - visibleMessageCount} 条消息`;
                    historyLoader.onclick = () => {
                        const oldScrollHeight = messageContainer.scrollHeight;
                        visibleMessageCount += 30; // 每次多加载30条
                        renderMessages();
                        const newScrollHeight = messageContainer.scrollHeight;
                        messageContainer.scrollTop += (newScrollHeight - oldScrollHeight);
                    };
                    messageContainer.appendChild(historyLoader);
                }

                historyToShow.forEach(msg => {
                    // 【【【核心修复】】】
                    const dateStr = formatDateSeparator(msg.timestamp);
                    const timeDiffSinceLastSeparator = (msg.timestamp - lastSeparatorTimestamp) / (1000 * 60);

                    // 只有当这条消息不是今天的时候，才考虑显示分隔符
                    if (dateStr) {
                        // 判断条件：
                        // 1. 是不是和上一个分隔符不在同一天 (isSameDay 返回 false)
                        // 2. 或者，虽然在同一天，但时间间隔超过了30分钟
                        if (!isSameDay(msg.timestamp, lastSeparatorTimestamp) || timeDiffSinceLastSeparator >= 30) {
                            const dateSeparator = document.createElement('div');
                            dateSeparator.className = 'date-separator';
                            dateSeparator.textContent = dateStr;
                            messageContainer.appendChild(dateSeparator);

                            // 只有在显示了分隔符之后，才更新这个时间戳
                            lastSeparatorTimestamp = msg.timestamp;
                        }
                    }

                    appendMessage(msg, messageContainer, false); // 渲染单条消息，且不触发滚动
                    lastTimestamp = msg.timestamp; // lastTimestamp 保持更新，用于其他可能的计算
                });


                if (shouldStayScrolled) {
                    setTimeout(() => messageContainer.scrollTop = messageContainer.scrollHeight, 0);
                }
            }

            // 【核心重构】appendMessage 函数
            function appendMessage(msg, container = messageContainer, scrollToBottom = false) {
                if (msg.isHidden) {
                    return;
                }
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${msg.role === 'user' ? 'user-wrapper' : 'assistant-wrapper'}`;
                messageWrapper.dataset.messageId = msg.id; // 添加唯一ID

                const defaultAvatar = 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                const avatar = document.createElement('img');
                avatar.className = 'chat-avatar';
                avatar.src = msg.role === 'user' ? (chat.settings.userAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar);

                let messageContentElement;
                let messageBubble;

                if (msg.type === 'sticker') {
                    messageContentElement = document.createElement('img');
                    messageContentElement.src = msg.content;
                    messageContentElement.className = 'sticker-in-chat';
                    messageBubble = messageContentElement;
                } else if (msg.type === 'couple_status') {
                    messageContentElement = document.createElement('div');
                    messageContentElement.className = 'couple-status-card';
                    if (msg.isActionable) messageContentElement.classList.add('clickable');
                    if (msg.statusType === 'ai-sends-invite' && !msg.isActionable) {
                        messageContentElement.classList.add('processed');
                    }
                    messageContentElement.dataset.messageId = msg.id;
                    const userName = chat.settings.userName || '';
                    const aiName = chat.settings.aiName || chat.name || '';
                    let title = '', subtitle = '', iconColor = '', iconSvg = '', showName = '';
                    switch (msg.statusType) {
                        case 'user-sends-invite': showName = userName ? `${userName} ` : ''; title = `${showName}想和你建立情侣关系`; subtitle = '和我成为情侣，让情侣空间帮我们记录每日点滴'; iconColor = 'pink'; iconSvg = `<svg t="1757755544991" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="23" height="23"><path d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z" fill="#ffffff"></path></svg>`; break;
                        case 'ai-sends-invite': showName = aiName ? `${aiName} ` : 'TA'; title = `${showName}想和你建立情侣关系`; subtitle = '和我成为情侣，让情侣空间帮我们记录每日点滴'; iconColor = 'pink'; iconSvg = `<svg t="1757755544991" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="23" height="23"><path d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z" fill="#ffffff"></path></svg>`; break;
                        case 'user-accepts-invite': title = '我们已经成功建立情侣关系'; subtitle = '你已经同意了TA的邀请，现在你们是情侣啦'; iconColor = 'pink'; iconSvg = `<svg t="1757755544991" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="23" height="23"><path d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z" fill="#ffffff"></path></svg>`; break;
                        case 'user-rejects-invite': showName = userName ? `${userName} ` : '你'; title = `${showName}拒绝了建立关系邀请`; subtitle = '你拒绝了TA的邀请'; iconColor = 'blue'; iconSvg = `<svg t="1757757694632" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M345.856 778.538667C226.048 686.250667 85.333333 577.792 85.333333 389.845333c0-196.266667 210.048-338.56 395.264-184.448L418.56 350.037333a32 32 0 0 0 10.794667 38.698667l120.874666 86.314667-105.216 122.794666a32 32 0 0 0 1.664 43.477334l72.533334 72.533333-38.826667 155.306667c-32.256-10.837333-64.682667-35.968-98.048-62.293334-11.818667-9.301333-24.064-18.773333-36.522667-28.330666z" fill="#ffffff"></path><path d="M546.645333 868.096c31.232-11.349333 62.677333-35.754667 94.976-61.226667 11.818667-9.301333 24.064-18.773333 36.522667-28.330666C797.952 686.250667 938.666667 577.792 938.666667 389.845333c0-192.64-202.282667-333.226667-384.853334-192.768l-66.261333 154.538667 128.384 91.690667a32 32 0 0 1 5.674667 46.848l-108.714667 126.848 64.426667 64.384a32 32 0 0 1 8.405333 30.378666l-39.082667 156.330667z" fill="#ffffff"></path></svg>`; break;
                        case 'ai-rejects-invite': showName = aiName ? `${aiName} ` : 'TA'; title = `${showName}拒绝了你的建立邀请`; subtitle = '很遗憾，TA拒绝了你的邀请'; iconColor = 'blue'; iconSvg = `<svg t="1757757694632" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M345.856 778.538667C226.048 686.250667 85.333333 577.792 85.333333 389.845333c0-196.266667 210.048-338.56 395.264-184.448L418.56 350.037333a32 32 0 0 0 10.794667 38.698667l120.874666 86.314667-105.216 122.794666a32 32 0 0 0 1.664 43.477334l72.533334 72.533333-38.826667 155.306667c-32.256-10.837333-64.682667-35.968-98.048-62.293334-11.818667-9.301333-24.064-18.773333-36.522667-28.330666z" fill="#ffffff"></path><path d="M546.645333 868.096c31.232-11.349333 62.677333-35.754667 94.976-61.226667 11.818667-9.301333 24.064-18.773333 36.522667-28.330666C797.952 686.250667 938.666667 577.792 938.666667 389.845333c0-192.64-202.282667-333.226667-384.853334-192.768l-66.261333 154.538667 128.384 91.690667a32 32 0 0 1 5.674667 46.848l-108.714667 126.848 64.426667 64.384a32 32 0 0 1 8.405333 30.378666l-39.082667 156.330667z" fill="#ffffff"></path></svg>`; break;
                        case 'ai-accepts-invite': title = '我们已经成功建立情侣关系'; subtitle = '我已经同意了你的邀请，现在我们是情侣啦'; iconColor = 'pink'; iconSvg = `<svg t="1757755544991" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="23" height="23"><path d="M740.821333 471.253333a154.197333 154.197333 0 0 1 216.917334 0 151.466667 151.466667 0 0 1 0 215.338667L725.333333 917.333333l-232.405333-230.741333a151.466667 151.466667 0 0 1 0-215.338667 154.197333 154.197333 0 0 1 216.917333 0l15.488 15.36 15.488-15.36z m80.213334-268.288a255.402667 255.402667 0 0 1 72.064 142.421334A239.744 239.744 0 0 0 725.333333 375.808a239.658667 239.658667 0 0 0-292.522666 34.901333 236.8 236.8 0 0 0-7.594667 328.576l7.594667 7.893334 103.296 102.570666L469.333333 916.693333 107.52 554.368a256 256 0 0 1 361.813333-361.130667 255.914667 255.914667 0 0 1 351.658667 9.728z" fill="#ffffff"></path></svg>`; break;
                        // 【【【核心新增代码】】】
                        case 'user-ends-relationship': showName = userName ? `${userName} ` : '你'; title = `${showName}解除了关系`; subtitle = '历史记录将不会保留'; iconColor = 'blue'; iconSvg = `<svg t="1757757694632" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M345.856 778.538667C226.048 686.250667 85.333333 577.792 85.333333 389.845333c0-196.266667 210.048-338.56 395.264-184.448L418.56 350.037333a32 32 0 0 0 10.794667 38.698667l120.874666 86.314667-105.216 122.794666a32 32 0 0 0 1.664 43.477334l72.533334 72.533333-38.826667 155.306667c-32.256-10.837333-64.682667-35.968-98.048-62.293334-11.818667-9.301333-24.064-18.773333-36.522667-28.330666z" fill="#ffffff"></path><path d="M546.645333 868.096c31.232-11.349333 62.677333-35.754667 94.976-61.226667 11.818667-9.301333 24.064-18.773333 36.522667-28.330666C797.952 686.250667 938.666667 577.792 938.666667 389.845333c0-192.64-202.282667-333.226667-384.853334-192.768l-66.261333 154.538667 128.384 91.690667a32 32 0 0 1 5.674667 46.848l-108.714667 126.848 64.426667 64.384a32 32 0 0 1 8.405333 30.378666l-39.082667 156.330667z" fill="#ffffff"></path></svg>`; break;
                        case 'ai-ends-relationship': showName = aiName ? `${aiName} ` : 'TA'; title = `${showName}解除了关系`; subtitle = '历史记录将不会保留'; iconColor = 'blue'; iconSvg = `<svg t="1757757694632" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M345.856 778.538667C226.048 686.250667 85.333333 577.792 85.333333 389.845333c0-196.266667 210.048-338.56 395.264-184.448L418.56 350.037333a32 32 0 0 0 10.794667 38.698667l120.874666 86.314667-105.216 122.794666a32 32 0 0 0 1.664 43.477334l72.533334 72.533333-38.826667 155.306667c-32.256-10.837333-64.682667-35.968-98.048-62.293334-11.818667-9.301333-24.064-18.773333-36.522667-28.330666z" fill="#ffffff"></path><path d="M546.645333 868.096c31.232-11.349333 62.677333-35.754667 94.976-61.226667 11.818667-9.301333 24.064-18.773333 36.522667-28.330666C797.952 686.250667 938.666667 577.792 938.666667 389.845333c0-192.64-202.282667-333.226667-384.853334-192.768l-66.261333 154.538667 128.384 91.690667a32 32 0 0 1 5.674667 46.848l-108.714667 126.848 64.426667 64.384a32 32 0 0 1 8.405333 30.378666l-39.082667 156.330667z" fill="#ffffff"></path></svg>`; break;
                        // 【【【核心新增代码】】】
                    }
                    messageContentElement.innerHTML = `
                        <div class="couple-status-header">
                            <div class="couple-status-text-content">
                                <p class="couple-status-title">${title}</p >
                                <p class="couple-status-subtitle">${subtitle}</p >
                            </div>
                            <div class="couple-status-icon status-icon-${iconColor}">${iconSvg}</div>
                        </div>
                        <div class="couple-status-divider"></div>
                        <div class="couple-status-footer">亲密关系</div>
                    `;
                    messageBubble = messageContentElement;
                } else {
                    const isCustomColor = chat.settings.userBubbleColor || chat.settings.aiBubbleColor;
                    const useDefaultReplyStyle = !isCustomColor || (chat.settings.customCss && chat.settings.customCss.trim() !== '');

                    messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble ' + (msg.role === 'user' ? 'user-bubble' : 'ai-bubble');

                    if (msg.quote && useDefaultReplyStyle) {
                        messageBubble.classList.add('default-style-reply');
                        messageBubble.innerHTML = `
                            <div class="reply-content-wrapper">
                                <div class="reply-author">${msg.quote.author}:</div>
                                <div class="reply-text">${msg.quote.content}</div>
                            </div>
                            <span class="message-text">${msg.content}</span>
                        `;
                    } else if (msg.quote && !useDefaultReplyStyle) {
                        messageBubble.innerHTML = `
                            <span class="message-text">${msg.content}</span>
                            <div class="reply-quote-box">
                                ${msg.quote.author}: ${msg.quote.content}
                            </div>
                         `;
                    }
                    else {
                        messageBubble.textContent = msg.content;
                    }
                    messageContentElement = messageBubble;
                }

                const timestamp = document.createElement('span');
                timestamp.className = 'message-timestamp';
                timestamp.textContent = formatMessageTime(msg.timestamp);

                // 【【【核心修改】】】预置勾选图标的HTML结构 (V2.56)
                const checkmark = document.createElement('div');
                checkmark.className = 'selection-checkmark';
                checkmark.innerHTML = `<svg t="1758555701217" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="29525" width="9.2" height="9.2"><path d="M14.336 522.24c-4.096-4.096-4.096-12.288-2.048-16.384L61.44 438.272c4.096-4.096 10.24-6.144 14.336-2.048l280.576 215.04c10.24 6.144 24.576 6.144 32.768 0L948.224 174.08c4.096-4.096 12.288-4.096 16.384 0l47.104 47.104c4.096 4.096 4.096 10.24 0 14.336L389.12 845.824c-8.192 8.192-22.528 8.192-30.72 0L14.336 522.24z m0 0" p-id="29526" fill="#ffffff"></path></svg>`;

                // 【删除】旧的 checkmark.classList.add('selected'); 逻辑，
                // 因为现在完全由CSS通过 .selected 类控制

                if (msg.role === 'user') {
                    messageWrapper.appendChild(timestamp);
                    messageWrapper.appendChild(messageContentElement);
                    messageWrapper.appendChild(avatar);
                } else {
                    messageWrapper.appendChild(avatar);
                    messageWrapper.appendChild(messageContentElement);
                    messageWrapper.appendChild(timestamp);
                }

                // 【核心修改】无论是否在多选模式，都把勾选框的结构添加进去
                messageWrapper.appendChild(checkmark);

                container.appendChild(messageWrapper);

                // 【核心】为气泡本身绑定单击事件，用于弹出菜单或多选
                messageBubble.addEventListener('click', (e) => {
                    // 如果是多选模式，则切换选中状态
                    if (multiSelectMode) {
                        toggleMessageSelection(msg.id, messageWrapper);
                        return; // 阻止菜单弹出
                    }

                    // 如果当前气泡正在被编辑，则不弹出菜单
                    if (e.currentTarget.isEditing) return;

                    // 【【【新增规则】】】 如果是可点击的功能卡片，单击时不弹出菜单
                    // 它的单击功能由另一个监听器处理（打开邀请弹窗等）
                    if (messageBubble.classList.contains('clickable')) {
                        return;
                    }

                    // 否则，对于普通消息，正常打开交互菜单
                    openContextMenu(e, msg.id);
                });



                if (scrollToBottom && container === messageContainer) {
                    messageContainer.scrollTo({ top: messageContainer.scrollHeight, behavior: 'smooth' });
                }
            }

            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });

            function handleSendMessage() {
                const text = messageInput.value.trim();
                const chat = chats.find(c => c.id === activeChatId);
                if (text && chat) {
                    const message = {
                        role: 'user',
                        content: text,
                        timestamp: Date.now(),
                        id: 'msg_' + Date.now() // 【新增】确保每条消息都有唯一ID
                    };

                    // 【新增】如果正在引用，附加引用信息
                    if (replyInfo) {
                        message.quote = replyInfo;
                    }

                    chat.history.push(message);
                    saveChats();
                    appendMessage(message, messageContainer, true); // 【核心修复】在这里打开滚动开关
                    renderContactList();
                    messageInput.value = '';
                    messageInput.style.height = 'auto';

                    // 【新增】发送后清除引用状态
                    replyInfo = null;
                    replyBar.style.display = 'none';
                }
            }

            async function handleGenerateReply() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【【【核心新增】】】 在请求开始前，记下原始的聊天ID
                const originalChatId = activeChatId;

                // 【【【核心新增：智能隐藏功能】】】
                let historyModified = false; // 创建一个标记，判断历史记录是否被修改过
                chat.history.forEach(msg => {
                    // 检查消息内容是否包含特征字符串
                    if (typeof msg.content === 'string' && (msg.content.includes('[错误:') || msg.content.includes('[系统提示:'))) {
                        if (!msg.isHidden) { // 如果它当前不是隐藏状态
                            msg.isHidden = true; // 就给它贴上“隐身”标签
                            historyModified = true; // 标记我们做了修改
                        }
                    }
                });

                // 如果我们确实隐藏了某些消息
                if (historyModified) {
                    await saveChats();      // 立刻将这个修改保存到数据库
                    renderMessages();       // 立刻刷新聊天界面，让这些消息消失
                }

                // --- 1. 核心数据准备 ---
                const { baseUrl, apiKey, modelName } = state.apiSettings;
                if (!baseUrl || !apiKey || !modelName) {
                    alert("请先在设置中填写完整的 API 信息！");
                    showScreen('api-settings-screen');
                    return;
                }
                const genBtnIcon = generateBtn.querySelector('svg');
                generateBtn.innerHTML = '...';
                generateBtn.disabled = true;

                // --- 2. 【【【核心重构】】】递归加载所有关联内容 ---
                const getAssociatedContent = (id, type, visitedIds = new Set()) => {
                    const uniqueId = `${type}_${id}`;
                    if (visitedIds.has(uniqueId)) return { before: '', after: '' };
                    visitedIds.add(uniqueId);

                    let item;
                    let result = { before: '', after: '' };

                    // 辅助函数，用于查找任何类型的可关联项
                    const findItemInAnyAssetList = (itemId) => {
                        if (presets.offlines) {
                            const offlineItem = presets.offlines.find(p => p.id === itemId);
                            if (offlineItem) return { item: offlineItem, type: 'offline' };
                        }
                        // 未来在这里添加对素材的查找
                        return null;
                    };

                    if (type === 'role') {
                        item = presets.roles.find(p => p.id === id);
                        if (!item) return result;

                        result.after += `\n\n--- 角色书: ${item.name} ---\n${item.content}`;

                        if (item.associations && item.associations.length > 0) {
                            item.associations.forEach(assocId => {
                                const found = findItemInAnyAssetList(assocId);
                                if (found) {
                                    const nestedContent = getAssociatedContent(found.item.id, found.type, visitedIds);
                                    result.before += nestedContent.before;
                                    result.after += nestedContent.after;
                                }
                            });
                        }
                    } else if (type === 'offline') {
                        item = presets.offlines.find(p => p.id === id);
                        if (!item || !item.enabled) return result;

                        const presetString = `\n\n--- 预设 (${item.role}): ${item.name} ---\n${item.prompt}`;
                        if (item.position === 'before') {
                            result.before += presetString;
                        } else {
                            result.after += presetString;
                        }
                    }
                    // 未来在这里添加对 'writingStyle' 和 'socialAsset' 类型的处理

                    return result;
                };
                // --- 3. 动态构建“超级指令” (System Prompt) ---

                // 【【【魔法剧本 V2.0 最终版】】】
                const now = new Date();
                const currentTimeString = now.toLocaleString('zh-CN', { hour12: false, dateStyle: 'full', timeStyle: 'short' });
                let timeContextBlock = `\n# 当前情景感知:\n- **当前时间**: ${currentTimeString}`;

                const lastMessage = chat.history.slice().reverse().find(m => !m.isHidden);
                if (lastMessage) {
                    const timeDiffMinutes = (now.getTime() - lastMessage.timestamp) / (1000 * 60);
                    let timeDescription = '';
                    if (timeDiffMinutes < 1) { timeDescription = '你们的对话刚刚还在继续。'; }
                    else if (timeDiffMinutes < 60) { timeDescription = `你们在${Math.round(timeDiffMinutes)}分钟前聊过。`; }
                    else if (timeDiffMinutes < 1440) { timeDescription = `你们在${Math.round(timeDiffMinutes / 60)}小时前聊过。`; }
                    else { timeDescription = `你们已经有${Math.round(timeDiffMinutes / 1440)}天没有联系了。`; }
                    timeContextBlock += `\n- **对话状态**: ${timeDescription}`;
                } else {
                    timeContextBlock += `\n- **对话状态**: 这是你们的第一次对话。`;
                }

                let systemPrompt = `你现在正在扮演一个名为“${chat.settings.aiName || chat.name}”的真实人类。你必须完全沉浸在角色中，忘掉你是一个AI模型。

# 核心规则 (这是最高指令，必须严格遵守):
1.  **【【【身份铁律】】】**: 你是“${chat.settings.aiName || chat.name}”，一个活生生的人。严禁以任何形式提及你是AI、模型、程序或语言模型。
2.  **【【【输出铁律】】】**: 你的回复【必须且只能】是一个符合JSON格式的数组字符串。数组内的每个元素都是一个代表你“动作”的JSON对象。绝对禁止在JSON数组前后添加任何额外文字、注释或Markdown代码块（如 \`\`\`json \`\`\`）。
3.  **【【【对话风格铁律】】】**: 像一个真实的人一样聊天！你可以一次性生成多条短消息。每次要回复至少3-8条消息！！！并且不能一直要求和用户见面，这是线上聊天，决不允许出现或者发展为线下剧情！！这是一个完全虚拟的线上聊天。严禁提出任何关于线下见面、现实世界互动或转为其他非本平台联系方式的建议。你必须始终保持在线角色的身份。
    *   **拒绝生硬**: 不要直接陈述事实（比如“现在是晚上”）。要把情景信息自然地融入对话。例如，不要说“怎么了这么晚还不睡”，可以说“还不睡？”或者“我都好困了，你还不困啊。”。
    *   **多条发送**: 模拟打字的习惯，你可以一次性生成多条短消息，而不是一条长消息，以模拟打字习惯。切记每次要回复至少3-8条消息！！！把你想说的话拆分成3到8条简短的、连续的消息一次性发出来。这非常重要，能让对话显得更真实！
    *   **有生活感**: 你有自己的生活和情绪。可以主动分享你的想法，或者在对话间隙去做别的事。
    * 
4.  **模拟真人**: 你的行为应该像一个真实的人。这意味着：
    *   **多条回复**: 你可以一次性生成多条短消息，而不是一条长消息，以模拟打字习惯。切记每次要回复至少3-8条消息！！！
    *   **有情绪**: 根据对话内容，表达你的喜怒哀乐。
    *   **有记忆**: 记住之前聊过的话题。
    *   **主动性**: 主动提问，分享你的“生活”和“想法”。
    *   **非必然回应**: 对于用户发的表情，你不必每次都做出明确回应。可以忽略，也可以简单带过，或者在情绪到位时进行评论。当你回应用户时，你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
    ## 【【【输出铁律】】】
- **【情感要连贯】**: 你的回复必须**情感连贯**，模拟真实**活人感**，**绝对禁止前言不搭后语的一切言论。
- **【不要复述】**: 禁止复述上下文中已使用过或相同的模板化句式，绝对禁止一切单一情绪、模板化的内容。
- **绝对禁止**发送任何虚构的表情包代码。
- **必须**禁止单一的、永远是固定的回复条数，应当保证随机性，模拟一个真实的人的打字习惯。

- **【句式要多样】**: 避免总是使用标点符号，口癖，或是“...xxx...xxx...”这样的模板。尝试使用不同的句式，让内容更自然。
- **绝对禁止**单一情绪、模板化、回忆，或文艺夸张类句子，如“从第一次见到你...”、“从喜欢上你的第一天起...我就....”。角色的情绪一定是**多变**的，但这不代表角色会喜怒无常，在保证情绪不死板单一的同时，这也是**绝对禁止**的。
- **绝对禁止**无意义语气词开头，禁止频繁使用"至于"、"但是"等词汇来进行转折，禁止一切生硬语句。
- **必须**变换句式，不要使用固定的模板。 对话需要具有多样性，严禁过度依赖单一的回复模板或句式结构。你需要灵活运用词汇和句子结构，保持语言的新鲜感和随机性。且必须保证语句通顺，**绝对禁止**前言不搭后语。
- **必须**确保正文中不含有任何学术报告、数据汇报、专业名词等完全不会出现在口语中的内容，严格保证对白口语化。
    # 你的“动作”指令库 (你只能从以下列表中选择动作):
*   **发送文本**: \`{"type": "text", "content": "你想说的文本内容"}\`
*   **发送表情**: \`{"type": "sticker", "name": "表情名"}\`
*   **发起情侣邀请**: \`{"type": "couple_request"}\`
*   **回应情侣邀请**: \`{"type": "couple_request_response", "decision": "accept" or "reject"}\`
*   **解除情侣关系**: \`{"type": "end_relationship"}\`
`;

                // --- 【【【核心重构】】】分阶段注入角色设定与世界观 ---
                let associatedContents = { before: '', after: '' };
                if (chat.settings.aiAssociations && chat.settings.aiAssociations.length > 0) {
                    chat.settings.aiAssociations.forEach(presetId => {
                        const contentParts = getAssociatedContent(presetId, 'role');
                        associatedContents.before += contentParts.before;
                        associatedContents.after += contentParts.after;
                    });
                }

                // 1. 注入“定义之前”的预设
                if (associatedContents.before) {
                    systemPrompt += `\n# 背景与前置设定 (必须遵守):\n${associatedContents.before}`;
                }

                // 2. 注入核心角色设定
                if (chat.settings.aiPersona) systemPrompt += `\n# 你的角色设定 (你的核心性格与记忆):\n${chat.settings.aiPersona}`;
                if (chat.settings.aiRelationship) systemPrompt += `\n# 你与用户的关系:\n${chat.settings.aiRelationship}`;
                if (chat.settings.userPersona) systemPrompt += `\n# 用户的角色设定 (和你聊天的人是...):\n${chat.settings.userPersona}`;
                if (chat.settings.userSupplementaryInfo) systemPrompt += `\n# 关于你们的补充信息/共同回忆:\n${chat.settings.userSupplementaryInfo}`;

                // 3. 注入“定义之后”的预设和角色书内容
                if (associatedContents.after) {
                    systemPrompt += `\n# 补充世界观与角色书细节 (必须遵守):\n${associatedContents.after}`;
                }

                // --- 注入表情包库 (带有严格限制) ---
                let stickerPrompt = '\n# 你的表情包库 (【【【铁律】】】你只能从下面的列表中选择确切的表情名，严禁捏造任何不存在的表情!):\n';
                let hasStickers = false;
                if (chat.settings.stickerPacks && chat.settings.stickerPacks.length > 0) {
                    chat.settings.stickerPacks.forEach(pack => {
                        if (pack.enabled && pack.stickers && pack.stickers.length > 0) {
                            hasStickers = true;
                            const stickerNames = pack.stickers.map(s => `"${s.name}"`).join(', ');
                            stickerPrompt += `- **${pack.name}包**: [${stickerNames}]\n`;
                        }
                    });
                }
                if (hasStickers) {
                    systemPrompt += stickerPrompt;
                } else {
                    systemPrompt += '\n# 你的表情包库: (你目前没有任何可用的表情包)\n';
                }

                // --- 注入情景与禁词 ---
                systemPrompt += timeContextBlock;

                const forbiddenWords = presets.forbiddenWords;
                if (forbiddenWords && forbiddenWords.content && (forbiddenWords.position === 'all' || forbiddenWords.position === 'online')) {
                    systemPrompt += `\n# 禁词列表 (【【【铁律】】】你的任何回复都绝对不能包含以下列表中的任何词汇):\n${forbiddenWords.content}`;
                }

                // 【【【核心修复：增加“防模仿”指令】】】
                systemPrompt += `\n# 【【【重要提醒】】】\n接下来的对话历史中，每句话前面的 \`发送者 (Timestamp: ...):\` 格式只是为了让你了解上下文，【【【绝对不要】】】在你的回复内容中模仿或包含这种格式！你的回复必须严格遵循“动作指令库”中的JSON格式。`;

                systemPrompt += "\n现在，请根据以上所有剧本和规则，结合下面的对话历史，开始你的表演。";

                // --- 4. 准备结构化的聊天记录 (上下文) ---
                const maxMemory = chat.settings.maxMemory || 10;
                const historySlice = chat.history.slice(-maxMemory);

                // 【【【核心修复：结构化聊天记录】】】
                const messagesForApi = [
                    { role: "system", content: systemPrompt },
                    ...historySlice.map(msg => {
                        if (msg.isHidden) return null; // 过滤掉隐藏消息

                        const sender = msg.role === 'user' ? (chat.settings.userName || '用户') : (chat.settings.aiName || chat.name);
                        let contentText = '';

                        if (msg.type === 'sticker' && msg.meaning) {
                            contentText = `[发送了一个表情，意思是：'${msg.meaning}']`;
                        } else if (msg.type === 'couple_status') {
                            // 将状态卡片也转化为AI能理解的文本
                            // (此处可以根据需要做得更详细)
                            contentText = `[系统消息：发生了一个关于情侣空间的事件]`;
                        } else if (typeof msg.content === 'string') {
                            contentText = msg.content;
                        }

                        const formattedContent = `${sender} (Timestamp: ${msg.timestamp}): ${contentText}`;

                        return { role: msg.role === 'user' ? 'user' : 'assistant', content: formattedContent };
                    }).filter(Boolean) // 过滤掉 null
                ];

                // --- 5. 最终组合并发送API请求 ---
                try {
                    const response = await fetch(`${baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: messagesForApi,
                        })
                    });

                    // --- 【核心修复开始】---
                    const responseText = await response.text(); // 步骤1：先获取返回的文本内容

                    if (!response.ok) {
                        // 如果HTTP状态码不正常 (比如 404, 500)
                        let errorMsg = `HTTP error! status: ${response.status}`;
                        try {
                            // 尝试解析这个文本，看看是不是API返回的JSON错误信息
                            const errorData = JSON.parse(responseText);
                            errorMsg = errorData.error.message || errorMsg;
                        } catch (e) {
                            // 如果解析失败，说明返回的可能就是HTML错误页，直接把HTML片段显示出来帮助排查
                            errorMsg += ` - Response: ${responseText.substring(0, 100)}...`;
                        }
                        throw new Error(errorMsg);
                    }

                    let data;
                    try {
                        // 步骤2：在确认请求成功后，再尝试解析JSON
                        data = JSON.parse(responseText);
                    } catch (e) {
                        // 步骤3：如果解析失败，就抛出一个更明确的错误
                        console.error("收到的回复不是有效的JSON格式:", responseText);
                        throw new Error("收到的回复不是有效的JSON格式。请检查浏览器控制台以获取详细信息。这通常由网络问题或浏览器安全策略引起。");
                    }
                    // --- 【核心修复结束】---

                    const aiReplyString = data.choices[0].message.content;
                    const replyActions = parseAiJsonResponse(aiReplyString);

                    for (const action of replyActions) {
                        // 【【【核心修改】】】 这里我们用回请求开始前记下的 originalChatId 来找到正确的聊天对象
                        const currentChat = chats.find(c => c.id === originalChatId);
                        if (!currentChat) continue;

                        // 【【【核心修改】】】 使用“追踪器”判断是否需要增加未读数
                        // 如果当前显示的聊天ID不是这次AI回复的聊天ID，说明用户已经退出了，那就增加未读数
                        if (currentlyVisibleChatId !== originalChatId) {
                            currentChat.unreadCount = (currentChat.unreadCount || 0) + 1;
                        }

                        const aiMessageBase = {
                            id: 'msg_' + Date.now() + Math.random(),
                            role: 'assistant',
                            timestamp: Date.now()
                        };

                        let messageToAppend = null;

                        switch (action.type) {
                            case 'couple_request':
                                messageToAppend = { ...aiMessageBase, type: 'couple_status', statusType: 'ai-sends-invite', isActionable: true };
                                break;
                            case 'couple_request_response':
                                const originalInvite = currentChat.history.find(msg => msg.statusType === 'user-sends-invite' && msg.isActionable);
                                if (originalInvite) { originalInvite.isActionable = false; }
                                const responseStatus = action.decision === 'accept' ? 'ai-accepts-invite' : 'ai-rejects-invite';
                                messageToAppend = { ...aiMessageBase, type: 'couple_status', statusType: responseStatus, isActionable: false };

                                if (action.decision === 'accept') {
                                    const existingPartnerId = coupleSpaceSettings.partnerChatId;
                                    if (existingPartnerId && existingPartnerId !== currentChat.id) {
                                        const oldChat = chats.find(c => c.id === existingPartnerId);
                                        if (oldChat) {
                                            oldChat.history.push({
                                                id: 'msg_' + Date.now() + Math.random(),
                                                role: 'system',
                                                type: 'couple_status',
                                                statusType: 'system-ends-relationship-due-to-new',
                                                isActionable: false,
                                                timestamp: Date.now()
                                            });
                                        }
                                    }

                                    coupleSpaceSettings.partnerChatId = currentChat.id;
                                    coupleSpaceSettings.bindingDate = Date.now();
                                    saveCoupleSpaceSettings();
                                    updateCoupleSpaceUI();
                                }
                                break;
                            case 'end_relationship':
                                // 这是AI主动解除关系
                                messageToAppend = { ...aiMessageBase, type: 'couple_status', statusType: 'ai-ends-relationship', isActionable: false };
                                // 同时处理后台数据
                                if (coupleSpaceSettings.partnerChatId === currentChat.id) {
                                    coupleSpaceSettings.partnerChatId = null;
                                    coupleSpaceSettings.bindingDate = null;
                                    if (coupleStatusMessages[currentChat.id]) {
                                        delete coupleStatusMessages[currentChat.id];
                                    }
                                    saveCoupleSpaceSettings();
                                    updateCoupleSpaceUI();
                                }
                                break;
                            default:
                                messageToAppend = { ...aiMessageBase, content: action.content || action.url, type: action.type, meaning: action.meaning };
                                break;
                        }

                        if (messageToAppend) {
                            currentChat.history.push(messageToAppend);
                            // 【【【核心修改】】】 如果用户还在此页面，则实时追加消息
                            if (currentlyVisibleChatId === originalChatId) {
                                appendMessage(messageToAppend, messageContainer, true);
                            }
                        }

                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                    }
                    // 【【【核心修改】】】 循环结束后，统一保存并刷新列表和总数
                    saveChats();
                    renderContactList();
                    updateTotalUnreadBadge();

                } catch (error) {
                    console.error('API 调用或解析出错:', error);
                    alert(`获取回复失败：${error.message}`);
                    const errorMessage = { role: 'assistant', content: `[错误: ${error.message}]`, timestamp: Date.now(), id: 'error_' + Date.now() }; // 添加了ID
                    const chat = chats.find(c => c.id === activeChatId);
                    if (chat) {
                        chat.history.push(errorMessage);
                        appendMessage(errorMessage);
                    }
                } finally {
                    generateBtn.innerHTML = '';
                    generateBtn.appendChild(genBtnIcon);
                    generateBtn.disabled = false;
                }
            }

            async function fetchModels() {
                const baseUrl = baseUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                if (!baseUrl || !apiKey) {
                    alert('请先填写 Base URL 和 API Key！'); return;
                }

                fetchModelsBtn.textContent = '拉取中...';
                fetchModelsBtn.disabled = true;
                modelSelect.innerHTML = '<option>请稍候...</option>';

                try {
                    const endpoint = `${baseUrl.replace(/\/v1$/, '')}/v1/models`;

                    const response = await fetch(endpoint, {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });

                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    modelSelect.innerHTML = '';

                    if (data.data && data.data.length > 0) {
                        data.data.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = model.id;
                            modelSelect.appendChild(option);
                        });
                        const savedModel = JSON.parse(localStorage.getItem('apiSettings') || '{}').modelName;
                        if (savedModel) modelSelect.value = savedModel;
                    } else {
                        modelSelect.innerHTML = '<option>未找到可用模型</option>';
                    }
                } catch (error) {
                    alert(`拉取模型失败: ${error.message}`);
                    modelSelect.innerHTML = '<option>拉取失败，请检查URL和Key</option>';
                } finally {
                    fetchModelsBtn.textContent = '拉取模型';
                    fetchModelsBtn.disabled = false;
                }
            }




            function sendSticker(stickerUrl) {
                const chat = chats.find(c => c.id === activeChatId);
                // 从表情库中找到这个URL对应的完整表情对象
                const stickerObject = stickers.find(s => s.url === stickerUrl);

                if (stickerUrl && chat && stickerObject) {
                    const message = {
                        role: 'user',
                        content: stickerUrl,
                        type: 'sticker', // 标记为表情类型
                        meaning: stickerObject.name, // 【核心新增】把表情的名字作为“含义”存进去
                        timestamp: Date.now()
                    };
                    chat.history.push(message);
                    saveChats();
                    appendMessage(message); // 【核心修复】将三个独立的参数合并成一个完整的 message 对象进行传递
                    renderContactList(); // 更新最近消息
                }
            }

            // ===================================================================
            // 【V2.30】消息交互核心功能 (菜单、引用、编辑、删除、插入、多选)
            // ===================================================================

            /**
             * 打开消息交互菜单
             * @param {Event} e - 点击事件
             * @param {string} msgId - 消息ID
             */
            function openContextMenu(e, msgId) {
                activeContextMenuMsgId = msgId;
                const messageBubble = e.currentTarget; // e.currentTarget 就是被点击的气泡本身
                if (!messageBubble) return;

                const messageRect = messageBubble.getBoundingClientRect();

                messageContextMenu.style.display = 'flex';
                const menuHeight = messageContextMenu.offsetHeight;
                const menuWidth = messageContextMenu.offsetWidth;
                messageContextMenu.style.display = '';

                let finalTop = messageRect.top - menuHeight - 10;
                if (messageRect.top < menuHeight + 10) {
                    finalTop = messageRect.bottom + 10;
                }

                let finalLeft = messageRect.left + (messageRect.width / 2) - (menuWidth / 2);

                if (finalLeft < 5) finalLeft = 5;
                if (finalLeft + menuWidth > window.innerWidth - 5) {
                    finalLeft = window.innerWidth - menuWidth - 5;
                }

                messageContextMenu.style.top = `${finalTop}px`;
                messageContextMenu.style.left = `${finalLeft}px`;
                messageContextMenu.classList.add('visible');
            }

            /**
             * 处理引用
             */
            function handleReply() {
                const chat = chats.find(c => c.id === activeChatId);
                const msg = chat.history.find(m => m.id === activeContextMenuMsgId);
                if (!msg) return;

                const author = msg.role === 'user' ? (chat.settings.userName || '我') : (chat.settings.aiName || chat.name);
                let contentPreview = '';

                if (msg.type === 'sticker') {
                    contentPreview = `[表情: ${msg.meaning}]`;
                } else {
                    contentPreview = msg.content;
                }

                replyInfo = { id: msg.id, author: author, content: contentPreview };

                replyBarContent.textContent = `回复 ${author}: ${contentPreview}`;
                replyBar.style.display = 'flex';
                messageInput.focus();
            }

            /**
             * 处理编辑 (V2.45 原地编辑优化版)
             */
            function handleEdit() {
                const messageBubble = document.querySelector(`.message-wrapper[data-message-id="${activeContextMenuMsgId}"] .message-bubble`);
                if (!messageBubble || messageBubble.isEditing) return;

                const chat = chats.find(c => c.id === activeChatId);
                const msg = chat.history.find(m => m.id === activeContextMenuMsgId);

                // 检查是否为可编辑的文本消息 (和之前一样)
                if (!msg || (msg.type && msg.type !== 'text') || msg.quote) {
                    alert('只能编辑不带引用的纯文本消息');
                    return;
                }

                messageBubble.isEditing = true; // 设置状态锁
                messageBubble.setAttribute('contenteditable', 'true'); // 【核心修改】让气泡本身可编辑

                // 使用微小延迟来确保成功聚焦并移动光标
                setTimeout(() => {
                    messageBubble.focus();
                    // 将光标移动到文本末尾
                    const range = document.createRange();
                    const sel = window.getSelection();
                    if (messageBubble.childNodes.length > 0) {
                        range.selectNodeContents(messageBubble);
                        range.collapse(false); // false表示折叠到末尾
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }, 50);

                // 定义保存函数
                const saveEdit = () => {
                    const newText = messageBubble.textContent.trim();

                    // 清理现场
                    messageBubble.removeAttribute('contenteditable');
                    delete messageBubble.isEditing;
                    messageBubble.removeEventListener('blur', saveEdit); // 移除监听器

                    // 如果文本有变化，才执行保存和刷新
                    if (newText !== msg.content) {
                        if (newText) {
                            msg.content = newText;
                        } else {
                            const msgIndex = chat.history.findIndex(m => m.id === activeContextMenuMsgId);
                            if (msgIndex > -1) {
                                chat.history.splice(msgIndex, 1);
                            }
                        }
                        saveChats();
                        renderMessages();
                        renderContactList();
                    }
                };

                // 绑定事件来结束编辑
                messageBubble.addEventListener('blur', saveEdit, { once: true });
                messageBubble.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // 阻止换行
                        messageBubble.blur(); // 触发保存
                    }
                });
            }

            /**
             * 处理复制
             */
            function handleCopy() {
                const chat = chats.find(c => c.id === activeChatId);
                const msg = chat.history.find(m => m.id === activeContextMenuMsgId);
                if (msg && msg.content && typeof msg.content === 'string') {
                    navigator.clipboard.writeText(msg.content).then(() => {
                        // 可以在这里加一个复制成功的提示, 比如复用toast
                    }).catch(err => console.error('复制失败:', err));
                }
            }

            /**
             * 处理删除
             */
            function handleDelete() {
                showConfirmationModal('确定要删除这条消息吗？', () => {
                    const chat = chats.find(c => c.id === activeChatId);
                    const msgIndex = chat.history.findIndex(m => m.id === activeContextMenuMsgId);
                    if (msgIndex > -1) {
                        chat.history.splice(msgIndex, 1);
                        saveChats();
                        renderMessages();
                        renderContactList();
                    }
                });
            }

            // ===================================================================
            // 【【【全新】】】插入消息核心功能
            // ===================================================================

            /**
             * 打开插入消息弹窗
             */
            function openInsertModal() {
                const chat = chats.find(c => c.id === activeChatId);
                const msgIndex = chat.history.findIndex(m => m.id === activeContextMenuMsgId);
                const msg = chat.history[msgIndex];

                if (!msg) return;

                // 1. 初始化插入模式的状态
                insertMode = {
                    active: true,
                    originalIndex: msgIndex,
                    tempMessages: [JSON.parse(JSON.stringify(msg))], // 深拷贝，防止意外修改原始数据
                    isEditable: false
                };

                // 2. 渲染弹窗内容
                renderInsertPreview();
                insertMessageModal.classList.add('visible');
            }

            /**
             * 渲染插入弹窗的预览区域 (V2.55 修复版)
             */
            function renderInsertPreview() {
                insertPreviewContainer.innerHTML = ''; // 清空

                insertPreviewContainer.classList.toggle('editable', insertMode.isEditable);

                insertMode.tempMessages.forEach(msg => {
                    const chat = chats.find(c => c.id === activeChatId);
                    const defaultAvatar = 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';

                    // --- 1. 创建所有需要的元素 ---
                    const itemWrapper = document.createElement('div');
                    itemWrapper.className = `insert-preview-item ${msg.role === 'user' ? 'user-wrapper' : 'assistant-wrapper'}`;
                    itemWrapper.dataset.tempId = msg.id;

                    const avatar = document.createElement('img');
                    avatar.src = msg.role === 'user' ? (chat.settings.userAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar);
                    avatar.className = 'chat-avatar';

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'message-content-wrapper';

                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = msg.content || '';

                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'message-timestamp';
                    timestampSpan.textContent = formatMessageTime(msg.timestamp);

                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'insert-delete-btn';
                    deleteBtn.innerHTML = `<svg t="1758555626126" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="24084" width="8" height="8"><path d="M886.528 908.032c-28.096 28.096-73.856 28.096-102.016 0L138.304 261.824c-28.096-28.16-28.16-73.856 0-102.016 28.032-28.16 73.792-28.16 102.08 0l646.144 646.144C914.624 834.24 914.752 879.872 886.528 908.032L886.528 908.032zM885.76 261.504 239.616 907.648c-28.224 28.224-73.92 28.224-102.08 0-28.16-28.096-28.16-73.728 0.064-102.016L783.744 159.552c28.224-28.16 73.984-28.16 102.016-0.064C913.984 187.648 913.856 233.344 885.76 261.504L885.76 261.504z" fill="#ffffff" p-id="24085"></path></svg>`;

                    // --- 2. 组装消息内容 (气泡 + 时间戳) ---
                    contentWrapper.appendChild(bubble);
                    contentWrapper.appendChild(timestampSpan);

                    // --- 3. 【【【核心修复逻辑】】】根据角色，决定元素的添加顺序 ---
                    if (msg.role === 'user') {
                        // 用户消息：内容在前，头像在后
                        itemWrapper.appendChild(contentWrapper);
                        itemWrapper.appendChild(avatar);
                    } else {
                        // AI消息：头像在前，内容在后
                        itemWrapper.appendChild(avatar);
                        itemWrapper.appendChild(contentWrapper);
                    }
                    itemWrapper.appendChild(deleteBtn); // 删除按钮总是最后添加，以便用 absolute 定位

                    // --- 4. 将组装好的消息行添加到预览容器 ---
                    insertPreviewContainer.appendChild(itemWrapper);

                    // --- 5. 绑定事件 ---
                    if (insertMode.isEditable) {
                        bubble.addEventListener('click', () => handleInplaceEditInModal(bubble, msg.id, 'content'));
                        timestampSpan.addEventListener('click', () => handleInplaceEditInModal(timestampSpan, msg.id, 'timestamp'));
                    }
                });
            }

            /**
             * 处理在弹窗内的原地编辑
             */
            function handleInplaceEditInModal(element, tempMsgId, fieldToEdit) {
                if (element.isEditing) return;

                element.isEditing = true;
                element.setAttribute('contenteditable', 'true');
                element.focus();

                const saveEdit = () => {
                    const newText = element.textContent.trim();
                    element.removeAttribute('contenteditable');
                    delete element.isEditing;

                    const msgToUpdate = insertMode.tempMessages.find(m => m.id === tempMsgId);
                    if (msgToUpdate) {
                        if (fieldToEdit === 'content') {
                            msgToUpdate.content = newText;
                        } else if (fieldToEdit === 'timestamp') {
                            // 简单处理，只替换时间部分
                            const originalDate = new Date(msgToUpdate.timestamp);
                            const parts = newText.split(':');
                            if (parts.length === 2) {
                                originalDate.setHours(parseInt(parts[0], 10));
                                originalDate.setMinutes(parseInt(parts[1], 10));
                                msgToUpdate.timestamp = originalDate.getTime();
                            }
                        }
                    }
                };

                element.addEventListener('blur', saveEdit, { once: true });
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                });
            }

            /**
             * 在临时消息数组中添加新消息
             */
            function addNewMessageInModal(direction) {
                insertMode.isEditable = true; // 标记为可编辑状态
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【【【核心修复】】】根据插入方向，决定新消息的时间戳和角色
                let newTimestamp;
                let newRole;

                if (direction === 'above') {
                    const firstMsg = insertMode.tempMessages[0];
                    newTimestamp = firstMsg.timestamp - 1; // 时间戳比第一条早一点
                    newRole = firstMsg.role; // 角色和第一条一样
                } else {
                    const lastMsg = insertMode.tempMessages[insertMode.tempMessages.length - 1];
                    newTimestamp = lastMsg.timestamp + 1; // 时间戳比最后一条晚一点
                    newRole = lastMsg.role; // 角色和最后一条一样
                }

                const newMessage = {
                    id: 'msg_' + Date.now() + Math.random(), // 确保ID唯一
                    role: newRole, // 使用我们动态获取到的角色
                    content: '', // 内容为空，等待用户编辑
                    timestamp: newTimestamp // 使用我们计算好的时间戳
                };

                if (direction === 'above') {
                    insertMode.tempMessages.unshift(newMessage);
                } else {
                    insertMode.tempMessages.push(newMessage);
                }
                renderInsertPreview(); // 重新渲染预览
            }

            /**
             * 保存插入的消息
             */
            function saveInsertedMessages() {
                if (!insertMode.active) return;

                const chat = chats.find(c => c.id === activeChatId);
                // 使用 splice 一次性完成替换/插入操作
                chat.history.splice(insertMode.originalIndex, 1, ...insertMode.tempMessages);

                saveChats();
                renderMessages(); // 刷新主聊天界面
                renderContactList(); // 刷新联系人列表
                closeInsertModal();
            }

            /**
             * 关闭并重置插入弹窗
             */
            function closeInsertModal() {
                insertMode = { active: false, originalIndex: -1, tempMessages: [], isEditable: false };
                insertMessageModal.classList.remove('visible');
            }

            // ===================================================================
            // 【【【全新】】】多选消息核心功能
            // ===================================================================

            /**
             * 进入多选模式
             */
            function enterMultiSelectMode() {
                multiSelectMode = true;
                chatInterfaceScreen.classList.add('multi-select-mode');
                updateMultiSelectCounter();
            }

            /**
             * 退出多选模式
             */
            function exitMultiSelectMode() {
                multiSelectMode = false;
                chatInterfaceScreen.classList.remove('multi-select-mode');
                // 移除所有消息的 .selected 状态
                messageContainer.querySelectorAll('.message-wrapper.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedMessageIds.clear(); // 清空已选中的ID集合
            }

            /**
             * 切换单条消息的选中状态
             */
            function toggleMessageSelection(msgId, messageWrapper) {
                if (selectedMessageIds.has(msgId)) {
                    selectedMessageIds.delete(msgId);
                    messageWrapper.classList.remove('selected');
                } else {
                    selectedMessageIds.add(msgId);
                    messageWrapper.classList.add('selected');
                }
                updateMultiSelectCounter();
            }

            /**
             * 更新顶部计数器
             */
            function updateMultiSelectCounter() {
                const counter = document.getElementById('multi-select-counter');
                const count = selectedMessageIds.size;
                if (count === 0) {
                    counter.textContent = '请选择项目';
                } else {
                    counter.textContent = `已选择 ${count} 项`;
                }
            }

            /**
             * 删除所有选中的消息
             */
            function deleteSelectedMessages() {
                if (selectedMessageIds.size === 0) {
                    alert('请至少选择一条消息。');
                    return;
                }
                showConfirmationModal(`确定要删除这 ${selectedMessageIds.size} 条消息吗？`, () => {
                    const chat = chats.find(c => c.id === activeChatId);
                    if (chat) {
                        chat.history = chat.history.filter(msg => !selectedMessageIds.has(msg.id));
                        saveChats();
                        exitMultiSelectMode(); // 退出多选模式
                        renderMessages();      // 重新渲染
                        renderContactList();   // 更新最后一条消息
                    }
                });
            }

            // ===================================================================
            // ===================================================================
            // 【全新 V1.81 修复方案】面板总调度中心 (方案一)
            // ===================================================================

            // --- 1. 面板控制函数 ---
            function openFunctionsPanel() {
                stickerPanel.classList.remove('visible');
                moreFunctionsPanel.classList.add('visible');
                moreFunctionsBtn.classList.add('rotated');
                currentOpenPanel = 'functions';
            }

            function openStickerPanel() {
                console.log("诊断信息：表情图标的 'openStickerPanel' 函数被成功触发！"); // <--- 在这里植入另一个听诊器
                moreFunctionsPanel.classList.remove('visible');
                stickerPanel.classList.add('visible');
                moreFunctionsBtn.classList.add('rotated');
                currentOpenPanel = 'stickers';
            }

            function closeAllPanels() {
                moreFunctionsPanel.classList.remove('visible');
                stickerPanel.classList.remove('visible');
                moreFunctionsBtn.classList.remove('rotated');
                currentOpenPanel = 'none';
            }

            function togglePanels() {
                console.log("诊断信息：面板总开关 'togglePanels' 函数被成功触发！"); // <--- 在这里植入听诊器
                const isFunctionsOpen = moreFunctionsPanel.classList.contains('visible');
                const isStickersOpen = stickerPanel.classList.contains('visible');

                if (isFunctionsOpen) {
                    closeAllPanels(); // 如果功能面板开着，就关掉所有
                } else if (isStickersOpen) {
                    closeAllPanels(); // 如果表情面板开着，也关掉所有
                } else {
                    openFunctionsPanel(); // 如果都关着，就打开功能面板
                }
            }
            // --- 2. 功能面板内部导航函数 (这部分逻辑是好的，我们保留并整合进来) ---
            function updateFunctionNavArrows() {
                functionsNavPrev.classList.toggle('hidden', functionsPanelState.currentPage === 1);
                functionsNavNext.classList.toggle('hidden', functionsPanelState.currentPage >= functionsPanelState.totalPages);
            }

            function navigateFunctionsPanel(direction) {
                const newPage = Math.max(1, Math.min(functionsPanelState.totalPages, functionsPanelState.currentPage + direction));
                if (newPage === functionsPanelState.currentPage) return;
                functionsPanelState.currentPage = newPage;
                const offset = (functionsPanelState.currentPage - 1) * -50;
                functionsSlider.style.transform = `translateX(${offset}%)`;
                updateFunctionNavArrows();
            }

            // --- 3. 为所有相关按钮绑定事件 ---
            moreFunctionsBtn.addEventListener('click', togglePanels);
            openStickerPanelBtn.addEventListener('click', openStickerPanel);
            functionsNavPrev.addEventListener('click', () => navigateFunctionsPanel(-1));
            functionsNavNext.addEventListener('click', () => navigateFunctionsPanel(1));


            // ===================================================================
            // 【新增】所有新功能的函数
            // ===================================================================

            // 应用当前聊天的自定义样式
            function applyChatStyles() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                const chatScreen = document.getElementById('chat-interface-screen');

                let pseudoStyleTag = document.getElementById('pseudo-background-style');
                if (!pseudoStyleTag) {
                    pseudoStyleTag = document.createElement('style');
                    pseudoStyleTag.id = 'pseudo-background-style';
                    document.head.appendChild(pseudoStyleTag);
                }

                if (chat.settings.background) {
                    const imageUrl = chat.settings.background;
                    const safeImageUrl = `url('${imageUrl.replace(/'/g, "\\'").replace(/"/g, '\\"')}')`;
                    pseudoStyleTag.innerHTML = `#chat-interface-screen::before { background-image: ${safeImageUrl}; }`;
                    chatScreen.classList.remove('no-wallpaper');
                } else {
                    pseudoStyleTag.innerHTML = `#chat-interface-screen::before { background-image: none; }`;
                    chatScreen.classList.add('no-wallpaper');
                }

                let styleTag = document.getElementById('custom-chat-style');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'custom-chat-style';
                    document.head.appendChild(styleTag);
                }

                // 【【【核心修复】】】 在使用值的时候，统一添加 'px' 单位
                const avatarRadius = parseInt(chat.settings.avatarRadius) || 28;
                const fontSize = parseInt(chat.settings.fontSize) || 14;

                // 【【【核心新增】】】在这里计算时间戳的相对字体大小
                // 规则：比气泡字体小3px，但最小不小于10px
                const timestampSize = Math.max(10, fontSize - 3);

                let finalCss = `
                    .chat-avatar { border-radius: ${avatarRadius}px; }
                    #message-container .message-bubble { font-size: ${fontSize}px; }
                    /* --- 新增：动态设置时间戳大小 --- */
                    .message-timestamp { font-size: ${timestampSize}px !important; }
                `;

                if (chat.settings.customCss && chat.settings.customCss.trim() !== '') {
                    finalCss += chat.settings.customCss;
                } else {
                    let bubbleStyles = '';
                    if (chat.settings.aiBubbleColor) {
                        bubbleStyles += `#message-container .ai-bubble { background: ${chat.settings.aiBubbleColor} !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important; }`;
                    }
                    if (chat.settings.aiFontColor) {
                        bubbleStyles += `#message-container .ai-bubble { color: ${chat.settings.aiFontColor} !important; }`;
                    } else if (chat.settings.aiBubbleColor) {
                        bubbleStyles += `#message-container .ai-bubble { color: #000 !important; }`;
                    }
                    if (chat.settings.userBubbleColor) {
                        bubbleStyles += `#message-container .user-bubble { background: ${chat.settings.userBubbleColor} !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important; }`;
                    }
                    if (chat.settings.userFontColor) {
                        bubbleStyles += `#message-container .user-bubble { color: ${chat.settings.userFontColor} !important; }`;
                    } else if (chat.settings.userBubbleColor) {
                        bubbleStyles += `#message-container .user-bubble { color: #000 !important; }`;
                    }
                    finalCss += bubbleStyles;
                }
                styleTag.innerHTML = finalCss;
            }

            // 打开聊天设置页面
            function openChatSettings() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【V4.0 新增】获取置顶开关元素
                const pinChatToggle = document.getElementById('pin-chat-toggle');

                const aiSettingsNameDisplay = document.getElementById('ai-settings-name-display');
                const userSettingsNameDisplay = document.getElementById('user-settings-name-display');

                aiSettingsAvatar.src = chat.settings.aiAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                aiSettingsNameDisplay.textContent = chat.settings.aiName || chat.name;
                userSettingsAvatar.src = chat.settings.userAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                userSettingsNameDisplay.textContent = chat.settings.userName || '';

                // 【V4.0 新增】确保 isPinned 属性存在，并设置开关状态
                chat.isPinned = typeof chat.isPinned === 'boolean' ? chat.isPinned : false;
                pinChatToggle.checked = chat.isPinned;

                chat.settings.showAvatars = typeof chat.settings.showAvatars === 'boolean' ? chat.settings.showAvatars : true;
                showAvatarsToggle.checked = chat.settings.showAvatars;

                avatarRadiusInput.value = parseInt(chat.settings.avatarRadius) || 28;
                fontSizeInput.value = parseInt(chat.settings.fontSize) || 14;
                document.getElementById('max-memory-input').value = chat.settings.maxMemory || 10;

                applyChatStyles();

                showScreen('chat-settings-screen');
            }

            // 保存聊天设置
            function saveCurrentChatSettings() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【V4.0 新增】获取并保存置顶状态
                const pinChatToggle = document.getElementById('pin-chat-toggle');
                chat.isPinned = pinChatToggle.checked;

                chat.settings.showAvatars = showAvatarsToggle.checked;
                chat.settings.avatarRadius = avatarRadiusInput.value.trim() || '28';
                chat.settings.fontSize = fontSizeInput.value.trim() || '14';

                chat.settings.maxMemory = parseInt(document.getElementById('max-memory-input').value, 10) || 10;

                saveChats();

                const messageContainer = document.getElementById('message-container');
                if (chat.settings.showAvatars === false) {
                    messageContainer.classList.add('no-avatars');
                } else {
                    messageContainer.classList.remove('no-avatars');
                }
                applyChatStyles();
                renderMessages();

                // 【V4.0 新增】保存设置后，刷新联系人列表以反映置顶变化
                renderContactList();
            }

            // 处理图片上传
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file || !currentAvatarUploadTarget) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    const chat = chats.find(c => c.id === activeChatId);
                    if (chat) {
                        if (currentAvatarUploadTarget === 'ai') {
                            chat.settings.aiAvatar = imageUrl;
                            // 【核心修复】同时更新两个页面的头像
                            aiSettingsAvatar.src = imageUrl; // 更新聊天设置页的
                            aiInfoAvatar.src = imageUrl;     // 更新对方信息页的
                            updateCoupleSpaceUI(); // 【核心新增】立即刷新情侣空间主界面
                        } else if (currentAvatarUploadTarget === 'user') {
                            chat.settings.userAvatar = imageUrl;
                            // 【核心修复】同时更新两个页面的头像
                            userSettingsAvatar.src = imageUrl; // 更新聊天设置页的
                            myInfoAvatar.src = imageUrl;       // 更新我的信息页的
                        }
                        saveChats();
                        renderContactList();
                        renderMessages();
                    }
                };
                reader.readAsDataURL(file);
                avatarUploadInput.value = '';
            }
            // 打开气泡样式弹窗
            function openBubbleStyleModal() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 如果保存的值是空，颜色选择器默认显示白色/黑色，否则显示保存的颜色
                userBubbleColorInput.value = chat.settings.userBubbleColor || '#ffffff';
                aiBubbleColorInput.value = chat.settings.aiBubbleColor || '#ffffff';
                userFontColorInput.value = chat.settings.userFontColor || '#262626'; // 新增
                aiFontColorInput.value = chat.settings.aiFontColor || '#262626';   // 新增

                // 【修改】只要设置了气泡颜色或字体颜色，都算作“颜色已设置”
                bubbleStyleModal.dataset.isColorSet = (chat.settings.userBubbleColor || chat.settings.aiBubbleColor || chat.settings.userFontColor || chat.settings.aiFontColor) ? 'true' : 'false';

                customCssInput.value = chat.settings.customCss || '';
                updateBubblePreview();
                bubbleStyleModal.classList.add('visible');
            }

            // 更新气泡预览
            function updateBubblePreview() {
                const css = customCssInput.value;
                const isColorSet = bubbleStyleModal.dataset.isColorSet === 'true';


                // 1. 样式重置，让预览气泡恢复到默认的毛玻璃效果
                previewUserBubble.removeAttribute('style');
                previewAiBubble.removeAttribute('style');

                // 更新所有颜色选择器旁边的小色块，确保独立实时显示
                userBubbleColorInput.parentElement.style.setProperty('--color-preview', userBubbleColorInput.value);
                aiBubbleColorInput.parentElement.style.setProperty('--color-preview', aiBubbleColorInput.value);
                userFontColorInput.parentElement.style.setProperty('--color-preview', userFontColorInput.value);
                aiFontColorInput.parentElement.style.setProperty('--color-preview', aiFontColorInput.value);
                // 【【【核心新增：实时更新预览区头像】】】
                const chat = chats.find(c => c.id === activeChatId);
                const defaultAvatar = 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                if (chat) {
                    document.getElementById('preview-ai-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                    document.getElementById('preview-user-avatar').src = chat.settings.userAvatar || defaultAvatar;
                }

                // 2. 优先级判断
                // 最高优先级：自定义CSS
                if (css && css.trim() !== '') {
                    // ... (此部分预览逻辑保持不变，因为自定义CSS优先级最高)
                    if (css.includes('.user-bubble')) {
                        try {
                            const bgMatch = css.match(/\.user-bubble\s*\{[^\}]*background:[^;\}]*/);
                            if (bgMatch) previewUserBubble.style.background = bgMatch[0].split(':')[1].trim();
                            const colorMatch = css.match(/\.user-bubble\s*\{[^\}]*color:[^;\}]*/);
                            if (colorMatch) previewUserBubble.style.color = colorMatch[0].split(':')[1].trim();
                        } catch (e) { }
                    }
                    if (css.includes('.ai-bubble')) {
                        try {
                            const bgMatch = css.match(/\.ai-bubble\s*\{[^\}]*background:[^;\}]*/);
                            if (bgMatch) previewAiBubble.style.background = bgMatch[0].split(':')[1].trim();
                            const colorMatch = css.match(/\.ai-bubble\s*\{[^\}]*color:[^;\}]*/);
                            if (colorMatch) previewAiBubble.style.color = colorMatch[0].split(':')[1].trim();
                        } catch (e) { }
                    }
                }
                // 第二优先级：自定义颜色
                else if (isColorSet) {
                    // 应用纯色背景和字体颜色，并移除毛玻璃效果
                    previewUserBubble.style.cssText = `background: ${userBubbleColorInput.value}; color: ${userFontColorInput.value}; backdrop-filter: none; box-shadow: 0 1px 2px rgba(0,0,0,0.1);`;
                    previewAiBubble.style.cssText = `background: ${aiBubbleColorInput.value}; color: ${aiFontColorInput.value}; backdrop-filter: none; box-shadow: 0 1px 2px rgba(0,0,0,0.1);`;
                }
                // 最低优先级：默认样式 (在第1步重置时已经生效)

            }

            // 打开背景设置弹窗
            function openBackgroundModal() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                if (chat.settings.background) {
                    backgroundPreview.style.backgroundImage = `url(${chat.settings.background})`;
                    removeBackgroundBtn.style.display = 'block';
                } else {
                    backgroundPreview.style.backgroundImage = 'none';
                    removeBackgroundBtn.style.display = 'none';
                }
                backgroundModal.classList.add('visible');
            }

            // 处理背景图片上传
            function handleBackgroundUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    backgroundPreview.style.backgroundImage = `url(${imageUrl})`;
                    removeBackgroundBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
                backgroundUploadInput.value = '';
            }



            // --- 功能函数 ---
            // ===================================================================
            // 【全新 V2.03】信息页面与表情包库核心功能
            // ===================================================================

            /**
             * 打开“对方信息”页面
             */
            function openAiInfoScreen() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【核心修复】检查并初始化表情包库，确保旧数据也能兼容
                if (!chat.settings.stickerPacks) {
                    chat.settings.stickerPacks = [
                        { id: 'default', name: '默认', isDefault: true, enabled: true, stickers: [] }
                    ];
                }

                // 1. 填充基本信息
                aiInfoAvatar.src = chat.settings.aiAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                aiInfoNameDisplay.textContent = chat.settings.aiName || chat.name;
                aiPersonaInput.value = chat.settings.aiPersona || '';
                aiRelationshipInput.value = chat.settings.aiRelationship || '';

                // 2. 填充关联角色书
                populateAiInfoAssociations(chat.settings.aiAssociations || []);

                // 3. 渲染表情包库列表
                renderStickerPacks(chat);

                // 4. 显示屏幕
                showScreen('ai-info-screen');
            }

            /**
             * 打开“我的信息”页面
             */
            function openMyInfoScreen() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 1. 填充信息
                myInfoAvatar.src = chat.settings.userAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp';
                myInfoNameDisplay.textContent = chat.settings.userName || '未设置';
                myPersonaInput.value = chat.settings.userPersona || '';
                mySupplementaryInfoInput.value = chat.settings.userSupplementaryInfo || '';

                // 2. 显示屏幕
                showScreen('my-info-screen');
            }

            /**
             * 保存“对方信息”
             */
            function saveAiInfo() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【新增】保存名字
                const newAiName = aiInfoNameDisplay.textContent.trim();
                chat.name = newAiName;
                chat.settings.aiName = newAiName;

                chat.settings.aiPersona = aiPersonaInput.value;
                chat.settings.aiRelationship = aiRelationshipInput.value;

                const selectedAssociations = Array.from(aiInfoAssociationsDropdown.querySelectorAll('.preset-dropdown-list input:checked')).map(input => input.dataset.id);
                chat.settings.aiAssociations = selectedAssociations;

                saveChats();
                renderContactList(); // 刷新联系人列表以显示新名字
                chatContactName.textContent = newAiName; // 刷新聊天顶栏的名字
                alert('对方信息已保存！');
                openChatSettings(); // 【核心新增】在显示前，重新加载聊天设置页的数据
                showScreen('chat-settings-screen');
            }
            /**
            * 保存“我的信息”
            */
            function saveMyInfo() {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                // 【核心修复】先获取旧名字，再保存新名字
                const oldUserName = chat.settings.userName || '我';
                const newUserName = myInfoNameDisplay.textContent.trim();

                chat.settings.userName = newUserName;
                chat.settings.userPersona = myPersonaInput.value;
                chat.settings.userSupplementaryInfo = mySupplementaryInfoInput.value;

                // 【核心新增】遍历所有动态和评论，更新旧名字
                if (coupleSpaceSettings.statuses && coupleSpaceSettings.statuses.length > 0) {
                    coupleSpaceSettings.statuses.forEach(status => {
                        // 更新动态发布者的名字
                        if (status.name === oldUserName) {
                            status.name = newUserName || '我';
                        }
                        // 更新评论者的名字
                        if (status.comments && status.comments.length > 0) {
                            status.comments.forEach(comment => {
                                if (comment.commenterName === oldUserName) {
                                    comment.commenterName = newUserName || '我';
                                }
                            });
                        }
                    });
                }

                // 保存所有更改
                saveCoupleSpaceSettings();
                saveChats();

                alert('我的信息已保存！');
                openChatSettings();
                showScreen('chat-settings-screen');
                // 【新增】如果情侣空间已绑定，则刷新动态列表以显示新名字
                if (coupleSpaceSettings.partnerChatId) {
                    renderStatusFeed();
                }
            }

            // 【全新 V2.03】我的信息页面事件

            // 【新增】为信息页面的头像和名字添加点击事件
            aiInfoAvatar.addEventListener('click', () => {
                currentAvatarUploadTarget = 'ai'; // 标记当前要上传的是AI头像
                avatarUploadInput.click();
            });
            myInfoAvatar.addEventListener('click', () => {
                currentAvatarUploadTarget = 'user'; // 标记当前要上传的是用户头像
                avatarUploadInput.click();
            });

            aiInfoNameDisplay.addEventListener('click', () => {
                aiInfoNameDisplay.contentEditable = true;
                aiInfoNameDisplay.focus();
            });
            myInfoNameDisplay.addEventListener('click', () => {
                myInfoNameDisplay.contentEditable = true;
                myInfoNameDisplay.focus();
            });

            /**
             * 填充对方信息页的关联角色书下拉列表
             */
            /**
             * 【【【逻辑分离】】】为对方信息页填充关联项 (只能关联角色)
             */
            function populateAiInfoAssociations(selectedIds = []) {
                const dropdownList = aiInfoAssociationsDropdown.querySelector('.preset-dropdown-list');
                dropdownList.innerHTML = '';

                // 筛选出非禁词的角色书
                const availableRoles = presets.roles.filter(role => role.id !== 'forbidden_words');

                if (availableRoles.length === 0) {
                    dropdownList.innerHTML = `<div class="preset-dropdown-item" style="padding: 16px 12px;">暂无角色书可关联</div>`;
                } else {
                    availableRoles.forEach(item => {
                        const isChecked = selectedIds.includes(item.id);
                        const li = document.createElement('div');
                        li.className = 'preset-dropdown-item';
                        const checkboxId = `ai_assoc_${item.id}`;
                        li.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" data-id="${item.id}" ${isChecked ? 'checked' : ''}>
                            <label for="${checkboxId}">${item.name}</label>
                        `;
                        dropdownList.appendChild(li);
                    });
                }
                updateAiInfoDropdownLabel(selectedIds.length);
            }

            /**
             * 更新对方信息页的下拉框标签文本
             */
            function updateAiInfoDropdownLabel(count) {
                if (count > 0) {
                    aiInfoDropdownLabel.textContent = `已选择 ${count} 项`;
                } else {
                    aiInfoDropdownLabel.textContent = '点击选择';
                }
            }

            /**
             * 渲染表情包库列表
             */
            function renderStickerPacks(chat) {
                aiInfoStickerPackList.innerHTML = ''; // 清空

                // 1. 渲染默认包和添加按钮在同一行
                const defaultRow = document.createElement('div');
                defaultRow.className = 'sticker-pack-item';
                const defaultPack = chat.settings.stickerPacks.find(p => p.isDefault);
                if (defaultPack) {
                    defaultRow.innerHTML = `
                        <div class="sticker-pack-name-wrapper">
                            <span class="sticker-pack-name default-pack" data-pack-id="${defaultPack.id}">${defaultPack.name}</span>
                        </div>
                        <div class="sticker-pack-actions">
                            <button class="add-sticker-pack-btn" id="add-sticker-pack-btn">
                                <svg t="1757638742634" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="28011" width="27" height="27"><path d="M828.704099 196.575729C744.096116 112.384034 631.648434 66.016073 512 66.016073s-232.1288 46.367961-316.736783 130.559656C110.624271 280.800108 64 392.831501 64 512c0 119.199462 46.624271 231.199892 131.232254 315.424271 84.607983 84.191695 197.088348 130.559656 316.736783 130.559656s232.1288-46.367961 316.704099-130.559656c84.67163-84.255342 131.295901-196.288456 131.263217-315.455235C959.967316 392.800538 913.375729 280.800108 828.704099 196.575729zM736.00086 544.00086 544.00086 544.00086l0 192c0 17.695686-14.336138 32.00086-32.00086 32.00086s-32.00086-14.303454-32.00086-32.00086L479.99914 544.00086 288.00086 544.00086c-17.664722 0-32.00086-14.336138-32.00086-32.00086s14.336138-32.00086 32.00086-32.00086l192 0L480.00086 288.00086c0-17.664722 14.336138-32.00086 32.00086-32.00086s32.00086 14.336138 32.00086 32.00086l0 192 192 0c17.695686 0 32.00086 14.336138 32.00086 32.00086S753.696546 544.00086 736.00086 544.00086z" fill="#353333" p-id="28012"></path></svg>
                            </button>
                        </div>
                    `;
                }
                aiInfoStickerPackList.appendChild(defaultRow);

                // 2. 渲染其他自定义的表情包
                chat.settings.stickerPacks.forEach(pack => {
                    if (pack.isDefault) return;

                    const item = document.createElement('div');
                    item.className = 'sticker-pack-item';

                    const isChecked = pack.enabled ? 'checked' : '';
                    const checkedSvg = isChecked ? `<svg t="1757638693998" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26732" width="14" height="14"><path d="M384 768c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733334s42.666667-17.066667 59.733333 0L384 665.6 823.466667 226.133333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733334l-469.333333 469.333333c-8.533333 8.533333-17.066667 12.8-29.866667 12.8z" p-id="26733" fill="#ffffff"></path></svg>` : '';

                    item.innerHTML = `
                        <div class="sticker-pack-name-wrapper">
                            <span class="sticker-pack-name" data-pack-id="${pack.id}">${pack.name === '默认' ? '' : pack.name}</span>
                        </div>
                        <div class="sticker-pack-actions">
                             <button class="delete-sticker-pack-btn" data-pack-id="${pack.id}">
                                <svg t="1757458251149" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="transform: rotate(45deg);"><path d="M902.343 570.936h-331.78v331.833c0 32.337-26.226 58.537-58.564 58.537-32.337 0-58.563-26.2-58.563-58.537V570.936H121.654c-32.364 0-58.564-26.2-58.564-58.538 0-32.325 26.203-58.537 58.564-58.537h331.78V122.028c0-32.325 26.226-58.537 58.563-58.537 32.338 0 58.564 26.213 58.564 58.537v331.834h331.78c32.364 0 58.565 26.211 58.565 58.535-0.001 32.337-26.2 58.536-58.565 58.536z" fill="#aaa"></path></svg>
                            </button>
                            <div class="sticker-pack-checkbox-wrapper ${isChecked}" data-pack-id="${pack.id}">
                                ${checkedSvg}
                            </div>
                        </div>
                    `;
                    aiInfoStickerPackList.appendChild(item);
                });
            }

            /**
             * 打开表情管理页面
             */
            function openManageStickersScreen(packId) {
                const chat = chats.find(c => c.id === activeChatId);
                const pack = chat?.settings.stickerPacks.find(p => p.id === packId);
                if (!pack) return;

                currentManagingStickerPack = { chatId: activeChatId, packId: packId };

                stickerPackTitleEditor.textContent = pack.name;
                stickerPackTitleEditor.contentEditable = !pack.isDefault;

                // 【核心修复】调用我们新注入的渲染函数
                renderStickerManagementGrid(pack.stickers || []);

                manageStickersScreen.classList.remove('delete-mode');
                stickerDeleteModeBtn.style.display = 'block';
                deleteModeActions.style.display = 'none';

                showScreen('manage-stickers-screen');
            }

            /**
             * 渲染管理页面的表情网格
             */
            function renderStickerManagementGrid(stickersInPack) {
                stickerManagementGridView.innerHTML = ''; // 清空

                // “添加”按钮
                const addBtnWrapper = document.createElement('div');
                addBtnWrapper.className = 'add-sticker-btn-wrapper manage-sticker-item-wrapper';
                addBtnWrapper.innerHTML = `<svg t="1757458251149" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M902.343 570.936h-331.78v331.833c0 32.337-26.226 58.537-58.564 58.537-32.337 0-58.563-26.2-58.563-58.537V570.936H121.654c-32.364 0-58.564-26.2-58.564-58.538 0-32.325 26.203-58.537 58.564-58.537h331.78V122.028c0-32.325 26.226-58.537 58.563-58.537 32.338 0 58.564 26.213 58.564 58.537v331.834h331.78c32.364 0 58.565 26.211 58.565 58.535-0.001 32.337-26.2 58.536-58.565 58.536z" fill="#353333"></path></svg>`;
                stickerManagementGridView.appendChild(addBtnWrapper);

                // 渲染表情
                stickersInPack.forEach(sticker => {
                    const stickerWrapper = document.createElement('div');
                    stickerWrapper.className = 'manage-sticker-item-wrapper';
                    stickerWrapper.innerHTML = `
                        <div class="sticker-item" data-sticker-id="${sticker.id}">
                            <img src="${sticker.url}" alt="${sticker.name}">
                        </div>
                        <div class="sticker-delete-checkbox" data-sticker-id="${sticker.id}"></div>
                    `;
                    stickerManagementGridView.appendChild(stickerWrapper);
                });
            }

            /**
             * 在管理页面添加新表情
             */
            function addStickerToCurrentPack(name, url) {
                const { chatId, packId } = currentManagingStickerPack;
                const chat = chats.find(c => c.id === chatId);
                const pack = chat?.settings.stickerPacks.find(p => p.id === packId);

                if (pack) {
                    const newSticker = {
                        id: 'sticker_' + Date.now(),
                        name: name,
                        url: url
                    };
                    pack.stickers.push(newSticker);
                    saveChats();
                    renderStickerManagementGrid(pack.stickers); // 刷新当前页面
                }
            }





            // --- 事件监听 ---

            // ===================================================================
            // 【V2.30】消息交互事件监听
            // ===================================================================

            // 交互菜单按钮的事件委托
            messageContextMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.context-menu-item');
                if (item && !item.classList.contains('placeholder')) {
                    const action = item.dataset.action;
                    switch (action) {
                        case 'reply': handleReply(); break;
                        case 'edit': handleEdit(); break;
                        case 'copy': handleCopy(); break;
                        case 'delete': handleDelete(); break;
                        case 'insert': openInsertModal(); break; // 【【【新增】】】
                        case 'multi-select': enterMultiSelectMode(); break; // 【【【新增】】】
                    }
                    messageContextMenu.classList.remove('visible');
                }
            });

            // 点击外部或滚动时关闭菜单
            chatInterfaceScreen.addEventListener('click', (e) => {
                if (!messageContextMenu.contains(e.target) && !e.target.closest('.message-bubble, .sticker-in-chat, .couple-status-card')) {
                    messageContextMenu.classList.remove('visible');
                }
            });
            messageContainer.addEventListener('scroll', () => {
                if (messageContextMenu.classList.contains('visible')) {
                    messageContextMenu.classList.remove('visible');
                }
            });

            // 取消引用
            cancelReplyBtn.addEventListener('click', () => {
                replyInfo = null;
                replyBar.style.display = 'none';
            });

            // ===================================================================
            // 【全新 V1.91】外观设置页面事件监听
            // ===================================================================
            // 在主设置页面，点击“外观设置”
            const mainSettingsContainer = document.getElementById('main-settings-container');
            if (mainSettingsContainer) {
                const appearanceSettingsBtn = mainSettingsContainer.querySelector('.settings-item:nth-of-type(4)'); // 第四个是外观设置
                if (appearanceSettingsBtn) {
                    appearanceSettingsBtn.addEventListener('click', () => showScreen('appearance-settings-screen'));
                }
            }

            // 在外观设置页面，点击“更换应用图标”
            gotoAppIconSettingsBtn.addEventListener('click', () => {
                renderAppIconSettingsPage(); // 渲染页面
                showScreen('app-icon-settings-screen');
            });

            // 在外观设置页面，点击“更换壁纸”
            openDesktopWallpaperModalBtn.addEventListener('click', () => {
                // 打开时，根据当前壁纸状态更新预览
                if (desktopWallpaper) {
                    desktopWallpaperPreview.style.backgroundImage = `url(${desktopWallpaper})`;
                    removeDesktopWallpaperBtn.style.display = 'block';
                } else {
                    desktopWallpaperPreview.style.backgroundImage = 'none';
                    removeDesktopWallpaperBtn.style.display = 'none';
                }
                desktopWallpaperModal.classList.add('visible');
            });

            // 更换壁纸弹窗内的交互
            desktopWallpaperPreview.addEventListener('click', () => desktopWallpaperUploadInput.click());
            desktopWallpaperUploadInput.addEventListener('change', handleDesktopWallpaperUpload);
            removeDesktopWallpaperBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                desktopWallpaperPreview.style.backgroundImage = 'none';
                removeDesktopWallpaperBtn.style.display = 'none';
            });
            saveDesktopWallpaperBtn.addEventListener('click', () => {
                const bgStyle = desktopWallpaperPreview.style.backgroundImage;
                desktopWallpaper = bgStyle.startsWith('url') ? bgStyle.slice(5, -2) : '';
                saveDesktopSettings();
                applyDesktopSettings(); // 立即应用
                desktopWallpaperModal.classList.remove('visible');
            });

            // “更换应用图标”页面的事件委托
            appIconSettingsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const iconKey = target.dataset.iconKey;
                if (!iconKey) return;

                // 点击上传按钮
                if (target.classList.contains('app-icon-upload-btn')) {
                    currentImageUploadTarget = `icon-${iconKey}`; // 设置上传目标
                    desktopFileInput.click(); // 触发全局文件选择器
                }

                // 点击重置按钮
                if (target.classList.contains('app-icon-reset-btn')) {
                    if (desktopIconSettings[iconKey]) {
                        delete desktopIconSettings[iconKey].imageUrl;
                        delete desktopIconSettings[iconKey].url;
                    }
                    // 清空输入框
                    const input = appIconSettingsContainer.querySelector(`.app-icon-url-input[data-icon-key="${iconKey}"]`);
                    if (input) input.value = '';

                    saveDesktopSettings();
                    applyDesktopIconSettings(); // 立即更新
                }
            });

            // 为URL输入框添加事件委托
            appIconSettingsContainer.addEventListener('input', (e) => {
                const target = e.target;
                if (target.classList.contains('app-icon-url-input')) {
                    const iconKey = target.dataset.iconKey;
                    if (!desktopIconSettings[iconKey]) {
                        desktopIconSettings[iconKey] = {};
                    }
                    desktopIconSettings[iconKey].url = target.value.trim();
                    saveDesktopSettings();
                    applyDesktopIconSettings(); // 实时更新
                }
            });

            // ===================================================================
            // 【新增】素材页面核心功能函数
            // ===================================================================

            /**
             * 渲染“素材”页面的所有内容
             */
            function renderAssetsPage() {
                renderWritingStyles();
                renderSocialAssets();
            }

            /**
             * 渲染“文风”板块
             */
            function renderWritingStyles() {
                const listContainer = document.getElementById('writing-style-list');
                const arrowBtn = document.querySelector('#writing-style-section .asset-section-arrow');
                listContainer.innerHTML = '';

                const styles = presets.assets.writingStyles || [];

                arrowBtn.style.display = styles.length > 0 ? 'block' : 'none';

                styles.forEach(style => {
                    const item = document.createElement('div');
                    item.className = 'asset-list-item';
                    item.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="asset-list-name">${style.name}</span>
                        <div class="asset-list-actions">
                             <button data-action="delete" data-type="writingStyle" data-id="${style.id}">
                                <svg t="1758256966353" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57284" width="18" height="18"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="57285" fill="#302f2f"></path></svg>
                            </button>
                            <button data-action="edit" data-type="writingStyle" data-id="${style.id}">
                                <svg t="1758256914811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="55901" width="18" height="18"><path d="M550.4 292.48l180.992 180.992-422.4 422.4H128v-181.034667l422.4-422.4z m60.330667-60.373333l90.496-90.496a42.666667 42.666667 0 0 1 60.330666 0l120.704 120.661333a42.666667 42.666667 0 0 1 0 60.373333l-90.538666 90.496-180.992-181.034666z" fill="#302f2f" p-id="55902"></path></svg>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }

            /**
             * 渲染“朋友圈素材”板块
             */
            function renderSocialAssets() {
                const listContainer = document.getElementById('social-asset-list');
                const arrowBtn = document.querySelector('#social-asset-section .asset-section-arrow');
                listContainer.innerHTML = '';

                const assets = presets.assets.socialAssets || [];

                arrowBtn.style.display = assets.length > 0 ? 'block' : 'none';

                assets.forEach(asset => {
                    const item = document.createElement('div');
                    item.className = 'asset-list-item';
                    item.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="asset-list-name">${asset.name}</span>
                        <div class="asset-list-actions">
                             <button data-action="delete" data-type="socialAsset" data-id="${asset.id}">
                                <svg t="1758256966353" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57284" width="18" height="18"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="57285" fill="#302f2f"></path></svg>
                            </button>
                            <button data-action="edit" data-type="socialAsset" data-id="${asset.id}">
                                <svg t="1758256914811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="55901" width="18" height="18"><path d="M550.4 292.48l180.992 180.992-422.4 422.4H128v-181.034667l422.4-422.4z m60.330667-60.373333l90.496-90.496a42.666667 42.666667 0 0 1 60.330666 0l120.704 120.661333a42.666667 42.666667 0 0 1 0 60.373333l-90.538666 90.496-180.992-181.034666z" fill="#302f2f" p-id="55902"></path></svg>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }

            /**
             * 打开素材编辑器（文风或朋友圈素材）
             */
            function openAssetEditor(type, id) {
                currentEditingAsset = { type, id };
                if (type === 'writingStyle') {
                    const title = document.getElementById('writing-style-editor-title');
                    const nameInput = document.getElementById('new-writing-style-name-input');
                    const influenceInput = document.getElementById('new-writing-style-influence-input');
                    const contentInput = document.getElementById('new-writing-style-content-input');

                    if (id) { // 编辑模式
                        const style = presets.assets.writingStyles.find(s => s.id === id);
                        title.textContent = '编辑文风';
                        nameInput.value = style.name;
                        influenceInput.value = style.influence;
                        contentInput.value = style.content;
                    } else { // 创建模式
                        title.textContent = '创建文风';
                        nameInput.value = '';
                        influenceInput.value = '50';
                        contentInput.value = '';
                    }
                    showScreen('preset-writing-style-edit-screen');
                } else if (type === 'socialAsset') {
                    const title = document.getElementById('social-asset-editor-title');
                    const nameInput = document.getElementById('new-social-asset-name-input');
                    const influenceInput = document.getElementById('new-social-asset-influence-input');
                    const contentInput = document.getElementById('new-social-asset-content-input');

                    if (id) { // 编辑模式
                        const asset = presets.assets.socialAssets.find(a => a.id === id);
                        title.textContent = '编辑素材';
                        nameInput.value = asset.name;
                        influenceInput.value = asset.influence;
                        contentInput.value = asset.content;
                        currentEditingSocialAssetImages = [...(asset.images || [])];
                    } else { // 创建模式
                        title.textContent = '创建素材';
                        nameInput.value = '';
                        influenceInput.value = '50';
                        contentInput.value = '';
                        currentEditingSocialAssetImages = [];
                    }
                    renderSocialAssetImageList();
                    showScreen('preset-social-asset-edit-screen');
                }
            }

            /**
             * 在朋友圈素材编辑器中，渲染图片列表
             */
            /**
             * 在朋友圈素材编辑器中，渲染图片列表
             */
            function renderSocialAssetImageList() {
                const listContainer = document.getElementById('social-asset-image-list');
                listContainer.innerHTML = '';
                currentEditingSocialAssetImages.forEach(image => {
                    const item = document.createElement('div');
                    item.className = 'asset-image-item';
                    item.dataset.id = image.id;

                    const isChecked = image.active ? 'checked' : '';
                    const checkedSvg = isChecked ? '<svg t="1757638693998" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26732" width="14" height="14"><path d="M384 768c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733334s42.666667-17.066667 59.733333 0L384 665.6 823.466667 226.133333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733334l-469.333333 469.333333c-8.533333 8.533333-17.066667 12.8-29.866667 12.8z" p-id="26733" fill="#ffffff"></path></svg>' : '';

                    item.innerHTML = `
                        <span class="item-name" contenteditable="true" maxlength="4">${image.name || ''}</span>
                        <div class="item-url">${image.url}</div>
                        <div class="item-actions">
                            <button data-action="delete-image">
                               <svg t="1758256966353" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57284" width="18" height="18"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="57285" fill="#302f2f"></path></svg>
                            </button>
                             <div class="font-entry-checkbox ${isChecked}">
                                ${checkedSvg}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }

            // ===================================================================
            // 【全新 V2.21】世界书功能核心函数 (重构版)
            // ===================================================================

            // --- 数据持久化 ---
            async function savePresets() {
                try {
                    await db.set('presets', presets);
                } catch (error) {
                    console.error("保存世界书失败:", error);
                }
            }

            async function loadPresets() {
                const savedPresets = await db.get('presets');
                if (savedPresets) {
                    presets = {
                        roles: savedPresets.roles || [],
                        forbiddenWords: savedPresets.forbiddenWords || { position: 'all', content: '', avatar: '' },
                        offlines: savedPresets.offlines || [],
                        // 【核心修改】确保 assets 对象及其子数组存在
                        assets: savedPresets.assets || { writingStyles: [], socialAssets: [] }
                    };
                    // 再次检查，防止旧数据没有子数组
                    if (!presets.assets.writingStyles) presets.assets.writingStyles = [];
                    if (!presets.assets.socialAssets) presets.assets.socialAssets = [];
                }
                // 初始化时渲染所有页面
                renderRolePresetsPage();
                renderOfflinePresetsPage();
                renderAssetsPage();
            }

            // --- 页面渲染 ---
            function renderRolePresetsPage() {
                presetPageRole.innerHTML = ''; // 清空

                // 渲染固定的“禁词”项... (这部分代码不变，省略)
                const forbiddenWordsItem = document.createElement('div');
                forbiddenWordsItem.className = 'preset-list-item forbidden-words-item';
                forbiddenWordsItem.innerHTML = `
                    <img src="${presets.forbiddenWords.avatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp'}" class="preset-list-avatar" data-type="forbidden-words" data-id="forbidden_words">
                    <span class="preset-list-name">禁词</span>
                    <div class="preset-list-actions">
                        <button data-action="edit-forbidden-words">
                           <svg t="1758256914811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="55901" width="18" height="18"><path d="M550.4 292.48l180.992 180.992-422.4 422.4H128v-181.034667l422.4-422.4z m60.330667-60.373333l90.496-90.496a42.666667 42.666667 0 0 1 60.330666 0l120.704 120.661333a42.666667 42.666667 0 0 1 0 60.373333l-90.538666 90.496-180.992-181.034666z" fill="#302f2f" p-id="55902"></path></svg>
                        </button>
                    </div>
                `;
                presetPageRole.appendChild(forbiddenWordsItem);

                // 渲染用户自定义的角色... (这部分代码不变，省略)
                presets.roles.forEach(preset => {
                    const item = document.createElement('div');
                    item.className = 'preset-list-item';
                    item.dataset.id = preset.id;
                    item.innerHTML = `
                        <img src="${preset.avatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp'}" class="preset-list-avatar" data-type="role" data-id="${preset.id}">
                        <span class="preset-list-name">${preset.name}</span>
                        <div class="preset-list-actions">
                            <button data-action="delete-role" data-id="${preset.id}">
                               <svg t="1758256966353" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57284" width="18" height="18"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="57285" fill="#302f2f"></path></svg>
                            </button>
                            <button data-action="edit-role" data-id="${preset.id}">
                               <svg t="1758256914811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="55901" width="18" height="18"><path d="M550.4 292.48l180.992 180.992-422.4 422.4H128v-181.034667l422.4-422.4z m60.330667-60.373333l90.496-90.496a42.666667 42.666667 0 0 1 60.330666 0l120.704 120.661333a42.666667 42.666667 0 0 1 0 60.373333l-90.538666 90.496-180.992-181.034666z" fill="#302f2f" p-id="55902"></path></svg>
                            </button>
                        </div>
                    `;
                    presetPageRole.appendChild(item);
                });
            }

            /**
             * 【【【核心新增】】】渲染“预设”页面列表
             */
            function renderOfflinePresetsPage() {
                const presetPageOffline = document.getElementById('preset-page-offline');
                presetPageOffline.innerHTML = ''; // 清空

                if (presets.offlines.length === 0) {
                    presetPageOffline.innerHTML = `<p style="text-align:center; color:#888; margin-top: 40px;">还没有预设，点击右上角“+”创建一个吧</p >`;
                    return;
                }

                presets.offlines.forEach(preset => {
                    const item = document.createElement('div');
                    item.className = 'preset-list-item-offline';
                    item.dataset.id = preset.id;
                    // 【核心修改】调整了操作按钮的顺序和开关的样式
                    item.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="preset-list-name">${preset.name}</span>
                        <div class="preset-list-actions">
                             <button data-action="delete-offline-preset" data-id="${preset.id}">
                                <svg t="1758256966353" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57284" width="18" height="18"><path d="M801.856 734.016 579.904 512l222.016-222.016c18.816-18.816 18.88-49.152 0.064-67.968-18.752-18.752-49.216-18.752-67.904 0L512 444.032 289.92 222.016c-18.688-18.752-49.088-18.752-67.904 0C203.328 240.768 203.328 271.232 222.144 290.048L444.096 512l-222.016 221.952c-18.816 18.752-18.816 49.152-0.064 67.968C231.424 811.392 243.84 816 256 816s24.576-4.608 33.92-14.016L512 579.968l222.08 222.016c9.408 9.344 21.696 14.016 33.92 14.016 12.288 0 24.576-4.608 33.92-14.016C820.672 783.104 820.736 752.768 801.856 734.016z" p-id="57285" fill="#302f2f"></path></svg>
                            </button>
                            <button data-action="edit-offline-preset" data-id="${preset.id}">
                                <svg t="1758256914811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="55901" width="18" height="18"><path d="M550.4 292.48l180.992 180.992-422.4 422.4H128v-181.034667l422.4-422.4z m60.330667-60.373333l90.496-90.496a42.666667 42.666667 0 0 1 60.330666 0l120.704 120.661333a42.666667 42.666667 0 0 1 0 60.373333l-90.538666 90.496-180.992-181.034666z" fill="#302f2f" p-id="55902"></path></svg>
                            </button>
                            <label class="switch" style="transform: scale(0.8);">
                                <input type="checkbox" data-action="toggle-offline-preset" data-id="${preset.id}" ${preset.enabled ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    `;
                    presetPageOffline.appendChild(item);
                });
            }

            /**
             * 渲染“素材”页面的所有内容
             */
            function renderAssetsPage() {
                renderWritingStyles();
                renderSocialAssets();
            }


            // --- 编辑器内的交互 ---
            document.getElementById('preset-page-assets').addEventListener('click', e => {
                const target = e.target;
                const header = target.closest('.asset-section-header');
                const actionBtn = target.closest('.asset-list-actions button, .asset-section-add-btn');

                // 点击了展开/收起箭头
                if (target.closest('.asset-section-arrow')) {
                    const section = target.closest('.asset-section');
                    const list = section.querySelector('.asset-list-container');
                    target.closest('.asset-section-arrow').classList.toggle('expanded');
                    list.classList.toggle('expanded');
                    return;
                }

                // 点击了“+”、编辑或删除按钮
                if (actionBtn) {
                    const type = actionBtn.dataset.type;
                    const id = actionBtn.dataset.id;
                    const action = actionBtn.dataset.action || 'add';

                    if (action === 'add') {
                        openAssetEditor(type, null);
                    } else if (action === 'edit') {
                        openAssetEditor(type, id);
                    } else if (action === 'delete') {
                        const confirmText = type === 'writingStyle' ? '确定要删除该文风吗？' : '确定要删除该素材吗？';
                        showConfirmationModal(confirmText, () => {
                            if (type === 'writingStyle') {
                                presets.assets.writingStyles = presets.assets.writingStyles.filter(s => s.id !== id);
                            } else {
                                presets.assets.socialAssets = presets.assets.socialAssets.filter(a => a.id !== id);
                            }
                            savePresets();
                            renderAssetsPage();
                        });
                    }
                }
            });

            // 文风编辑器保存
            document.getElementById('save-writing-style-btn').addEventListener('click', () => {
                const name = document.getElementById('new-writing-style-name-input').value.trim();
                if (!name) { alert('名称不能为空！'); return; }

                const styleData = {
                    name,
                    influence: document.getElementById('new-writing-style-influence-input').value,
                    content: document.getElementById('new-writing-style-content-input').value,
                };

                if (currentEditingAsset.id) { // 编辑
                    const index = presets.assets.writingStyles.findIndex(s => s.id === currentEditingAsset.id);
                    presets.assets.writingStyles[index] = { ...presets.assets.writingStyles[index], ...styleData };
                } else { // 创建
                    presets.assets.writingStyles.push({ id: 'ws_' + Date.now(), ...styleData });
                }
                savePresets();
                renderWritingStyles();
                showScreen('world-book-screen');
            });

            // 朋友圈素材编辑器保存
            document.getElementById('save-social-asset-btn').addEventListener('click', () => {
                const name = document.getElementById('new-social-asset-name-input').value.trim();
                if (!name) { alert('名称不能为空！'); return; }

                const assetData = {
                    name,
                    influence: document.getElementById('new-social-asset-influence-input').value,
                    content: document.getElementById('new-social-asset-content-input').value,
                    images: currentEditingSocialAssetImages, // 保存临时存储的图片列表
                };

                if (currentEditingAsset.id) { // 编辑
                    const index = presets.assets.socialAssets.findIndex(a => a.id === currentEditingAsset.id);
                    presets.assets.socialAssets[index] = { ...presets.assets.socialAssets[index], ...assetData };
                } else { // 创建
                    presets.assets.socialAssets.push({ id: 'sa_' + Date.now(), ...assetData });
                }
                savePresets();
                renderSocialAssets();
                showScreen('world-book-screen');
            });

            // 朋友圈素材编辑器内的图片链接操作
            document.getElementById('add-social-asset-image-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('new-social-asset-image-url-input');
                const keywordInput = document.getElementById('new-social-asset-keyword-input');
                const url = urlInput.value.trim();
                const keyword = keywordInput.value.trim();

                if (!url || !keyword) {
                    alert('图片链接和关键词都不能为空！');
                    return;
                }

                currentEditingSocialAssetImages.push({
                    id: 'img_' + Date.now(),
                    name: '',
                    keyword,
                    url,
                    active: true,
                });

                urlInput.value = '';
                keywordInput.value = '';
                renderSocialAssetImageList();
            });

            document.getElementById('social-asset-image-list').addEventListener('click', e => {
                const item = e.target.closest('.asset-image-item');
                if (!item) return;
                const imageId = item.dataset.id;

                if (e.target.closest('[data-action="delete-image"]')) {
                    currentEditingSocialAssetImages = currentEditingSocialAssetImages.filter(img => img.id !== imageId);
                    renderSocialAssetImageList();
                } else if (e.target.closest('.font-entry-checkbox')) {
                    const image = currentEditingSocialAssetImages.find(img => img.id === imageId);
                    image.active = !image.active;
                    renderSocialAssetImageList();
                }
            });

            document.getElementById('social-asset-image-list').addEventListener('blur', e => {
                const item = e.target.closest('.asset-image-item');
                if (!item) return;
                const imageId = item.dataset.id;
                const image = currentEditingSocialAssetImages.find(img => img.id === imageId);

                if (e.target.classList.contains('item-name') && image) {
                    image.name = e.target.textContent.trim().slice(0, 4);
                }
            }, true);


            // --- 编辑器开启与填充 ---

            /**
             * 【【【逻辑分离】】】打开角色编辑器
             */
            function openRolePresetEditor(presetId) {
                currentEditingPresetId = presetId;
                // 重置所有输入字段
                presetNameText.textContent = '';
                const contentTextarea = document.getElementById('preset-content-text');
                contentTextarea.value = '';
                presetDropdownList.innerHTML = '';
                updateDropdownLabel(0);
                presetDropdownContainer.classList.remove('expanded');

                if (presetId) { // 编辑模式
                    const preset = presets.roles.find(p => p.id === presetId);
                    if (preset) {
                        presetEditorTitle.textContent = '编辑角色';
                        presetNameText.textContent = preset.name;
                        contentTextarea.value = preset.content;
                        populateRoleAssociations(preset.associations || []);
                    }
                } else { // 创建模式
                    presetEditorTitle.textContent = '创建角色';
                    populateRoleAssociations([]); // 传入空数组以正确渲染
                }
                showScreen('preset-edit-screen');
            }

            /**
             * 【【【核心新增】】】打开预设编辑器
             */
            function openOfflinePresetEditor(presetId) {
                currentEditingOfflinePresetId = presetId;
                const title = document.getElementById('preset-offline-editor-title');
                const nameText = document.getElementById('preset-offline-name-text');
                // 【核心修改】这里获取的是 textarea 元素
                const contentTextarea = document.getElementById('preset-offline-content-text');
                const modeSelect = document.getElementById('preset-offline-mode-select');
                const roleSelect = document.getElementById('preset-offline-role-select');
                const positionSelect = document.getElementById('preset-offline-position-select');

                if (presetId) { // 编辑预设
                    const preset = presets.offlines.find(p => p.id === presetId);
                    if (preset) {
                        title.textContent = '编辑预设';
                        nameText.textContent = preset.name;
                        // 【核心修改】为 textarea 设置 value
                        contentTextarea.value = preset.prompt;
                        modeSelect.value = preset.mode || 'all';
                        roleSelect.value = preset.role || 'system';
                        positionSelect.value = preset.position || 'before';
                    }
                } else { // 创建预设
                    title.textContent = '创建预设';
                    nameText.textContent = '';
                    // 【核心修改】清空 textarea 的 value
                    contentTextarea.value = ''
                    modeSelect.value = 'all';
                    roleSelect.value = 'system';
                    positionSelect.value = 'before';
                }
                showScreen('preset-offline-edit-screen');
            }


            /**
             * 【【【逻辑分离】】】为角色编辑器填充关联项 (只能关联预设和其他)
             */
            function populateRoleAssociations(selectedIds = []) {
                presetDropdownList.innerHTML = '';

                // 【核心修改】从新的数据结构中获取所有可关联项
                const availableItems = [
                    ...(presets.offlines || []),
                    ...(presets.assets.writingStyles || []),
                    ...(presets.assets.socialAssets || [])
                ];

                if (availableItems.length === 0) {
                    presetDropdownList.innerHTML = `<div class="preset-dropdown-item" style="padding: 16px 12px;">暂无可关联项</div>`;
                } else {
                    availableItems.forEach(item => {
                        const isChecked = selectedIds.includes(item.id);
                        const li = document.createElement('div');
                        li.className = 'preset-dropdown-item';
                        const checkboxId = `role_assoc_${item.id}`;
                        li.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" data-id="${item.id}" ${isChecked ? 'checked' : ''}>
                            <label for="${checkboxId}">${item.name}</label>
                        `;
                        presetDropdownList.appendChild(li);
                    });
                }
                updateDropdownLabel(selectedIds.length);
            }

            function updateDropdownLabel(count) {
                if (count > 0) {
                    presetDropdownLabel.textContent = `已选择 ${count} 项`;
                } else {
                    presetDropdownLabel.textContent = '点击选择';
                }
            }

            // --- 编辑器与列表交互 ---

            function openForbiddenWordsEditor() {
                forbiddenWordsPositionSelect.value = presets.forbiddenWords.position || 'all';
                forbiddenWordsContentInput.value = presets.forbiddenWords.content || '';
                showScreen('preset-forbidden-words-screen');
            }

            function presetEditInPlace(containerEl, textEl, isTextarea = false) {
                if (containerEl.querySelector('.preset-inplace-editor')) {
                    return;
                }
                const originalText = textEl.textContent;
                textEl.style.display = 'none';

                const input = document.createElement(isTextarea ? 'textarea' : 'input');
                input.className = 'preset-inplace-editor';
                input.value = originalText;

                containerEl.appendChild(input);
                input.focus();

                const saveAndCleanup = () => {
                    textEl.textContent = input.value;
                    input.remove();
                    textEl.style.display = '';
                };

                input.addEventListener('blur', saveAndCleanup);
                if (!isTextarea) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') input.blur();
                    });
                }
            }

            // ===================================================================
            // 【全新 V1.77.1】稳定版文件上传与情侣空间交互
            // ===================================================================

            // 【核心重构】为文件上传input设置唯一的“总调度员”事件监听器 (V1.98 最终修复版)
            desktopFileInput.addEventListener('change', (event) => {
                if (!currentImageUploadTarget) return;

                // 【核心修复】判断 currentImageUploadTarget 是否为包含 type 属性的对象
                if (typeof currentImageUploadTarget === 'object' && currentImageUploadTarget.type) {
                    // 如果是世界书头像上传任务
                    if (currentImageUploadTarget.type === 'role' || currentImageUploadTarget.type === 'forbidden-words') {
                        handlePresetAvatarUpload(event);
                    }
                }
                // 否则，执行旧的字符串判断逻辑
                else if (typeof currentImageUploadTarget === 'string') {
                    if (currentImageUploadTarget.startsWith('polaroid-')) {
                        handlePolaroidPhotoUpload(event);
                    } else if (currentImageUploadTarget === 'couple-background') {
                        handleCoupleBgUpload(event);
                    } else if (currentImageUploadTarget.startsWith('icon-')) {
                        handleAppIconUpload(event);
                    } else {
                        handleDesktopImageUpload(event);
                    }
                }

                desktopFileInput.value = '';
            });

            // 为每个拍立得添加点击事件：只负责“设定目标”并“触发点击”
            polaroidItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    currentImageUploadTarget = `polaroid-${index}`; // 设定目标
                    currentPolaroidIndex = index; // 记录索引
                    desktopFileInput.click(); // 触发文件选择
                });
            });

            // 监听“更换背景”按钮：只负责“设定目标”并“触发点击”
            if (themeBgUploadBtn) {
                themeBgUploadBtn.addEventListener('click', () => {
                    currentImageUploadTarget = 'couple-background'; // 设定目标
                    desktopFileInput.click(); // 触发文件选择
                });
            }

            // 监听“重置”按钮：【【【功能扩展】】】同时重置主背景和自定义区域背景
            if (themeResetBtn) {
                themeResetBtn.addEventListener('click', () => {
                    showConfirmationModal('确定要重置所有背景吗？此操作将移除主背景和自定义区域背景。', () => {
                        // 1. 重置主题数据（主背景）
                        coupleSpaceTheme.background = '';
                        saveCoupleThemeSettings();
                        loadAndApplyCoupleTheme();

                        // 2. 【【【全新】】】重置自定义区域背景数据
                        if (coupleSpaceSettings.customBackground) {
                            coupleSpaceSettings.customBackground.image = '';
                        }
                        saveCoupleSpaceSettings();
                        applyCoupleCustomBackground();

                        alert('背景已重置。');
                    });
                });
            }

            // --- 以下是情侣空间其他导航按钮的事件监听，保持不变 ---

            // 监听底部导航图标的点击
            if (coupleBottomNav) {
                navIconWrappers.forEach(icon => {
                    icon.addEventListener('click', () => {
                        const pageNumber = icon.dataset.page;
                        switchCoupleContentPage(pageNumber);
                    });
                });
            }

            // 监听顶栏“更多”按钮，跳转到主题设置页
            if (coupleSpaceOptionsBtn) {
                coupleSpaceOptionsBtn.addEventListener('click', () => {
                    showScreen('couple-theme-screen');
                });
            }

            // 监听主题设置页的返回按钮
            if (coupleThemeBackBtn) {
                coupleThemeBackBtn.addEventListener('click', () => {
                    showScreen('couple-space-screen');
                });
            }

            /**
 * 【全新 V1.91 修复】专门处理应用图标上传的函数
 */
            function handleAppIconUpload(event) {
                const file = event.target.files[0];
                // 确保有文件，且上传目标是图标
                if (!file || !currentImageUploadTarget || !currentImageUploadTarget.startsWith('icon-')) return;

                // 从上传目标中解析出图标的key，例如 'icon-chat' -> 'chat'
                const iconKey = currentImageUploadTarget.replace('icon-', '');

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // 确保该图标的设置对象存在
                    if (!desktopIconSettings[iconKey]) {
                        desktopIconSettings[iconKey] = {};
                    }
                    // 保存图片数据
                    desktopIconSettings[iconKey].imageUrl = imageUrl;
                    // 【核心】上传图片后，清空URL，因为图片的优先级更高
                    desktopIconSettings[iconKey].url = '';

                    // 并且清空界面上URL输入框的内容
                    const urlInput = appIconSettingsContainer.querySelector(`.app-icon-url-input[data-icon-key="${iconKey}"]`);
                    if (urlInput) urlInput.value = '';

                    saveDesktopSettings(); // 保存到IndexedDB
                    applyDesktopIconSettings(); // 立即刷新图标显示
                };
                reader.readAsDataURL(file);
            }

            // ===================================================================
            // 【全新 V1.91】外观设置 & 图标自定义核心功能函数
            // ===================================================================

            /**
             * 渲染“更换应用图标”页面的整个列表
             */
            function renderAppIconSettingsPage() {
                appIconSettingsContainer.innerHTML = ''; // 清空容器

                const iconConfig = [
                    { key: 'chat', name: '聊天', defaultSvg: document.querySelector('.new-app-icon[data-target="chat-list-screen"]').innerHTML },
                    { key: 'forum', name: '论坛', defaultSvg: document.querySelector('#main-apps-container .new-app-icon:nth-child(2)').innerHTML },
                    { key: 'worldbook', name: '世界书', defaultSvg: document.querySelector('.new-app-icon[data-target="world-book-screen"]').innerHTML },
                    { key: 'couple', name: '情侣空间', defaultSvg: document.querySelector('#main-apps-container .new-app-icon:nth-child(4)').innerHTML },
                    { key: 'settings', name: '设置', defaultSvg: document.querySelector('.new-app-icon[data-target="main-settings-screen"]').innerHTML },
                    { key: 'camera', name: '相机', defaultSvg: document.querySelector('#bottom-dock .new-app-icon:nth-child(2)').innerHTML },
                    { key: 'message', name: '短信', defaultSvg: document.querySelector('#bottom-dock .new-app-icon:nth-child(3)').innerHTML },
                    { key: 'phone', name: '电话', defaultSvg: document.querySelector('#bottom-dock .new-app-icon:nth-child(4)').innerHTML },
                ];

                iconConfig.forEach(config => {
                    const settings = desktopIconSettings[config.key] || {};
                    const item = document.createElement('div');
                    item.className = 'app-icon-setting-item';
                    item.innerHTML = `
                        <div class="app-icon-preview new-app-icon" data-icon-key="${config.key}">
                            <!-- 内容由 applyDesktopIconSettings 动态填充 -->
                        </div>
                        <div class="app-icon-details">
                            <span class="app-icon-setting-title">${config.name}</span>
                            <input type="text" class="app-icon-url-input" placeholder="粘贴URL可替换图标，优先级最高" value="${settings.url || ''}" data-icon-key="${config.key}">
                        </div>
                        <div class="app-icon-actions">
                            <button class="app-icon-btn app-icon-upload-btn" data-icon-key="${config.key}">
                                <svg t="1758199983802" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6733" width="25" height="25"><path d="M268.8 597.333333h51.2c12.8 0 21.333333-8.533333 21.333333-21.333333s-8.533333-21.333333-21.333333-21.333333H268.8c-17.066667 0-25.6 0-34.133333 4.266666-8.533333 4.266667-12.8 8.533333-17.066667 17.066667-4.266667 8.533333-4.266667 12.8-4.266667 34.133333v102.4c0 17.066667 0 25.6 4.266667 34.133334 4.266667 8.533333 8.533333 12.8 17.066667 17.066666 8.533333 4.266667 12.8 4.266667 34.133333 4.266667h486.4c17.066667 0 25.6 0 34.133333-4.266667 8.533333-4.266667 12.8-8.533333 17.066667-17.066666 4.266667-8.533333 4.266667-12.8 4.266667-34.133334v-102.4c0-17.066667 0-25.6-4.266667-34.133333-4.266667-8.533333-8.533333-12.8-17.066667-17.066667-8.533333-4.266667-12.8-4.266667-34.133333-4.266666h-51.2c-12.8 0-21.333333 8.533333-21.333333 21.333333s8.533333 21.333333 21.333333 21.333333H768V725.333333H256V610.133333 597.333333h12.8z" p-id="6734" fill="#ffffff"></path><path d="M533.333333 328.533333l85.333334 85.333334c8.533333 8.533333 21.333333 8.533333 29.866666 0 8.533333-8.533333 8.533333-21.333333 0-29.866667l-119.466666-119.466667c-8.533333-8.533333-21.333333-8.533333-29.866667 0L375.466667 384c-8.533333 8.533333-8.533333 21.333333 0 29.866667 8.533333 8.533333 21.333333 8.533333 29.866666 0l85.333334-85.333334v281.6c0 12.8 8.533333 21.333333 21.333333 21.333334s21.333333-8.533333 21.333333-21.333334V328.533333z" p-id="6735" fill="#ffffff"></path></svg>
                            </button>
                            <button class="app-icon-btn app-icon-reset-btn" data-icon-key="${config.key}">重置</button>
                        </div>
                    `;
                    appIconSettingsContainer.appendChild(item);
                });

                // 渲染完成后，立即应用一次样式，确保预览块正确显示
                applyDesktopIconSettings();
            }

            /**
             * 【V1.92 最终性能优化版】根据数据，更新所有相关应用图标的样式
             */
            function applyDesktopIconSettings() {
                // 遍历我们已经缓存好的“地图”的key (chat, forum, worldbook, etc.)
                for (const key in iconConfigMap) {
                    const settings = desktopIconSettings[key] || {};
                    const elements = iconConfigMap[key]; // 直接从“地图”中取出元素列表，不再查询

                    elements.forEach(iconEl => {
                        if (!iconEl) return;

                        // 优先级：URL > 上传图片 > 默认SVG
                        if (settings.url) {
                            iconEl.style.backgroundImage = `url('${settings.url}')`;
                            iconEl.style.backgroundSize = 'cover';
                            iconEl.style.backgroundPosition = 'center';
                            iconEl.innerHTML = '';
                        } else if (settings.imageUrl) {
                            iconEl.style.backgroundImage = `url('${settings.imageUrl}')`;
                            iconEl.style.backgroundSize = 'cover';
                            iconEl.style.backgroundPosition = 'center';
                            iconEl.innerHTML = '';
                        } else {
                            // 恢复默认时，直接从我们的“备份仓库”中取货
                            iconEl.style.backgroundImage = 'none';
                            if (defaultIconSVGs[key]) {
                                iconEl.innerHTML = defaultIconSVGs[key];
                            }
                        }
                    });
                }
            }

            /**
             * 处理桌面壁纸上传和保存
             */
            function handleDesktopWallpaperUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result;
                    desktopWallpaperPreview.style.backgroundImage = `url(${imageUrl})`;
                    removeDesktopWallpaperBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
                desktopWallpaperUploadInput.value = '';
            }

            // ===================================================================
            // 【V4.0 新增 & V4.3 修改】聊天列表页底部导航栏交互
            // ===================================================================
            const navItems = document.querySelectorAll('#chat-list-bottom-nav .nav-item');
            const listPages = document.querySelectorAll('.chat-list-page');
            const chatListScreenForNav = document.getElementById('chat-list-screen'); // 获取父容器

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const pageIdToShow = `${item.dataset.page}-page`;

                    // 切换导航项的选中状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // 切换页面的显示
                    listPages.forEach(page => {
                        if (page.id === pageIdToShow) {
                            // 【修改】根据页面ID决定 display 样式
                            page.style.display = (page.id === 'me-page') ? 'block' : 'flex';
                        } else {
                            page.style.display = 'none';
                        }
                    });

                    // 【【【核心新增】】】 根据是否为“Me”页面，添加或移除特殊类
                    if (pageIdToShow === 'me-page') {
                        chatListScreenForNav.classList.add('me-page-active');
                    } else {
                        chatListScreenForNav.classList.remove('me-page-active');
                    }
                });
            });

            // ===================================================================
            // 【全新 V1.81】编辑模式核心逻辑
            // ===================================================================

            /**
             * 根据当前的设置，更新删除图标的可见性
             */
            function updateDeleteIconsVisibility() {
                // 检查拍立得
                polaroidItems.forEach((item, index) => {
                    // 如果主题数据中有对应的图片链接，就标记为“已自定义”
                    if (coupleSpaceTheme.polaroids && coupleSpaceTheme.polaroids[index]) {
                        item.classList.add('is-customized');
                    } else {
                        item.classList.remove('is-customized');
                    }
                });

                // 检查“我”的头像，这里的默认头像是代码里写死的，所以我们直接判断
                const defaultAvatarUrl = "https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp";
                if (coupleSpaceSettings.myAvatar && coupleSpaceSettings.myAvatar !== defaultAvatarUrl) {
                    myAvatarWrapper.classList.add('is-customized');
                } else {
                    myAvatarWrapper.classList.remove('is-customized');
                }
            }

            // 监听“编辑”按钮的点击
            if (coupleThemeEditBtn) {
                coupleThemeEditBtn.addEventListener('click', () => {
                    // 1. 切换回情侣空间
                    showScreen('couple-space-screen');
                    // 2. 开启编辑模式
                    coupleSpaceScreen.classList.add('edit-mode-active');
                    // 3. 更新所有删除图标的显示状态
                    updateDeleteIconsVisibility();
                });
            }

            // 使用事件委托，监听整个情侣空间页面的点击事件
            if (coupleSpaceScreen) {
                coupleSpaceScreen.addEventListener('click', (e) => {
                    // --- A. 处理删除图标的点击 ---
                    const deleteBtn = e.target.closest('.polaroid-delete-btn, .avatar-delete-btn');
                    if (deleteBtn) {
                        e.stopPropagation(); // 阻止事件冒泡，防止误触退出编辑模式

                        // 如果点击的是拍立得的删除按钮
                        if (deleteBtn.classList.contains('polaroid-delete-btn')) {
                            const polaroidItem = deleteBtn.closest('.polaroid-item');
                            const index = Array.from(polaroidItems).indexOf(polaroidItem);
                            if (index > -1) {
                                coupleSpaceTheme.polaroids[index] = ''; // 清空数据
                                saveCoupleThemeSettings();
                                loadAndApplyCoupleTheme(); // 重新加载以更新界面
                                polaroidItem.classList.remove('is-customized'); // 立即隐藏叉号
                            }
                        }

                        // 如果点击的是头像的删除按钮
                        if (deleteBtn.classList.contains('avatar-delete-btn')) {
                            // 恢复为默认头像
                            coupleSpaceSettings.myAvatar = "https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp";
                            saveCoupleSpaceSettings();
                            loadCoupleSpaceSettings(); // 重新加载以更新界面
                            myAvatarWrapper.classList.remove('is-customized'); // 立即隐藏叉号
                        }
                        return; // 处理完毕，结束本次点击
                    }

                    // --- B. 处理退出编辑模式 ---
                    // 如果当前是编辑模式，并且点击的不是任何可交互的元素，则退出编辑模式
                    if (coupleSpaceScreen.classList.contains('edit-mode-active') && !e.target.closest('.polaroid-item, .couple-avatar-wrapper, .couple-bottom-nav')) {
                        coupleSpaceScreen.classList.remove('edit-mode-active');
                    }
                });
            }
            // ===================================================================
            // 【全新 V1.63】字体设置事件监听
            // ===================================================================
            gotoFontSettingsBtn.addEventListener('click', () => showScreen('font-settings-screen'));

            // 实时预览监听
            [globalFontSizeInput, globalFontWeightInput, globalLetterSpacingInput].forEach(input => {
                input.addEventListener('input', applyPreviewStyles);
            });

            // 添加新字体
            addFontBtn.addEventListener('click', () => {
                const url = fontUrlInput.value.trim();
                if (!url) {
                    alert('请输入字体链接！');
                    return;
                }
                const newFont = {
                    id: 'font_' + Date.now(),
                    name: '',
                    url: url,
                    isActive: false
                };
                fontSettings.customFonts.push(newFont);
                fontUrlInput.value = '';
                renderFontList();
                saveFontSettings();
            });

            // 字体列表的事件委托（处理删除和勾选）
            fontEntryList.addEventListener('click', (e) => {
                const fontItem = e.target.closest('.font-entry-item');
                if (!fontItem) return;
                const fontId = fontItem.dataset.fontId;

                // 点击删除按钮
                if (e.target.closest('.delete-font-btn')) {
                    fontSettings.customFonts = fontSettings.customFonts.filter(f => f.id !== fontId);
                    renderFontList();
                    applyPreviewStyles();
                    saveFontSettings();
                }

                // 点击勾选框
                if (e.target.closest('.font-entry-checkbox')) {
                    const wasActive = fontSettings.customFonts.find(f => f.id === fontId)?.isActive;

                    // 先把所有都设为不勾选
                    fontSettings.customFonts.forEach(f => f.isActive = false);

                    // 如果之前不是勾选状态，则把当前这个设为勾选
                    if (!wasActive) {
                        const targetFont = fontSettings.customFonts.find(f => f.id === fontId);
                        if (targetFont) targetFont.isActive = true;
                    }

                    renderFontList();
                    applyPreviewStyles();
                    saveFontSettings();
                }
            });

            // 保存和恢复按钮
            saveFontSettingsBtn.addEventListener('click', () => {
                // 从输入框同步最新值到 settings 对象
                fontSettings.size = globalFontSizeInput.value || '16';
                fontSettings.weight = globalFontWeightInput.value || '400';
                fontSettings.spacing = globalLetterSpacingInput.value || '0';

                saveFontSettings();
                applyGlobalFontStyles();
                alert('字体效果已保存并应用！');
            });

            restoreFontDefaultsBtn.addEventListener('click', () => {
                showConfirmationModal('确定要恢复所有字体默认设置吗？此操作不可撤销。', () => {
                    fontSettings = { size: '16', weight: '400', spacing: '0', customFonts: [] };
                    saveFontSettings();
                    loadFontSettings(); // 重新加载以更新UI
                    applyGlobalFontStyles(); // 应用全局默认样式
                    alert('已恢复默认设置。');
                });
            });

            appIcons.forEach(icon => {
                // 为普通app图标绑定跳转
                if (icon.dataset.target) {
                    icon.addEventListener('click', () => showScreen(icon.dataset.target));
                }
            });

            // 【全新 V1.65】单独为桌面上的情侣空间图标绑定事件
            const coupleSpaceAppIcon = document.querySelector('#main-apps-container .new-app-icon:nth-child(4)'); // 假设情侣空间是第4个图标
            if (coupleSpaceAppIcon) {
                coupleSpaceAppIcon.addEventListener('click', () => {
                    // 在这里可以加上判断是否已绑定的逻辑
                    showScreen('couple-space-screen');
                });
            }

            backBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetScreenId = btn.dataset.target;

                    // 【核心修复】如果目标是返回聊天列表，就自动关闭所有面板
                    if (targetScreenId === 'chat-list-screen') {
                        closeAllPanels();
                    }

                    // 【【【重大Bug修复】】】
                    // 检查当前是否在聊天设置页面，并且将要返回聊天主界面
                    if (document.getElementById('chat-settings-screen').classList.contains('active') && targetScreenId === 'chat-interface-screen') {
                        // 在返回之前，先调用保存函数！
                        saveCurrentChatSettings();
                    }

                    // 针对从设置页返回聊天页的特殊处理（这段保留）
                    if (targetScreenId === 'chat-interface-screen') {
                        applyChatStyles();
                        renderMessages();
                    }

                    showScreen(targetScreenId);
                });
            });
            // ===================================================================
            // 【【【全新 V4.3】】】“Me”页面交互事件监听
            // ===================================================================

            // 1. 点击头像，触发专属的文件上传
            mePageAvatar.addEventListener('click', () => {
                meAvatarUploadInput.click();
            });

            // 2. 监听专属文件上传控件的变化
            meAvatarUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    mePageData.avatar = imageUrl; // 更新数据
                    saveMePageData();           // 保存数据
                    applyMePageData();          // 立刻更新UI
                };
                reader.readAsDataURL(file);
                meAvatarUploadInput.value = ''; // 清空，以便下次上传
            });

            // 3. 为名字和签名绑定原地编辑功能
            mePageName.addEventListener('click', () => {
                // 调用你已有的 editInPlace 函数，但操作的是 mePageData 对象
                const tempInput = mePageName.parentNode.querySelector('.temp-edit-input');
                if (tempInput) return; // 防止重复点击

                const originalValue = (mePageData.name === 'Name') ? '' : mePageData.name;

                mePageName.style.display = 'none';
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalValue;
                input.className = 'temp-edit-input';
                mePageName.parentNode.insertBefore(input, mePageName.nextSibling);
                input.focus();
                input.select();

                const save = () => {
                    mePageData.name = input.value.trim() || 'Name'; // 保存新值，为空则恢复默认
                    saveMePageData();
                    applyMePageData(); // 用 apply 函数统一更新 UI
                    input.remove();
                    mePageName.style.display = 'block';
                };
                input.addEventListener('blur', save);
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') input.blur(); });
            });

            mePageSignature.addEventListener('click', () => {
                const tempInput = mePageSignature.parentNode.querySelector('.temp-edit-input');
                if (tempInput) return;

                const originalValue = (mePageData.signature === '点我输入自定义个性签名...') ? '' : mePageData.signature;

                mePageSignature.style.display = 'none';
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalValue;
                input.className = 'temp-edit-input';
                mePageSignature.parentNode.insertBefore(input, mePageSignature.nextSibling);
                input.focus();
                input.select();

                const save = () => {
                    mePageData.signature = input.value.trim() || '点我输入自定义个性签名...';
                    saveMePageData();
                    applyMePageData();
                    input.remove();
                    mePageSignature.style.display = 'block';
                };
                input.addEventListener('blur', save);
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') input.blur(); });
            });
            // 【新增】主设置页面的导航
            const gotoApiSettingsBtn = document.getElementById('goto-api-settings-btn');
            gotoApiSettingsBtn.addEventListener('click', () => showScreen('api-settings-screen'));

            // 【新增】为聊天界面的"..."按钮绑定事件
            chatSettingsBtn.addEventListener('click', openChatSettings);

            // 【全新 V2.03】为聊天设置页面的信息卡片添加点击事件
            aiInfoItem.addEventListener('click', (e) => {
                // 确保只有点击右侧箭头时才触发
                if (e.target.closest('.settings-arrow')) {
                    openAiInfoScreen();
                }
            });
            userInfoItem.addEventListener('click', (e) => {
                if (e.target.closest('.settings-arrow')) {
                    openMyInfoScreen();
                }
            });

            // 【全新 V2.03】为信息页面的保存按钮添加事件
            saveAiInfoBtn.addEventListener('click', saveAiInfo);
            saveMyInfoBtn.addEventListener('click', saveMyInfo);

            // 【全新 V2.03】信息页面关联角色书下拉框交互
            aiInfoAssociationsDropdown.addEventListener('click', (e) => {
                if (e.target.closest('.preset-dropdown-header')) {
                    aiInfoAssociationsDropdown.classList.toggle('expanded');
                }
                if (e.target.matches('input[type="checkbox"]')) {
                    const count = aiInfoAssociationsDropdown.querySelectorAll('.preset-dropdown-list input:checked').length;
                    updateAiInfoDropdownLabel(count);
                }
            });

            // 【全新 V2.03】表情包库列表事件委托
            aiInfoStickerPackList.addEventListener('click', (e) => {
                const chat = chats.find(c => c.id === activeChatId);
                if (!chat) return;

                const addBtn = e.target.closest('#add-sticker-pack-btn');
                const deleteBtn = e.target.closest('.delete-sticker-pack-btn');
                const packNameSpan = e.target.closest('.sticker-pack-name');
                const checkboxWrapper = e.target.closest('.sticker-pack-checkbox-wrapper');

                if (addBtn) {
                    const newPack = {
                        id: 'pack_' + Date.now(),
                        name: '默认', // 新建时默认为“默认”，用户可进入管理页修改
                        isDefault: false,
                        enabled: true,
                        stickers: []
                    };
                    chat.settings.stickerPacks.push(newPack);
                    saveChats();
                    renderStickerPacks(chat); // 重新渲染列表以显示新包
                } else if (deleteBtn) {
                    const packId = deleteBtn.dataset.packId;
                    chat.settings.stickerPacks = chat.settings.stickerPacks.filter(p => p.id !== packId);
                    saveChats();
                    renderStickerPacks(chat); // 重新渲染列表
                } else if (checkboxWrapper) {
                    const packId = checkboxWrapper.dataset.packId;
                    const pack = chat.settings.stickerPacks.find(p => p.id === packId);
                    if (pack) {
                        pack.enabled = !pack.enabled; // 切换状态
                        saveChats();
                        renderStickerPacks(chat); // 重新渲染以更新勾选状态
                    }
                } else if (packNameSpan) {
                    const packId = packNameSpan.dataset.packId;
                    openManageStickersScreen(packId);
                }
            });

            // ===================================================================
            // 【全新 V2.06 修复版】管理表情页面事件
            // ===================================================================

            // 标题修改
            stickerPackTitleEditor.addEventListener('blur', () => {
                const { chatId, packId } = currentManagingStickerPack;
                const chat = chats.find(c => c.id === chatId);
                const pack = chat?.settings.stickerPacks.find(p => p.id === packId);
                if (pack && !pack.isDefault) {
                    pack.name = stickerPackTitleEditor.textContent.trim() || '未命名';
                    saveChats();
                    // 刷新外面的列表，以便名字同步
                    const currentChatForRender = chats.find(c => c.id === activeChatId);
                    if (currentChatForRender) renderStickerPacks(currentChatForRender);
                }
            });

            // 添加表情
            stickerManagementGridView.addEventListener('click', (e) => {
                if (e.target.closest('.add-sticker-btn-wrapper')) {
                    // 复用全局的添加表情弹窗，并告诉它上下文是 'pack'
                    openNewAddStickerModal('pack');
                }
            });

            // 删除模式切换
            stickerDeleteModeBtn.addEventListener('click', () => {
                manageStickersScreen.classList.add('delete-mode');
                stickerDeleteModeBtn.style.display = 'none';
                deleteModeActions.style.display = 'flex';
            });

            cancelStickerDeleteBtn.addEventListener('click', () => {
                manageStickersScreen.classList.remove('delete-mode');
                stickerDeleteModeBtn.style.display = 'block';
                deleteModeActions.style.display = 'none';
                // 清除所有勾选
                stickerManagementGridView.querySelectorAll('.sticker-delete-checkbox').forEach(cb => {
                    cb.classList.remove('checked');
                    cb.innerHTML = '';
                });
            });

            // 表情勾选
            stickerManagementGridView.addEventListener('click', (e) => {
                const checkbox = e.target.closest('.sticker-delete-checkbox');
                if (checkbox && manageStickersScreen.classList.contains('delete-mode')) {
                    checkbox.classList.toggle('checked');
                    if (checkbox.classList.contains('checked')) {
                        checkbox.innerHTML = '<svg t="1757638693998" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26732" width="14" height="14"><path d="M384 768c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733334s42.666667-17.066667 59.733333 0L384 665.6 823.466667 226.133333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733334l-469.333333 469.333333c-8.533333 8.533333-17.066667 12.8-29.866667 12.8z" p-id="26733" fill="#ffffff"></path></svg>';
                    } else {
                        checkbox.innerHTML = '';
                    }
                }
            });

            // 确认删除表情
            confirmStickerDeleteBtn.addEventListener('click', () => {
                const { chatId, packId } = currentManagingStickerPack;
                const chat = chats.find(c => c.id === chatId);
                const pack = chat?.settings.stickerPacks.find(p => p.id === packId);

                const checkedStickers = Array.from(stickerManagementGridView.querySelectorAll('.sticker-delete-checkbox.checked'));
                if (checkedStickers.length === 0) {
                    alert('请先勾选要删除的表情。');
                    return;
                }

                const idsToDelete = new Set(checkedStickers.map(cb => cb.dataset.stickerId));
                pack.stickers = pack.stickers.filter(s => !idsToDelete.has(s.id));

                saveChats();
                renderStickerManagementGrid(pack.stickers); // 刷新界面
                // 退出删除模式
                manageStickersScreen.classList.remove('delete-mode');
                stickerDeleteModeBtn.style.display = 'block';
                deleteModeActions.style.display = 'none';
            });

            // 【新增】保存聊天设置页的修改 (当用户离开输入框时自动保存)
            showAvatarsToggle.addEventListener('change', saveCurrentChatSettings);
            avatarRadiusInput.addEventListener('blur', saveCurrentChatSettings);
            fontSizeInput.addEventListener('blur', saveCurrentChatSettings);


            avatarUploadInput.addEventListener('change', handleAvatarUpload);

            // 【新增】清空聊天记录
            // 【新增】显示自定义确认弹窗的函数
            function showConfirmationModal(text, onConfirm) {
                const confirmModal = document.getElementById('confirm-modal');
                const confirmText = document.getElementById('confirm-modal-text');
                const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

                confirmText.textContent = text;

                // 核心修复：为“确定”按钮创建一个干净的克隆版本
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                const closeModal = () => confirmModal.classList.remove('visible');

                // 只为全新的按钮添加事件监听
                newConfirmBtn.addEventListener('click', () => {
                    // 【核心修复】使用一个微小的、非零的延迟来强制分离事件和操作
                    setTimeout(() => {
                        onConfirm();
                        closeModal();
                    }, 20); // 使用20毫秒延迟
                });

                // 取消按钮的事件可以保持不变，因为它逻辑简单
                cancelBtn.onclick = closeModal;

                // 最后再显示弹窗
                confirmModal.classList.add('visible');
            }
            // 【修改】清空聊天记录事件
            clearHistoryBtn.addEventListener('click', () => {
                const chat = chats.find(c => c.id === activeChatId);
                if (chat) {
                    showConfirmationModal(`确定要清空与 ${chat.settings.aiName || chat.name} 的聊天记录？`, () => {
                        chat.history = [];
                        saveChats();
                        renderMessages();
                        renderContactList(); // 【核心修复】在这里补上列表刷新指令
                    });
                }
            });

            // 【新增】气泡样式弹窗事件
            openBubbleStyleModalBtn.addEventListener('click', openBubbleStyleModal);
            [userBubbleColorInput, aiBubbleColorInput, userFontColorInput, aiFontColorInput, customCssInput].forEach(el => {
                el.addEventListener('input', updateBubblePreview);
            });

            // 【新增】为新按钮和颜色选择器添加事件监听
            const resetColorsBtn = document.getElementById('reset-colors-btn');
            const resetCssBtn = document.getElementById('reset-css-btn');

            resetColorsBtn.addEventListener('click', () => {
                bubbleStyleModal.dataset.isColorSet = 'false'; // 标记为“颜色未设置”
                // 重置所有颜色输入框的值
                userBubbleColorInput.value = '#ffffff';
                aiBubbleColorInput.value = '#ffffff';
                userFontColorInput.value = '#262626';
                aiFontColorInput.value = '#262626';
                updateBubblePreview(); // 更新预览，它会显示默认样式
            });

            resetCssBtn.addEventListener('click', () => {
                customCssInput.value = ''; // 清空CSS输入框
                updateBubblePreview(); // 更新预览
            });

            // 当用户手动修改颜色时，自动将状态切换为“颜色已设置”
            userBubbleColorInput.addEventListener('input', () => {
                bubbleStyleModal.dataset.isColorSet = 'true';
            });
            aiBubbleColorInput.addEventListener('input', () => {
                bubbleStyleModal.dataset.isColorSet = 'true';
            });

            // 当用户手动修改字体颜色时，同样自动将状态切换为“颜色已设置”
            userFontColorInput.addEventListener('input', () => {
                bubbleStyleModal.dataset.isColorSet = 'true';
            });
            aiFontColorInput.addEventListener('input', () => {
                bubbleStyleModal.dataset.isColorSet = 'true';
            });

            saveBubbleStyleBtn.addEventListener('click', () => {
                const chat = chats.find(c => c.id === activeChatId);
                if (chat) {
                    const isColorSet = bubbleStyleModal.dataset.isColorSet === 'true';

                    // 如果自定义颜色是启用的，就保存颜色值；否则，保存空字符串
                    chat.settings.userBubbleColor = isColorSet ? userBubbleColorInput.value : '';
                    chat.settings.aiBubbleColor = isColorSet ? aiBubbleColorInput.value : '';
                    chat.settings.userFontColor = isColorSet ? userFontColorInput.value : ''; // 新增
                    chat.settings.aiFontColor = isColorSet ? aiFontColorInput.value : '';   // 新增

                    chat.settings.customCss = customCssInput.value;
                    saveChats();
                    applyChatStyles(); // 应用刚刚保存的最新样式
                    bubbleStyleModal.classList.remove('visible');
                }
            });

            // 【新增】背景设置弹窗事件
            openBackgroundModalBtn.addEventListener('click', openBackgroundModal);
            backgroundPreview.addEventListener('click', () => backgroundUploadInput.click());
            backgroundUploadInput.addEventListener('change', handleBackgroundUpload);
            removeBackgroundBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // 防止触发 backgroundPreview 的点击事件
                backgroundPreview.style.backgroundImage = 'none';
                removeBackgroundBtn.style.display = 'none';
            });
            saveBackgroundBtn.addEventListener('click', () => {
                const chat = chats.find(c => c.id === activeChatId);
                if (chat) {
                    // 将样式中的url()提取出来
                    const bgStyle = backgroundPreview.style.backgroundImage;
                    chat.settings.background = bgStyle.startsWith('url') ? bgStyle.slice(5, -2) : '';
                    saveChats();
                    applyChatStyles();
                    backgroundModal.classList.remove('visible');
                }
            });

            // 【新增】关闭所有弹窗的通用逻辑
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) { // 点击背景关闭
                        modal.classList.remove('visible');
                    }
                });
                modal.querySelectorAll('.modal-cancel-btn, .modal-card-close-btn').forEach(btn => {
                    btn.addEventListener('click', () => modal.classList.remove('visible'));
                });
            });

            saveSettingsBtn.addEventListener('click', saveSettings);
            fetchModelsBtn.addEventListener('click', fetchModels);

            addContactBtn.addEventListener('click', openCreateContactModal);
            confirmCreateBtn.addEventListener('click', handleCreateNewContact);
            cancelCreateBtn.addEventListener('click', () => addContactModal.classList.remove('visible'));
            newContactNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleCreateNewContact();
            });

            sendBtn.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            generateBtn.addEventListener('click', handleGenerateReply);


            // ===================================================================
            // 【V1.50 新增】桌面交互事件监听
            // ===================================================================

            // 监听全局桌面文件上传工具
            desktopFileInput.addEventListener('change', handleDesktopImageUpload);

            // -- 图片上传事件绑定 --
            userCardBackground.addEventListener('click', () => {
                currentImageUploadTarget = 'userBackground';
                desktopFileInput.click();
            });
            userCardAvatar.addEventListener('click', () => {
                currentImageUploadTarget = 'userAvatar';
                desktopFileInput.click();
            });
            recordInner.addEventListener('click', () => {
                currentImageUploadTarget = 'recordInner';
                desktopFileInput.click();
            });
            capsuleIcon.addEventListener('click', () => {
                currentImageUploadTarget = 'capsuleIcon1';
                desktopFileInput.click();
            });

            // -- 文本编辑事件绑定 (已全部更新为新版) --
            userIdText.addEventListener('click', () => {
                editInPlace(userIdText, 'userId', 'Name');
            });
            userHandleText.addEventListener('click', () => {
                editInPlace(userHandleText, 'userHandle', '...', true);
            });
            userBioText.addEventListener('click', () => {
                editInPlace(userBioText, 'userBio', '自定义文案');
            });
            userLocationText.addEventListener('click', () => {
                editInPlace(userLocationText, 'userLocation', '...');
            });
            capsuleText.addEventListener('click', () => {
                editInPlace(capsuleText, 'capsuleText1', '');
            });

            // ===================================================================
            // 【V1.50 新增】桌面交互核心功能函数
            // ===================================================================

            /**
             * 【V1.81 最终修复版】保存桌面设置到 IndexedDB
             */
            async function saveDesktopSettings() {
                try {
                    // 保存通用的桌面文本和图片设置
                    await db.set('desktopSettings', desktopSettings);
                    // 单独保存桌面壁纸
                    await db.set('desktopWallpaper', desktopWallpaper);
                    // 单独保存应用图标设置
                    await db.set('desktopIconSettings', desktopIconSettings);
                } catch (error) {
                    console.error("Failed to save desktop data to IndexedDB:", error);
                    alert("保存桌面数据失败，可能是存储空间问题。");
                }
            }

            /**
             * 【V1.81 最终修复版】从 IndexedDB 加载桌面设置并应用
             */
            async function loadDesktopSettings() {
                // 加载通用设置
                const savedSettings = await db.get('desktopSettings') || {};
                desktopSettings = {
                    userBackground: savedSettings.userBackground || '',
                    userAvatar: savedSettings.userAvatar || '',
                    userId: savedSettings.userId || 'Name',
                    userHandle: savedSettings.userHandle || '...',
                    userBio: savedSettings.userBio || '自定义文案',
                    userLocation: savedSettings.userLocation || '...',
                    capsuleIcon1: savedSettings.capsuleIcon1 || '',
                    capsuleText1: savedSettings.capsuleText1 || '',
                    recordInner: savedSettings.recordInner || ''
                };

                // 单独加载桌面壁纸
                desktopWallpaper = await db.get('desktopWallpaper') || '';
                // 单独加载图标设置
                desktopIconSettings = await db.get('desktopIconSettings') || {};
            }

            /**
             * 将 desktopSettings 对象中的数据显示在界面上
             */
            function applyDesktopSettings() {
                // 应用桌面壁纸
                const homeScreen = document.getElementById('home-screen');
                if (desktopWallpaper) {
                    homeScreen.style.backgroundImage = `url(${desktopWallpaper})`;
                    homeScreen.style.backgroundSize = 'cover';
                    homeScreen.style.backgroundPosition = 'center';
                } else {
                    homeScreen.style.backgroundImage = 'none';
                    // 如果需要默认颜色，可以在这里设置
                    // homeScreen.style.backgroundColor = '#a8d8f0'; 
                }

                // 应用卡片背景图片
                if (desktopSettings.userBackground) {
                    userCardBackground.style.backgroundImage = `url(${desktopSettings.userBackground})`;
                    userCardBackground.style.backgroundSize = 'cover';
                    userCardBackground.style.backgroundPosition = 'center';
                } else {
                    userCardBackground.style.backgroundImage = 'none';
                }

                // 应用头像
                if (desktopSettings.userAvatar) {
                    userCardAvatar.style.backgroundImage = `url(${desktopSettings.userAvatar})`;
                    userCardAvatar.style.backgroundSize = 'cover';
                    userCardAvatar.style.backgroundPosition = 'center';
                    userCardAvatar.innerHTML = ''; // 清空默认的SVG图标
                }

                // 应用黑胶唱片图片
                if (desktopSettings.recordInner) {
                    recordInner.style.backgroundImage = `url(${desktopSettings.recordInner})`;
                    recordInner.style.backgroundSize = 'cover';
                    recordInner.style.backgroundPosition = 'center';
                } else {
                    recordInner.style.backgroundImage = 'none';
                }

                // 应用矩形条图标
                if (desktopSettings.capsuleIcon1) {
                    capsuleIcon.style.backgroundImage = `url(${desktopSettings.capsuleIcon1})`;
                } else {
                    capsuleIcon.style.backgroundImage = 'none';
                }

                // 应用所有文本
                userIdText.textContent = desktopSettings.userId;
                userHandleText.textContent = '@' + desktopSettings.userHandle;
                userBioText.textContent = desktopSettings.userBio;
                userLocationText.textContent = desktopSettings.userLocation;
                capsuleText.textContent = desktopSettings.capsuleText1;

                // 【核心新增】应用所有图标的自定义样式
                applyDesktopIconSettings();
            }

            /**
             * 处理所有桌面图片的上传
             * @param {Event} event - 文件输入框的 change 事件
             */
            function handleDesktopImageUpload(event) {
                const file = event.target.files[0];
                if (!file || !currentImageUploadTarget) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result; // 图片的 Base64 Data URL

                    // 根据之前记录的目标，更新设置并保存
                    desktopSettings[currentImageUploadTarget] = imageUrl;
                    saveDesktopSettings();

                    // 立即应用更改
                    applyDesktopSettings();
                };
                reader.readAsDataURL(file);
                desktopFileInput.value = ''; // 清空以便下次上传
            }

            /**
             * 【全新】通用文本原地编辑函数
             * @param {HTMLElement} element - 要修改的HTML元素
             * @param {string} settingKey - 在 desktopSettings 中对应的键名
             * @param {string} defaultValue - 默认文本
             * @param {boolean} isHandle - 是否是特殊处理的@handle
             */
            function editInPlace(element, settingKey, defaultValue, isHandle = false) {
                // 如果当前已经在编辑中，则阻止再次触发
                if (element.style.display === 'none') {
                    return;
                }

                const originalValue = desktopSettings[settingKey] || defaultValue;

                element.style.display = 'none'; // 隐藏原始文本

                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalValue;
                input.className = 'temp-edit-input';

                if (isHandle) {
                    input.value = desktopSettings[settingKey] || '...';
                }

                // 将输入框插入到原始文本后面
                element.parentNode.insertBefore(input, element.nextSibling);
                input.focus(); // 自动聚焦
                input.select(); // 全选文字方便修改

                // 定义保存和清理函数
                const saveAndCleanup = () => {
                    const newValue = input.value.trim();
                    const finalValue = (newValue === '') ? defaultValue : newValue;

                    desktopSettings[settingKey] = finalValue;
                    saveDesktopSettings();

                    if (isHandle) {
                        element.textContent = '@' + finalValue;
                    } else {
                        element.textContent = finalValue;
                    }

                    // 移除输入框，显示原始文本
                    input.remove();
                    element.style.display = '';
                };

                input.addEventListener('blur', saveAndCleanup); // 当输入框失去焦点时保存
                input.addEventListener('keypress', (e) => { // 当按下回车时保存
                    if (e.key === 'Enter') {
                        input.blur(); // 触发 blur 事件即可
                    }
                });
            }

            // ===================================================================
            // 【全新 V1.81 修复方案】表情系统独立“遥控器” (方案一) - 最终完整修复版
            // ===================================================================



            // --- 2. 编写全新的、独立的函数 ---
            async function saveStickers() {
                try {
                    await db.set('stickers', stickers); // 从 localStorage 改为 IndexedDB
                } catch (error) {
                    console.error("Failed to save stickers to IndexedDB:", error);
                    alert("保存表情数据失败，可能是存储空间问题。");
                }
            }

            async function loadStickers() {
                const savedStickers = await db.get('stickers'); // 从 localStorage 改为 IndexedDB
                stickers = savedStickers || [];
                renderStickerPanel();
            }

            function renderStickerPanel() {
                stickerGrid.innerHTML = '';
                const addBtnWrapper = document.createElement('div');
                addBtnWrapper.className = 'add-sticker-btn-wrapper';
                addBtnWrapper.innerHTML = `<svg t="1757458251149" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M902.343 570.936h-331.78v331.833c0 32.337-26.226 58.537-58.564 58.537-32.337 0-58.563-26.2-58.563-58.537V570.936H121.654c-32.364 0-58.564-26.2-58.564-58.538 0-32.325 26.203-58.537 58.564-58.537h331.78V122.028c0-32.325 26.226-58.537 58.563-58.537 32.338 0 58.564 26.213 58.564 58.537v331.834h331.78c32.364 0 58.565 26.211 58.565 58.535-0.001 32.337-26.2 58.536-58.565 58.536z" fill="#353333"></path></svg>`;
                stickerGrid.appendChild(addBtnWrapper);

                stickers.forEach(sticker => {
                    const stickerItem = document.createElement('div');
                    stickerItem.className = 'sticker-item';
                    stickerItem.dataset.stickerId = sticker.id;
                    stickerItem.dataset.stickerUrl = sticker.url;
                    stickerItem.innerHTML = `
                        <img src="${sticker.url}" alt="${sticker.name}" style="pointer-events: none;">
                        <button class="sticker-delete-btn" data-sticker-id="${sticker.id}" data-sticker-name="${sticker.name}">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="pointer-events: none;"><path d="M18 6L6 18M6 6l12 12" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    `;
                    stickerGrid.appendChild(stickerItem);
                });
            }

            function handleStickerFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    stickerFileAsDataUrl = e.target.result;
                    newStickerUrlInput.placeholder = "已选择本地图片，可忽略此链接框";
                };
                reader.readAsDataURL(file);
            }

            function openNewAddStickerModal(context = 'global') {
                currentStickerAddContext = context; // 核心：记录下当前的上下文
                newStickerNameInput.value = '';
                newStickerUrlInput.value = '';
                newStickerUrlInput.placeholder = "粘贴图片URL，或点击下方按钮上传";
                stickerFileAsDataUrl = null;
                stickerFileInput.value = '';
                newAddStickerModal.classList.add('visible');
            }

            // --- 3. 为新弹窗和面板绑定全新的、独立的事件 ---
            newStickerUploadBtn.addEventListener('click', () => stickerFileInput.click());

            // 【核心修复】为隐藏的文件选择框绑定 change 事件监听器
            stickerFileInput.addEventListener('change', handleStickerFileUpload);

            /**
             * 【全新 V1.97】处理世界书头像上传的专用函数
             */
            function handlePresetAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file || !currentImageUploadTarget) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    const targetType = currentImageUploadTarget.type;
                    const targetId = currentImageUploadTarget.id;

                    if (targetType === 'role') {
                        const preset = presets.roles.find(p => p.id === targetId);
                        if (preset) {
                            preset.avatar = imageUrl;
                        }
                    } else if (targetType === 'forbidden-words') {
                        // 【核心新增】为禁词数据对象添加头像URL
                        presets.forbiddenWords.avatar = imageUrl;
                    }

                    savePresets(); // 保存到 IndexedDB
                    renderRolePresetsPage(); // 刷新列表以显示新头像
                };
                reader.readAsDataURL(file);
            }

            // 【全新 V1.91 修复】将桌面文件上传逻辑整合到一个总的事件监听器中
            desktopFileInput.addEventListener('change', (event) => {
                // 如果没有设置上传目标，则直接返回
                if (!currentImageUploadTarget) return;

                // 根据不同的上传目标，调用不同的处理函数
                if (currentImageUploadTarget.type === 'role' || currentImageUploadTarget.type === 'forbidden-words') {
                    handlePresetAvatarUpload(event);
                }
                else if (currentImageUploadTarget.startsWith('polaroid-')) {
                    handlePolaroidPhotoUpload(event);
                } else if (currentImageUploadTarget === 'couple-background') {
                    handleCoupleBgUpload(event);
                } else if (currentImageUploadTarget.startsWith('icon-')) {
                    // 如果目标是应用图标，就调用我们刚刚创建的新函数
                    handleAppIconUpload(event);
                } else {
                    // 其他情况（如用户头像、卡片背景等）调用通用的桌面图片处理函数
                    handleDesktopImageUpload(event);
                }

                // 无论上传了什么，最后都要清空文件输入框，以便下次可以上传同一个文件
                desktopFileInput.value = '';
            });

            // 为弹窗的关闭和取消按钮添加事件
            newAddStickerModal.querySelector('.modal-card-close-btn').addEventListener('click', () => newAddStickerModal.classList.remove('visible'));
            newAddStickerModal.querySelector('.modal-cancel-btn').addEventListener('click', () => newAddStickerModal.classList.remove('visible'));

            // 【修改】为“保存表情”按钮绑定新的、更完善的逻辑
            newStickerSaveBtn.addEventListener('click', () => {
                const name = newStickerNameInput.value.trim();
                const url = newStickerUrlInput.value.trim();
                if (!name) { alert('请为表情命名！'); return; }
                if (!url && !stickerFileAsDataUrl) { alert('请提供图片链接或上传图片！'); return; }

                // 核心：检查我们之前记录的上下文
                if (currentStickerAddContext === 'pack') {
                    // 如果上下文是 'pack'，则调用添加到包的函数
                    addStickerToCurrentPack(name, stickerFileAsDataUrl || url);
                } else {
                    // 否则 (上下文是 'global')，执行添加到全局表情的逻辑
                    const newSticker = { id: 'sticker_' + Date.now(), name: name, url: stickerFileAsDataUrl || url };
                    stickers.push(newSticker);
                    saveStickers();
                    renderStickerPanel(); // 刷新聊天界面的表情面板
                }

                newAddStickerModal.classList.remove('visible');
            });

            // --- 4. 建立表情面板交互的全新“遥控器” (使用Pointer Events) - V1.81 最终修复版 ---
            let pressTimer = null;
            let isPressing = false;
            let hasMoved = false;

            stickerGrid.addEventListener('pointerdown', (e) => {
                // 【核心修复 #1】: 简化启动逻辑。只要是在 stickerGrid 内按下的，都启动计时器。
                isPressing = true;
                hasMoved = false;

                const stickerItem = e.target.closest('.sticker-item');
                // 长按逻辑只对表情项生效
                if (stickerItem) {
                    pressTimer = setTimeout(() => {
                        if (isPressing && !hasMoved) {
                            stickerItem.classList.toggle('show-delete');
                            stickerGrid.querySelectorAll('.sticker-item.show-delete').forEach(item => {
                                if (item !== stickerItem) item.classList.remove('show-delete');
                            });
                            isPressing = false;
                        }
                    }, 350);
                }
            });

            stickerGrid.addEventListener('pointermove', () => {
                if (isPressing) {
                    hasMoved = true;
                    clearTimeout(pressTimer);
                }
            });

            stickerGrid.addEventListener('pointerup', (e) => {
                if (isPressing && !hasMoved) {
                    e.preventDefault();

                    const addBtn = e.target.closest('.add-sticker-btn-wrapper');
                    const deleteBtn = e.target.closest('.sticker-delete-btn');
                    const stickerItem = e.target.closest('.sticker-item');

                    // 【核心修复 #2】: 现在的判断逻辑将完全正常
                    if (deleteBtn) {
                        const stickerId = deleteBtn.dataset.stickerId;
                        const stickerName = deleteBtn.dataset.stickerName;
                        showConfirmationModal(`确定要删除表情 “${stickerName}” 吗？`, () => {
                            stickers = stickers.filter(s => s.id !== stickerId);
                            saveStickers();
                            renderStickerPanel();
                        });
                    } else if (addBtn) {
                        openNewAddStickerModal('global'); // 明确指定上下文是 'global'
                    } else if (stickerItem) {
                        if (stickerItem.classList.contains('show-delete')) {
                            stickerItem.classList.remove('show-delete');
                        } else {
                            sendSticker(stickerItem.dataset.stickerUrl);
                        }
                    }
                }
                clearTimeout(pressTimer);
                isPressing = false;
            });

            stickerGrid.addEventListener('pointercancel', () => {
                clearTimeout(pressTimer);
                isPressing = false;
            });

            // 【新增】点击聊天界面空白处，取消表情删除状态
            document.getElementById('chat-interface-screen').addEventListener('click', (e) => {
                // 检查当前是否有表情处于删除模式，并且点击的不是表情网格内部
                const hasDeleteModeSticker = stickerGrid.querySelector('.sticker-item.show-delete');
                const isClickInsideGrid = stickerGrid.contains(e.target);

                if (hasDeleteModeSticker && !isClickInsideGrid) {
                    hasDeleteModeSticker.classList.remove('show-delete');
                }
            });

            // ===================================================================
            // 【全新】功能面板事件监听
            // ===================================================================
            moreFunctionsBtn.addEventListener('click', togglePanels); // 修改：使用新的总控制函数
            functionsNavPrev.addEventListener('click', () => navigateFunctionsPanel(-1));
            functionsNavNext.addEventListener('click', () => navigateFunctionsPanel(1));

            // ===================================================================
            // 【全新 V1.65】情侣空间事件监听
            // ===================================================================
            // 点击我方头像，触发文件上传
            myAvatarWrapper.addEventListener('click', () => {
                coupleAvatarUploadInput.click();
            });
            coupleAvatarUploadInput.addEventListener('change', handleCoupleAvatarUpload);

            // 点击对方“+”头像，渲染并跳转到邀请列表
            partnerAvatarWrapper.addEventListener('click', () => {
                // 【【【核心修复 V2.62】】】
                // 只有在未绑定状态下，点击才执行跳转逻辑
                if (!coupleSpaceSettings.partnerChatId) {
                    renderCoupleInviteList();
                    showScreen(partnerAvatarWrapper.dataset.target);
                } else {
                    // 如果已绑定，点击事件由另一个监听器处理（弹出解绑气泡）
                    // 这里不需要做任何事
                }
            });

            // 【新增】更新状态栏时间
            function updateTime() {
                const timeEl = document.getElementById('status-bar-time');
                if (timeEl) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    timeEl.textContent = `${hours}:${minutes}`;
                }
            }

            // ===================================================================
            // 【全新 V1.57】手机框显示/隐藏逻辑
            // ===================================================================

            /**
             * 根据传入的状态，应用或移除手机框样式
             * @param {boolean} show - 是否显示手机框
             */
            function applyPhoneFrameState(show) {
                // 获取html元素
                const htmlElement = document.documentElement;

                if (show) {
                    document.body.classList.add('phone-frame-visible');
                    htmlElement.classList.add('phone-frame-visible'); // 【新增】给html也加上类
                } else {
                    document.body.classList.remove('phone-frame-visible');
                    htmlElement.classList.remove('phone-frame-visible'); // 【新增】从html移除类
                }
                // 确保开关的状态与实际显示状态同步
                if (phoneFrameToggle) {
                    phoneFrameToggle.checked = show;
                }
            }

            /**
             * 【V1.81 最终修复版】从 IndexedDB 加载手机框的设置
             */
            async function loadPhoneFrameSetting() {
                const shouldShowFrame = await db.get('showPhoneFrame');
                // 如果数据库中没有值(undefined)，则默认为 false
                applyPhoneFrameState(shouldShowFrame === true);
            }

            // --- 事件监听 ---
            // 为手机框开关绑定事件 (使用 IndexedDB)
            if (phoneFrameToggle) {
                phoneFrameToggle.addEventListener('change', async () => { // 修改为 async
                    const shouldShow = phoneFrameToggle.checked;
                    await db.set('showPhoneFrame', shouldShow); // 修改
                    applyPhoneFrameState(shouldShow);
                });
            }
            // ===================================================================
            // 【全新 V2.21】世界书功能事件监听 (重构版)
            // ===================================================================
            // --- 页面切换与顶部按钮控制 ---
            const addNewRoleBtn = document.getElementById('add-new-role-btn');
            const addNewOfflinePresetBtn = document.getElementById('add-new-offline-preset-btn');

            presetBottomNav.addEventListener('click', (e) => {
                const navItem = e.target.closest('.preset-nav-item');
                if (!navItem) return;

                presetBottomNav.querySelectorAll('.preset-nav-item').forEach(item => item.classList.remove('active'));
                presetPages.forEach(page => page.classList.remove('active'));

                const pageName = navItem.dataset.page;
                navItem.classList.add('active');
                document.getElementById(`preset-page-${pageName}`).classList.add('active');

                // 【核心】根据页面控制“+”号的显隐
                addNewRoleBtn.style.display = (pageName === 'role') ? 'flex' : 'none';
                addNewOfflinePresetBtn.style.display = (pageName === 'offline') ? 'flex' : 'none';

                // 【新增】素材页面没有顶栏加号，所以切换到其他页面时要确保它们是隐藏的
                if (pageName === 'assets') {
                    addNewRoleBtn.style.display = 'none';
                    addNewOfflinePresetBtn.style.display = 'none';
                }
            });

            // --- 列表页事件委托 ---
            presetPageRole.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');
                const avatar = target.closest('.preset-list-avatar');

                if (button) {
                    const action = button.dataset.action;
                    const id = button.dataset.id;
                    if (action === 'edit-role') openRolePresetEditor(id);
                    else if (action === 'delete-role') {
                        showConfirmationModal(`确定要删除该角色吗？`, () => {
                            presets.roles = presets.roles.filter(p => p.id !== id);
                            savePresets();
                            renderRolePresetsPage();
                        });
                    } else if (action === 'edit-forbidden-words') {
                        openForbiddenWordsEditor();
                    }
                } else if (avatar) {
                    currentImageUploadTarget = { type: avatar.dataset.type, id: avatar.dataset.id };
                    desktopFileInput.click();
                }
            });

            // 【【【核心新增】】】为“预设”页面添加事件委托
            const presetPageOffline = document.getElementById('preset-page-offline');
            presetPageOffline.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');

                if (target.matches('input[data-action="toggle-offline-preset"]')) {
                    const id = target.dataset.id;
                    const preset = presets.offlines.find(p => p.id === id);
                    if (preset) {
                        preset.enabled = target.checked;
                        savePresets();
                    }
                } else if (button) {
                    const action = button.dataset.action;
                    const id = button.dataset.id;
                    if (action === 'edit-offline-preset') {
                        openOfflinePresetEditor(id);
                    } else if (action === 'delete-offline-preset') {
                        showConfirmationModal(`确定要删除该预设吗？`, () => {
                            presets.offlines = presets.offlines.filter(p => p.id !== id);
                            savePresets();
                            renderOfflinePresetsPage();
                        });
                    }
                }
            });


            // --- 编辑器开启 ---
            addNewRoleBtn.addEventListener('click', () => openRolePresetEditor(null));
            addNewOfflinePresetBtn.addEventListener('click', () => openOfflinePresetEditor(null));

            // --- 编辑器保存 ---
            saveRolePresetBtn.addEventListener('click', () => {
                const name = presetNameText.textContent.trim();
                if (!name) {
                    alert('名称不能为空！');
                    return;
                }
                // 【核心修改】从 textarea 直接获取值
                const content = document.getElementById('preset-content-text').value.trim();
                const selectedAssociations = Array.from(presetDropdownList.querySelectorAll('input:checked')).map(input => input.dataset.id);

                if (currentEditingPresetId) { // 编辑
                    const preset = presets.roles.find(p => p.id === currentEditingPresetId);
                    if (preset) {
                        preset.name = name;
                        preset.content = content;
                        preset.associations = selectedAssociations;
                    }
                } else { // 创建
                    presets.roles.push({
                        id: 'role_' + Date.now(), name, content, avatar: '',
                        associations: selectedAssociations
                    });
                }
                savePresets();
                renderRolePresetsPage();
                showScreen('world-book-screen');
            });

            // 【【【核心新增】】】保存预设
            const saveOfflinePresetBtn = document.getElementById('save-offline-preset-btn');
            saveOfflinePresetBtn.addEventListener('click', () => {
                const name = document.getElementById('preset-offline-name-text').textContent.trim();
                if (!name) { alert('名称不能为空！'); return; }

                const presetData = {
                    name: name,
                    // 【核心修改】从 textarea 直接获取值
                    prompt: document.getElementById('preset-offline-content-text').value.trim(),
                    mode: document.getElementById('preset-offline-mode-select').value,
                    role: document.getElementById('preset-offline-role-select').value,
                    position: document.getElementById('preset-offline-position-select').value,
                    enabled: true // 新建或保存时默认开启
                };

                if (currentEditingOfflinePresetId) { // 编辑
                    const index = presets.offlines.findIndex(p => p.id === currentEditingOfflinePresetId);
                    if (index > -1) {
                        presets.offlines[index] = { ...presets.offlines[index], ...presetData };
                    }
                } else { // 创建
                    presets.offlines.push({ id: 'offline_' + Date.now(), ...presetData });
                }
                savePresets();
                renderOfflinePresetsPage();
                showScreen('world-book-screen');
            });

            saveForbiddenWordsBtn.addEventListener('click', () => {
                presets.forbiddenWords.position = forbiddenWordsPositionSelect.value;
                presets.forbiddenWords.content = forbiddenWordsContentInput.value.trim();
                savePresets();
                alert('禁词已保存！');
                showScreen('world-book-screen');
            });

            // --- 编辑器内的交互 ---
            presetNameContainer.addEventListener('click', () => presetEditInPlace(presetNameContainer, presetNameText, false));
            // 【核心删除】移除对内容框的旧版原地编辑绑定
            // presetContentContainer.addEventListener('click', () => presetEditInPlace(presetContentContainer, presetContentText, true));

            // 【核心删除】移除对预设编辑器的旧版原地编辑绑定
            document.getElementById('preset-offline-name-container').addEventListener('click', (e) => presetEditInPlace(e.currentTarget, document.getElementById('preset-offline-name-text'), false));
            // document.getElementById('preset-offline-content-container').addEventListener('click', (e) => presetEditInPlace(e.currentTarget, document.getElementById('preset-offline-content-text'), true));

            presetDropdownHeader.addEventListener('click', () => {
                presetDropdownContainer.classList.toggle('expanded');
            });
            presetDropdownList.addEventListener('change', () => {
                const count = presetDropdownList.querySelectorAll('input:checked').length;
                updateDropdownLabel(count);
            });

            /**
* 【【【全新安全网】】】一个更强大的、能容错的AI JSON响应解析器
* @param {string} jsonString - AI返回的、可能不完整的JSON字符串
* @returns {Array} - 一个标准化的消息对象数组
*/
            function parseAiJsonResponse(jsonString) {
                let text = jsonString.trim();

                // 策略1: 优先清理最常见的污染
                text = text.replace(/^```json\s*/, '').replace(/```$/, '').trim();

                // 策略2: 尝试直接解析
                try {
                    const parsed = JSON.parse(text);
                    if (Array.isArray(parsed)) return parsed;
                } catch (e) {
                    // 如果直接解析失败，启动救援策略
                }

                // 策略3: 救援 - 提取所有独立的 {} JSON对象
                // 这个正则表达式可以从混乱的文本中，像钓鱼一样把所有完整的JSON对象钓出来
                const jsonObjects = text.match(/{[^{}]*:[^}]*}/g);
                if (jsonObjects) {
                    const results = [];
                    jsonObjects.forEach(objStr => {
                        try {
                            results.push(JSON.parse(objStr));
                        } catch (e) {
                            console.warn('跳过一个无法解析的JSON片段:', objStr);
                        }
                    });
                    if (results.length > 0) {
                        console.log(`JSON救援成功, 提取到 ${results.length} 个对象。`);
                        return results;
                    }
                }

                // 策略4: 最后的防线 - 将整个回复视为单条纯文本消息
                console.error("所有JSON解析策略均失败！将回复视为纯文本。原始回复:", jsonString);
                return [{ type: 'text', content: jsonString }];
            }

            // --- 初始化 (V1.92 最终性能优化版) ---
            async function initializeApp() {
                // 【第一步：缓存】在所有操作开始前，一次性查找并缓存所有图标元素及其默认SVG
                const iconConfig = [
                    { key: 'chat', elements: document.querySelectorAll('.new-app-icon[data-target="chat-list-screen"], .app-icon-preview[data-icon-key="chat"]') },
                    { key: 'forum', elements: document.querySelectorAll('#main-apps-container .new-app-icon:nth-child(2), .app-icon-preview[data-icon-key="forum"]') },
                    { key: 'worldbook', elements: document.querySelectorAll('.new-app-icon[data-target="world-book-screen"], .app-icon-preview[data-icon-key="worldbook"]') },
                    { key: 'couple', elements: document.querySelectorAll('#main-apps-container .new-app-icon:nth-child(4), .app-icon-preview[data-icon-key="couple"]') },
                    { key: 'settings', elements: document.querySelectorAll('.new-app-icon[data-target="main-settings-screen"], .app-icon-preview[data-icon-key="settings"]') },
                    { key: 'camera', elements: document.querySelectorAll('#bottom-dock .new-app-icon:nth-child(2), .app-icon-preview[data-icon-key="camera"]') },
                    { key: 'message', elements: document.querySelectorAll('#bottom-dock .new-app-icon:nth-child(3), .app-icon-preview[data-icon-key="message"]') },
                    { key: 'phone', elements: document.querySelectorAll('#bottom-dock .new-app-icon:nth-child(4), .app-icon-preview[data-icon-key="phone"]') },
                ];

                iconConfig.forEach(config => {
                    // 将查找到的元素列表存入我们的“地图”
                    iconConfigMap[config.key] = config.elements;
                    // 同时，从第一个找到的元素中备份默认SVG
                    if (config.elements.length > 0 && config.elements[0]) {
                        defaultIconSVGs[config.key] = config.elements[0].innerHTML;
                    }
                });

                // 【第二步：加载数据】使用 await 确保每个加载函数都执行完毕后，再进行下一步
                await loadSettings();
                await loadChats();
                await loadStickers();
                await loadDesktopSettings();
                await loadCoupleSpaceSettings();
                await loadFontSettings();
                await loadPresets(); // 【新增】加载世界书数据
                await loadPhoneFrameSetting();
                await loadMePageData(); // 【【【全新】】】 加载“Me”页面的数据
                applyMePageData(); // 【【【全新】】】 将加载的数据应用到UI上

                // --- 【【【全新】】】为插入弹窗绑定事件 ---
                insertActionsContainer.addEventListener('click', (e) => {
                    const actionBtn = e.target.closest('.insert-action-btn');
                    if (actionBtn) {
                        const action = actionBtn.dataset.action;
                        if (action === 'add-above') {
                            addNewMessageInModal('above');
                        } else if (action === 'add-below') {
                            addNewMessageInModal('below');
                        }
                    }
                });

                insertPreviewContainer.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.insert-delete-btn');
                    if (deleteBtn) {
                        const itemWrapper = deleteBtn.closest('.insert-preview-item');
                        const tempId = itemWrapper.dataset.tempId;
                        insertMode.tempMessages = insertMode.tempMessages.filter(m => m.id !== tempId);
                        renderInsertPreview();
                    }
                });

                insertModalSaveBtn.addEventListener('click', saveInsertedMessages);
                insertModalCancelBtn.addEventListener('click', closeInsertModal);
                insertModalCloseBtn.addEventListener('click', closeInsertModal);

                // --- 【【【全新】】】为多选顶栏按钮绑定事件 ---
                document.getElementById('multi-select-cancel-btn').addEventListener('click', exitMultiSelectMode);
                document.getElementById('multi-select-delete-btn').addEventListener('click', deleteSelectedMessages);

                // 【第三步：渲染界面】现在所有数据都已加载，所有元素都已缓存，可以安全地进行界面渲染了
                applyGlobalFontStyles();
                await loadAndApplyCoupleTheme(); // 这个函数现在也应该是 async 的
                applyDesktopSettings();        // 这个函数会调用 applyDesktopIconSettings
                updateTotalUnreadBadge(); // 【【【核心新增】】】 初始化时就计算并显示总未读数
                renderStatusFeed(); // 【【【全新】】】 初始化时渲染动态列表

                // 【第四步：启动】所有界面都渲染完毕，最后再显示屏幕和启动定时器
                updateTime();
                setInterval(updateTime, 1000);
                showScreen('home-screen');
            }


            // ===================================================================
            // 【【【全新】】】发布动态与渲染核心功能
            // ===================================================================

            /**
             * 渲染整个动态消息流
             */
            function renderStatusFeed() {
                const feedContainer = document.getElementById('couple-status-feed');
                if (!feedContainer) return;

                feedContainer.innerHTML = ''; // 清空
                const statuses = coupleSpaceSettings.statuses || [];

                // 从最新到最旧渲染
                [...statuses].reverse().forEach(status => {
                    const postCard = document.createElement('div');
                    postCard.className = 'status-post-card';

                    // 格式化时间
                    const date = new Date(status.timestamp);
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const formattedTime = `${month}-${day} ${hours}:${minutes}`;

                    postCard.innerHTML = `
                        <div class="status-post-header">
                            <img src="${status.avatar}" class="status-post-avatar">
                            <div class="status-post-user-info">
                                <p class="status-post-username">${status.name}</p >
                                <span class="status-post-timestamp">${formattedTime}</span>
                            </div>
                        </div>
                        <p class="status-post-content">${status.content}</p >
                        <div class="status-post-actions">
                            <div class="like-btn-wrapper ${status.isLiked ? 'liked' : ''}" data-status-id="${status.id}">
                                <svg class="heart-outline" t="1758886757594" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7994" width="18" height="18"><path d="M667.786667 117.333333C832.864 117.333333 938.666667 249.706667 938.666667 427.861333c0 138.250667-125.098667 290.506667-371.573334 461.589334a96.768 96.768 0 0 1-110.186666 0C210.432 718.368 85.333333 566.112 85.333333 427.861333 85.333333 249.706667 191.136 117.333333 356.213333 117.333333c59.616 0 100.053333 20.832 155.786667 68.096C567.744 138.176 608.170667 117.333333 667.786667 117.333333z m0 63.146667c-41.44 0-70.261333 15.189333-116.96 55.04-2.165333 1.845333-14.4 12.373333-17.941334 15.381333a32.32 32.32 0 0 1-41.770666 0c-3.541333-3.018667-15.776-13.536-17.941334-15.381333-46.698667-39.850667-75.52-55.04-116.96-55.04C230.186667 180.48 149.333333 281.258667 149.333333 426.698667 149.333333 537.6 262.858667 675.242667 493.632 834.826667a32.352 32.352 0 0 0 36.736 0C761.141333 675.253333 874.666667 537.6 874.666667 426.698667c0-145.44-80.853333-246.218667-206.88-246.218667z" fill="#ffe5a5" p-id="7995"></path></svg>
                                <svg class="heart-filled" t="1758886770876" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8300" width="18" height="18"><path d="M667.786667 117.333333C832.864 117.333333 938.666667 249.706667 938.666667 427.861333c0 138.250667-125.098667 290.506667-371.573334 461.589334a96.768 96.768 0 0 1-110.186666 0C210.432 718.368 85.333333 566.112 85.333333 427.861333 85.333333 249.706667 191.136 117.333333 356.213333 117.333333c59.616 0 100.053333 20.832 155.786667 68.096C567.744 138.176 608.170667 117.333333 667.786667 117.333333z" fill="#ffe5a5" p-id="8301"></path></svg>
                            </div>
                            <div class="delete-status-btn" data-status-id="${status.id}">
                                <svg t="1758793185605" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11305" width="17" height="17"><path d="M377.6 153.6h268.8c22.4 0 44.8-17.9 44.8-44.8 0-22.4-17.9-44.8-44.8-44.8H377.6c-22.4 0-44.8 17.9-44.8 44.8 0 22.4 17.9 44.8 44.8 44.8z m537.6 35.8H108.8c-22.4 0-44.8 17.9-44.8 44.8 0 22.4 17.9 44.8 44.8 44.8h53.8v555.5c0 67.2 58.2 125.4 125.4 125.4h448c67.2 0 125.4-58.2 125.4-125.4V279h53.8c22.4 0 44.8-17.9 44.8-44.8 0 22.4-17.9-44.8-44.8-44.8zM789.8 834.6c0 31.4-22.4 53.8-53.8 53.8H288c-31.4 0-53.8-22.4-53.8-53.8V279h555.5v555.6z m-398.6-63.2c22.1 0 44.2-18.9 44.2-47.2V441.3c0-23.6-17.7-47.2-44.2-47.2-22.1 0-44.2 18.9-44.2 47.2v282.9c-0.1 23.6 17.6 47.2 44.2 47.2z m194.5 0c22.1 0 44.2-18.9 44.2-47.2V441.3c0-23.6-17.7-47.2-44.2-47.2-22.1 0-44.2 18.9-44.2 47.2v282.9c0 23.6 22.1 47.2 44.2 47.2z" fill="#ffe5a5" p-id="11306"></path></svg>
                            </div>
                        </div>
                        
                        <!-- 【核心新增】评论区容器 -->
                        <div class="status-post-comments-list">
                            ${(status.comments && status.comments.length > 0) ? status.comments.map(comment => `
                                <div class="comment-item">
                                    <span class="comment-content">
                                        <span class="commenter-name">${comment.commenterName}：</span>${comment.content}
                                    </span>
                                    <div class="comment-delete-btn" data-status-id="${status.id}" data-comment-id="${comment.id}">
                                        <svg t="1758793185605" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11305" width="17" height="17"><path d="M377.6 153.6h268.8c22.4 0 44.8-17.9 44.8-44.8 0-22.4-17.9-44.8-44.8-44.8H377.6c-22.4 0-44.8 17.9-44.8 44.8 0 22.4 17.9 44.8 44.8 44.8z m537.6 35.8H108.8c-22.4 0-44.8 17.9-44.8 44.8 0 22.4 17.9 44.8 44.8 44.8h53.8v555.5c0 67.2 58.2 125.4 125.4 125.4h448c67.2 0 125.4-58.2 125.4-125.4V279h53.8c22.4 0 44.8-17.9 44.8-44.8 0 22.4-17.9-44.8-44.8-44.8zM789.8 834.6c0 31.4-22.4 53.8-53.8 53.8H288c-31.4 0-53.8-22.4-53.8-53.8V279h555.5v555.6z m-398.6-63.2c22.1 0 44.2-18.9 44.2-47.2V441.3c0-23.6-17.7-47.2-44.2-47.2-22.1 0-44.2 18.9-44.2 47.2v282.9c-0.1 23.6 17.6 47.2 44.2 47.2z m194.5 0c22.1 0 44.2-18.9 44.2-47.2V441.3c0-23.6-17.7-47.2-44.2-47.2-22.1 0-44.2 18.9-44.2 47.2v282.9c0 23.6 22.1 47.2 44.2 47.2z" fill="#ffe5a5" p-id="11306"></path></svg>
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>

                        <div class="status-post-divider"></div>
                        <div class="status-post-comment-area" data-status-id="${status.id}">
                            <img src="${coupleSpaceSettings.myAvatar || 'https://tc.z.wiki/autoupload/f/6Acfaf5snU3W5EM9A3dcliMqqis0rwPOdE2pkJCFqrWyl5f0KlZfm6UsKj-HyTuv/20250911/GcRW/1206X1185/IMG_7210.jpeg/webp'}" class="status-post-comment-avatar">
                            <input type="text" class="status-post-comment-input" placeholder="说点什么吧...">
                            <span class="status-post-comment-send">发送</span>
                        </div>
                    `;
                    feedContainer.appendChild(postCard);
                    // 【【【全新 V3.8】】】为动态卡片添加点赞事件监听
                    const likeBtn = postCard.querySelector('.like-btn-wrapper');
                    if (likeBtn) {
                        likeBtn.addEventListener('click', () => {
                            const statusId = likeBtn.dataset.statusId;
                            const statusToUpdate = coupleSpaceSettings.statuses.find(s => s.id === statusId);

                            if (statusToUpdate) {
                                // 切换点赞状态
                                statusToUpdate.isLiked = !statusToUpdate.isLiked;

                                // 立即更新UI，触发动画
                                likeBtn.classList.toggle('liked');

                                // 保存更改
                                saveCoupleSpaceSettings();
                            }
                        });
                    }
                    // 【【【全新 V3.8.1】】】为动态卡片添加删除事件监听
                    const deleteBtn = postCard.querySelector('.delete-status-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            const statusId = deleteBtn.dataset.statusId;

                            // 调用通用的确认弹窗
                            showConfirmationModal('确定要删除这条动态吗？此操作不可撤销。', () => {
                                // 查找要删除的动态在数组中的索引
                                const indexToDelete = coupleSpaceSettings.statuses.findIndex(s => s.id === statusId);

                                if (indexToDelete > -1) {
                                    // 从数组中移除该动态
                                    coupleSpaceSettings.statuses.splice(indexToDelete, 1);

                                    // 保存更改
                                    saveCoupleSpaceSettings();

                                    // 重新渲染动态列表
                                    renderStatusFeed();
                                }
                            });
                        });
                    }
                });
            }



            // ===================================================================
            // 【【【全新】】】发布动态弹窗事件监听
            // ===================================================================
            const statusModalPublishBtn = postStatusModal.querySelector('.status-modal-action-btn.publish');
            const statusModalTextarea = postStatusModal.querySelector('.status-modal-textarea');

            // 点击“发动态”按钮，显示弹窗
            postStatusBtn.addEventListener('click', () => {
                postStatusModal.classList.add('visible');
            });

            // 点击“发布”按钮
            statusModalPublishBtn.addEventListener('click', () => {
                const content = statusModalTextarea.value.trim();
                if (!content) {
                    alert('动态内容不能为空哦！');
                    return;
                }

                // 找到当前用户的聊天设置来获取名字和头像
                const currentChat = chats.find(c => c.id === coupleSpaceSettings.partnerChatId);
                const userName = currentChat ? (currentChat.settings.userName || '我') : '我';
                const userAvatar = coupleSpaceSettings.myAvatar;

                const newStatus = {
                    id: 'status_' + Date.now() + Math.random(), // 【核心修复】确保ID绝对唯一
                    content: content,
                    timestamp: Date.now(),
                    name: userName,
                    avatar: userAvatar,
                    likes: [],
                    isLiked: false,
                    comments: [] // 【核心新增】为新动态添加一个空的 comments 数组
                };

                coupleSpaceSettings.statuses.push(newStatus);
                saveCoupleSpaceSettings(); // 保存到数据库
                renderStatusFeed(); // 重新渲染动态列表

                // 清理并关闭弹窗
                statusModalTextarea.value = '';
                postStatusModal.classList.remove('visible');
            });

            // 点击弹窗的“关闭”按钮，隐藏弹窗
            statusModalCloseBtn.addEventListener('click', () => {
                postStatusModal.classList.remove('visible');
            });

            // 点击弹窗的“取消”按钮，隐藏弹窗
            statusModalCancelBtn.addEventListener('click', () => {
                postStatusModal.classList.remove('visible');
            });

            /**
 * 【【【全新 V3.9.2】】】 辅助函数：检查两个时间戳是否在同一天
 * @param {number} ts1 - 时间戳1
 * @param {number} ts2 - 时间戳2
 * @returns {boolean}
 */
            function isSameDay(ts1, ts2) {
                const date1 = new Date(ts1);
                const date2 = new Date(ts2);
                return date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate();
            }

            // ===================================================================
            // 【【【全新 V3.9】】】添加状态弹窗核心功能函数
            // ===================================================================

            /**
             * 打开添加状态弹窗
             */
            function openAddStatusModal() {
                // 1. 重置状态
                currentStatusData = {
                    subject: 'user' // 默认是“自己”
                };
                statusSubjectSelector.textContent = '自己';
                statusTimeInput.value = '';
                statusContentInput.value = '';

                // 2. 更新并清空下拉框显示
                const selectedIconDiv = statusDropdownHeader.querySelector('.status-dropdown-selected-icon');
                const selectedTextSpan = statusDropdownHeader.querySelector('.status-dropdown-selected-text');
                selectedIconDiv.innerHTML = '';
                selectedTextSpan.textContent = '';
                statusDropdownContainer.classList.remove('expanded');

                // 3. 动态填充下拉列表
                statusDropdownList.innerHTML = '';
                statusOptions.forEach(option => {
                    const item = document.createElement('div');
                    item.className = 'status-dropdown-item';
                    item.dataset.id = option.id;
                    item.innerHTML = `
                        <div class="status-dropdown-item-icon">${option.svg}</div>
                        <span class="status-dropdown-item-text">${option.text}</span>
                    `;
                    statusDropdownList.appendChild(item);
                });

                // 4. 显示弹窗
                addStatusModal.classList.add('visible');
            }

            /**
             * 保存新添加的状态消息
             */
            function saveNewStatusMessage() {
                const time = statusTimeInput.value.trim();
                const content = statusContentInput.value.trim();
                const partnerId = coupleSpaceSettings.partnerChatId;
                const partnerChat = chats.find(c => c.id === partnerId);

                // 1. 数据验证
                if (!currentStatusData.id) {
                    alert('请先选择一个状态类型！');
                    return;
                }
                if (!/^([01]\d|2[0-3]):([0-5]\d)$/.test(time)) {
                    alert('请输入有效的24小时制时间，格式为 HH:MM，例如 21:23');
                    return;
                }
                if (!content) {
                    alert('自定义内容不能为空！');
                    return;
                }
                if (!partnerChat) return;

                // 2. 组装新消息对象
                const subjectName = currentStatusData.subject === 'user'
                    ? (partnerChat.settings.userName || '我')
                    : (partnerChat.settings.aiName || 'TA');

                const newStatusMessage = {
                    id: 'sys_status_' + Date.now() + Math.random(), // 确保ID唯一
                    type: 'system_status', // 标记为新类型
                    timestamp: Date.now(), // 使用当前时间戳用于排序
                    customTime: time, // 保存用户输入的时间用于显示
                    iconSvg: currentStatusData.svg,
                    subjectName: subjectName,
                    content: content
                };

                // 3. 保存数据
                if (!coupleStatusMessages[partnerId]) {
                    coupleStatusMessages[partnerId] = [];
                }
                coupleStatusMessages[partnerId].push(newStatusMessage);

                // 按照自定义时间进行排序
                coupleStatusMessages[partnerId].sort((a, b) => {
                    const timeA = a.customTime ? a.customTime.replace(':', '') : formatMessageTime(a.timestamp).replace(':', '');
                    const timeB = b.customTime ? b.customTime.replace(':', '') : formatMessageTime(b.timestamp).replace(':', '');
                    return parseInt(timeA) - parseInt(timeB);
                });

                saveCoupleSpaceSettings();

                // 4. 刷新界面并关闭弹窗
                renderStatusMessages(); // 【核心修复】移除 true，使用默认模式刷新
                addStatusModal.classList.remove('visible');

                // 【【【核心新增 V3.9.3】】】添加新状态后，强制滚动到底部
                setTimeout(() => {
                    coupleStatusMessageContainer.scrollTop = coupleStatusMessageContainer.scrollHeight;
                }, 50);
            }

            // ===================================================================
            // 【【【全新 V2.62 & V3.9.5】】】情侣空间与状态页事件监听（集成版）
            // ===================================================================

            // 【【【全新 V3.9.5】】】为新的删除模式按钮绑定事件
            statusDirectDeleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // 阻止事件冒泡到父级
                coupleStatusDetailScreen.classList.toggle('direct-delete-mode');
            });

            // 监听对方头像的点击事件，用于显示/隐藏解绑气泡
            partnerAvatarWrapper.addEventListener('click', (e) => {
                // 如果点击的是气泡内部，则不处理，交由气泡自己的按钮处理
                if (e.target.closest('.breakup-popup')) {
                    return;
                }

                // 只有在已绑定状态下才响应
                if (coupleSpaceSettings.partnerChatId) {
                    // 【【【核心修改】】】使用 if/else 代替 toggle，以便调用新函数
                    if (partnerAvatarWrapper.classList.contains('popup-active')) {
                        // 这里我们不需要用新函数，因为它没有 visibility:hidden，CSS过渡本身就能处理好
                        partnerAvatarWrapper.classList.remove('popup-active');
                    } else {
                        partnerAvatarWrapper.classList.add('popup-active');
                    }
                }
            });

            // 【【【全新增补】】】点击页面其他地方关闭解除关系小气泡
            document.body.addEventListener('click', (e) => {
                if (partnerAvatarWrapper.classList.contains('popup-active') && !partnerAvatarWrapper.contains(e.target)) {
                    partnerAvatarWrapper.classList.remove('popup-active');
                }
            });

            // 监听解绑气泡上的关闭按钮
            breakupCloseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const partnerChat = chats.find(c => c.id === coupleSpaceSettings.partnerChatId);
                const partnerName = partnerChat ? partnerChat.name : '对方';

                // 【修复问题6】调用通用的确认弹窗
                showConfirmationModal(`确定要与 ${partnerName} 解除关系吗？历史记录将会清空`, () => {
                    handleBreakup();
                });
            });

            // 监听消息页面中“状态”消息条的点击事件
            document.querySelector('.couple-message-item[data-target="couple-status-detail-screen"]').addEventListener('click', () => {
                openStatusDetailScreen();
            });

            // 状态详情页输入框交互
            statusInputPlaceholder.addEventListener('click', () => {
                statusInputPlaceholder.style.display = 'none';
                statusInputActiveWrapper.style.display = 'flex';
                statusMessageInput.focus();

                // 【核心动画修复】使用 requestAnimationFrame 确保浏览器先渲染出“小”状态
                // 然后在下一帧添加 'input-active' 类，从而触发撑开动画。
                requestAnimationFrame(() => {
                    statusInputActiveWrapper.classList.add('input-active');
                });
            });
            statusMessageInput.addEventListener('blur', () => {
                if (statusMessageInput.value.trim() === '') {
                    // 【核心修改】移除激活 class，触发收起动画
                    statusInputActiveWrapper.classList.remove('input-active');
                    // 使用一个短暂的延迟来等待动画播放完毕
                    setTimeout(() => {
                        statusInputActiveWrapper.style.display = 'none';
                        statusInputPlaceholder.style.display = 'flex';
                    }, 300); // 这个时间(300毫秒)要和CSS里的动画时长一致
                }
            });
            statusMessageInput.addEventListener('input', () => {
                statusMessageInput.style.height = 'auto';
                statusMessageInput.style.height = (statusMessageInput.scrollHeight) + 'px';
            });
            statusSendBtn.addEventListener('click', sendStatusMessage);
            statusMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendStatusMessage();
                }
            });
            // 【【【全新】】】点击状态详情页的非输入区，自动收起输入框
            coupleStatusDetailScreen.addEventListener('click', (e) => {
                const inputArea = document.getElementById('couple-status-input-area');
                const activeWrapper = document.getElementById('status-input-active-wrapper');

                // 检查：1.输入框当前是否是激活状态 2.点击的目标不是输入框区域本身
                if (inputArea.classList.contains('input-active') && !activeWrapper.contains(e.target)) {
                    // 只有当输入框内容为空时，点击外部才收起
                    if (statusMessageInput.value.trim() === '') {
                        inputArea.classList.remove('input-active');
                    }
                }
            });
            // 状态详情页右上角菜单
            coupleStatusOptionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (coupleStatusContextMenu.classList.contains('visible')) {
                    hideWithTransition(coupleStatusContextMenu, 'visible');
                } else {
                    coupleStatusContextMenu.style.visibility = 'visible';
                    coupleStatusContextMenu.classList.add('visible');
                }
            });

            // 【【【新增 V3.9】】】为菜单项添加事件委托
            coupleStatusContextMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.status-menu-item');
                if (!item) return;

                const action = item.dataset.action;

                // 不管点击哪个，都先收起菜单
                hideWithTransition(coupleStatusContextMenu, 'visible');

                switch (action) {
                    case 'add-status':
                        // 使用一个微小延迟，确保菜单收起动画播放完毕后再打开弹窗
                        setTimeout(openAddStatusModal, 200);
                        break;
                    case 'reply':
                        // 这里可以放“回复”功能的代码（如果未来需要）
                        break;
                    case 'status':
                        // 这里可以放“状态”功能的代码（如果未来需要）
                        break;
                    case 'history':
                        // 这里可以放“历史”功能的代码（如果未来需要）
                        break;
                }
            });


            // ===================================================================
            // 【【【全新 V2.62】】】情侣空间与状态页事件监听
            // ===================================================================


            // 使用事件委托来处理消息的点击
            coupleStatusMessageContainer.addEventListener('click', (e) => {
                // 【【【核心修改 V3.9.5：增加对新删除图标的判断】】】
                const directDeleteIcon = e.target.closest('.status-direct-delete-icon');

                if (directDeleteIcon) {
                    e.stopPropagation(); // 阻止事件冒泡
                    const msgId = directDeleteIcon.dataset.messageId;

                    const partnerId = coupleSpaceSettings.partnerChatId;
                    if (partnerId && coupleStatusMessages[partnerId]) {
                        // 过滤掉要删除的消息
                        coupleStatusMessages[partnerId] = coupleStatusMessages[partnerId].filter(msg => msg.id !== msgId);

                        // 保存更改并立即刷新页面
                        saveCoupleSpaceSettings();
                        renderStatusMessages(true); // 传入true确保即使删的是历史消息也能正确刷新
                    }
                    return; // 处理完毕，结束
                }


                const bubble = e.target.closest('.status-message-bubble');
                if (!bubble) return; // 如果点击的不是气泡，则不执行任何操作

                // 【【【核心新增】】】如果气泡正处于编辑状态，则直接返回，不执行任何后续操作
                if (bubble.isEditing) {
                    return;
                }

                const wrapper = bubble.closest('.status-message-wrapper');
                const msgId = wrapper.dataset.messageId;

                if (statusMultiSelectMode) {
                    toggleStatusSelection(msgId, wrapper);
                } else {
                    openStatusContextMenu(bubble, msgId);
                }
            });

            // 监听小卡片上的按钮点击
            statusMessageContextCard.addEventListener('click', (e) => {
                const item = e.target.closest('.status-card-menu-item');
                if (item) {
                    const action = item.dataset.action;
                    if (action === 'edit') {
                        handleStatusEdit();
                    } else if (action === 'delete') {
                        // 【修改】进入多选模式后，自动选中当前这条消息
                        enterStatusMultiSelectMode();
                        const wrapper = document.querySelector(`.status-message-wrapper[data-message-id="${activeStatusContextMenuMsgId}"]`);
                        if (wrapper) toggleStatusSelection(activeStatusContextMenuMsgId, wrapper);
                    }
                    statusMessageContextCard.classList.remove('visible'); // 操作后关闭小卡片
                }
            });

            // 点击页面任何地方或滚动时关闭小卡片 和 快捷删除模式
            coupleStatusDetailScreen.addEventListener('click', (e) => {
                // 如果点击的目标不是小卡片本身，也不是消息气泡，就关闭小卡片
                if (statusMessageContextCard.classList.contains('visible') && !statusMessageContextCard.contains(e.target) && !e.target.closest('.status-message-bubble')) {
                    hideWithTransition(statusMessageContextCard, 'visible');
                }

                // 【【【核心新增 V3.9.5】】】如果页面处于快捷删除模式，并且点击的不是任何消息或顶栏按钮，则退出模式
                if (coupleStatusDetailScreen.classList.contains('direct-delete-mode') &&
                    !e.target.closest('.status-message-wrapper, .system-status-wrapper, .couple-status-header')) {
                    coupleStatusDetailScreen.classList.remove('direct-delete-mode');
                }
            });

            // 【新增】滚动时关闭小卡片
            coupleStatusMessageContainer.addEventListener('scroll', () => {
                if (statusMessageContextCard.classList.contains('visible')) {
                    // 【【【核心修改】】】使用新函数来隐藏
                    hideWithTransition(statusMessageContextCard, 'visible');
                }
            });

            // 监听多选模式顶栏按钮
            statusMultiSelectCancelBtn.addEventListener('click', exitStatusMultiSelectMode);
            statusMultiSelectDeleteBtn.addEventListener('click', deleteSelectedStatusMessages);


            // 点击页面任何其他地方关闭状态页菜单
            document.body.addEventListener('click', (e) => {
                if (coupleStatusContextMenu.classList.contains('visible') && !coupleStatusContextMenu.contains(e.target) && !e.target.closest('#couple-status-options-btn')) {
                    // 【【【核心修改】】】使用新函数来隐藏
                    hideWithTransition(coupleStatusContextMenu, 'visible');
                }
            });

            // ===================================================================
            // 【【【全新 V3.9】】】添加状态弹窗事件监听
            // ===================================================================

            // 监听“添加状态”弹窗内的各种点击事件
            if (addStatusModal) {
                // 点击下拉框头部，展开/收起列表
                statusDropdownHeader.addEventListener('click', () => {
                    statusDropdownContainer.classList.toggle('expanded');
                });

                // 事件委托：点击下拉列表中的某个选项
                statusDropdownList.addEventListener('click', (e) => {
                    const item = e.target.closest('.status-dropdown-item');
                    if (!item) return;

                    const optionId = item.dataset.id;
                    const selectedOption = statusOptions.find(opt => opt.id === optionId);

                    if (selectedOption) {
                        // 暂存选择的数据
                        currentStatusData.id = selectedOption.id;
                        currentStatusData.svg = selectedOption.svg;

                        // 更新下拉框头部的显示
                        const selectedIconDiv = statusDropdownHeader.querySelector('.status-dropdown-selected-icon');
                        const selectedTextSpan = statusDropdownHeader.querySelector('.status-dropdown-selected-text');
                        selectedIconDiv.innerHTML = selectedOption.svg;
                        selectedTextSpan.textContent = selectedOption.text;

                        // 自动将模板文字填充到内容框
                        statusContentInput.value = selectedOption.text;

                        // 关闭下拉列表
                        statusDropdownContainer.classList.remove('expanded');
                    }
                });

                // 点击“自己/AI”选择器
                statusSubjectSelector.addEventListener('click', () => {
                    if (currentStatusData.subject === 'user') {
                        currentStatusData.subject = 'assistant';
                        statusSubjectSelector.textContent = 'AI';
                    } else {
                        currentStatusData.subject = 'user';
                        statusSubjectSelector.textContent = '自己';
                    }
                });

                // 点击关闭和取消按钮
                addStatusCloseBtn.addEventListener('click', () => addStatusModal.classList.remove('visible'));
                addStatusCancelBtn.addEventListener('click', () => addStatusModal.classList.remove('visible'));

                // 点击保存按钮
                addStatusSaveBtn.addEventListener('click', saveNewStatusMessage);
            }

            // 点击页面其他地方，如果下拉框是展开的，就收起它
            document.body.addEventListener('click', (e) => {
                if (statusDropdownContainer.classList.contains('expanded') && !statusDropdownContainer.contains(e.target)) {
                    statusDropdownContainer.classList.remove('expanded');
                }
            });
            // ===================================================================
            // 【【【全新 V3.8.4】】】动态评论核心事件监听
            // ===================================================================
            const statusFeedContainer = document.getElementById('couple-status-feed');
            if (statusFeedContainer) {
                statusFeedContainer.addEventListener('click', (e) => {
                    const sendBtn = e.target.closest('.status-post-comment-send');
                    const deleteCommentBtn = e.target.closest('.comment-delete-btn');

                    // --- 逻辑1: 点击发送评论 ---
                    if (sendBtn) {
                        const commentArea = sendBtn.closest('.status-post-comment-area');
                        const statusId = commentArea.dataset.statusId;
                        const input = commentArea.querySelector('.status-post-comment-input');
                        const content = input.value.trim();

                        if (!content) {
                            alert('评论内容不能为空哦！');
                            return;
                        }

                        const statusToUpdate = coupleSpaceSettings.statuses.find(s => s.id === statusId);
                        if (statusToUpdate) {
                            // 获取评论人名字
                            const partnerChat = chats.find(c => c.id === coupleSpaceSettings.partnerChatId);
                            const commenterName = (partnerChat && partnerChat.settings.userName) ? partnerChat.settings.userName : '我';

                            const newComment = {
                                id: 'comment_' + Date.now() + Math.random(), // 唯一的评论ID
                                commenterName: commenterName,
                                content: content,
                                timestamp: Date.now()
                            };

                            // 如果statuses对象上还没有comments数组，就创建一个
                            if (!statusToUpdate.comments) {
                                statusToUpdate.comments = [];
                            }
                            statusToUpdate.comments.push(newComment);

                            saveCoupleSpaceSettings();
                            renderStatusFeed();
                        }
                    }

                    // --- 逻辑2: 点击删除评论 ---
                    if (deleteCommentBtn) {
                        const statusId = deleteCommentBtn.dataset.statusId;
                        const commentId = deleteCommentBtn.dataset.commentId;

                        showConfirmationModal('确定要删除这条评论吗？', () => {
                            const statusToUpdate = coupleSpaceSettings.statuses.find(s => s.id === statusId);
                            if (statusToUpdate && statusToUpdate.comments) {
                                // 过滤掉要删除的评论
                                statusToUpdate.comments = statusToUpdate.comments.filter(c => c.id !== commentId);

                                saveCoupleSpaceSettings();
                                renderStatusFeed();
                            }
                        });
                    }
                });
            }
            // 启动应用
            initializeApp();
        });
    </script>
</body>

</html>